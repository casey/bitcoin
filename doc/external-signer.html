<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>external-signer - Bitcoin Core Developer Documentation</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Bitcoin Core Developer Documentation</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="support-for-signing-transactions-outside-of-bitcoin-core"><a class="header" href="#support-for-signing-transactions-outside-of-bitcoin-core">Support for signing transactions outside of Bitcoin Core</a></h1>
<p>Bitcoin Core can be launched with <code>-signer=&lt;cmd&gt;</code> where <code>&lt;cmd&gt;</code> is an external tool which can sign transactions and perform other functions. For example, it can be used to communicate with a hardware wallet.</p>
<h2 id="example-usage"><a class="header" href="#example-usage">Example usage</a></h2>
<p>The following example is based on the <a href="https://github.com/bitcoin-core/HWI">HWI</a> tool. Version 2.0 or newer is required. Although this tool is hosted under the Bitcoin Core GitHub organization and maintained by Bitcoin Core developers, it should be used with caution. It is considered experimental and has far less review than Bitcoin Core itself. Be particularly careful when running tools such as these on a computer with private keys on it.</p>
<p>When using a hardware wallet, consult the manufacturer website for (alternative) software they recommend. As long as their software conforms to the standard below, it should be able to work with Bitcoin Core.</p>
<p>Start Bitcoin Core:</p>
<pre><code class="language-sh">$ bitcoind -signer=../HWI/hwi.py
</code></pre>
<h3 id="device-setup"><a class="header" href="#device-setup">Device setup</a></h3>
<p>Follow the hardware manufacturers instructions for the initial device setup, as well as their instructions for creating a backup. Alternatively, for some devices, you can use the <code>setup</code>, <code>restore</code> and <code>backup</code> commands provided by <a href="https://github.com/bitcoin-core/HWI">HWI</a>.</p>
<h3 id="create-wallet-and-import-keys"><a class="header" href="#create-wallet-and-import-keys">Create wallet and import keys</a></h3>
<p>Get a list of signing devices / services:</p>
<pre><code>$ bitcoin-cli enumeratesigners
{
  "signers": [
    {
      "fingerprint": "c8df832a"
    }
]
</code></pre>
<p>The master key fingerprint is used to identify a device.</p>
<p>Create a wallet, this automatically imports the public keys:</p>
<pre><code class="language-sh">$ bitcoin-cli createwallet "hww" true true "" true true true
</code></pre>
<h3 id="verify-an-address"><a class="header" href="#verify-an-address">Verify an address</a></h3>
<p>Display an address on the device:</p>
<pre><code class="language-sh">$ bitcoin-cli -rpcwallet=&lt;wallet&gt; getnewaddress
$ bitcoin-cli -rpcwallet=&lt;wallet&gt; walletdisplayaddress &lt;address&gt;
</code></pre>
<p>Replace <code>&lt;address&gt;</code> with the result of <code>getnewaddress</code>.</p>
<h3 id="spending"><a class="header" href="#spending">Spending</a></h3>
<p>Under the hood this uses a <a href="psbt.html">Partially Signed Bitcoin Transaction</a>.</p>
<pre><code class="language-sh">$ bitcoin-cli -rpcwallet=&lt;wallet&gt; sendtoaddress &lt;address&gt; &lt;amount&gt;
</code></pre>
<p>This prompts your hardware wallet to sign, and fail if it's not connected. If successful
it automatically broadcasts the transaction.</p>
<pre><code class="language-sh">{"complete": true, "txid": &lt;txid&gt;}
</code></pre>
<h2 id="signer-api"><a class="header" href="#signer-api">Signer API</a></h2>
<p>In order to be compatible with Bitcoin Core any signer command should conform to the specification below. This specification is subject to change. Ideally a BIP should propose a standard so that other wallets can also make use of it.</p>
<p>Prerequisite knowledge:</p>
<ul>
<li><a href="descriptors.html">Output Descriptors</a></li>
<li>Partially Signed Bitcoin Transaction (<a href="psbt.html">PSBT</a>)</li>
</ul>
<h3 id="enumerate-required"><a class="header" href="#enumerate-required"><code>enumerate</code> (required)</a></h3>
<p>Usage:</p>
<pre><code>$ &lt;cmd&gt; enumerate
[
    {
        "fingerprint": "00000000"
    }
]
</code></pre>
<p>The command MUST return an (empty) array with at least a <code>fingerprint</code> field.</p>
<p>A future extension could add an optional return field with device capabilities. Perhaps a descriptor with wildcards. For example: <code>["pkh("44'/0'/$'/{0,1}/*"), sh(wpkh("49'/0'/$'/{0,1}/*")), wpkh("84'/0'/$'/{0,1}/*")]</code>. This would indicate the device supports legacy, wrapped SegWit and native SegWit. In addition it restricts the derivation paths that can used for those, to maintain compatibility with other wallet software. It also indicates the device, or the driver, doesn't support multisig.</p>
<p>A future extension could add an optional return field <code>reachable</code>, in case <code>&lt;cmd&gt;</code> knows a signer exists but can't currently reach it.</p>
<h3 id="signtransaction-required"><a class="header" href="#signtransaction-required"><code>signtransaction</code> (required)</a></h3>
<p>Usage:</p>
<pre><code>$ &lt;cmd&gt; --fingerprint=&lt;fingerprint&gt; (--testnet) signtransaction &lt;psbt&gt;
base64_encode_signed_psbt
</code></pre>
<p>The command returns a psbt with any signatures.</p>
<p>The <code>psbt</code> SHOULD include bip32 derivations. The command SHOULD fail if none of the bip32 derivations match a key owned by the device.</p>
<p>The command SHOULD fail if the user cancels.</p>
<p>The command MAY complain if <code>--testnet</code> is set, but any of the BIP32 derivation paths contain a coin type other than <code>1h</code> (and vice versa).</p>
<h3 id="getdescriptors-optional"><a class="header" href="#getdescriptors-optional"><code>getdescriptors</code> (optional)</a></h3>
<p>Usage:</p>
<pre><code>$ &lt;cmd&gt; --fingerprint=&lt;fingerprint&gt; (--testnet) getdescriptors &lt;account&gt;
&lt;xpub&gt;
</code></pre>
<p>Returns descriptors supported by the device. Example:</p>
<pre><code>$ &lt;cmd&gt; --fingerprint=00000000 --testnet getdescriptors
{
  "receive": [
    "pkh([00000000/44h/0h/0h]xpub6C.../0/*)#fn95jwmg",
    "sh(wpkh([00000000/49h/0h/0h]xpub6B..../0/*))#j4r9hntt",
    "wpkh([00000000/84h/0h/0h]xpub6C.../0/*)#qw72dxa9"
  ],
  "internal": [
    "pkh([00000000/44h/0h/0h]xpub6C.../1/*)#c8q40mts",
    "sh(wpkh([00000000/49h/0h/0h]xpub6B..../1/*))#85dn0v75",
    "wpkh([00000000/84h/0h/0h]xpub6C..../1/*)#36mtsnda"
  ]
}
</code></pre>
<h3 id="displayaddress-optional"><a class="header" href="#displayaddress-optional"><code>displayaddress</code> (optional)</a></h3>
<p>Usage:</p>
<pre><code>&lt;cmd&gt; --fingerprint=&lt;fingerprint&gt; (--testnet) displayaddress --desc descriptor
</code></pre>
<p>Example, display the first native SegWit receive address on Testnet:</p>
<pre><code>&lt;cmd&gt; --fingerprint=00000000 --testnet displayaddress --desc "wpkh([00000000/84h/1h/0h]tpubDDUZ..../0/0)"
</code></pre>
<p>The command MUST be able to figure out the address type from the descriptor.</p>
<p>The command MUST return an object containing <code>{"address": "[the address]"}</code>.
As a sanity check, for devices that support this, it SHOULD ask the device to derive the address.</p>
<p>If <descriptor> contains a master key fingerprint, the command MUST fail if it does not match the fingerprint known by the device.</p>
<p>If <descriptor> contains an xpub, the command MUST fail if it does not match the xpub known by the device.</p>
<p>The command MAY complain if <code>--testnet</code> is set, but the BIP32 coin type is not <code>1h</code> (and vice versa).</p>
<h2 id="how-bitcoin-core-uses-the-signer-api"><a class="header" href="#how-bitcoin-core-uses-the-signer-api">How Bitcoin Core uses the Signer API</a></h2>
<p>The <code>enumeratesigners</code> RPC simply calls <code>&lt;cmd&gt; enumerate</code>.</p>
<p>The <code>createwallet</code> RPC calls:</p>
<ul>
<li><code>&lt;cmd&gt; --fingerprint=00000000 getdescriptors 0</code></li>
</ul>
<p>It then imports descriptors for all support address types, in a BIP44/49/84 compatible manner.</p>
<p>The <code>walletdisplayaddress</code> RPC reuses some code from <code>getaddressinfo</code> on the provided address and obtains the inferred descriptor. It then calls <code>&lt;cmd&gt; --fingerprint=00000000 displayaddress --desc=&lt;descriptor&gt;</code>.</p>
<p><code>sendtoaddress</code> and <code>sendmany</code> check <code>inputs-&gt;bip32_derivs</code> to see if any inputs have the same <code>master_fingerprint</code> as the signer. If so, it calls <code>&lt;cmd&gt; --fingerprint=00000000 signtransaction &lt;psbt&gt;</code>. It waits for the device to return a (partially) signed psbt, tries to finalize it and broadcasts the transaction.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../doc/dnsseed-policy.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../doc/files.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../doc/dnsseed-policy.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../doc/files.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
