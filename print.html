<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Bitcoin Core Developer Documentation</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Bitcoin Core Developer Documentation</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="bitcoin-core-integrationstaging-tree"><a class="header" href="#bitcoin-core-integrationstaging-tree">Bitcoin Core integration/staging tree</a></h1>
<p>https://bitcoincore.org</p>
<p>For an immediately usable, binary version of the Bitcoin Core software, see
https://bitcoincore.org/en/download/.</p>
<h2 id="what-is-bitcoin-core"><a class="header" href="#what-is-bitcoin-core">What is Bitcoin Core?</a></h2>
<p>Bitcoin Core connects to the Bitcoin peer-to-peer network to download and fully
validate blocks and transactions. It also includes a wallet and graphical user
interface, which can be optionally built.</p>
<p>Further information about Bitcoin Core is available in the <a href="/doc">doc folder</a>.</p>
<h2 id="license"><a class="header" href="#license">License</a></h2>
<p>Bitcoin Core is released under the terms of the MIT license. See <a href="COPYING">COPYING</a> for more
information or see https://opensource.org/licenses/MIT.</p>
<h2 id="development-process"><a class="header" href="#development-process">Development Process</a></h2>
<p>The <code>master</code> branch is regularly built (see <code>doc/build-*.md</code> for instructions) and tested, but it is not guaranteed to be
completely stable. <a href="https://github.com/bitcoin/bitcoin/tags">Tags</a> are created
regularly from release branches to indicate new official, stable release versions of Bitcoin Core.</p>
<p>The https://github.com/bitcoin-core/gui repository is used exclusively for the
development of the GUI. Its master branch is identical in all monotree
repositories. Release branches and tags do not exist, so please do not fork
that repository unless it is for development reasons.</p>
<p>The contribution workflow is described in <a href="CONTRIBUTING.html">CONTRIBUTING.md</a>
and useful hints for developers can be found in <a href="doc/developer-notes.html">doc/developer-notes.md</a>.</p>
<h2 id="testing"><a class="header" href="#testing">Testing</a></h2>
<p>Testing and code review is the bottleneck for development; we get more pull
requests than we can review and test on short notice. Please be patient and help out by testing
other people's pull requests, and remember this is a security-critical project where any mistake might cost people
lots of money.</p>
<h3 id="automated-testing"><a class="header" href="#automated-testing">Automated Testing</a></h3>
<p>Developers are strongly encouraged to write <a href="src/test/README.html">unit tests</a> for new code, and to
submit new unit tests for old code. Unit tests can be compiled and run
(assuming they weren't disabled during the generation of the build system) with: <code>ctest</code>. Further details on running
and extending unit tests can be found in <a href="/src/test/README.html">/src/test/README.md</a>.</p>
<p>There are also <a href="/test">regression and integration tests</a>, written
in Python.
These tests can be run (if the <a href="/test">test dependencies</a> are installed) with: <code>build/test/functional/test_runner.py</code>
(assuming <code>build</code> is your build directory).</p>
<p>The CI (Continuous Integration) systems make sure that every pull request is built for Windows, Linux, and macOS,
and that unit/sanity tests are run automatically.</p>
<h3 id="manual-quality-assurance-qa-testing"><a class="header" href="#manual-quality-assurance-qa-testing">Manual Quality Assurance (QA) Testing</a></h3>
<p>Changes should be tested by somebody other than the developer who wrote the
code. This is especially important for large or high-risk changes. It is useful
to add a test plan to the pull request description if testing the changes is
not straightforward.</p>
<h2 id="translations"><a class="header" href="#translations">Translations</a></h2>
<p>Changes to translations as well as new translations can be submitted to
<a href="https://www.transifex.com/bitcoin/bitcoin/">Bitcoin Core's Transifex page</a>.</p>
<p>Translations are periodically pulled from Transifex and merged into the git repository. See the
<a href="doc/translation_process.html">translation process</a> for details on how this works.</p>
<p><strong>Important</strong>: We do not accept translation changes as GitHub pull requests because the next
pull from Transifex would automatically overwrite them again.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="contributing-to-bitcoin-core"><a class="header" href="#contributing-to-bitcoin-core">Contributing to Bitcoin Core</a></h1>
<p>The Bitcoin Core project operates an open contributor model where anyone is
welcome to contribute towards development in the form of peer review, testing
and patches. This document explains the practical process and guidelines for
contributing.</p>
<p>First, in terms of structure, there is no particular concept of "Bitcoin Core
developers" in the sense of privileged people. Open source often naturally
revolves around a meritocracy where contributors earn trust from the developer
community over time. Nevertheless, some hierarchy is necessary for practical
purposes. As such, there are repository maintainers who are responsible for
merging pull requests, the <a href="/doc/release-process.html">release cycle</a>, and
moderation.</p>
<h2 id="getting-started"><a class="header" href="#getting-started">Getting Started</a></h2>
<p>New contributors are very welcome and needed.</p>
<p>Reviewing and testing is highly valued and the most effective way you can contribute
as a new contributor. It also will teach you much more about the code and
process than opening pull requests. Please refer to the <a href="CONTRIBUTING.html#peer-review">peer review</a>
section below.</p>
<p>Before you start contributing, familiarize yourself with the Bitcoin Core build
system and tests. Refer to the documentation in the repository on how to build
Bitcoin Core and how to run the unit tests, functional tests, and fuzz tests.</p>
<p>There are many open issues of varying difficulty waiting to be fixed.
If you're looking for somewhere to start contributing, check out the
<a href="https://github.com/bitcoin/bitcoin/issues?q=is%3Aopen+is%3Aissue+label%3A%22good+first+issue%22">good first issue</a>
list or changes that are
<a href="https://github.com/bitcoin/bitcoin/issues?utf8=%E2%9C%93&amp;q=label%3A%22Up+for+grabs%22">up for grabs</a>.
Some of them might no longer be applicable. So if you are interested, but
unsure, you might want to leave a comment on the issue first.</p>
<p>You may also participate in the weekly
<a href="https://bitcoincore.reviews/">Bitcoin Core PR Review Club</a> meeting.</p>
<h3 id="good-first-issue-label"><a class="header" href="#good-first-issue-label">Good First Issue Label</a></h3>
<p>The purpose of the <code>good first issue</code> label is to highlight which issues are
suitable for a new contributor without a deep understanding of the codebase.</p>
<p>However, good first issues can be solved by anyone. If they remain unsolved
for a longer time, a frequent contributor might address them.</p>
<p>You do not need to request permission to start working on an issue. However,
you are encouraged to leave a comment if you are planning to work on it. This
will help other contributors monitor which issues are actively being addressed
and is also an effective way to request assistance if and when you need it.</p>
<h2 id="communication-channels"><a class="header" href="#communication-channels">Communication Channels</a></h2>
<p>Most communication about Bitcoin Core development happens on IRC, in the
<code>#bitcoin-core-dev</code> channel on Libera Chat. The easiest way to participate on IRC is
with the web client, <a href="https://web.libera.chat/#bitcoin-core-dev">web.libera.chat</a>. Chat
history logs can be found
on <a href="https://www.erisian.com.au/bitcoin-core-dev/">https://www.erisian.com.au/bitcoin-core-dev/</a>
and <a href="https://gnusha.org/bitcoin-core-dev/">https://gnusha.org/bitcoin-core-dev/</a>.</p>
<p>Discussion about codebase improvements happens in GitHub issues and pull
requests.</p>
<p>The developer
<a href="https://groups.google.com/g/bitcoindev">mailing list</a>
should be used to discuss complicated or controversial consensus or P2P protocol changes before working on
a patch set.
Archives can be found on <a href="https://gnusha.org/pi/bitcoindev/">https://gnusha.org/pi/bitcoindev/</a>.</p>
<h2 id="contributor-workflow"><a class="header" href="#contributor-workflow">Contributor Workflow</a></h2>
<p>The codebase is maintained using the "contributor workflow" where everyone
without exception contributes patch proposals using "pull requests" (PRs). This
facilitates social contribution, easy testing and peer review.</p>
<p>To contribute a patch, the workflow is as follows:</p>
<ol>
<li>Fork repository (<a href="https://docs.github.com/en/get-started/quickstart/fork-a-repo">only for the first time</a>)</li>
<li>Create topic branch</li>
<li>Commit patches</li>
</ol>
<p>For GUI-related issues or pull requests, the https://github.com/bitcoin-core/gui repository should be used.
For all other issues and pull requests, the https://github.com/bitcoin/bitcoin node repository should be used.</p>
<p>The master branch for all monotree repositories is identical.</p>
<p>As a rule of thumb, everything that only modifies <code>src/qt</code> is a GUI-only pull
request. However:</p>
<ul>
<li>For global refactoring or other transversal changes the node repository
should be used.</li>
<li>For GUI-related build system changes, the node repository should be used
because the change needs review by the build systems reviewers.</li>
<li>Changes in <code>src/interfaces</code> need to go to the node repository because they
might affect other components like the wallet.</li>
</ul>
<p>For large GUI changes that include build system and interface changes, it is
recommended to first open a pull request against the GUI repository. When there
is agreement to proceed with the changes, a pull request with the build system
and interfaces changes can be submitted to the node repository.</p>
<p>The project coding conventions in the <a href="doc/developer-notes.html">developer notes</a>
must be followed.</p>
<h3 id="committing-patches"><a class="header" href="#committing-patches">Committing Patches</a></h3>
<p>In general, <a href="https://en.wikipedia.org/wiki/Atomic_commit#Atomic_commit_convention">commits should be atomic</a>
and diffs should be easy to read. For this reason, do not mix any formatting
fixes or code moves with actual code changes.</p>
<p>Make sure each individual commit is hygienic: that it builds successfully on its
own without warnings, errors, regressions, or test failures.</p>
<p>Commit messages should be verbose by default consisting of a short subject line
(50 chars max), a blank line and detailed explanatory text as separate
paragraph(s), unless the title alone is self-explanatory (like "Correct typo
in init.cpp") in which case a single title line is sufficient. Commit messages should be
helpful to people reading your code in the future, so explain the reasoning for
your decisions. Further explanation <a href="https://chris.beams.io/posts/git-commit/">here</a>.</p>
<p>If a particular commit references another issue, please add the reference. For
example: <code>refs #1234</code> or <code>fixes #4321</code>. Using the <code>fixes</code> or <code>closes</code> keywords
will cause the corresponding issue to be closed when the pull request is merged.</p>
<p>Commit messages should never contain any <code>@</code> mentions (usernames prefixed with "@").</p>
<p>Please refer to the <a href="https://git-scm.com/doc">Git manual</a> for more information
about Git.</p>
<ul>
<li>Push changes to your fork</li>
<li>Create pull request</li>
</ul>
<h3 id="creating-the-pull-request"><a class="header" href="#creating-the-pull-request">Creating the Pull Request</a></h3>
<p>The title of the pull request should be prefixed by the component or area that
the pull request affects. Valid areas as:</p>
<ul>
<li><code>consensus</code> for changes to consensus critical code</li>
<li><code>doc</code> for changes to the documentation</li>
<li><code>qt</code> or <code>gui</code> for changes to bitcoin-qt</li>
<li><code>log</code> for changes to log messages</li>
<li><code>mining</code> for changes to the mining code</li>
<li><code>net</code> or <code>p2p</code> for changes to the peer-to-peer network code</li>
<li><code>refactor</code> for structural changes that do not change behavior</li>
<li><code>rpc</code>, <code>rest</code> or <code>zmq</code> for changes to the RPC, REST or ZMQ APIs</li>
<li><code>contrib</code> or <code>cli</code> for changes to the scripts and tools</li>
<li><code>test</code>, <code>qa</code> or <code>ci</code> for changes to the unit tests, QA tests or CI code</li>
<li><code>util</code> or <code>lib</code> for changes to the utils or libraries</li>
<li><code>wallet</code> for changes to the wallet code</li>
<li><code>build</code> for changes to CMake</li>
<li><code>guix</code> for changes to the GUIX reproducible builds</li>
</ul>
<p>Examples:</p>
<pre><code>consensus: Add new opcode for BIP-XXXX OP_CHECKAWESOMESIG
net: Automatically create onion service, listen on Tor
qt: Add feed bump button
log: Fix typo in log message
</code></pre>
<p>The body of the pull request should contain sufficient description of <em>what</em> the
patch does, and even more importantly, <em>why</em>, with justification and reasoning.
You should include references to any discussions (for example, other issues or
mailing list discussions).</p>
<p>The description for a new pull request should not contain any <code>@</code> mentions. The
PR description will be included in the commit message when the PR is merged and
any users mentioned in the description will be annoyingly notified each time a
fork of Bitcoin Core copies the merge. Instead, make any username mentions in a
subsequent comment to the PR.</p>
<h3 id="translation-changes"><a class="header" href="#translation-changes">Translation changes</a></h3>
<p>Note that translations should not be submitted as pull requests. Please see
<a href="https://github.com/bitcoin/bitcoin/blob/master/doc/translation_process.md">Translation Process</a>
for more information on helping with translations.</p>
<h3 id="work-in-progress-changes-and-requests-for-comments"><a class="header" href="#work-in-progress-changes-and-requests-for-comments">Work in Progress Changes and Requests for Comments</a></h3>
<p>If a pull request is not to be considered for merging (yet), please
prefix the title with [WIP] or use <a href="https://docs.github.com/en/github/writing-on-github/getting-started-with-writing-and-formatting-on-github/basic-writing-and-formatting-syntax#task-lists">Tasks Lists</a>
in the body of the pull request to indicate tasks are pending.</p>
<h3 id="address-feedback"><a class="header" href="#address-feedback">Address Feedback</a></h3>
<p>At this stage, one should expect comments and review from other contributors. You
can add more commits to your pull request by committing them locally and pushing
to your fork.</p>
<p>You are expected to reply to any review comments before your pull request is
merged. You may update the code or reject the feedback if you do not agree with
it, but you should express so in a reply. If there is outstanding feedback and
you are not actively working on it, your pull request may be closed.</p>
<p>Please refer to the <a href="CONTRIBUTING.html#peer-review">peer review</a> section below for more details.</p>
<h3 id="squashing-commits"><a class="header" href="#squashing-commits">Squashing Commits</a></h3>
<p>If your pull request contains fixup commits (commits that change the same line of code repeatedly) or too fine-grained
commits, you may be asked to <a href="https://git-scm.com/docs/git-rebase#_interactive_mode">squash</a> your commits
before it will be reviewed. The basic squashing workflow is shown below.</p>
<pre><code>git checkout your_branch_name
git rebase -i HEAD~n
# n is normally the number of commits in the pull request.
# Set commits (except the one in the first line) from 'pick' to 'squash', save and quit.
# On the next screen, edit/refine commit messages.
# Save and quit.
git push -f # (force push to GitHub)
</code></pre>
<p>Please update the resulting commit message, if needed. It should read as a
coherent message. In most cases, this means not just listing the interim
commits.</p>
<p>If your change contains a merge commit, the above workflow may not work and you
will need to remove the merge commit first. See the next section for details on
how to rebase.</p>
<p>Please refrain from creating several pull requests for the same change.
Use the pull request that is already open (or was created earlier) to amend
changes. This preserves the discussion and review that happened earlier for
the respective change set.</p>
<p>The length of time required for peer review is unpredictable and will vary from
pull request to pull request.</p>
<h3 id="rebasing-changes"><a class="header" href="#rebasing-changes">Rebasing Changes</a></h3>
<p>When a pull request conflicts with the target branch, you may be asked to rebase it on top of the current target branch.</p>
<pre><code>git fetch https://github.com/bitcoin/bitcoin  # Fetch the latest upstream commit
git rebase FETCH_HEAD  # Rebuild commits on top of the new base
</code></pre>
<p>This project aims to have a clean git history, where code changes are only made in non-merge commits. This simplifies
auditability because merge commits can be assumed to not contain arbitrary code changes. Merge commits should be signed,
and the resulting git tree hash must be deterministic and reproducible. The script in
<a href="/contrib/verify-commits">/contrib/verify-commits</a> checks that.</p>
<p>After a rebase, reviewers are encouraged to sign off on the force push. This should be relatively straightforward with
the <code>git range-diff</code> tool explained in the <a href="/doc/productivity.html#diff-the-diffs-with-git-range-diff">productivity
notes</a>. To avoid needless review churn, maintainers will
generally merge pull requests that received the most review attention first.</p>
<h2 id="pull-request-philosophy"><a class="header" href="#pull-request-philosophy">Pull Request Philosophy</a></h2>
<p>Patchsets should always be focused. For example, a pull request could add a
feature, fix a bug, or refactor code; but not a mixture. Please also avoid super
pull requests which attempt to do too much, are overly large, or overly complex
as this makes review difficult.</p>
<h3 id="features"><a class="header" href="#features">Features</a></h3>
<p>When adding a new feature, thought must be given to the long term technical debt
and maintenance that feature may require after inclusion. Before proposing a new
feature that will require maintenance, please consider if you are willing to
maintain it (including bug fixing). If features get orphaned with no maintainer
in the future, they may be removed by the Repository Maintainer.</p>
<h3 id="refactoring"><a class="header" href="#refactoring">Refactoring</a></h3>
<p>Refactoring is a necessary part of any software project's evolution. The
following guidelines cover refactoring pull requests for the project.</p>
<p>There are three categories of refactoring: code-only moves, code style fixes, and
code refactoring. In general, refactoring pull requests should not mix these
three kinds of activities in order to make refactoring pull requests easy to
review and uncontroversial. In all cases, refactoring PRs must not change the
behaviour of code within the pull request (bugs must be preserved as is).</p>
<p>Project maintainers aim for a quick turnaround on refactoring pull requests, so
where possible keep them short, uncomplex and easy to verify.</p>
<p>Pull requests that refactor the code should not be made by new contributors. It
requires a certain level of experience to know where the code belongs to and to
understand the full ramification (including rebase effort of open pull requests).</p>
<p>Trivial pull requests or pull requests that refactor the code with no clear
benefits may be immediately closed by the maintainers to reduce unnecessary
workload on reviewing.</p>
<h2 id="decision-making-process"><a class="header" href="#decision-making-process">"Decision Making" Process</a></h2>
<p>The following applies to code changes to the Bitcoin Core project (and related
projects such as libsecp256k1), and is not to be confused with overall Bitcoin
Network Protocol consensus changes.</p>
<p>Whether a pull request is merged into Bitcoin Core rests with the project merge
maintainers.</p>
<p>Maintainers will take into consideration if a patch is in line with the general
principles of the project; meets the minimum standards for inclusion; and will
judge the general consensus of contributors.</p>
<p>In general, all pull requests must:</p>
<ul>
<li>Have a clear use case, fix a demonstrable bug or serve the greater good of
the project (for example refactoring for modularisation);</li>
<li>Be well peer-reviewed;</li>
<li>Have unit tests, functional tests, and fuzz tests, where appropriate;</li>
<li>Follow code style guidelines (<a href="doc/developer-notes.html">C++</a>, <a href="test/functional/README.html">functional tests</a>);</li>
<li>Not break the existing test suite;</li>
<li>Where bugs are fixed, where possible, there should be unit tests
demonstrating the bug and also proving the fix. This helps prevent regression.</li>
<li>Change relevant comments and documentation when behaviour of code changes.</li>
</ul>
<p>Patches that change Bitcoin consensus rules are considerably more involved than
normal because they affect the entire ecosystem and so must be preceded by
extensive mailing list discussions and have a numbered BIP. While each case will
be different, one should be prepared to expend more time and effort than for
other kinds of patches because of increased peer review and consensus building
requirements.</p>
<h3 id="peer-review"><a class="header" href="#peer-review">Peer Review</a></h3>
<p>Anyone may participate in peer review which is expressed by comments in the pull
request. Typically reviewers will review the code for obvious errors, as well as
test out the patch set and opine on the technical merits of the patch. Project
maintainers take into account the peer review when determining if there is
consensus to merge a pull request (remember that discussions may have been
spread out over GitHub, mailing list and IRC discussions).</p>
<p>Code review is a burdensome but important part of the development process, and
as such, certain types of pull requests are rejected. In general, if the
<strong>improvements</strong> do not warrant the <strong>review effort</strong> required, the PR has a
high chance of being rejected. It is up to the PR author to convince the
reviewers that the changes warrant the review effort, and if reviewers are
"Concept NACK'ing" the PR, the author may need to present arguments and/or do
research backing their suggested changes.</p>
<h4 id="conceptual-review"><a class="header" href="#conceptual-review">Conceptual Review</a></h4>
<p>A review can be a conceptual review, where the reviewer leaves a comment</p>
<ul>
<li><code>Concept (N)ACK</code>, meaning "I do (not) agree with the general goal of this pull
request",</li>
<li><code>Approach (N)ACK</code>, meaning <code>Concept ACK</code>, but "I do (not) agree with the
approach of this change".</li>
</ul>
<p>A <code>NACK</code> needs to include a rationale why the change is not worthwhile.
NACKs without accompanying reasoning may be disregarded.</p>
<h4 id="code-review"><a class="header" href="#code-review">Code Review</a></h4>
<p>After conceptual agreement on the change, code review can be provided. A review
begins with <code>ACK BRANCH_COMMIT</code>, where <code>BRANCH_COMMIT</code> is the top of the PR
branch, followed by a description of how the reviewer did the review. The
following language is used within pull request comments:</p>
<ul>
<li>"I have tested the code", involving change-specific manual testing in
addition to running the unit, functional, or fuzz tests, and in case it is
not obvious how the manual testing was done, it should be described;</li>
<li>"I have not tested the code, but I have reviewed it and it looks
OK, I agree it can be merged";</li>
<li>A "nit" refers to a trivial, often non-blocking issue.</li>
</ul>
<p>Project maintainers reserve the right to weigh the opinions of peer reviewers
using common sense judgement and may also weigh based on merit. Reviewers that
have demonstrated a deeper commitment and understanding of the project over time
or who have clear domain expertise may naturally have more weight, as one would
expect in all walks of life.</p>
<p>Where a patch set affects consensus-critical code, the bar will be much
higher in terms of discussion and peer review requirements, keeping in mind that
mistakes could be very costly to the wider community. This includes refactoring
of consensus-critical code.</p>
<p>Where a patch set proposes to change the Bitcoin consensus, it must have been
discussed extensively on the mailing list and IRC, be accompanied by a widely
discussed BIP and have a generally widely perceived technical consensus of being
a worthwhile change based on the judgement of the maintainers.</p>
<h3 id="finding-reviewers"><a class="header" href="#finding-reviewers">Finding Reviewers</a></h3>
<p>As most reviewers are themselves developers with their own projects, the review
process can be quite lengthy, and some amount of patience is required. If you find
that you've been waiting for a pull request to be given attention for several
months, there may be a number of reasons for this, some of which you can do something
about:</p>
<ul>
<li>It may be because of a feature freeze due to an upcoming release. During this time,
only bug fixes are taken into consideration. If your pull request is a new feature,
it will not be prioritized until after the release. Wait for the release.</li>
<li>It may be because the changes you are suggesting do not appeal to people. Rather than
nits and critique, which require effort and means they care enough to spend time on your
contribution, thundering silence is a good sign of widespread (mild) dislike of a given change
(because people don't assume <em>others</em> won't actually like the proposal). Don't take
that personally, though! Instead, take another critical look at what you are suggesting
and see if it: changes too much, is too broad, doesn't adhere to the
<a href="doc/developer-notes.html">developer notes</a>, is dangerous or insecure, is messily written, etc.
Identify and address any of the issues you find. Then ask e.g. on IRC if someone could give
their opinion on the concept itself.</li>
<li>It may be because your code is too complex for all but a few people, and those people
may not have realized your pull request even exists. A great way to find people who
are qualified and care about the code you are touching is the
<a href="https://docs.github.com/en/github/managing-files-in-a-repository/managing-files-on-github/tracking-changes-in-a-file">Git Blame feature</a>. Simply
look up who last modified the code you are changing and see if you can find
them and give them a nudge. Don't be incessant about the nudging, though.</li>
<li>Finally, if all else fails, ask on IRC or elsewhere for someone to give your pull request
a look. If you think you've been waiting for an unreasonably long time (say,
more than a month) for no particular reason (a few lines changed, etc.),
this is totally fine. Try to return the favor when someone else is asking
for feedback on their code, and the universe balances out.</li>
<li>Remember that the best thing you can do while waiting is give review to others!</li>
</ul>
<h2 id="backporting"><a class="header" href="#backporting">Backporting</a></h2>
<p>Security and bug fixes can be backported from <code>master</code> to release
branches.
Maintainers will do backports in batches and
use the proper <code>Needs backport (...)</code> labels
when needed (the original author does not need to worry about it).</p>
<p>A backport should contain the following metadata in the commit body:</p>
<pre><code>Github-Pull: #&lt;PR number&gt;
Rebased-From: &lt;commit hash of the original commit&gt;
</code></pre>
<p>Have a look at <a href="https://github.com/bitcoin/bitcoin/pull/16189">an example backport PR</a>.</p>
<p>Also see the <a href="https://github.com/bitcoin-core/bitcoin-maintainer-tools#backport">backport.py script</a>.</p>
<h2 id="copyright"><a class="header" href="#copyright">Copyright</a></h2>
<p>By contributing to this repository, you agree to license your work under the
MIT license unless specified otherwise in <code>contrib/debian/copyright</code> or at
the top of the file itself. Any work contributed where you are not the original
author must contain its license header with the original author(s) and source.</p>
<div style="break-before: page; page-break-before: always;"></div><p>See <a href="/doc">doc/build-*.md</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="security-policy"><a class="header" href="#security-policy">Security Policy</a></h1>
<h2 id="supported-versions"><a class="header" href="#supported-versions">Supported Versions</a></h2>
<p>See our website for versions of Bitcoin Core that are currently supported with
security updates: https://bitcoincore.org/en/lifecycle/#schedule</p>
<h2 id="reporting-a-vulnerability"><a class="header" href="#reporting-a-vulnerability">Reporting a Vulnerability</a></h2>
<p>To report security issues send an email to security@bitcoincore.org (not for support).</p>
<p>The following keys may be used to communicate sensitive information to developers:</p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Fingerprint</th></tr></thead><tbody>
<tr><td>Pieter Wuille</td><td>133E AC17 9436 F14A 5CF1  B794 860F EB80 4E66 9320</td></tr>
<tr><td>Michael Ford</td><td>E777 299F C265 DD04 7930  70EB 944D 35F9 AC3D B76A</td></tr>
<tr><td>Ava Chow</td><td>1528 1230 0785 C964 44D3  334D 1756 5732 E08E 5E41</td></tr>
</tbody></table>
</div>
<p>You can import a key by running the following command with that individualâ€™s fingerprint: <code>gpg --keyserver hkps://keys.openpgp.org --recv-keys "&lt;fingerprint&gt;"</code> Ensure that you put quotes around fingerprints containing spaces.</p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="ci-scripts"><a class="header" href="#ci-scripts">CI Scripts</a></h2>
<p>This directory contains scripts for each build step in each build stage.</p>
<h3 id="running-a-stage-locally"><a class="header" href="#running-a-stage-locally">Running a Stage Locally</a></h3>
<p>Be aware that the tests will be built and run in-place, so please run at your own risk.
If the repository is not a fresh git clone, you might have to clean files from previous builds or test runs first.</p>
<p>The ci needs to perform various sysadmin tasks such as installing packages or writing to the user's home directory.
While it should be fine to run
the ci system locally on you development box, the ci scripts can generally be assumed to have received less review and
testing compared to other parts of the codebase. If you want to keep the work tree clean, you might want to run the ci
system in a virtual machine with a Linux operating system of your choice.</p>
<p>To allow for a wide range of tested environments, but also ensure reproducibility to some extent, the test stage
requires <code>bash</code>, <code>docker</code>, and <code>python3</code> to be installed. To run on different architectures than the host <code>qemu</code> is also required. To install all requirements on Ubuntu, run</p>
<pre><code>sudo apt install bash docker.io python3 qemu-user-static
</code></pre>
<p>It is recommended to run the ci system in a clean env. To run the test stage
with a specific configuration,</p>
<pre><code>env -i HOME="$HOME" PATH="$PATH" USER="$USER" bash -c 'FILE_ENV="./ci/test/00_setup_env_arm.sh" ./ci/test_run_all.sh'
</code></pre>
<h3 id="configurations"><a class="header" href="#configurations">Configurations</a></h3>
<p>The test files (<code>FILE_ENV</code>) are constructed to test a wide range of
configurations, rather than a single pass/fail. This helps to catch build
failures and logic errors that present on platforms other than the ones the
author has tested.</p>
<p>Some builders use the dependency-generator in <code>./depends</code>, rather than using
the system package manager to install build dependencies. This guarantees that
the tester is using the same versions as the release builds, which also use
<code>./depends</code>.</p>
<p>It is also possible to force a specific configuration without modifying the
file. For example,</p>
<pre><code>env -i HOME="$HOME" PATH="$PATH" USER="$USER" bash -c 'MAKEJOBS="-j1" FILE_ENV="./ci/test/00_setup_env_arm.sh" ./ci/test_run_all.sh'
</code></pre>
<p>The files starting with <code>0n</code> (<code>n</code> greater than 0) are the scripts that are run
in order.</p>
<h3 id="cache"><a class="header" href="#cache">Cache</a></h3>
<p>In order to avoid rebuilding all dependencies for each build, the binaries are
cached and reused when possible. Changes in the dependency-generator will
trigger cache-invalidation and rebuilds as necessary.</p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="retry---the-command-line-retry-tool"><a class="header" href="#retry---the-command-line-retry-tool">retry - The command line retry tool</a></h2>
<p>Retry any shell command with exponential backoff or constant delay.</p>
<h3 id="instructions"><a class="header" href="#instructions">Instructions</a></h3>
<p>Install:</p>
<p>retry is a shell script, so drop it somewhere and make sure it's added to your $PATH. Or you can use the following one-liner:</p>
<pre><code class="language-sh">sudo sh -c "curl https://raw.githubusercontent.com/kadwanev/retry/master/retry -o /usr/local/bin/retry &amp;&amp; chmod +x /usr/local/bin/retry"
</code></pre>
<p>If you're on OS X, retry is also on Homebrew:</p>
<pre><code>brew pull 27283
brew install retry
</code></pre>
<p>Not popular enough for homebrew-core. Please star this project to help.</p>
<h3 id="usage"><a class="header" href="#usage">Usage</a></h3>
<p>Help:</p>
<p><code>retry -?</code></p>
<pre><code>Usage: retry [options] -- execute command
    -h, -?, --help
    -v, --verbose                    Verbose output
    -t, --tries=#                    Set max retries: Default 10
    -s, --sleep=secs                 Constant sleep amount (seconds)
    -m, --min=secs                   Exponential Backoff: minimum sleep amount (seconds): Default 0.3
    -x, --max=secs                   Exponential Backoff: maximum sleep amount (seconds): Default 60
    -f, --fail="script +cmds"        Fail Script: run in case of final failure
</code></pre>
<h3 id="examples"><a class="header" href="#examples">Examples</a></h3>
<p>No problem:</p>
<p><code>retry echo u work good</code></p>
<pre><code>u work good
</code></pre>
<p>Test functionality:</p>
<p><code>retry 'echo "y u no work"; false'</code></p>
<pre><code>y u no work
Before retry #1: sleeping 0.3 seconds
y u no work
Before retry #2: sleeping 0.6 seconds
y u no work
Before retry #3: sleeping 1.2 seconds
y u no work
Before retry #4: sleeping 2.4 seconds
y u no work
Before retry #5: sleeping 4.8 seconds
y u no work
Before retry #6: sleeping 9.6 seconds
y u no work
Before retry #7: sleeping 19.2 seconds
y u no work
Before retry #8: sleeping 38.4 seconds
y u no work
Before retry #9: sleeping 60.0 seconds
y u no work
Before retry #10: sleeping 60.0 seconds
y u no work
etc..
</code></pre>
<p>Limit retries:</p>
<p><code>retry -t 4 'echo "y u no work"; false'</code></p>
<pre><code>y u no work
Before retry #1: sleeping 0.3 seconds
y u no work
Before retry #2: sleeping 0.6 seconds
y u no work
Before retry #3: sleeping 1.2 seconds
y u no work
Before retry #4: sleeping 2.4 seconds
y u no work
Retries exhausted
</code></pre>
<p>Bad command:</p>
<p><code>retry poop</code></p>
<pre><code>bash: poop: command not found
</code></pre>
<p>Fail command:</p>
<p><code>retry -t 3 -f 'echo "oh poopsickles"' 'echo "y u no work"; false'</code></p>
<pre><code>y u no work
Before retry #1: sleeping 0.3 seconds
y u no work
Before retry #2: sleeping 0.6 seconds
y u no work
Before retry #3: sleeping 1.2 seconds
y u no work
Retries exhausted, running fail script
oh poopsickles
</code></pre>
<p>Last attempt passed:</p>
<p><code>retry -t 3 -- 'if [ $RETRY_ATTEMPT -eq 3 ]; then echo Passed at attempt $RETRY_ATTEMPT; true; else echo Failed at attempt $RETRY_ATTEMPT; false; fi;'</code></p>
<pre><code>Failed at attempt 0
Before retry #1: sleeping 0.3 seconds
Failed at attempt 1
Before retry #2: sleeping 0.6 seconds
Failed at attempt 2
Before retry #3: sleeping 1.2 seconds
Passed at attempt 3
</code></pre>
<h3 id="license-1"><a class="header" href="#license-1">License</a></h3>
<p>Apache 2.0 - go nuts</p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="repository-tools"><a class="header" href="#repository-tools">Repository Tools</a></h2>
<h3 id="developer-tools"><a class="header" href="#developer-tools"><a href="contrib//contrib/devtools">Developer tools</a></a></h3>
<p>Specific tools for developers working on this repository.
Additional tools, including the <code>github-merge.py</code> script, are available in the <a href="https://github.com/bitcoin-core/bitcoin-maintainer-tools">maintainer-tools</a> repository.</p>
<h3 id="verify-commits"><a class="header" href="#verify-commits"><a href="contrib//contrib/verify-commits">Verify-Commits</a></a></h3>
<p>Tool to verify that every merge commit was signed by a developer using the <code>github-merge.py</code> script.</p>
<h3 id="linearize"><a class="header" href="#linearize"><a href="contrib//contrib/linearize">Linearize</a></a></h3>
<p>Construct a linear, no-fork, best version of the blockchain.</p>
<h3 id="qos"><a class="header" href="#qos"><a href="contrib//contrib/qos">Qos</a></a></h3>
<p>A Linux bash script that will set up traffic control (tc) to limit the outgoing bandwidth for connections to the Bitcoin network. This means one can have an always-on bitcoind instance running, and another local bitcoind/bitcoin-qt instance which connects to this node and receives blocks from it.</p>
<h3 id="seeds"><a class="header" href="#seeds"><a href="contrib//contrib/seeds">Seeds</a></a></h3>
<p>Utility to generate the pnSeed[] array that is compiled into the client.</p>
<h2 id="build-tools-and-keys"><a class="header" href="#build-tools-and-keys">Build Tools and Keys</a></h2>
<h3 id="packaging"><a class="header" href="#packaging">Packaging</a></h3>
<p>The <a href="contrib//contrib/debian">Debian</a> subfolder contains the copyright file.</p>
<p>All other packaging related files can be found in the <a href="https://github.com/bitcoin-core/packaging">bitcoin-core/packaging</a> repository.</p>
<h3 id="macdeploy"><a class="header" href="#macdeploy"><a href="contrib//contrib/macdeploy">MacDeploy</a></a></h3>
<p>Scripts and notes for Mac builds.</p>
<h2 id="test-and-verify-tools"><a class="header" href="#test-and-verify-tools">Test and Verify Tools</a></h2>
<h3 id="testgen"><a class="header" href="#testgen"><a href="contrib//contrib/testgen">TestGen</a></a></h3>
<p>Utilities to generate test vectors for the data-driven Bitcoin tests.</p>
<h3 id="verify-binaries"><a class="header" href="#verify-binaries"><a href="contrib//contrib/verify-binaries">Verify-Binaries</a></a></h3>
<p>This script attempts to download and verify the signature file SHA256SUMS.asc from bitcoin.org.</p>
<h2 id="command-line-tools"><a class="header" href="#command-line-tools">Command Line Tools</a></h2>
<h3 id="completions"><a class="header" href="#completions"><a href="contrib//contrib/completions">Completions</a></a></h3>
<p>Shell completions for bash and fish.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="asmap-tool"><a class="header" href="#asmap-tool">ASMap Tool</a></h1>
<p>Tool for performing various operations on textual and binary asmap files,
particularly encoding/compressing the raw data to the binary format that can
be used in Bitcoin Core with the <code>-asmap</code> option.</p>
<p>Example usage:</p>
<pre><code>python3 asmap-tool.py encode /path/to/input.file /path/to/output.file
python3 asmap-tool.py decode /path/to/input.file /path/to/output.file
python3 asmap-tool.py diff /path/to/first.file /path/to/second.file
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="contents"><a class="header" href="#contents">Contents</a></h1>
<p>This directory contains tools for developers working on this repository.</p>
<h1 id="clang-format-diffpy"><a class="header" href="#clang-format-diffpy">clang-format-diff.py</a></h1>
<p>A script to format unified git diffs according to <a href="contrib/devtools/../../src/.clang-format">.clang-format</a>.</p>
<p>Requires <code>clang-format</code>, installed e.g. via <code>brew install clang-format</code> on macOS,
or <code>sudo apt install clang-format</code> on Debian/Ubuntu.</p>
<p>For instance, to format the last commit with 0 lines of context,
the script should be called from the git root folder as follows.</p>
<pre><code>git diff -U0 HEAD~1.. | ./contrib/devtools/clang-format-diff.py -p1 -i -v
</code></pre>
<h1 id="copyright_headerpy"><a class="header" href="#copyright_headerpy">copyright_header.py</a></h1>
<p>Provides utilities for managing copyright headers of <code>The Bitcoin Core developers</code> in repository source files. It has three subcommands:</p>
<pre><code>$ ./copyright_header.py report &lt;base_directory&gt; [verbose]
$ ./copyright_header.py update &lt;base_directory&gt;
$ ./copyright_header.py insert &lt;file&gt;
</code></pre>
<p>Running these subcommands without arguments displays a usage string.</p>
<h2 id="copyright_headerpy-report-base_directory-verbose"><a class="header" href="#copyright_headerpy-report-base_directory-verbose">copyright_header.py report &lt;base_directory&gt; [verbose]</a></h2>
<p>Produces a report of all copyright header notices found inside the source files
of a repository. Useful to quickly visualize the state of the headers.
Specifying <code>verbose</code> will list the full filenames of files of each category.</p>
<h2 id="copyright_headerpy-update-base_directory-verbose"><a class="header" href="#copyright_headerpy-update-base_directory-verbose">copyright_header.py update &lt;base_directory&gt; [verbose]</a></h2>
<p>Updates all the copyright headers of <code>The Bitcoin Core developers</code> which were
changed in a year more recent than is listed. For example:</p>
<pre><code>// Copyright (c) &lt;firstYear&gt;-&lt;lastYear&gt; The Bitcoin Core developers
</code></pre>
<p>will be updated to:</p>
<pre><code>// Copyright (c) &lt;firstYear&gt;-&lt;lastModifiedYear&gt; The Bitcoin Core developers
</code></pre>
<p>where <code>&lt;lastModifiedYear&gt;</code> is obtained from the <code>git log</code> history.</p>
<p>This subcommand also handles copyright headers that have only a single year. In
those cases:</p>
<pre><code>// Copyright (c) &lt;year&gt; The Bitcoin Core developers
</code></pre>
<p>will be updated to:</p>
<pre><code>// Copyright (c) &lt;year&gt;-&lt;lastModifiedYear&gt; The Bitcoin Core developers
</code></pre>
<p>where the update is appropriate.</p>
<h2 id="copyright_headerpy-insert-file"><a class="header" href="#copyright_headerpy-insert-file">copyright_header.py insert &lt;file&gt;</a></h2>
<p>Inserts a copyright header for <code>The Bitcoin Core developers</code> at the top of the
file in either Python or C++ style as determined by the file extension. If the
file is a Python file and it has  <code>#!</code> starting the first line, the header is
inserted in the line below it.</p>
<p>The copyright dates will be set to be <code>&lt;year_introduced&gt;-&lt;current_year&gt;</code> where
<code>&lt;year_introduced&gt;</code> is according to the <code>git log</code> history. If
<code>&lt;year_introduced&gt;</code> is equal to <code>&lt;current_year&gt;</code>, it will be set as a single
year rather than two hyphenated years.</p>
<p>If the file already has a copyright for <code>The Bitcoin Core developers</code>, the
script will exit.</p>
<h1 id="gen-manpagespy"><a class="header" href="#gen-manpagespy">gen-manpages.py</a></h1>
<p>A small script to automatically create manpages in ../../doc/man by running the release binaries with the -help option.
This requires help2man which can be found at: https://www.gnu.org/software/help2man/</p>
<p>With in-tree builds this tool can be run from any directory within the
repository. To use this tool with out-of-tree builds set <code>BUILDDIR</code>. For
example:</p>
<pre><code class="language-bash">BUILDDIR=$PWD/build contrib/devtools/gen-manpages.py
</code></pre>
<h1 id="headerssync-paramspy"><a class="header" href="#headerssync-paramspy">headerssync-params.py</a></h1>
<p>A script to generate optimal parameters for the headerssync module (src/headerssync.cpp). It takes no command-line
options, as all its configuration is set at the top of the file. It runs many times faster inside PyPy. Invocation:</p>
<pre><code class="language-bash">pypy3 contrib/devtools/headerssync-params.py
</code></pre>
<h1 id="gen-bitcoin-confsh"><a class="header" href="#gen-bitcoin-confsh">gen-bitcoin-conf.sh</a></h1>
<p>Generates a bitcoin.conf file in <code>share/examples/</code> by parsing the output from <code>bitcoind --help</code>. This script is run during the
release process to include a bitcoin.conf with the release binaries and can also be run by users to generate a file locally.
When generating a file as part of the release process, make sure to commit the changes after running the script.</p>
<p>With in-tree builds this tool can be run from any directory within the
repository. To use this tool with out-of-tree builds set <code>BUILDDIR</code>. For
example:</p>
<pre><code class="language-bash">BUILDDIR=$PWD/build contrib/devtools/gen-bitcoin-conf.sh
</code></pre>
<h1 id="security-checkpy-and-test-security-checkpy"><a class="header" href="#security-checkpy-and-test-security-checkpy">security-check.py and test-security-check.py</a></h1>
<p>Perform basic security checks on a series of executables.</p>
<h1 id="symbol-checkpy"><a class="header" href="#symbol-checkpy">symbol-check.py</a></h1>
<p>A script to check that release executables only contain
certain symbols and are only linked against allowed libraries.</p>
<p>For Linux this means checking for allowed gcc, glibc and libstdc++ version symbols.
This makes sure they are still compatible with the minimum supported distribution versions.</p>
<p>For macOS and Windows we check that the executables are only linked against libraries we allow.</p>
<p>Example usage:</p>
<pre><code>find ../path/to/executables -type f -executable | xargs python3 contrib/devtools/symbol-check.py
</code></pre>
<p>If no errors occur the return value will be 0 and the output will be empty.</p>
<p>If there are any errors the return value will be 1 and output like this will be printed:</p>
<pre><code>.../64/test_bitcoin: symbol memcpy from unsupported version GLIBC_2.14
.../64/test_bitcoin: symbol __fdelt_chk from unsupported version GLIBC_2.15
.../64/test_bitcoin: symbol std::out_of_range::~out_of_range() from unsupported version GLIBCXX_3.4.15
.../64/test_bitcoin: symbol _ZNSt8__detail15_List_nod from unsupported version GLIBCXX_3.4.15
</code></pre>
<h1 id="circular-dependenciespy"><a class="header" href="#circular-dependenciespy">circular-dependencies.py</a></h1>
<p>Run this script from the root of the source tree (<code>src/</code>) to find circular dependencies in the source code.
This looks only at which files include other files, treating the <code>.cpp</code> and <code>.h</code> file as one unit.</p>
<p>Example usage:</p>
<pre><code>cd .../src
../contrib/devtools/circular-dependencies.py {*,*/*,*/*/*}.{h,cpp}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="bitcoin-tidy"><a class="header" href="#bitcoin-tidy">Bitcoin Tidy</a></h1>
<p>Example Usage:</p>
<pre><code class="language-bash">cmake -S . -B build -DLLVM_DIR=$(llvm-config --cmakedir) -DCMAKE_BUILD_TYPE=Release

cmake --build build -j$(nproc)

cmake --build build --target bitcoin-tidy-tests -j$(nproc)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="bootstrappable-bitcoin-core-builds"><a class="header" href="#bootstrappable-bitcoin-core-builds">Bootstrappable Bitcoin Core Builds</a></h1>
<p>This directory contains the files necessary to perform bootstrappable Bitcoin
Core builds.</p>
<p><a href="https://bootstrappable.org/">Bootstrappability</a> furthers our binary security guarantees by allowing us
to <em>audit and reproduce</em> our toolchain instead of blindly <em>trusting</em> binary
downloads.</p>
<p>We achieve bootstrappability by using Guix as a functional package manager.</p>
<h1 id="requirements"><a class="header" href="#requirements">Requirements</a></h1>
<p>Conservatively, you will need:</p>
<ul>
<li>16GB of free disk space on the partition that /gnu/store will reside in</li>
<li>8GB of free disk space <strong>per platform triple</strong> you're planning on building
(see the <code>HOSTS</code> <a href="contrib/guix/index.html#recognized-environment-variables">environment variable description</a>)</li>
</ul>
<h1 id="installation-and-setup"><a class="header" href="#installation-and-setup">Installation and Setup</a></h1>
<p>If you don't have Guix installed and set up, please follow the instructions in
<a href="contrib/guix/./INSTALL.html">INSTALL.md</a></p>
<h1 id="usage-1"><a class="header" href="#usage-1">Usage</a></h1>
<p>If you haven't considered your security model yet, please read <a href="contrib/guix/index.html#choosing-your-security-model">the relevant
section</a> before proceeding to perform a build.</p>
<h2 id="making-the-xcode-sdk-available-for-macos-cross-compilation"><a class="header" href="#making-the-xcode-sdk-available-for-macos-cross-compilation">Making the Xcode SDK available for macOS cross-compilation</a></h2>
<p>In order to perform a build for macOS (which is included in the default set of
platform triples to build), you'll need to extract the macOS SDK tarball using
tools found in the <a href="contrib/guix/../macdeploy/README.html"><code>macdeploy</code> directory</a>.</p>
<p>You can then either point to the SDK using the <code>SDK_PATH</code> environment variable:</p>
<pre><code class="language-sh"># Extract the SDK tarball to /path/to/parent/dir/of/extracted/SDK/Xcode-&lt;foo&gt;-&lt;bar&gt;-extracted-SDK-with-libcxx-headers
tar -C /path/to/parent/dir/of/extracted/SDK -xaf /path/to/Xcode-&lt;foo&gt;-&lt;bar&gt;-extracted-SDK-with-libcxx-headers.tar.gz

# Indicate where to locate the SDK tarball
export SDK_PATH=/path/to/parent/dir/of/extracted/SDK
</code></pre>
<p>or extract it into <code>depends/SDKs</code>:</p>
<pre><code class="language-sh">mkdir -p depends/SDKs
tar -C depends/SDKs -xaf /path/to/SDK/tarball
</code></pre>
<h2 id="building"><a class="header" href="#building">Building</a></h2>
<p><em>The author highly recommends at least reading over the <a href="contrib/guix/index.html#common-guix-build-invocation-patterns-and-examples">common usage patterns
and examples</a> section below
before starting a build. For a full list of customization options, see the
<a href="contrib/guix/index.html#recognized-environment-variables">recognized environment variables</a> section.</em></p>
<p>To build Bitcoin Core reproducibly with all default options, invoke the
following from the top of a clean repository:</p>
<pre><code class="language-sh">./contrib/guix/guix-build
</code></pre>
<h2 id="codesigning-build-outputs"><a class="header" href="#codesigning-build-outputs">Codesigning build outputs</a></h2>
<p>The <code>guix-codesign</code> command attaches codesignatures (produced by codesigners) to
existing non-codesigned outputs. Please see the <a href="contrib/guix//doc/release-process.html">release process
documentation</a> for more context.</p>
<p>It respects many of the same environment variable flags as <code>guix-build</code>, with 2
crucial differences:</p>
<ol>
<li>Since only Windows and macOS build outputs require codesigning, the <code>HOSTS</code>
environment variable will have a sane default value of <code>x86_64-w64-mingw32 x86_64-apple-darwin arm64-apple-darwin</code> instead of all the platforms.</li>
<li>The <code>guix-codesign</code> command <em><strong>requires</strong></em> a <code>DETACHED_SIGS_REPO</code> flag.
<ul>
<li>
<p><em><strong>DETACHED_SIGS_REPO</strong></em></p>
<p>Set the directory where detached codesignatures can be found for the current
Bitcoin Core version being built.</p>
<p><em>REQUIRED environment variable</em></p>
</li>
</ul>
</li>
</ol>
<p>An invocation with all default options would look like:</p>
<pre><code>env DETACHED_SIGS_REPO=&lt;path/to/bitcoin-detached-sigs&gt; ./contrib/guix/guix-codesign
</code></pre>
<h2 id="cleaning-intermediate-work-directories"><a class="header" href="#cleaning-intermediate-work-directories">Cleaning intermediate work directories</a></h2>
<p>By default, <code>guix-build</code> leaves all intermediate files or "work directories"
(e.g. <code>depends/work</code>, <code>guix-build-*/distsrc-*</code>) intact at the end of a build so
that they are available to the user (to aid in debugging, etc.). However, these
directories usually take up a large amount of disk space. Therefore, a
<code>guix-clean</code> convenience script is provided which cleans the current <code>git</code>
worktree to save disk space:</p>
<pre><code>./contrib/guix/guix-clean
</code></pre>
<h2 id="attesting-to-build-outputs"><a class="header" href="#attesting-to-build-outputs">Attesting to build outputs</a></h2>
<p>Much like how Gitian build outputs are attested to in a <code>gitian.sigs</code>
repository, Guix build outputs are attested to in the <a href="https://github.com/bitcoin-core/guix.sigs"><code>guix.sigs</code>
repository</a>.</p>
<p>After you've cloned the <code>guix.sigs</code> repository, to attest to the current
worktree's commit/tag:</p>
<pre><code>env GUIX_SIGS_REPO=&lt;path/to/guix.sigs&gt; SIGNER=&lt;gpg-key-name&gt; ./contrib/guix/guix-attest
</code></pre>
<p>See <code>./contrib/guix/guix-attest --help</code> for more information on the various ways
<code>guix-attest</code> can be invoked.</p>
<h2 id="verifying-build-output-attestations"><a class="header" href="#verifying-build-output-attestations">Verifying build output attestations</a></h2>
<p>After at least one other signer has uploaded their signatures to the <code>guix.sigs</code>
repository:</p>
<pre><code>git -C &lt;path/to/guix.sigs&gt; pull
env GUIX_SIGS_REPO=&lt;path/to/guix.sigs&gt; ./contrib/guix/guix-verify
</code></pre>
<h2 id="common-guix-build-invocation-patterns-and-examples"><a class="header" href="#common-guix-build-invocation-patterns-and-examples">Common <code>guix-build</code> invocation patterns and examples</a></h2>
<h3 id="keeping-caches-and-sdks-outside-of-the-worktree"><a class="header" href="#keeping-caches-and-sdks-outside-of-the-worktree">Keeping caches and SDKs outside of the worktree</a></h3>
<p>If you perform a lot of builds and have a bunch of worktrees, you may find it
more efficient to keep the depends tree's download cache, build cache, and SDKs
outside of the worktrees to avoid duplicate downloads and unnecessary builds. To
help with this situation, the <code>guix-build</code> script honours the <code>SOURCES_PATH</code>,
<code>BASE_CACHE</code>, and <code>SDK_PATH</code> environment variables and will pass them on to the
depends tree so that you can do something like:</p>
<pre><code class="language-sh">env SOURCES_PATH="$HOME/depends-SOURCES_PATH" BASE_CACHE="$HOME/depends-BASE_CACHE" SDK_PATH="$HOME/macOS-SDKs" ./contrib/guix/guix-build
</code></pre>
<p>Note that the paths that these environment variables point to <strong>must be
directories</strong>, and <strong>NOT symlinks to directories</strong>.</p>
<p>See the <a href="contrib/guix/index.html#recognized-environment-variables">recognized environment variables</a> section for more
details.</p>
<h3 id="building-a-subset-of-platform-triples"><a class="header" href="#building-a-subset-of-platform-triples">Building a subset of platform triples</a></h3>
<p>Sometimes you only want to build a subset of the supported platform triples, in
which case you can override the default list by setting the space-separated
<code>HOSTS</code> environment variable:</p>
<pre><code class="language-sh">env HOSTS='x86_64-w64-mingw32 x86_64-apple-darwin' ./contrib/guix/guix-build
</code></pre>
<p>See the <a href="contrib/guix/index.html#recognized-environment-variables">recognized environment variables</a> section for more
details.</p>
<h3 id="controlling-the-number-of-threads-used-by-guix-build-commands"><a class="header" href="#controlling-the-number-of-threads-used-by-guix-build-commands">Controlling the number of threads used by <code>guix</code> build commands</a></h3>
<p>Depending on your system's RAM capacity, you may want to decrease the number of
threads used to decrease RAM usage or vice versa.</p>
<p>By default, the scripts under <code>./contrib/guix</code> will invoke all <code>guix</code> build
commands with <code>--cores="$JOBS"</code>. Note that <code>$JOBS</code> defaults to <code>$(nproc)</code> if not
specified. However, astute manual readers will also notice that <code>guix</code> build
commands also accept a <code>--max-jobs=</code> flag (which defaults to 1 if unspecified).</p>
<p>Here is the difference between <code>--cores=</code> and <code>--max-jobs=</code>:</p>
<blockquote>
<p>Note: When I say "derivation," think "package"</p>
</blockquote>
<p><code>--cores=</code></p>
<ul>
<li>controls the number of CPU cores to build each derivation. This is the value
passed to <code>make</code>'s <code>--jobs=</code> flag.</li>
</ul>
<p><code>--max-jobs=</code></p>
<ul>
<li>controls how many derivations can be built in parallel</li>
<li>defaults to 1</li>
</ul>
<p>Therefore, the default is for <code>guix</code> build commands to build one derivation at a
time, utilizing <code>$JOBS</code> threads.</p>
<p>Specifying the <code>$JOBS</code> environment variable will only modify <code>--cores=</code>, but you
can also modify the value for <code>--max-jobs=</code> by specifying
<code>$ADDITIONAL_GUIX_COMMON_FLAGS</code>. For example, if you have a LOT of memory, you
may want to set:</p>
<pre><code class="language-sh">export ADDITIONAL_GUIX_COMMON_FLAGS='--max-jobs=8'
</code></pre>
<p>Which allows for a maximum of 8 derivations to be built at the same time, each
utilizing <code>$JOBS</code> threads.</p>
<p>Or, if you'd like to avoid spurious build failures caused by issues with
parallelism within a single package, but would still like to build multiple
packages when the dependency graph allows for it, you may want to try:</p>
<pre><code class="language-sh">export JOBS=1 ADDITIONAL_GUIX_COMMON_FLAGS='--max-jobs=8'
</code></pre>
<p>See the <a href="contrib/guix/index.html#recognized-environment-variables">recognized environment variables</a> section for more
details.</p>
<h2 id="recognized-environment-variables"><a class="header" href="#recognized-environment-variables">Recognized environment variables</a></h2>
<ul>
<li>
<p><em><strong>HOSTS</strong></em></p>
<p>Override the space-separated list of platform triples for which to perform a
bootstrappable build.</p>
<p><em>(defaults to "x86_64-linux-gnu arm-linux-gnueabihf aarch64-linux-gnu
riscv64-linux-gnu powerpc64-linux-gnu powerpc64le-linux-gnu
x86_64-w64-mingw32 x86_64-apple-darwin arm64-apple-darwin")</em></p>
</li>
<li>
<p><em><strong>SOURCES_PATH</strong></em></p>
<p>Set the depends tree download cache for sources. This is passed through to the
depends tree. Setting this to the same directory across multiple builds of the
depends tree can eliminate unnecessary redownloading of package sources.</p>
<p>The path that this environment variable points to <strong>must be a directory</strong>, and
<strong>NOT a symlink to a directory</strong>.</p>
</li>
<li>
<p><em><strong>BASE_CACHE</strong></em></p>
<p>Set the depends tree cache for built packages. This is passed through to the
depends tree. Setting this to the same directory across multiple builds of the
depends tree can eliminate unnecessary building of packages.</p>
<p>The path that this environment variable points to <strong>must be a directory</strong>, and
<strong>NOT a symlink to a directory</strong>.</p>
</li>
<li>
<p><em><strong>SDK_PATH</strong></em></p>
<p>Set the path where <em>extracted</em> SDKs can be found. This is passed through to
the depends tree. Note that this is should be set to the <em>parent</em> directory of
the actual SDK (e.g. <code>SDK_PATH=$HOME/Downloads/macOS-SDKs</code> instead of
<code>$HOME/Downloads/macOS-SDKs/Xcode-12.2-12B45b-extracted-SDK-with-libcxx-headers</code>).</p>
<p>The path that this environment variable points to <strong>must be a directory</strong>, and
<strong>NOT a symlink to a directory</strong>.</p>
</li>
<li>
<p><em><strong>JOBS</strong></em></p>
<p>Override the number of jobs to run simultaneously, you might want to do so on
a memory-limited machine. This may be passed to:</p>
<ul>
<li><code>guix</code> build commands as in <code>guix shell --cores="$JOBS"</code></li>
<li><code>make</code> as in <code>make --jobs="$JOBS"</code></li>
<li><code>cmake</code> as in <code>cmake --build build -j "$JOBS"</code></li>
<li><code>xargs</code> as in <code>xargs -P"$JOBS"</code></li>
</ul>
<p>See <a href="contrib/guix/index.html#controlling-the-number-of-threads-used-by-guix-build-commands">here</a> for
more details.</p>
<p><em>(defaults to the value of <code>nproc</code> outside the container)</em></p>
</li>
<li>
<p><em><strong>SOURCE_DATE_EPOCH</strong></em></p>
<p>Override the reference UNIX timestamp used for bit-for-bit reproducibility,
the variable name conforms to <a href="https://reproducible-builds.org/docs/source-date-epoch/">standard</a>.</p>
<p><em>(defaults to the output of <code>$(git log --format=%at -1)</code>)</em></p>
</li>
<li>
<p><em><strong>V</strong></em></p>
<p>If non-empty, will pass <code>V=1</code> to all <code>make</code> invocations, making <code>make</code> output
verbose.</p>
<p>Note that any given value is ignored. The variable is only checked for
emptiness. More concretely, this means that <code>V=</code> (setting <code>V</code> to the empty
string) is interpreted the same way as not setting <code>V</code> at all, and that <code>V=0</code>
has the same effect as <code>V=1</code>.</p>
</li>
<li>
<p><em><strong>SUBSTITUTE_URLS</strong></em></p>
<p>A whitespace-delimited list of URLs from which to download pre-built packages.
A URL is only used if its signing key is authorized (refer to the <a href="contrib/guix/index.html#option-1-building-with-substitutes">substitute
servers section</a> for more details).</p>
</li>
<li>
<p><em><strong>ADDITIONAL_GUIX_COMMON_FLAGS</strong></em></p>
<p>Additional flags to be passed to all <code>guix</code> commands.</p>
</li>
<li>
<p><em><strong>ADDITIONAL_GUIX_TIMEMACHINE_FLAGS</strong></em></p>
<p>Additional flags to be passed to <code>guix time-machine</code>.</p>
</li>
<li>
<p><em><strong>ADDITIONAL_GUIX_ENVIRONMENT_FLAGS</strong></em></p>
<p>Additional flags to be passed to the invocation of <code>guix shell</code> inside
<code>guix time-machine</code>.</p>
</li>
</ul>
<h1 id="choosing-your-security-model"><a class="header" href="#choosing-your-security-model">Choosing your security model</a></h1>
<p>No matter how you installed Guix, you need to decide on your security model for
building packages with Guix.</p>
<p>Guix allows us to achieve better binary security by using our CPU time to build
everything from scratch. However, it doesn't sacrifice user choice in pursuit of
this: users can decide whether or not to use <strong>substitutes</strong> (pre-built
packages).</p>
<h2 id="option-1-building-with-substitutes"><a class="header" href="#option-1-building-with-substitutes">Option 1: Building with substitutes</a></h2>
<h3 id="step-1-authorize-the-signing-keys"><a class="header" href="#step-1-authorize-the-signing-keys">Step 1: Authorize the signing keys</a></h3>
<p>Depending on the installation procedure you followed, you may have already
authorized the Guix build farm key. In particular, the official shell installer
script asks you if you want the key installed, and the debian distribution
package authorized the key during installation.</p>
<p>You can check the current list of authorized keys at <code>/etc/guix/acl</code>.</p>
<p>At the time of writing, a <code>/etc/guix/acl</code> with just the Guix build farm key
authorized looks something like:</p>
<pre><code class="language-lisp">(acl
 (entry
  (public-key
   (ecc
    (curve Ed25519)
    (q #8D156F295D24B0D9A86FA5741A840FF2D24F60F7B6C4134814AD55625971B394#)
    )
   )
  (tag
   (guix import)
   )
  )
 )
</code></pre>
<p>If you've determined that the official Guix build farm key hasn't been
authorized, and you would like to authorize it, run the following as root:</p>
<pre><code>guix archive --authorize &lt; /var/guix/profiles/per-user/root/current-guix/share/guix/ci.guix.gnu.org.pub
</code></pre>
<p>If
<code>/var/guix/profiles/per-user/root/current-guix/share/guix/ci.guix.gnu.org.pub</code>
doesn't exist, try:</p>
<pre><code class="language-sh">guix archive --authorize &lt; &lt;PREFIX&gt;/share/guix/ci.guix.gnu.org.pub
</code></pre>
<p>Where <code>&lt;PREFIX&gt;</code> is likely:</p>
<ul>
<li><code>/usr</code> if you installed from a distribution package</li>
<li><code>/usr/local</code> if you installed Guix from source and didn't supply any
prefix-modifying flags to Guix's <code>./configure</code></li>
</ul>
<p>For dongcarl's substitute server at https://guix.carldong.io, run as root:</p>
<pre><code class="language-sh">wget -qO- 'https://guix.carldong.io/signing-key.pub' | guix archive --authorize
</code></pre>
<h4 id="removing-authorized-keys"><a class="header" href="#removing-authorized-keys">Removing authorized keys</a></h4>
<p>To remove previously authorized keys, simply edit <code>/etc/guix/acl</code> and remove the
<code>(entry (public-key ...))</code> entry.</p>
<h3 id="step-2-specify-the-substitute-servers"><a class="header" href="#step-2-specify-the-substitute-servers">Step 2: Specify the substitute servers</a></h3>
<p>Once its key is authorized, the official Guix build farm at
https://ci.guix.gnu.org is automatically used unless the <code>--no-substitutes</code> flag
is supplied. This default list of substitute servers is overridable both on a
<code>guix-daemon</code> level and when you invoke <code>guix</code> commands. See examples below for
the various ways of adding dongcarl's substitute server after having <a href="contrib/guix/index.html#step-1-authorize-the-signing-keys">authorized
his signing key</a>.</p>
<p>Change the <strong>default list</strong> of substitute servers by starting <code>guix-daemon</code> with
the <code>--substitute-urls</code> option (you will likely need to edit your init script):</p>
<pre><code class="language-sh">guix-daemon &lt;cmd&gt; --substitute-urls='https://guix.carldong.io https://ci.guix.gnu.org'
</code></pre>
<p>Override the default list of substitute servers by passing the
<code>--substitute-urls</code> option for invocations of <code>guix</code> commands:</p>
<pre><code class="language-sh">guix &lt;cmd&gt; --substitute-urls='https://guix.carldong.io https://ci.guix.gnu.org'
</code></pre>
<p>For scripts under <code>./contrib/guix</code>, set the <code>SUBSTITUTE_URLS</code> environment
variable:</p>
<pre><code class="language-sh">export SUBSTITUTE_URLS='https://guix.carldong.io https://ci.guix.gnu.org'
</code></pre>
<h2 id="option-2-disabling-substitutes-on-an-ad-hoc-basis"><a class="header" href="#option-2-disabling-substitutes-on-an-ad-hoc-basis">Option 2: Disabling substitutes on an ad-hoc basis</a></h2>
<p>If you prefer not to use any substitutes, make sure to supply <code>--no-substitutes</code>
like in the following snippet. The first build will take a while, but the
resulting packages will be cached for future builds.</p>
<p>For direct invocations of <code>guix</code>:</p>
<pre><code class="language-sh">guix &lt;cmd&gt; --no-substitutes
</code></pre>
<p>For the scripts under <code>./contrib/guix/</code>:</p>
<pre><code class="language-sh">export ADDITIONAL_GUIX_COMMON_FLAGS='--no-substitutes'
</code></pre>
<h2 id="option-3-disabling-substitutes-by-default"><a class="header" href="#option-3-disabling-substitutes-by-default">Option 3: Disabling substitutes by default</a></h2>
<p><code>guix-daemon</code> accepts a <code>--no-substitutes</code> flag, which will make sure that,
unless otherwise overridden by a command line invocation, no substitutes will be
used.</p>
<p>If you start <code>guix-daemon</code> using an init script, you can edit said script to
supply this flag.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="guix-installation-and-setup"><a class="header" href="#guix-installation-and-setup">Guix Installation and Setup</a></h1>
<p>This only needs to be done once per machine. If you have already completed the
installation and setup, please proceed to <a href="contrib/guix/./README.html">perform a build</a>.</p>
<p>Otherwise, you may choose from one of the following options to install Guix:</p>
<ol>
<li>Using the official <strong>shell installer script</strong> <a href="contrib/guix/INSTALL.html#options-1-and-2-using-the-official-shell-installer-script-or-binary-tarball">â¤“ skip to section</a>
<ul>
<li>Maintained by Guix developers</li>
<li>Easiest (automatically performs <em>most</em> setup)</li>
<li>Works on nearly all Linux distributions</li>
<li>Only installs latest release</li>
<li>Binary installation only, requires high level of trust</li>
<li>Note: The script needs to be run as root, so it should be inspected before it's run</li>
</ul>
</li>
<li>Using the official <strong>binary tarball</strong> <a href="contrib/guix/INSTALL.html#options-1-and-2-using-the-official-shell-installer-script-or-binary-tarball">â¤“ skip to section</a>
<ul>
<li>Maintained by Guix developers</li>
<li>Normal difficulty (full manual setup required)</li>
<li>Works on nearly all Linux distributions</li>
<li>Installs any release</li>
<li>Binary installation only, requires high level of trust</li>
</ul>
</li>
<li>Using fanquake's <strong>Docker image</strong> <a href="contrib/guix/INSTALL.html#option-3-using-fanquakes-docker-image">â†—ï¸Ž external instructions</a>
<ul>
<li>Maintained by fanquake</li>
<li>Easy (automatically performs <em>some</em> setup)</li>
<li>Works wherever Docker images work</li>
<li>Installs any release</li>
<li>Binary installation only, requires high level of trust</li>
</ul>
</li>
<li>Using a <strong>distribution-maintained package</strong> <a href="contrib/guix/INSTALL.html#option-4-using-a-distribution-maintained-package">â¤“ skip to section</a>
<ul>
<li>Maintained by distribution's Guix package maintainer</li>
<li>Normal difficulty (manual setup required)</li>
<li>Works only on distributions with Guix packaged, see: https://repology.org/project/guix/versions</li>
<li>Installs a release decided on by package maintainer</li>
<li>Source or binary installation depending on the distribution</li>
</ul>
</li>
<li>Building <strong>from source</strong> <a href="contrib/guix/INSTALL.html#option-5-building-from-source">â¤“ skip to section</a>
<ul>
<li>Maintained by you</li>
<li>Hard, but rewarding</li>
<li>Can be made to work on most Linux distributions</li>
<li>Installs any commit (more granular)</li>
<li>Source installation, requires lower level of trust</li>
</ul>
</li>
</ol>
<h2 id="options-1-and-2-using-the-official-shell-installer-script-or-binary-tarball"><a class="header" href="#options-1-and-2-using-the-official-shell-installer-script-or-binary-tarball">Options 1 and 2: Using the official shell installer script or binary tarball</a></h2>
<p>The installation instructions for both the official shell installer script and
the binary tarballs can be found in the GNU Guix Manual's <a href="https://guix.gnu.org/manual/en/html_node/Binary-Installation.html">Binary Installation
section</a>.</p>
<p>Note that running through the binary tarball installation steps is largely
equivalent to manually performing what the shell installer script does.</p>
<p>Note that at the time of writing (July 5th, 2021), the shell installer script
automatically creates an <code>/etc/profile.d</code> entry which the binary tarball
installation instructions do not ask you to create. However, you will likely
need this entry for better desktop integration. Please see <a href="contrib/guix/INSTALL.html#add-an-etcprofiled-entry">this
section</a> for instructions on how to add a
<code>/etc/profile.d/guix.sh</code> entry.</p>
<p>Regardless of which installation option you chose, the changes to
<code>/etc/profile.d</code> will not take effect until the next shell or desktop session,
so you should log out and log back in.</p>
<h2 id="option-3-using-fanquakes-docker-image"><a class="header" href="#option-3-using-fanquakes-docker-image">Option 3: Using fanquake's Docker image</a></h2>
<p>Please refer to fanquake's instructions
<a href="https://github.com/fanquake/core-review/tree/master/guix">here</a>.</p>
<h2 id="option-4-using-a-distribution-maintained-package"><a class="header" href="#option-4-using-a-distribution-maintained-package">Option 4: Using a distribution-maintained package</a></h2>
<p>Note that this section is based on the distro packaging situation at the time of
writing (July 2021). Guix is expected to be more widely packaged over time. For
an up-to-date view on Guix's package status/version across distros, please see:
https://repology.org/project/guix/versions</p>
<h3 id="debian--ubuntu"><a class="header" href="#debian--ubuntu">Debian / Ubuntu</a></h3>
<p>Guix is available as a distribution package in <a href="https://packages.debian.org/search?keywords=guix">Debian
</a> and <a href="https://packages.ubuntu.com/search?keywords=guix">Ubuntu
</a>.</p>
<p>To install:</p>
<pre><code class="language-sh">sudo apt install guix
</code></pre>
<h3 id="arch-linux"><a class="header" href="#arch-linux">Arch Linux</a></h3>
<p>Guix is available in the AUR as
<a href="https://aur.archlinux.org/packages/guix/"><code>guix</code></a>, please follow the
installation instructions in the Arch Linux Wiki (<a href="https://wiki.archlinux.org/index.php/Guix#AUR_Package_Installation">live
link</a>,
<a href="https://wiki.archlinux.org/index.php?title=Guix&amp;oldid=637559#AUR_Package_Installation">2021/03/30
permalink</a>)
to install Guix.</p>
<p>At the time of writing (2021/03/30), the <code>check</code> phase will fail if the path to
guix's build directory is longer than 36 characters due to an anachronistic
character limit on the shebang line. Since the <code>check</code> phase happens after the
<code>build</code> phase, which may take quite a long time, it is recommended that users
either:</p>
<ol>
<li>Skip the <code>check</code> phase
<ul>
<li>For <code>makepkg</code>: <code>makepkg --nocheck ...</code></li>
<li>For <code>yay</code>: <code>yay --mflags="--nocheck" ...</code></li>
<li>For <code>paru</code>: <code>paru --nocheck ...</code></li>
</ul>
</li>
<li>Or, check their build directory's length beforehand
<ul>
<li>For those building with <code>makepkg</code>: <code>pwd | wc -c</code></li>
</ul>
</li>
</ol>
<h2 id="option-5-building-from-source"><a class="header" href="#option-5-building-from-source">Option 5: Building from source</a></h2>
<p>Building Guix from source is a rather involved process but a rewarding one for
those looking to minimize trust and maximize customizability (e.g. building a
particular commit of Guix). Previous experience with using autotools-style build
systems to build packages from source will be helpful. <em>hic sunt dracones.</em></p>
<p>I strongly urge you to at least skim through the entire section once before you
start issuing commands, as it will save you a lot of unnecessary pain and
anguish.</p>
<h3 id="installing-common-build-tools"><a class="header" href="#installing-common-build-tools">Installing common build tools</a></h3>
<p>There are a few basic build tools that are required for most things we'll build,
so let's install them now:</p>
<p>Text transformation/i18n:</p>
<ul>
<li><code>autopoint</code> (sometimes packaged in <code>gettext</code>)</li>
<li><code>help2man</code></li>
<li><code>po4a</code></li>
<li><code>texinfo</code></li>
</ul>
<p>Build system tools:</p>
<ul>
<li><code>g++</code> w/ C++11 support</li>
<li><code>libtool</code></li>
<li><code>autoconf</code></li>
<li><code>automake</code></li>
<li><code>pkg-config</code> (sometimes packaged as <code>pkgconf</code>)</li>
<li><code>make</code></li>
<li><code>cmake</code></li>
</ul>
<p>Miscellaneous:</p>
<ul>
<li><code>git</code></li>
<li><code>gnupg</code></li>
<li><code>python3</code></li>
</ul>
<h3 id="building-and-installing-guixs-dependencies"><a class="header" href="#building-and-installing-guixs-dependencies">Building and Installing Guix's dependencies</a></h3>
<p>In order to build Guix itself from source, we need to first make sure that the
necessary dependencies are installed and discoverable. The most up-to-date list
of Guix's dependencies is kept in the <a href="https://guix.gnu.org/manual/en/html_node/Requirements.html">"Requirements"
section</a> of the Guix
Reference Manual.</p>
<p>Depending on your distribution, most or all of these dependencies may already be
packaged and installable without manually building and installing.</p>
<p>For reference, the graphic below outlines Guix v1.3.0's dependency graph:</p>
<p><img src="https://user-images.githubusercontent.com/6399679/125064185-a9a59880-e0b0-11eb-82c1-9b8e5dc9950d.png" alt="bootstrap map" /></p>
<p>If you do not care about building each dependency from source, and Guix is
already packaged for your distribution, you can easily install only the build
dependencies of Guix. For example, to enable deb-src and install the Guix build
dependencies on Ubuntu/Debian:</p>
<pre><code class="language-sh">sed -i 's|# deb-src|deb-src|g' /etc/apt/sources.list
apt update
apt-get build-dep -y guix
</code></pre>
<p>If this succeeded, you can likely skip to section
<a href="contrib/guix/INSTALL.html#building-and-installing-guix-itself">"Building and Installing Guix itself"</a>.</p>
<h4 id="guile"><a class="header" href="#guile">Guile</a></h4>
<h6 id="corner-case-multiple-versions-of-guile-on-one-system"><a class="header" href="#corner-case-multiple-versions-of-guile-on-one-system">Corner case: Multiple versions of Guile on one system</a></h6>
<p>It is recommended to only install the required version of Guile, so that build systems do
not get confused about which Guile to use.</p>
<p>However, if you insist on having more versions of Guile installed on
your system, then you need to <strong>consistently</strong> specify
<code>GUILE_EFFECTIVE_VERSION=3.0</code> to all
<code>./configure</code> invocations for Guix and its dependencies.</p>
<h5 id="installing-guile"><a class="header" href="#installing-guile">Installing Guile</a></h5>
<p>If your distribution splits packages into <code>-dev</code>-suffixed and
non-<code>-dev</code>-suffixed sub-packages (as is the case for Debian-derived
distributions), please make sure to install both. For example, to install Guile
v3.0 on Debian/Ubuntu:</p>
<pre><code class="language-sh">apt install guile-3.0 guile-3.0-dev
</code></pre>
<h4 id="mixing-distribution-packages-and-source-built-packages"><a class="header" href="#mixing-distribution-packages-and-source-built-packages">Mixing distribution packages and source-built packages</a></h4>
<p>At the time of writing, most distributions have <em>some</em> of Guix's dependencies
packaged, but not all. This means that you may want to install the distribution
package for some dependencies, and manually build-from-source for others.</p>
<p>Distribution packages usually install to <code>/usr</code>, which is different from the
default <code>./configure</code> prefix of source-built packages: <code>/usr/local</code>.</p>
<p>This means that if you mix-and-match distribution packages and source-built
packages and do not specify exactly <code>--prefix=/usr</code> to <code>./configure</code> for
source-built packages, you will need to augment the <code>GUILE_LOAD_PATH</code> and
<code>GUILE_LOAD_COMPILED_PATH</code> environment variables so that Guile will look
under the right prefix and find your source-built packages.</p>
<p>For example, if you are using Guile v3.0, and have Guile packages in the
<code>/usr/local</code> prefix, either add the following lines to your <code>.profile</code> or
<code>.bash_profile</code> so that the environment variable is properly set for all future
shell logins, or paste the lines into a POSIX-style shell to temporarily modify
the environment variables of your current shell session.</p>
<pre><code class="language-sh"># Help Guile v3.0.x find packages in /usr/local
export GUILE_LOAD_PATH="/usr/local/share/guile/site/3.0${GUILE_LOAD_PATH:+:}$GUILE_LOAD_PATH"
export GUILE_LOAD_COMPILED_PATH="/usr/local/lib/guile/3.0/site-ccache${GUILE_LOAD_COMPILED_PATH:+:}$GUILE_COMPILED_LOAD_PATH"
</code></pre>
<p>Note that these environment variables are used to check for packages during
<code>./configure</code>, so they should be set as soon as possible should you want to use
a prefix other than <code>/usr</code>.</p>
<h4 id="building-and-installing-source-built-packages"><a class="header" href="#building-and-installing-source-built-packages">Building and installing source-built packages</a></h4>
<p><em><strong>IMPORTANT</strong>: A few dependencies have non-obvious quirks/errata which are
documented in the sub-sections immediately below. Please read these sections
before proceeding to build and install these packages.</em></p>
<p>Although you should always refer to the README or INSTALL files for the most
accurate information, most of these dependencies use autoconf-style build
systems (check if there's a <code>configure.ac</code> file), and will likely do the right
thing with the following:</p>
<p>Clone the repository and check out the latest release:</p>
<pre><code class="language-sh">git clone &lt;git-repo-of-dependency&gt;/&lt;dependency&gt;.git
cd &lt;dependency&gt;
git tag -l  # check for the latest release
git checkout &lt;latest-release&gt;
</code></pre>
<p>For autoconf-based build systems (if <code>./autogen.sh</code> or <code>configure.ac</code> exists at
the root of the repository):</p>
<pre><code class="language-sh">./autogen.sh || autoreconf -vfi
./configure --prefix=&lt;prefix&gt;
make
sudo make install
</code></pre>
<p>For CMake-based build systems (if <code>CMakeLists.txt</code> exists at the root of the
repository):</p>
<pre><code class="language-sh">mkdir build &amp;&amp; cd build
cmake .. -DCMAKE_INSTALL_PREFIX=&lt;prefix&gt;
sudo cmake --build . --target install
</code></pre>
<p>If you choose not to specify exactly <code>--prefix=/usr</code> to <code>./configure</code>, please
make sure you've carefully read the [previous section] on mixing distribution
packages and source-built packages.</p>
<h5 id="binding-packages-require--dev-suffixed-packages"><a class="header" href="#binding-packages-require--dev-suffixed-packages">Binding packages require <code>-dev</code>-suffixed packages</a></h5>
<p>Relevant for:</p>
<ul>
<li>Everyone</li>
</ul>
<p>When building bindings, the <code>-dev</code>-suffixed version of the original package
needs to be installed. For example, building <code>Guile-zlib</code> on Debian-derived
distributions requires that <code>zlib1g-dev</code> is installed.</p>
<p>When using bindings, the <code>-dev</code>-suffixed version of the original package still
needs to be installed. This is particularly problematic when distribution
packages are mispackaged like <code>guile-sqlite3</code> is in Ubuntu Focal such that
installing <code>guile-sqlite3</code> does not automatically install <code>libsqlite3-dev</code> as a
dependency.</p>
<p>Below is a list of relevant Guile bindings and their corresponding <code>-dev</code>
packages in Debian at the time of writing.</p>
<div class="table-wrapper"><table><thead><tr><th>Guile binding package</th><th>-dev Debian package</th></tr></thead><tbody>
<tr><td>guile-gcrypt</td><td>libgcrypt-dev</td></tr>
<tr><td>guile-git</td><td>libgit2-dev</td></tr>
<tr><td>guile-gnutls</td><td>(none)</td></tr>
<tr><td>guile-json</td><td>(none)</td></tr>
<tr><td>guile-lzlib</td><td>liblz-dev</td></tr>
<tr><td>guile-ssh</td><td>libssh-dev</td></tr>
<tr><td>guile-sqlite3</td><td>libsqlite3-dev</td></tr>
<tr><td>guile-zlib</td><td>zlib1g-dev</td></tr>
</tbody></table>
</div>
<h5 id="guile-git-actually-depends-on-libgit2--11"><a class="header" href="#guile-git-actually-depends-on-libgit2--11"><code>guile-git</code> actually depends on <code>libgit2 &gt;= 1.1</code></a></h5>
<p>Relevant for:</p>
<ul>
<li>Those building <code>guile-git</code> from source against <code>libgit2 &lt; 1.1</code></li>
<li>Those installing <code>guile-git</code> from their distribution where <code>guile-git</code> is
built against <code>libgit2 &lt; 1.1</code></li>
</ul>
<p>As of v0.5.2, <code>guile-git</code> claims to only require <code>libgit2 &gt;= 0.28.0</code>, however,
it actually requires <code>libgit2 &gt;= 1.1</code>, otherwise, it will be confused by a
reference of <code>origin/keyring</code>: instead of interpreting the reference as "the
'keyring' branch of the 'origin' remote", the reference is interpreted as "the
branch literally named 'origin/keyring'"</p>
<p>This is especially notable because Ubuntu Focal packages <code>libgit2 v0.28.4</code>, and
<code>guile-git</code> is built against it.</p>
<p>Should you be in this situation, you need to build both <code>libgit2 v1.1.x</code> and
<code>guile-git</code> from source.</p>
<p>Source: https://logs.guix.gnu.org/guix/2020-11-12.log#232527</p>
<h3 id="building-and-installing-guix-itself"><a class="header" href="#building-and-installing-guix-itself">Building and Installing Guix itself</a></h3>
<p>Start by cloning Guix:</p>
<pre><code>git clone https://git.savannah.gnu.org/git/guix.git
cd guix
</code></pre>
<p>You will likely want to build the latest release.
At the time of writing (November 2023), the latest release was <code>v1.4.0</code>.</p>
<pre><code>git branch -a -l 'origin/version-*'  # check for the latest release
git checkout &lt;latest-release&gt;
</code></pre>
<p>Bootstrap the build system:</p>
<pre><code>./bootstrap
</code></pre>
<p>Configure with the recommended <code>--localstatedir</code> flag:</p>
<pre><code>./configure --localstatedir=/var
</code></pre>
<p>Note: If you intend to hack on Guix in the future, you will need to supply the
same <code>--localstatedir=</code> flag for all future Guix <code>./configure</code> invocations. See
the last paragraph of this
<a href="https://guix.gnu.org/manual/en/html_node/Requirements.html">section</a> for more
details.</p>
<p>Build Guix (this will take a while):</p>
<pre><code>make -j$(nproc)
</code></pre>
<p>Install Guix:</p>
<pre><code>sudo make install
</code></pre>
<h3 id="post-build-from-source-setup"><a class="header" href="#post-build-from-source-setup">Post-"build from source" Setup</a></h3>
<h4 id="creating-and-starting-a-guix-daemon-original-service-with-a-fixed-argv0"><a class="header" href="#creating-and-starting-a-guix-daemon-original-service-with-a-fixed-argv0">Creating and starting a <code>guix-daemon-original</code> service with a fixed <code>argv[0]</code></a></h4>
<p>At this point, guix will be installed to <code>${bindir}</code>, which is likely
<code>/usr/local/bin</code> if you did not override directory variables at
<code>./configure</code>-time. More information on standard Automake directory variables
can be found
<a href="https://www.gnu.org/software/automake/manual/html_node/Standard-Directory-Variables.html">here</a>.</p>
<p>However, the Guix init scripts and service configurations for Upstart, systemd,
SysV, and OpenRC are installed (in <code>${libdir}</code>) to launch
<code>${localstatedir}/guix/profiles/per-user/root/current-guix/bin/guix-daemon</code>,
which does not yet exist, and will only exist after <a href="contrib/guix/INSTALL.html#guix-pull-as-root"><code>root</code> performs their first
<code>guix pull</code></a>.</p>
<p>We need to create a <code>-original</code> version of these init scripts that's pointed to
the binaries we just built and <code>make install</code>'ed in <code>${bindir}</code> (normally,
<code>/usr/local/bin</code>).</p>
<p>Example for <code>systemd</code>, run as <code>root</code>:</p>
<pre><code class="language-sh"># Create guix-daemon-original.service by modifying guix-daemon.service
libdir=# set according to your PREFIX (default is /usr/local/lib)
bindir="$(dirname $(command -v guix-daemon))"
sed -E -e "s|/\S*/guix/profiles/per-user/root/current-guix/bin/guix-daemon|${bindir}/guix-daemon|" "${libdir}"/systemd/system/guix-daemon.service &gt; /etc/systemd/system/guix-daemon-original.service
chmod 664 /etc/systemd/system/guix-daemon-original.service

# Make systemd recognize the new service
systemctl daemon-reload

# Make sure that the non-working guix-daemon.service is stopped and disabled
systemctl stop guix-daemon
systemctl disable guix-daemon

# Make sure that the working guix-daemon-original.service is started and enabled
systemctl enable guix-daemon-original
systemctl start guix-daemon-original
</code></pre>
<h4 id="creating-guix-daemon-users--groups"><a class="header" href="#creating-guix-daemon-users--groups">Creating <code>guix-daemon</code> users / groups</a></h4>
<p>Please see the <a href="https://guix.gnu.org/manual/en/html_node/Build-Environment-Setup.html">relevant
section</a>
in the Guix Reference Manual for more details.</p>
<h2 id="optional-setup"><a class="header" href="#optional-setup">Optional setup</a></h2>
<p>At this point, you are set up to <a href="contrib/guix/./README.html#usage">use Guix to build Bitcoin
Core</a>. However, if you want to polish your setup a bit and
make it "what Guix intended", then read the next few subsections.</p>
<h3 id="add-an-etcprofiled-entry"><a class="header" href="#add-an-etcprofiled-entry">Add an <code>/etc/profile.d</code> entry</a></h3>
<p>This section definitely does not apply to you if you installed Guix using:</p>
<ol>
<li>The shell installer script</li>
<li>fanquake's Docker image</li>
<li>Debian's <code>guix</code> package</li>
</ol>
<h4 id="background"><a class="header" href="#background">Background</a></h4>
<p>Although Guix knows how to update itself and its packages, it does so in a
non-invasive way (it does not modify <code>/usr/local/bin/guix</code>).</p>
<p>Instead, it does the following:</p>
<ul>
<li>
<p>After a <code>guix pull</code>, it updates
<code>/var/guix/profiles/per-user/$USER/current-guix</code>, and creates a symlink
targeting this directory at <code>$HOME/.config/guix/current</code></p>
</li>
<li>
<p>After a <code>guix install</code>, it updates
<code>/var/guix/profiles/per-user/$USER/guix-profile</code>, and creates a symlink
targeting this directory at <code>$HOME/.guix-profile</code></p>
</li>
</ul>
<p>Therefore, in order for these operations to affect your shell/desktop sessions
(and for the principle of least astonishment to hold), their corresponding
directories have to be added to well-known environment variables like <code>$PATH</code>,
<code>$INFOPATH</code>, <code>$XDG_DATA_DIRS</code>, etc.</p>
<p>In other words, if <code>$HOME/.config/guix/current/bin</code> does not exist in your
<code>$PATH</code>, a <code>guix pull</code> will have no effect on what <code>guix</code> you are using. Same
goes for <code>$HOME/.guix-profile/bin</code>, <code>guix install</code>, and installed packages.</p>
<p>Helpfully, after a <code>guix pull</code> or <code>guix install</code>, a message will be printed like
so:</p>
<pre><code>hint: Consider setting the necessary environment variables by running:

     GUIX_PROFILE="$HOME/.guix-profile"
     . "$GUIX_PROFILE/etc/profile"

Alternately, see `guix package --search-paths -p "$HOME/.guix-profile"'.
</code></pre>
<p>However, this is somewhat tedious to do for both <code>guix pull</code> and <code>guix install</code>
for each user on the system that wants to properly use <code>guix</code>. I recommend that
you instead add an entry to <code>/etc/profile.d</code> instead. This is done by default
when installing the Debian package later than 1.2.0-4 and when using the shell
script installer.</p>
<h4 id="instructions-1"><a class="header" href="#instructions-1">Instructions</a></h4>
<p>Create <code>/etc/profile.d/guix.sh</code> with the following content:</p>
<pre><code class="language-sh"># _GUIX_PROFILE: `guix pull` profile
_GUIX_PROFILE="$HOME/.config/guix/current"
if [ -L $_GUIX_PROFILE ]; then
  export PATH="$_GUIX_PROFILE/bin${PATH:+:}$PATH"
  # Export INFOPATH so that the updated info pages can be found
  # and read by both /usr/bin/info and/or $GUIX_PROFILE/bin/info
  # When INFOPATH is unset, add a trailing colon so that Emacs
  # searches 'Info-default-directory-list'.
  export INFOPATH="$_GUIX_PROFILE/share/info:$INFOPATH"
fi

# GUIX_PROFILE: User's default profile
GUIX_PROFILE="$HOME/.guix-profile"
[ -L $GUIX_PROFILE ] || return
GUIX_LOCPATH="$GUIX_PROFILE/lib/locale"
export GUIX_PROFILE GUIX_LOCPATH

[ -f "$GUIX_PROFILE/etc/profile" ] &amp;&amp; . "$GUIX_PROFILE/etc/profile"

# set XDG_DATA_DIRS to include Guix installations
export XDG_DATA_DIRS="$GUIX_PROFILE/share:${XDG_DATA_DIRS:-/usr/local/share/:/usr/share/}"
</code></pre>
<p>Please note that this will not take effect until the next shell or desktop
session (log out and log back in).</p>
<h3 id="guix-pull-as-root"><a class="header" href="#guix-pull-as-root"><code>guix pull</code> as root</a></h3>
<p>Before you do this, you need to read the section on <a href="contrib/guix/./README.html#choosing-your-security-model">choosing your security
model</a> and adjust <code>guix</code> and <code>guix-daemon</code> flags according to
your choice, as invoking <code>guix pull</code> may pull substitutes from substitute
servers (which you may not want).</p>
<p>As mentioned in a previous section, Guix expects
<code>${localstatedir}/guix/profiles/per-user/root/current-guix</code> to be populated with
<code>root</code>'s Guix profile, <code>guix pull</code>-ed and built by some former version of Guix.
However, this is not the case when we build from source. Therefore, we need to
perform a <code>guix pull</code> as <code>root</code>:</p>
<pre><code class="language-sh">sudo --login guix pull --branch=version-&lt;latest-release-version&gt;
# or
sudo --login guix pull --commit=&lt;particular-commit&gt;
</code></pre>
<p><code>guix pull</code> is quite a long process (especially if you're using
<code>--no-substitutes</code>). If you encounter build problems, please refer to the
<a href="contrib/guix/INSTALL.html#troubleshooting">troubleshooting section</a>.</p>
<p>Note that running a bare <code>guix pull</code> with no commit or branch specified will
pull the latest commit on Guix's master branch, which is likely fine, but not
recommended.</p>
<p>If you installed Guix from source, you may get an error like the following:</p>
<pre><code class="language-sh">error: while creating symlink '/root/.config/guix/current' No such file or directory
</code></pre>
<p>To resolve this, simply:</p>
<pre><code>sudo mkdir -p /root/.config/guix
</code></pre>
<p>Then try the <code>guix pull</code> command again.</p>
<p>After the <code>guix pull</code> finishes successfully,
<code>${localstatedir}/guix/profiles/per-user/root/current-guix</code> should be populated.</p>
<h4 id="using-the-newly-pulled-guix-by-restarting-the-daemon"><a class="header" href="#using-the-newly-pulled-guix-by-restarting-the-daemon">Using the newly-pulled <code>guix</code> by restarting the daemon</a></h4>
<p>Depending on how you installed Guix, you should now make sure that your init
scripts and service configurations point to the newly-pulled <code>guix-daemon</code>.</p>
<h5 id="if-you-built-guix-from-source"><a class="header" href="#if-you-built-guix-from-source">If you built Guix from source</a></h5>
<p>If you followed the instructions for <a href="contrib/guix/INSTALL.html#creating-and-starting-a-guix-daemon-original-service-with-a-fixed-argv0">fixing argv[0]</a>, you can now
do the following:</p>
<pre><code class="language-sh">systemctl stop guix-daemon-original
systemctl disable guix-daemon-original

systemctl enable guix-daemon
systemctl start guix-daemon
</code></pre>
<p>Remember to set <code>--no-substitutes</code> in <code>$libdir/systemd/system/guix-daemon.service</code> and other customizations if you used them for <code>guix-daemon-original.service</code>.</p>
<h5 id="if-you-installed-guix-via-the-debianubuntu-distribution-packages"><a class="header" href="#if-you-installed-guix-via-the-debianubuntu-distribution-packages">If you installed Guix via the Debian/Ubuntu distribution packages</a></h5>
<p>You will need to create a <code>guix-daemon-latest</code> service which points to the new
<code>guix</code> rather than a pinned one.</p>
<pre><code class="language-sh"># Create guix-daemon-latest.service by modifying guix-daemon.service
sed -E -e "s|/usr/bin/guix-daemon|/var/guix/profiles/per-user/root/current-guix/bin/guix-daemon|" /etc/systemd/system/guix-daemon.service &gt; /lib/systemd/system/guix-daemon-latest.service
chmod 664 /lib/systemd/system/guix-daemon-latest.service

# Make systemd recognize the new service
systemctl daemon-reload

# Make sure that the old guix-daemon.service is stopped and disabled
systemctl stop guix-daemon
systemctl disable guix-daemon

# Make sure that the new guix-daemon-latest.service is started and enabled
systemctl enable guix-daemon-latest
systemctl start guix-daemon-latest
</code></pre>
<h5 id="if-you-installed-guix-via-lantw44s-arch-linux-aur-package"><a class="header" href="#if-you-installed-guix-via-lantw44s-arch-linux-aur-package">If you installed Guix via lantw44's Arch Linux AUR package</a></h5>
<p>At the time of writing (July 5th, 2021) the systemd unit for "updated Guix" is
<code>guix-daemon-latest.service</code>, therefore, you should do the following:</p>
<pre><code class="language-sh">systemctl stop guix-daemon
systemctl disable guix-daemon

systemctl enable guix-daemon-latest
systemctl start guix-daemon-latest
</code></pre>
<h5 id="otherwise"><a class="header" href="#otherwise">Otherwise...</a></h5>
<p>Simply do:</p>
<pre><code class="language-sh">systemctl restart guix-daemon
</code></pre>
<h3 id="checking-everything"><a class="header" href="#checking-everything">Checking everything</a></h3>
<p>If you followed all the steps above to make your Guix setup "prim and proper,"
you can check that you did everything properly by running through this
checklist.</p>
<ol>
<li>
<p><code>/etc/profile.d/guix.sh</code> should exist and be sourced at each shell login</p>
</li>
<li>
<p><code>guix describe</code> should not print <code>guix describe: error: failed to determine origin</code>, but rather something like:</p>
<pre><code>Generation 38   Feb 22 2021 16:39:31    (current)
  guix f350df4
    repository URL: https://git.savannah.gnu.org/git/guix.git
    branch: version-1.2.0
    commit: f350df405fbcd5b9e27e6b6aa500da7f101f41e7
</code></pre>
</li>
<li>
<p><code>guix-daemon</code> should be running from <code>${localstatedir}/guix/profiles/per-user/root/current-guix</code></p>
</li>
</ol>
<h1 id="troubleshooting"><a class="header" href="#troubleshooting">Troubleshooting</a></h1>
<h2 id="derivation-failed-to-build"><a class="header" href="#derivation-failed-to-build">Derivation failed to build</a></h2>
<p>When you see a build failure like below:</p>
<pre><code>building /gnu/store/...-foo-3.6.12.drv...
/ 'check' phasenote: keeping build directory `/tmp/guix-build-foo-3.6.12.drv-0'
builder for `/gnu/store/...-foo-3.6.12.drv' failed with exit code 1
build of /gnu/store/...-foo-3.6.12.drv failed
View build log at '/var/log/guix/drvs/../...-foo-3.6.12.drv.bz2'.
cannot build derivation `/gnu/store/...-qux-7.69.1.drv': 1 dependencies couldn't be built
cannot build derivation `/gnu/store/...-bar-3.16.5.drv': 1 dependencies couldn't be built
cannot build derivation `/gnu/store/...-baz-2.0.5.drv': 1 dependencies couldn't be built
guix time-machine: error: build of `/gnu/store/...-baz-2.0.5.drv' failed
</code></pre>
<p>It means that <code>guix</code> failed to build a package named <code>foo</code>, which was a
dependency of <code>qux</code>, <code>bar</code>, and <code>baz</code>. Importantly, note that the last "failed"
line is not necessarily the root cause, the first "failed" line is.</p>
<p>Most of the time, the build failure is due to a spurious test failure or the
package's build system/test suite breaking when running multi-threaded. To
rebuild <em>just</em> this derivation in a single-threaded fashion (please don't forget
to add other <code>guix</code> flags like <code>--no-substitutes</code> as appropriate):</p>
<pre><code class="language-sh">$ guix build --cores=1 /gnu/store/...-foo-3.6.12.drv
</code></pre>
<p>If the single-threaded rebuild did not succeed, you may need to dig deeper.
You may view <code>foo</code>'s build logs in <code>less</code> like so (please replace paths with the
path you see in the build failure output):</p>
<pre><code class="language-sh">$ bzcat /var/log/guix/drvs/../...-foo-3.6.12.drv.bz2 | less
</code></pre>
<p><code>foo</code>'s build directory is also preserved and available at
<code>/tmp/guix-build-foo-3.6.12.drv-0</code>. However, if you fail to build <code>foo</code> multiple
times, it may be <code>/tmp/...drv-1</code> or <code>/tmp/...drv-2</code>. Always consult the build
failure output for the most accurate, up-to-date information.</p>
<h3 id="python-minimal-errno-84-invalid-or-incomplete-multibyte-or-wide-character"><a class="header" href="#python-minimal-errno-84-invalid-or-incomplete-multibyte-or-wide-character">python(-minimal): [Errno 84] Invalid or incomplete multibyte or wide character</a></h3>
<p>This error occurs when your <code>$TMPDIR</code> (default: /tmp) exists on a filesystem
which rejects characters not present in the UTF-8 character code set. An example
is ZFS with the utf8only=on option set.</p>
<p>More information: https://github.com/python/cpython/issues/81765</p>
<h3 id="openssl-111l-and-openssl-111n"><a class="header" href="#openssl-111l-and-openssl-111n">openssl-1.1.1l and openssl-1.1.1n</a></h3>
<p>OpenSSL includes tests that will fail once some certificate has expired.
The workarounds from the GnuTLS section immediately below can be used.</p>
<p>For openssl-1.1.1l use 2022-05-01 as the date.</p>
<h3 id="gnutls-test-suite-fail-status-request-revoked"><a class="header" href="#gnutls-test-suite-fail-status-request-revoked">GnuTLS: test-suite FAIL: status-request-revoked</a></h3>
<p><em>The derivation is likely identified by: <code>/gnu/store/vhphki5sg9xkdhh2pbc8gi6vhpfzryf0-gnutls-3.6.12.drv</code></em></p>
<p>This unfortunate error is most common for non-substitute builders who installed
Guix v1.2.0. The problem stems from the fact that one of GnuTLS's tests uses a
hardcoded certificate which expired on 2020-10-24.</p>
<p>What's more unfortunate is that this GnuTLS derivation is somewhat special in
Guix's dependency graph and is not affected by the package transformation flags
like <code>--without-tests=</code>.</p>
<p>The easiest solution for those encountering this problem is to install a newer
version of Guix. However, there are ways to work around this issue:</p>
<h4 id="workaround-1-using-substitutes-for-this-single-derivation"><a class="header" href="#workaround-1-using-substitutes-for-this-single-derivation">Workaround 1: Using substitutes for this single derivation</a></h4>
<p>If you've authorized the official Guix build farm's key (more info
<a href="contrib/guix/./README.html#step-1-authorize-the-signing-keys">here</a>), then you can use
substitutes just for this single derivation by invoking the following:</p>
<pre><code class="language-sh">guix build --substitute-urls="https://ci.guix.gnu.org" /gnu/store/vhphki5sg9xkdhh2pbc8gi6vhpfzryf0-gnutls-3.6.12.drv
</code></pre>
<p>See <a href="contrib/guix/./README.html#removing-authorized-keys">this section</a> for instructions on how
to remove authorized keys if you don't want to keep the build farm's key
authorized.</p>
<h4 id="workaround-2-temporarily-setting-the-system-clock-back"><a class="header" href="#workaround-2-temporarily-setting-the-system-clock-back">Workaround 2: Temporarily setting the system clock back</a></h4>
<p>This workaround was described <a href="https://issues.guix.gnu.org/44559#5">here</a>.</p>
<p>Basically:</p>
<ol>
<li>Turn off NTP</li>
<li>Set system time to 2020-10-01</li>
<li>guix build --no-substitutes /gnu/store/vhphki5sg9xkdhh2pbc8gi6vhpfzryf0-gnutls-3.6.12.drv</li>
<li>Set system time back to accurate current time</li>
<li>Turn NTP back on</li>
</ol>
<p>For example,</p>
<pre><code class="language-sh">sudo timedatectl set-ntp no
sudo date --set "01 oct 2020 15:00:00"
guix build /gnu/store/vhphki5sg9xkdhh2pbc8gi6vhpfzryf0-gnutls-3.6.12.drv
sudo timedatectl set-ntp yes
</code></pre>
<h4 id="workaround-3-disable-the-tests-in-the-guix-source-code-for-this-single-derivation"><a class="header" href="#workaround-3-disable-the-tests-in-the-guix-source-code-for-this-single-derivation">Workaround 3: Disable the tests in the Guix source code for this single derivation</a></h4>
<p>If all of the above workarounds fail, you can also disable the <code>tests</code> phase of
the derivation via the <code>arguments</code> option, as described in the official
<a href="https://guix.gnu.org/manual/en/html_node/package-Reference.html"><code>package</code>
reference</a>.</p>
<p>For example, to disable the openssl-1.1 check phase:</p>
<pre><code class="language-diff">diff --git a/gnu/packages/tls.scm b/gnu/packages/tls.scm
index f1e844b..1077c4b 100644
--- a/gnu/packages/tls.scm
+++ b/gnu/packages/tls.scm
@@ -494,4 +494,5 @@ (define-public openssl-1.1
     (arguments
      `(#:parallel-tests? #f
+       #:tests? #f
        #:test-target "test"
</code></pre>
<h3 id="coreutils-fail-teststail-2inotify-dir-recreate"><a class="header" href="#coreutils-fail-teststail-2inotify-dir-recreate">coreutils: FAIL: tests/tail-2/inotify-dir-recreate</a></h3>
<p>The inotify-dir-create test fails on "remote" filesystems such as overlayfs
(Docker's default filesystem) due to the filesystem being mistakenly recognized
as non-remote.</p>
<p>A relatively easy workaround to this is to make sure that a somewhat traditional
filesystem is mounted at <code>/tmp</code> (where <code>guix-daemon</code> performs its builds). For
Docker users, this might mean <a href="https://docs.docker.com/storage/volumes/">using a volume</a>, <a href="https://docs.docker.com/storage/bind-mounts/">binding
mounting</a> from host, or (for those with enough RAM and swap)
<a href="https://docs.docker.com/storage/tmpfs/">mounting a tmpfs</a> using the <code>--tmpfs</code> flag.</p>
<p>Please see the following links for more details:</p>
<ul>
<li>An upstream coreutils bug has been filed: <a href="https://debbugs.gnu.org/cgi/bugreport.cgi?bug=47940">debbugs#47940</a></li>
<li>A Guix bug detailing the underlying problem has been filed: <a href="https://issues.guix.gnu.org/47935">guix-issues#47935</a>, <a href="https://issues.guix.gnu.org/49985#5">guix-issues#49985</a></li>
<li>A commit to skip this test in Guix has been merged into the core-updates branch:
<a href="https://git.savannah.gnu.org/cgit/guix.git/commit/?id=6ba1058df0c4ce5611c2367531ae5c3cdc729ab4">savannah/guix@6ba1058</a></li>
</ul>
<h1 id="purginguninstalling-guix"><a class="header" href="#purginguninstalling-guix">Purging/Uninstalling Guix</a></h1>
<p>In the extraordinarily rare case where you messed up your Guix installation in
an irreversible way, you may want to completely purge Guix from your system and
start over.</p>
<ol>
<li>
<p>Uninstall Guix itself according to the way you installed it (e.g. <code>sudo apt purge guix</code> for Ubuntu packaging, <code>sudo make uninstall</code> for a build from source).</p>
</li>
<li>
<p>Remove all build users and groups</p>
<p>You may check for relevant users and groups using:</p>
<pre><code>getent passwd | grep guix
getent group | grep guix
</code></pre>
<p>Then, you may remove users and groups using:</p>
<pre><code>sudo userdel &lt;user&gt;
sudo groupdel &lt;group&gt;
</code></pre>
</li>
<li>
<p>Remove all possible Guix-related directories</p>
<ul>
<li><code>/var/guix/</code></li>
<li><code>/var/log/guix/</code></li>
<li><code>/gnu/</code></li>
<li><code>/etc/guix/</code></li>
<li><code>/home/*/.config/guix/</code></li>
<li><code>/home/*/.cache/guix/</code></li>
<li><code>/home/*/.guix-profile/</code></li>
<li><code>/root/.config/guix/</code></li>
<li><code>/root/.cache/guix/</code></li>
<li><code>/root/.guix-profile/</code></li>
</ul>
</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><p>Sample configuration files for:</p>
<pre><code>systemd: bitcoind.service
Upstart: bitcoind.conf
OpenRC:  bitcoind.openrc
         bitcoind.openrcconf
CentOS:  bitcoind.init
macOS:   org.bitcoin.bitcoind.plist
</code></pre>
<p>have been made available to assist packagers in creating node packages here.</p>
<p>See <a href="contrib/init/../../doc/init.html">doc/init.md</a> for more information.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="linearize-1"><a class="header" href="#linearize-1">Linearize</a></h1>
<p>Construct a linear, no-fork, best version of the Bitcoin blockchain.</p>
<h2 id="step-1-download-hash-list"><a class="header" href="#step-1-download-hash-list">Step 1: Download hash list</a></h2>
<pre><code>$ ./linearize-hashes.py linearize.cfg &gt; hashlist.txt
</code></pre>
<p>Required configuration file settings for linearize-hashes:</p>
<ul>
<li>RPC: <code>datadir</code> (Required if <code>rpcuser</code> and <code>rpcpassword</code> are not specified)</li>
<li>RPC: <code>rpcuser</code>, <code>rpcpassword</code> (Required if <code>datadir</code> is not specified)</li>
</ul>
<p>Optional config file setting for linearize-hashes:</p>
<ul>
<li>RPC: <code>host</code>  (Default: <code>127.0.0.1</code>)</li>
<li>RPC: <code>port</code>  (Default: <code>8332</code>)</li>
<li>Blockchain: <code>min_height</code>, <code>max_height</code></li>
<li><code>rev_hash_bytes</code>: If true, the written block hash list will be
byte-reversed. (In other words, the hash returned by getblockhash will have its
bytes reversed.) False by default. Intended for generation of
standalone hash lists but safe to use with linearize-data.py, which will output
the same data no matter which byte format is chosen.</li>
</ul>
<p>The <code>linearize-hashes</code> script requires a connection, local or remote, to a
JSON-RPC server. Running <code>bitcoind</code> or <code>bitcoin-qt -server</code> will be sufficient.</p>
<h2 id="step-2-copy-local-block-data"><a class="header" href="#step-2-copy-local-block-data">Step 2: Copy local block data</a></h2>
<pre><code>$ ./linearize-data.py linearize.cfg
</code></pre>
<p>Required configuration file settings:</p>
<ul>
<li><code>output_file</code>: The file that will contain the final blockchain.
or</li>
<li><code>output</code>: Output directory for linearized <code>blocks/blkNNNNN.dat</code> output.</li>
</ul>
<p>Optional config file setting for linearize-data:</p>
<ul>
<li><code>debug_output</code>: Some printouts may not always be desired. If true, such output
will be printed.</li>
<li><code>file_timestamp</code>: Set each file's last-accessed and last-modified times,
respectively, to the current time and to the timestamp of the most recent block
written to the script's blockchain.</li>
<li><code>genesis</code>: The hash of the genesis block in the blockchain.</li>
<li><code>input</code>: bitcoind blocks/ directory containing blkNNNNN.dat</li>
<li><code>hashlist</code>: text file containing list of block hashes created by
linearize-hashes.py.</li>
<li><code>max_out_sz</code>: Maximum size for files created by the <code>output_file</code> option.
(Default: <code>1000*1000*1000 bytes</code>)</li>
<li><code>netmagic</code>: Network magic number.</li>
<li><code>out_of_order_cache_sz</code>: If out-of-order blocks are being read, the block can
be written to a cache so that the blockchain doesn't have to be sought again.
This option specifies the cache size. (Default: <code>100*1000*1000 bytes</code>)</li>
<li><code>rev_hash_bytes</code>: If true, the block hash list written by linearize-hashes.py
will be byte-reversed when read by linearize-data.py. See the linearize-hashes
entry for more information.</li>
<li><code>split_timestamp</code>: Split blockchain files when a new month is first seen, in
addition to reaching a maximum file size (<code>max_out_sz</code>).</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="macos-deployment"><a class="header" href="#macos-deployment">MacOS Deployment</a></h1>
<p>The <code>macdeployqtplus</code> script should not be run manually. Instead, after building as usual:</p>
<pre><code class="language-bash">make deploy
</code></pre>
<p>When complete, it will have produced <code>Bitcoin-Core.zip</code>.</p>
<h2 id="sdk-extraction"><a class="header" href="#sdk-extraction">SDK Extraction</a></h2>
<h3 id="step-1-obtaining-xcodeapp"><a class="header" href="#step-1-obtaining-xcodeapp">Step 1: Obtaining <code>Xcode.app</code></a></h3>
<p>A free Apple Developer Account is required to proceed.</p>
<p>Our macOS SDK can be extracted from
<a href="https://download.developer.apple.com/Developer_Tools/Xcode_15/Xcode_15.xip">Xcode_15.xip</a>.</p>
<p>Alternatively, after logging in to your account go to 'Downloads', then 'More'
and search for <a href="https://developer.apple.com/download/all/?q=Xcode%2015"><code>Xcode 15</code></a>.</p>
<p>An Apple ID and cookies enabled for the hostname are needed to download this.</p>
<p>The <code>sha256sum</code> of the downloaded XIP archive should be <code>4daaed2ef2253c9661779fa40bfff50655dc7ec45801aba5a39653e7bcdde48e</code>.</p>
<p>To extract the <code>.xip</code> on Linux:</p>
<pre><code class="language-bash"># Install/clone tools needed for extracting Xcode.app
apt install cpio
git clone https://github.com/bitcoin-core/apple-sdk-tools.git

# Unpack the .xip and place the resulting Xcode.app in your current
# working directory
python3 apple-sdk-tools/extract_xcode.py -f Xcode_15.xip | cpio -d -i
</code></pre>
<p>On macOS:</p>
<pre><code class="language-bash">xip -x Xcode_15.xip
</code></pre>
<h3 id="step-2-generating-the-sdk-tarball-from-xcodeapp"><a class="header" href="#step-2-generating-the-sdk-tarball-from-xcodeapp">Step 2: Generating the SDK tarball from <code>Xcode.app</code></a></h3>
<p>To generate the SDK, run the script <a href="contrib/macdeploy/./gen-sdk"><code>gen-sdk</code></a> with the
path to <code>Xcode.app</code> (extracted in the previous stage) as the first argument.</p>
<pre><code class="language-bash">./contrib/macdeploy/gen-sdk '/path/to/Xcode.app'
</code></pre>
<p>The generated archive should be: <code>Xcode-15.0-15A240d-extracted-SDK-with-libcxx-headers.tar.gz</code>.
The <code>sha256sum</code> should be <code>c0c2e7bb92c1fee0c4e9f3a485e4530786732d6c6dd9e9f418c282aa6892f55d</code>.</p>
<h2 id="deterministic-macos-app-notes"><a class="header" href="#deterministic-macos-app-notes">Deterministic macOS App Notes</a></h2>
<p>macOS Applications are created on Linux using a recent LLVM.</p>
<p>All builds must target an Apple SDK. These SDKs are free to download, but not redistributable.
See the SDK Extraction notes above for how to obtain it.</p>
<p>The Guix build process has been designed to avoid including the SDK's files in Guix's outputs.
All interim tarballs are fully deterministic and may be freely redistributed.</p>
<p>Using an Apple-blessed key to sign binaries is a requirement to produce (distributable) macOS
binaries. Because this private key cannot be shared, we'll have to be a bit creative in order
for the build process to remain somewhat deterministic. Here's how it works:</p>
<ul>
<li>Builders use Guix to create an unsigned release. This outputs an unsigned ZIP which
users may choose to bless, self-codesign, and run. It also outputs an unsigned app structure
in the form of a tarball.</li>
<li>The Apple keyholder uses this unsigned app to create a detached signature, using the
included script. Detached signatures are available from this <a href="https://github.com/bitcoin-core/bitcoin-detached-sigs">repository</a>.</li>
<li>Builders feed the unsigned app + detached signature back into Guix, which combines the
pieces into a deterministic ZIP.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><p>This Page Intentionally Left Blank</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="per-peer-message-capture"><a class="header" href="#per-peer-message-capture">Per-Peer Message Capture</a></h1>
<h2 id="purpose"><a class="header" href="#purpose">Purpose</a></h2>
<p>This feature allows for message capture on a per-peer basis.  It answers the simple question: "Can I see what messages my node is sending and receiving?"</p>
<h2 id="usage-and-functionality"><a class="header" href="#usage-and-functionality">Usage and Functionality</a></h2>
<ul>
<li>Run <code>bitcoind</code> with the <code>-capturemessages</code> option.</li>
<li>Look in the <code>message_capture</code> folder in your datadir.
<ul>
<li>Typically this will be <code>~/.bitcoin/message_capture</code>.</li>
<li>See that there are many folders inside, one for each peer names with its IP address and port.</li>
<li>Inside each peer's folder there are two <code>.dat</code> files: one is for received messages (<code>msgs_recv.dat</code>) and the other is for sent messages (<code>msgs_sent.dat</code>).</li>
</ul>
</li>
<li>Run <code>contrib/message-capture/message-capture-parser.py</code> with the proper arguments.
<ul>
<li>See the <code>-h</code> option for help.</li>
<li>To see all messages, both sent and received, for all peers use:
<pre><code>./contrib/message-capture/message-capture-parser.py -o out.json \
~/.bitcoin/message_capture/**/*.dat
</code></pre>
</li>
<li>Note:  The messages in the given <code>.dat</code> files will be interleaved in chronological order.  So, giving both received and sent <code>.dat</code> files (as above with <code>*.dat</code>) will result in all messages being interleaved in chronological order.</li>
<li>If an output file is not provided (i.e. the <code>-o</code> option is not used), then the output prints to <code>stdout</code>.</li>
</ul>
</li>
<li>View the resulting output.
<ul>
<li>The output file is <code>JSON</code> formatted.</li>
<li>Suggestion: use <code>jq</code> to view the output, with <code>jq . out.json</code></li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h3 id="qos-quality-of-service"><a class="header" href="#qos-quality-of-service">QoS (Quality of service)</a></h3>
<p>This is a Linux bash script that will set up tc to limit the outgoing bandwidth for connections to the Bitcoin network. It limits outbound TCP traffic with a source or destination port of 8333, but not if the destination IP is within a LAN.</p>
<p>This means one can have an always-on bitcoind instance running, and another local bitcoind/bitcoin-qt instance which connects to this node and receives blocks from it.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="seeds-1"><a class="header" href="#seeds-1">Seeds</a></h1>
<p>Utility to generate the seeds.txt list that is compiled into the client
(see <a href="contrib/seeds//src/chainparamsseeds.h">src/chainparamsseeds.h</a> and other utilities in <a href="contrib/seeds//contrib/seeds">contrib/seeds</a>).</p>
<p>Be sure to update <code>PATTERN_AGENT</code> in <code>makeseeds.py</code> to include the current version,
and remove old versions as necessary (at a minimum when SeedsServiceFlags()
changes its default return value, as those are the services which seeds are added
to addrman with).</p>
<p>The seeds compiled into the release are created from sipa's, achow101's and luke-jr's
DNS seed, virtu's crawler, and asmap community AS map data. Run the following commands
from the <code>/contrib/seeds</code> directory:</p>
<pre><code>curl https://bitcoin.sipa.be/seeds.txt.gz | gzip -dc &gt; seeds_main.txt
curl https://mainnet.achownodes.xyz/seeds.txt.gz | gzip -dc &gt;&gt; seeds_main.txt
curl https://21.ninja/seeds.txt.gz | gzip -dc &gt;&gt; seeds_main.txt
curl https://luke.dashjr.org/programs/bitcoin/files/charts/seeds.txt &gt;&gt; seeds_main.txt
curl https://testnet.achownodes.xyz/seeds.txt.gz | gzip -dc &gt; seeds_test.txt
curl https://raw.githubusercontent.com/asmap/asmap-data/main/latest_asmap.dat &gt; asmap-filled.dat
python3 makeseeds.py -a asmap-filled.dat -s seeds_main.txt &gt; nodes_main.txt
python3 makeseeds.py -a asmap-filled.dat -s seeds_test.txt &gt; nodes_test.txt
# TODO: Uncomment when a seeder publishes seeds.txt.gz for testnet4
# python3 makeseeds.py -a asmap-filled.dat -s seeds_testnet4.txt -m 30000 &gt; nodes_testnet4.txt
python3 generate-seeds.py . &gt; ../../src/chainparamsseeds.h
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="contents-1"><a class="header" href="#contents-1">Contents</a></h1>
<p>This directory contains tools related to Signet, both for running a Signet yourself and for using one.</p>
<h1 id="getcoinspy"><a class="header" href="#getcoinspy">getcoins.py</a></h1>
<p>A script to call a faucet to get Signet coins.</p>
<p>Syntax: <code>getcoins.py [-h|--help] [-c|--cmd=&lt;bitcoin-cli path&gt;] [-f|--faucet=&lt;faucet URL&gt;] [-a|--addr=&lt;signet bech32 address&gt;] [-p|--password=&lt;faucet password&gt;] [--] [&lt;bitcoin-cli args&gt;]</code></p>
<ul>
<li><code>--cmd</code> lets you customize the bitcoin-cli path. By default it will look for it in the PATH</li>
<li><code>--faucet</code> lets you specify which faucet to use; the faucet is assumed to be compatible with https://github.com/kallewoof/bitcoin-faucet</li>
<li><code>--addr</code> lets you specify a Signet address; by default, the address must be a bech32 address. This and <code>--cmd</code> above complement each other (i.e. you do not need <code>bitcoin-cli</code> if you use <code>--addr</code>)</li>
<li><code>--password</code> lets you specify a faucet password; this is handy if you are in a classroom and set up your own faucet for your students; (above faucet does not limit by IP when password is enabled)</li>
</ul>
<p>If using the default network, invoking the script with no arguments should be sufficient under normal
circumstances, but if multiple people are behind the same IP address, the faucet will by default only
accept one claim per day. See <code>--password</code> above.</p>
<h1 id="miner"><a class="header" href="#miner">miner</a></h1>
<p>You will first need to pick a difficulty target. Since signet chains are primarily protected by a signature rather than proof of work, there is no need to spend as much energy as possible mining, however you may wish to choose to spend more time than the absolute minimum. The calibrate subcommand can be used to pick a target appropriate for your hardware, eg:</p>
<pre><code>MINER="./contrib/signet/miner"
GRIND="./build/src/bitcoin-util grind"
$MINER calibrate --grind-cmd="$GRIND"
nbits=1e00f403 for 25s average mining time
</code></pre>
<p>It defaults to estimating an nbits value resulting in 25s average time to find a block, but the --seconds parameter can be used to pick a different target, or the --nbits parameter can be used to estimate how long it will take for a given difficulty.</p>
<p>To mine the first block in your custom chain, you can run:</p>
<pre><code>CLI="./build/src/bitcoin-cli -conf=mysignet.conf"
ADDR=$($CLI -signet getnewaddress)
NBITS=1e00f403
$MINER --cli="$CLI" generate --grind-cmd="$GRIND" --address="$ADDR" --nbits=$NBITS
</code></pre>
<p>This will mine a single block with a backdated timestamp designed to allow 100 blocks to be mined as quickly as possible, so that it is possible to do transactions.</p>
<p>Adding the --ongoing parameter will then cause the signet miner to create blocks indefinitely. It will pick the time between blocks so that difficulty is adjusted to match the provided --nbits value.</p>
<pre><code>$MINER --cli="$CLI" generate --grind-cmd="$GRIND" --address="$ADDR" --nbits=$NBITS --ongoing
</code></pre>
<h2 id="other-options"><a class="header" href="#other-options">Other options</a></h2>
<p>The --debug and --quiet options are available to control how noisy the signet miner's output is. Note that the --debug, --quiet and --cli parameters must all appear before the subcommand (generate, calibrate, etc) if used.</p>
<p>Instead of specifying --ongoing, you can specify --max-blocks=N to mine N blocks and stop.</p>
<p>The --set-block-time option is available to manually move timestamps forward or backward (subject to the rules that blocktime must be greater than mediantime, and dates can't be more than two hours in the future). It can only be used when mining a single block (ie, not when using --ongoing or --max-blocks greater than 1).</p>
<p>Instead of using a single address, a ranged descriptor may be provided via the --descriptor parameter, with the reward for the block at height H being sent to the H'th address generated from the descriptor.</p>
<p>Instead of calculating a specific nbits value, --min-nbits can be specified instead, in which case the minimum signet difficulty will be targeted. Signet's minimum difficulty corresponds to --nbits=1e0377ae.</p>
<p>By default, the signet miner mines blocks at fixed intervals with minimal variation. If you want blocks to appear more randomly, as they do in mainnet, specify the --poisson option.</p>
<p>Using the --multiminer parameter allows mining to be distributed amongst multiple miners. For example, if you have 3 miners and want to share blocks between them, specify --multiminer=1/3 on one, --multiminer=2/3 on another, and --multiminer=3/3 on the last one. If you want one to do 10% of blocks and two others to do 45% each, --multiminer=1-10/100 on the first, and --multiminer=11-55 and --multiminer=56-100 on the others. Note that which miner mines which block is determined by the previous block hash, so occasional runs of one miner doing many blocks in a row is to be expected.</p>
<p>When --multiminer is used, if a miner is down and does not mine a block within five minutes of when it is due, the other miners will automatically act as redundant backups ensuring the chain does not halt. The --backup-delay parameter can be used to change how long a given miner waits, allowing one to be the primary backup (after five minutes) and another to be the secondary backup (after six minutes, eg).</p>
<p>The --standby-delay parameter can be used to make a backup miner that only mines if a block doesn't arrive on time. This can be combined with --multiminer if desired. Setting --standby-delay also prevents the first block from being mined immediately.</p>
<h2 id="advanced-usage"><a class="header" href="#advanced-usage">Advanced usage</a></h2>
<p>The process generate follows internally is to get a block template, convert that into a PSBT, sign the PSBT, move the signature from the signed PSBT into the block template's coinbase, grind proof of work for the block, and then submit the block to the network.</p>
<p>These steps can instead be done explicitly:</p>
<pre><code>$CLI -signet getblocktemplate '{"rules": ["signet","segwit"]}' |
  $MINER --cli="$CLI" genpsbt --address="$ADDR" |
  $CLI -signet -stdin walletprocesspsbt |
  jq -r .psbt |
  $MINER --cli="$CLI" solvepsbt --grind-cmd="$GRIND" |
  $CLI -signet -stdin submitblock
</code></pre>
<p>This is intended to allow you to replace part of the pipeline for further experimentation (eg, to sign the block with a hardware wallet).</p>
<div style="break-before: page; page-break-before: always;"></div><h3 id="testgen-1"><a class="header" href="#testgen-1">TestGen</a></h3>
<p>Utilities to generate test vectors for the data-driven Bitcoin tests.</p>
<p>To use inside a scripted-diff (or just execute directly):</p>
<pre><code>./gen_key_io_test_vectors.py valid 70 &gt; ../../src/test/data/key_io_valid.json
./gen_key_io_test_vectors.py invalid 70 &gt; ../../src/test/data/key_io_invalid.json
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="example-scripts-for-user-space-statically-defined-tracing-usdt"><a class="header" href="#example-scripts-for-user-space-statically-defined-tracing-usdt">Example scripts for User-space, Statically Defined Tracing (USDT)</a></h1>
<p>This directory contains scripts showcasing User-space, Statically Defined
Tracing (USDT) support for Bitcoin Core on Linux using. For more information on
USDT support in Bitcoin Core see the <a href="contrib/tracing/../../doc/tracing.html">USDT documentation</a>.</p>
<p>Examples for the two main eBPF front-ends, <a href="https://github.com/iovisor/bpftrace">bpftrace</a> and
<a href="https://github.com/iovisor/bcc">BPF Compiler Collection (BCC)</a>, with support for USDT, are listed. BCC is used
for complex tools and daemons and <code>bpftrace</code> is preferred for one-liners and
shorter scripts.</p>
<p>To develop and run bpftrace and BCC scripts you need to install the
corresponding packages. See <a href="https://github.com/iovisor/bpftrace/blob/master/INSTALL.md">installing bpftrace</a> and <a href="https://github.com/iovisor/bcc/blob/master/INSTALL.md">installing BCC</a> for more
information. For development there exist a <a href="https://github.com/iovisor/bpftrace/blob/master/docs/reference_guide.md">bpftrace Reference Guide</a>, a
<a href="https://github.com/iovisor/bcc/blob/master/docs/reference_guide.md">BCC Reference Guide</a>, and a <a href="https://github.com/iovisor/bcc/blob/master/docs/tutorial_bcc_python_developer.md">bcc Python Developer Tutorial</a>.</p>
<h2 id="examples-1"><a class="header" href="#examples-1">Examples</a></h2>
<p>The bpftrace examples contain a relative path to the <code>bitcoind</code> binary. By
default, the scripts should be run from the repository-root and assume a
self-compiled <code>bitcoind</code> binary. The paths in the examples can be changed, for
example, to point to release builds if needed. See the
<a href="contrib/tracing/../../doc/tracing.html#listing-available-tracepoints">Bitcoin Core USDT documentation</a> on how to list available tracepoints in your
<code>bitcoind</code> binary.</p>
<p><strong>WARNING: eBPF programs require root privileges to be loaded into a Linux
kernel VM. This means the bpftrace and BCC examples must be executed with root
privileges. Make sure to carefully review any scripts that you run with root
privileges first!</strong></p>
<h3 id="log_p2p_trafficbt"><a class="header" href="#log_p2p_trafficbt">log_p2p_traffic.bt</a></h3>
<p>A bpftrace script logging information about inbound and outbound P2P network
messages. Based on the <code>net:inbound_message</code> and <code>net:outbound_message</code>
tracepoints.</p>
<p>By default, <code>bpftrace</code> limits strings to 64 bytes due to the limited stack size
in the eBPF VM. For example, Tor v3 addresses exceed the string size limit which
results in the port being cut off during logging. The string size limit can be
increased with the <code>BPFTRACE_STRLEN</code> environment variable (<code>BPFTRACE_STRLEN=70</code>
works fine).</p>
<pre><code>$ bpftrace contrib/tracing/log_p2p_traffic.bt
</code></pre>
<p>Output</p>
<pre><code>outbound 'ping' msg to peer 11 (outbound-full-relay, [2a02:b10c:f747:1:ef:fake:ipv6:addr]:8333) with 8 bytes
inbound 'pong' msg from peer 11 (outbound-full-relay, [2a02:b10c:f747:1:ef:fake:ipv6:addr]:8333) with 8 bytes
inbound 'inv' msg from peer 16 (outbound-full-relay, XX.XX.XXX.121:8333) with 37 bytes
outbound 'getdata' msg to peer 16 (outbound-full-relay, XX.XX.XXX.121:8333) with 37 bytes
inbound 'tx' msg from peer 16 (outbound-full-relay, XX.XX.XXX.121:8333) with 222 bytes
outbound 'inv' msg to peer 9 (outbound-full-relay, faketorv3addressa2ufa6odvoi3s77j4uegey0xb10csyfyve2t33curbyd.onion:8333) with 37 bytes
outbound 'inv' msg to peer 7 (outbound-full-relay, XX.XX.XXX.242:8333) with 37 bytes
â€¦
</code></pre>
<h3 id="p2p_monitorpy"><a class="header" href="#p2p_monitorpy">p2p_monitor.py</a></h3>
<p>A BCC Python script using curses for an interactive P2P message monitor. Based
on the <code>net:inbound_message</code> and <code>net:outbound_message</code> tracepoints.</p>
<p>Inbound and outbound traffic is listed for each peer together with information
about the connection. Peers can be selected individually to view recent P2P
messages.</p>
<pre><code>$ python3 contrib/tracing/p2p_monitor.py $(pidof bitcoind)
</code></pre>
<p>Lists selectable peers and traffic and connection information.</p>
<pre><code> P2P Message Monitor
 Navigate with UP/DOWN or J/K and select a peer with ENTER or SPACE to see individual P2P messages

 PEER  OUTBOUND              INBOUND               TYPE                   ADDR
    0  46          398 byte  61      1407590 byte  block-relay-only       XX.XX.XXX.196:8333
   11  1156     253570 byte  3431    2394924 byte  outbound-full-relay    XXX.X.XX.179:8333
   13  3425    1809620 byte  1236     305458 byte  inbound                XXX.X.X.X:60380
   16  1046     241633 byte  1589    1199220 byte  outbound-full-relay    4faketorv2pbfu7x.onion:8333
   19  577      181679 byte  390      148951 byte  outbound-full-relay    kfake4vctorjv2o2.onion:8333
   20  11         1248 byte  13         1283 byte  block-relay-only       [2600:fake:64d9:b10c:4436:aaaa:fe:bb]:8333
   21  11         1248 byte  13         1299 byte  block-relay-only       XX.XXX.X.155:8333
   22  5           103 byte  1           102 byte  feeler                 XX.XX.XXX.173:8333
   23  11         1248 byte  12         1255 byte  block-relay-only       XX.XXX.XXX.220:8333
   24  3           103 byte  1           102 byte  feeler                 XXX.XXX.XXX.64:8333
â€¦
</code></pre>
<p>Showing recent P2P messages between our node and a selected peer.</p>
<pre><code>    ----------------------------------------------------------------------
    |                PEER 16 (4faketorv2pbfu7x.onion:8333)               |
    | OUR NODE                outbound-full-relay                   PEER |
    |                                           &lt;--- sendcmpct (9 bytes) |
    | inv (37 byte) ---&gt;                                                 |
    |                                                &lt;--- ping (8 bytes) |
    | pong (8 byte) ---&gt;                                                 |
    | inv (37 byte) ---&gt;                                                 |
    |                                               &lt;--- addr (31 bytes) |
    | inv (37 byte) ---&gt;                                                 |
    |                                       &lt;--- getheaders (1029 bytes) |
    | headers (1 byte) ---&gt;                                              |
    |                                           &lt;--- feefilter (8 bytes) |
    |                                                &lt;--- pong (8 bytes) |
    |                                            &lt;--- headers (82 bytes) |
    |                                            &lt;--- addr (30003 bytes) |
    | inv (1261 byte) ---&gt;                                               |
    |                                 â€¦                                  |

</code></pre>
<h3 id="log_raw_p2p_msgspy"><a class="header" href="#log_raw_p2p_msgspy">log_raw_p2p_msgs.py</a></h3>
<p>A BCC Python script showcasing eBPF and USDT limitations when passing data
larger than about 32kb. Based on the <code>net:inbound_message</code> and
<code>net:outbound_message</code> tracepoints.</p>
<p>Bitcoin P2P messages can be larger than 32kb (e.g. <code>tx</code>, <code>block</code>, ...). The
eBPF VM's stack is limited to 512 bytes, and we can't allocate more than about
32kb for a P2P message in the eBPF VM. The <strong>message data is cut off</strong> when the
message is larger than MAX_MSG_DATA_LENGTH (see script). This can be detected
in user-space by comparing the data length to the message length variable. The
message is cut off when the data length is smaller than the message length.
A warning is included with the printed message data.</p>
<p>Data is submitted to user-space (i.e. to this script) via a ring buffer. The
throughput of the ring buffer is limited. Each p2p_message is about 32kb in
size. In- or outbound messages submitted to the ring buffer in rapid
succession fill the ring buffer faster than it can be read. Some messages are
lost. BCC prints: <code>Possibly lost 2 samples</code> on lost messages.</p>
<pre><code>$ python3 contrib/tracing/log_raw_p2p_msgs.py $(pidof bitcoind)
</code></pre>
<pre><code>Logging raw P2P messages.
Messages larger that about 32kb will be cut off!
Some messages might be lost!
 outbound msg 'inv' from peer 4 (outbound-full-relay, XX.XXX.XX.4:8333) with 253 bytes: 0705000000be2245c8f844c9f763748e1a7â€¦
â€¦
Warning: incomplete message (only 32568 out of 53552 bytes)! inbound msg 'tx' from peer 32 (outbound-full-relay, XX.XXX.XXX.43:8333) with 53552 bytes: 020000000001fd3c01939c85ad6756ed9fcâ€¦
â€¦
Possibly lost 2 samples
</code></pre>
<h3 id="connectblock_benchmarkbt"><a class="header" href="#connectblock_benchmarkbt">connectblock_benchmark.bt</a></h3>
<p>A <code>bpftrace</code> script to benchmark the <code>ConnectBlock()</code> function during, for
example, a blockchain re-index. Based on the <code>validation:block_connected</code> USDT
tracepoint.</p>
<p>The script takes three positional arguments. The first two arguments, the start,
and end height indicate between which blocks the benchmark should be run. The
third acts as a duration threshold in milliseconds. When the <code>ConnectBlock()</code>
function takes longer than the threshold, information about the block, is
printed. For more details, see the header comment in the script.</p>
<p>The following command can be used to benchmark, for example, <code>ConnectBlock()</code>
between height 20000 and 38000 on SigNet while logging all blocks that take
longer than 25ms to connect.</p>
<pre><code>$ bpftrace contrib/tracing/connectblock_benchmark.bt 20000 38000 25
</code></pre>
<p>In a different terminal, starting Bitcoin Core in SigNet mode and with
re-indexing enabled.</p>
<pre><code>$ ./build/src/bitcoind -signet -reindex
</code></pre>
<p>This produces the following output.</p>
<pre><code>Attaching 5 probes...
ConnectBlock Benchmark between height 20000 and 38000 inclusive
Logging blocks taking longer than 25 ms to connect.
Starting Connect Block Benchmark between height 20000 and 38000.
BENCH   39 blk/s     59 tx/s      59 inputs/s       20 sigops/s (height 20038)
Block 20492 (000000f555653bb05e2f3c6e79925e01a20dd57033f4dc7c354b46e34735d32b)    20 tx   2319 ins   2318 sigops  took   38 ms
BENCH 1840 blk/s   2117 tx/s    4478 inputs/s     2471 sigops/s (height 21879)
BENCH 1816 blk/s   4972 tx/s    4982 inputs/s      125 sigops/s (height 23695)
BENCH 2095 blk/s   2890 tx/s    2910 inputs/s      152 sigops/s (height 25790)
BENCH 1684 blk/s   3979 tx/s    4053 inputs/s      288 sigops/s (height 27474)
BENCH 1155 blk/s   3216 tx/s    3252 inputs/s      115 sigops/s (height 28629)
BENCH 1797 blk/s   2488 tx/s    2503 inputs/s      111 sigops/s (height 30426)
BENCH 1849 blk/s   6318 tx/s    6569 inputs/s    12189 sigops/s (height 32275)
BENCH  946 blk/s  20209 tx/s   20775 inputs/s    83809 sigops/s (height 33221)
Block 33406 (0000002adfe4a15cfcd53bd890a89bbae836e5bb7f38bac566f61ad4548c87f6)    25 tx   2045 ins   2090 sigops  took   29 ms
Block 33687 (00000073231307a9828e5607ceb8156b402efe56747271a4442e75eb5b77cd36)    52 tx   1797 ins   1826 sigops  took   26 ms
BENCH  582 blk/s  21581 tx/s   27673 inputs/s    60345 sigops/s (height 33803)
BENCH 1035 blk/s  19735 tx/s   19776 inputs/s    51355 sigops/s (height 34838)
Block 35625 (0000006b00b347390c4768ea9df2655e9ff4b120f29d78594a2a702f8a02c997)    20 tx   3374 ins   3371 sigops  took   49 ms
BENCH  887 blk/s  17857 tx/s   22191 inputs/s    24404 sigops/s (height 35725)
Block 35937 (000000d816d13d6e39b471cd4368db60463a764ba1f29168606b04a22b81ea57)    75 tx   3943 ins   3940 sigops  took   61 ms
BENCH  823 blk/s  16298 tx/s   21031 inputs/s    18440 sigops/s (height 36548)
Block 36583 (000000c3e260556dbf42968aae3f904dba8b8c1ff96a6f6e3aa5365d2e3ad317)    24 tx   2198 ins   2194 sigops  took   34 ms
Block 36700 (000000b3b173de9e65a3cfa738d976af6347aaf83fa17ab3f2a4d2ede3ddfac4)    73 tx   1615 ins   1611 sigops  took   31 ms
Block 36832 (0000007859578c02c1ac37dabd1b9ec19b98f350b56935f5dd3a41e9f79f836e)    34 tx   1440 ins   1436 sigops  took   26 ms
BENCH  613 blk/s  16718 tx/s   25074 inputs/s    23022 sigops/s (height 37161)
Block 37870 (000000f5c1086291ba2d943fb0c3bc82e71c5ee341ee117681d1456fbf6c6c38)    25 tx   1517 ins   1514 sigops  took   29 ms
BENCH  811 blk/s  16031 tx/s   20921 inputs/s    18696 sigops/s (height 37972)

Took 14055 ms to connect the blocks between height 20000 and 38000.

Histogram of block connection times in milliseconds (ms).
@durations:
[0]                16838 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|
[1]                  882 |@@                                                  |
[2, 4)               236 |                                                    |
[4, 8)                23 |                                                    |
[8, 16)                9 |                                                    |
[16, 32)               9 |                                                    |
[32, 64)               4 |                                                    |
</code></pre>
<h3 id="log_utxocache_flushpy"><a class="header" href="#log_utxocache_flushpy">log_utxocache_flush.py</a></h3>
<p>A BCC Python script to log the UTXO cache flushes. Based on the
<code>utxocache:flush</code> tracepoint.</p>
<pre><code class="language-bash">$ python3 contrib/tracing/log_utxocache_flush.py $(pidof bitcoind)
</code></pre>
<pre><code>Logging utxocache flushes. Ctrl-C to end...
Duration (Âµs)   Mode       Coins Count     Memory Usage    Prune
730451          IF_NEEDED  22990           3323.54 kB      True
637657          ALWAYS     122320          17124.80 kB     False
81349           ALWAYS     0               1383.49 kB      False
</code></pre>
<h3 id="log_utxosbt"><a class="header" href="#log_utxosbt">log_utxos.bt</a></h3>
<p>A <code>bpftrace</code> script to log information about the coins that are added, spent, or
uncached from the UTXO set. Based on the <code>utxocache:add</code>, <code>utxocache:spend</code> and
<code>utxocache:uncache</code> tracepoints.</p>
<pre><code class="language-bash">$ bpftrace contrib/tracing/log_utxos.bt
</code></pre>
<p>This should produce an output similar to the following. If you see bpftrace
warnings like <code>Lost 24 events</code>, the eBPF perf ring-buffer is filled faster
than it is being read. You can increase the ring-buffer size by setting the
ENV variable <code>BPFTRACE_PERF_RB_PAGES</code> (default 64) at a cost of higher
memory usage. See the <a href="https://github.com/iovisor/bpftrace/blob/master/docs/reference_guide.md">bpftrace reference guide</a> for more information.</p>
<pre><code class="language-bash">Attaching 4 probes...
OP      Outpoint                                                                           Value  Height Coinbase
Added   6ba9ad857e1ef2eb2a2c94f06813c414c7ab273e3d6bd7ad64e000315a887e7c:1                 10000 2094512 No
Spent   fa7dc4db56637a151f6649d8f26732956d1c5424c82aae400a83d02b2cc2c87b:0             182264897 2094512 No
Added   eeb2f099b1af6a2a12e6ddd2eeb16fc5968582241d7f08ba202d28b60ac264c7:0                 10000 2094512 No
Added   eeb2f099b1af6a2a12e6ddd2eeb16fc5968582241d7f08ba202d28b60ac264c7:1             182254756 2094512 No
Added   a0c7f4ec9cccef2d89672a624a4e6c8237a17572efdd4679eea9e9ee70d2db04:0              10072679 2094513 Yes
Spent   25e0df5cc1aeb1b78e6056bf403e5e8b7e41f138060ca0a50a50134df0549a5e:2                   540 2094508 No
Spent   42f383c04e09c26a2378272ec33aa0c1bf4883ca5ab739e8b7e06be5a5787d61:1               3848399 2007724 No
Added   f85e3b4b89270863a389395cc9a4123e417ab19384cef96533c6649abd6b0561:0               3788399 2094513 No
Added   f85e3b4b89270863a389395cc9a4123e417ab19384cef96533c6649abd6b0561:2                   540 2094513 No
Spent   a05880b8c77971ed0b9f73062c7c4cdb0ff3856ab14cbf8bc481ed571cd34b83:1            5591281046 2094511 No
Added   eb689865f7d957938978d6207918748f74e6aa074f47874724327089445b0960:0            5589696005 2094513 No
Added   eb689865f7d957938978d6207918748f74e6aa074f47874724327089445b0960:1               1565556 2094513 No
</code></pre>
<h3 id="mempool_monitorpy"><a class="header" href="#mempool_monitorpy">mempool_monitor.py</a></h3>
<p>A BCC Python script producing mempool statistics and an event log. Based on the
<code>mempool:added</code>, <code>mempool:removed</code>, <code>mempool:replaced</code>, and <code>mempool:rejected</code>
tracepoints.</p>
<p>Statistics include incidence and rate for each event type since the script was
started (<code>total</code>) as well as during the last minute (<code>1 min</code>) and ten minutes
(<code>10 min</code>). The event log shows mempool events in real time, each entry
comprising a timestamp along with all event data available via the event's
tracepoint.</p>
<pre><code class="language-console">$ python3 contrib/tracing/mempool_monitor.py $(pidof bitcoind)
</code></pre>
<pre><code> Mempool Monitor
 Press CTRL-C to stop.

 â”Œâ”€Event countâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€Event rateâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ Event       total   1 min  10 min â”‚  â”‚ Event       total    1 min   10 min â”‚
 â”‚ added      1425tx   201tx  1425tx â”‚  â”‚ added     4.7tx/s  3.4tx/s  4.7tx/s â”‚
 â”‚ removed      35tx     4tx    35tx â”‚  â”‚ removed   0.1tx/s  0.1tx/s  0.1tx/s â”‚
 â”‚ replaced     35tx     4tx    35tx â”‚  â”‚ replaced  0.1tx/s  0.1tx/s  0.1tx/s â”‚
 â”‚ rejected      0tx     0tx     0tx â”‚  â”‚ rejected  0.0tx/s  0.0tx/s  0.0tx/s â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

 â”Œâ”€Event logâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ 13:10:30Z added f9064ca5bfc87cdd191faa42bf697217cd920b2b94838c1f1192e4f06c4fd217 with feerate 8.92 sat/vB (981 sat, 110 vbytes)                                              â”‚
 â”‚ 13:10:30Z added 53ffa3afbe57b1bfe423e1755ca2b52c5b6cb4aa91b8b7ee9cb694953f47f234 with feerate 5.00 sat/vB (550 sat, 110 vbytes)                                              â”‚
 â”‚ 13:10:30Z added 4177df5e19465eb5e53c3f8b6830a293f57474921bc6c2ae89375e0986e1f0f9 with feerate 2.98 sat/vB (429 sat, 144 vbytes)                                              â”‚
 â”‚ 13:10:30Z added 931a10d83f0a268768da75dc4b9e199f2f055f12979ae5491cc304ee10f890ea with feerate 3.55 sat/vB (500 sat, 141 vbytes)                                              â”‚
 â”‚ 13:10:30Z added 4cf32b295723cc4ab73f2a2e51d4bb276c0042760a4c00a3eb9595b8ebb24721 with feerate 89.21 sat/vB (12668 sat, 142 vbytes)                                           â”‚
 â”‚ 13:10:31Z replaced d1eecf9d662121322f4f31f0c2267a752d14bb3956e6016ba96e87f47890e1db with feerate 27.12 sat/vB received 23.3 seconds ago (7213 sat, 266 vbytes) with c412db908â”‚
 â”‚ 9b7ed53f3e5e36d2819dd291278b59ccaabaeb17fd37c3d87fdcd57 with feerate 28.12 sat/vB (8351 sat, 297 vbytes)                                                                     â”‚
 â”‚ 13:10:31Z added c412db9089b7ed53f3e5e36d2819dd291278b59ccaabaeb17fd37c3d87fdcd57 with feerate 28.12 sat/vB (8351 sat, 297 vbytes)                                            â”‚
 â”‚ 13:10:31Z added b8388a5bdc421b11460bdf477d5a85a1a39c2784e7dd7bffabe688740424ea57 with feerate 25.21 sat/vB (3554 sat, 141 vbytes)                                            â”‚
 â”‚ 13:10:31Z added 4ddb88bc90a122cd9eae8a664e73bdf5bebe75f3ef901241b4a251245854a98e with feerate 24.15 sat/vB (5072 sat, 210 vbytes)                                            â”‚
 â”‚ 13:10:31Z added 19101e4161bca5271ad5d03e7747f2faec7793b274dc2f3c4cf516b7cef1aac3 with feerate 7.06 sat/vB (1080 sat, 153 vbytes)                                             â”‚
 â”‚ 13:10:31Z removed d1eecf9d662121322f4f31f0c2267a752d14bb3956e6016ba96e87f47890e1db with feerate 27.12 sat/vB (7213 sat, 266 vbytes): replaced                                â”‚
 â”‚ 13:10:31Z added 6c511c60d9b95b9eff81df6ecba5c86780f513fe62ce3ad6be2c5340d957025a with feerate 4.00 sat/vB (440 sat, 110 vbytes)                                              â”‚
 â”‚ 13:10:31Z added 44d66f7f004bd52c46be4dff3067cab700e51c7866a84282bd8aab560a5bfb79 with feerate 3.15 sat/vB (448 sat, 142 vbytes)                                              â”‚
 â”‚ 13:10:31Z added b17b7c9ec5acfbbf12f0eeef8e29826fad3105bb95eef7a47d2f1f22b4784643 with feerate 4.10 sat/vB (1348 sat, 329 vbytes)                                             â”‚
 â”‚ 13:10:31Z added b7a4ad93554e57454e8a8049bfc0bd803fa962bd3f0a08926aa72e7cb23e2276 with feerate 1.01 sat/vB (205 sat, 202 vbytes)                                              â”‚
 â”‚ 13:10:32Z added c78e87be86c828137a6e7e00a177c03b52202ce4c39029b99904c2a094b9da87 with feerate 11.00 sat/vB (1562 sat, 142 vbytes)                                            â”‚
 â”‚                                                                                                                                                                              â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h3 id="verify-binaries-1"><a class="header" href="#verify-binaries-1">Verify Binaries</a></h3>
<h4 id="preparation"><a class="header" href="#preparation">Preparation</a></h4>
<p>As of Bitcoin Core v22.0, releases are signed by a number of public keys on the basis
of the <a href="https://github.com/bitcoin-core/guix.sigs/">guix.sigs repository</a>. When
verifying binary downloads, you (the end user) decide which of these public keys you
trust and then use that trust model to evaluate the signature on a file that contains
hashes of the release binaries. The downloaded binaries are then hashed and compared to
the signed checksum file.</p>
<p>First, you have to figure out which public keys to recognize. Browse the <a href="https://github.com/bitcoin-core/guix.sigs/tree/main/builder-keys">list of frequent
builder-keys</a> and
decide which of these keys you would like to trust. For each key you want to trust, you
must obtain that key for your local GPG installation.</p>
<p>You can obtain these keys by</p>
<ul>
<li>through a browser using a key server (e.g. keyserver.ubuntu.com),</li>
<li>manually using the <code>gpg --keyserver &lt;url&gt; --recv-keys &lt;key&gt;</code> command, or</li>
<li>you can run the packaged <code>verify.py --import-keys ...</code> script to
have it automatically retrieve unrecognized keys.</li>
</ul>
<h4 id="usage-2"><a class="header" href="#usage-2">Usage</a></h4>
<p>This script attempts to download the checksum file (<code>SHA256SUMS</code>) and corresponding
signature file <code>SHA256SUMS.asc</code> from https://bitcoincore.org and https://bitcoin.org.</p>
<p>It first checks if the checksum file is valid based upon a plurality of signatures, and
then downloads the release files specified in the checksum file, and checks if the
hashes of the release files are as expected.</p>
<p>If we encounter pubkeys in the signature file that we do not recognize, the script
can prompt the user as to whether they'd like to download the pubkeys. To enable
this behavior, use the <code>--import-keys</code> flag.</p>
<p>The script returns 0 if everything passes the checks. It returns 1 if either the
signature check or the hash check doesn't pass. An exit code of &gt;2 indicates an error.</p>
<p>See the <code>Config</code> object for various options.</p>
<h4 id="examples-2"><a class="header" href="#examples-2">Examples</a></h4>
<p>Validate releases with default settings:</p>
<pre><code class="language-sh">./contrib/verify-binaries/verify.py pub 22.0
./contrib/verify-binaries/verify.py pub 22.0-rc3
</code></pre>
<p>Get JSON output and don't prompt for user input (no auto key import):</p>
<pre><code class="language-sh">./contrib/verify-binaries/verify.py --json pub 22.0-x86
./contrib/verify-binaries/verify.py --json pub 23.0-rc5-linux-gnu
</code></pre>
<p>Rely only on local GPG state and manually specified keys, while requiring a
threshold of at least 10 trusted signatures:</p>
<pre><code class="language-sh">./contrib/verify-binaries/verify.py \
    --trusted-keys 74E2DEF5D77260B98BC19438099BAD163C70FBFA,9D3CC86A72F8494342EA5FD10A41BDC3F4FAFF1C \
    --min-good-sigs 10 pub 22.0-linux
</code></pre>
<p>If you only want to download the binaries for a certain architecture and/or platform, add the corresponding suffix, e.g.:</p>
<pre><code class="language-sh">./contrib/verify-binaries/verify.py pub 25.2-x86_64-linux
./contrib/verify-binaries/verify.py pub 24.1-rc1-darwin
./contrib/verify-binaries/verify.py pub 27.0-win64-setup.exe
</code></pre>
<p>If you do not want to keep the downloaded binaries, specify the cleanup option.</p>
<pre><code class="language-sh">./contrib/verify-binaries/verify.py pub --cleanup 22.0
</code></pre>
<p>Use the bin subcommand to verify all files listed in a local checksum file</p>
<pre><code class="language-sh">./contrib/verify-binaries/verify.py bin SHA256SUMS
</code></pre>
<p>Verify only a subset of the files listed in a local checksum file</p>
<pre><code class="language-sh">./contrib/verify-binaries/verify.py bin ~/Downloads/SHA256SUMS \
    ~/Downloads/bitcoin-24.0.1-x86_64-linux-gnu.tar.gz \
    ~/Downloads/bitcoin-24.0.1-arm-linux-gnueabihf.tar.gz
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="tooling-for-verification-of-pgp-signed-commits"><a class="header" href="#tooling-for-verification-of-pgp-signed-commits">Tooling for verification of PGP signed commits</a></h2>
<p>This is an incomplete work in progress, but currently includes a pre-push hook
script (<code>pre-push-hook.sh</code>) for maintainers to ensure that their own commits
are PGP signed (nearly always merge commits), as well as a Python 3 script to verify
commits against a trusted keys list.</p>
<h2 id="using-verify-commitspy-safely"><a class="header" href="#using-verify-commitspy-safely">Using verify-commits.py safely</a></h2>
<p>Remember that you can't use an untrusted script to verify itself. This means
that checking out code, then running <code>verify-commits.py</code> against <code>HEAD</code> is
<em>not</em> safe, because the version of <code>verify-commits.py</code> that you just ran could
be backdoored. Instead, you need to use a trusted version of verify-commits
prior to checkout to make sure you're checking out only code signed by trusted
keys:</p>
<pre><code class="language-sh">git fetch origin &amp;&amp; \
./contrib/verify-commits/verify-commits.py origin/master &amp;&amp; \
git checkout origin/master
</code></pre>
<p>Note that the above isn't a good UI/UX yet, and needs significant improvements
to make it more convenient and reduce the chance of errors; pull-reqs
improving this process would be much appreciated.</p>
<p>Unless <code>--clean-merge 0</code> is specified, <code>verify-commits.py</code> will attempt to verify that
each merge commit applies cleanly (with some exceptions). This requires using at least
git v2.38.0.</p>
<h2 id="configuration-files"><a class="header" href="#configuration-files">Configuration files</a></h2>
<ul>
<li><code>trusted-git-root</code>: This file should contain a single git commit hash which is the first unsigned git commit (hence it is the "root of trust").</li>
<li><code>trusted-sha512-root-commit</code>: This file should contain a single git commit hash which is the first commit without a SHA512 root commitment.</li>
<li><code>trusted-keys</code>: This file should contain a \n-delimited list of all PGP fingerprints of authorized commit signers (primary, not subkeys).</li>
<li><code>allow-revsig-commits</code>: This file should contain a \n-delimited list of git commit hashes. See next section for more info.</li>
</ul>
<h2 id="import-trusted-keys"><a class="header" href="#import-trusted-keys">Import trusted keys</a></h2>
<p>In order to check the commit signatures, you must add the trusted PGP keys to your machine. <a href="https://gnupg.org/">GnuPG</a> may be used to import the trusted keys by running the following command:</p>
<pre><code class="language-sh">gpg --keyserver hkps://keys.openpgp.org --recv-keys $(&lt;contrib/verify-commits/trusted-keys)
</code></pre>
<h2 id="key-expiryrevocation"><a class="header" href="#key-expiryrevocation">Key expiry/revocation</a></h2>
<p>When a key (or subkey) which has signed old commits expires or is revoked,
verify-commits will start failing to verify all commits which were signed by
said key. In order to avoid bumping the root-of-trust <code>trusted-git-root</code>
file, individual commits which were signed by such a key can be added to the
<code>allow-revsig-commits</code> file. That way, the PGP signatures are still verified
but no new commits can be signed by any expired/revoked key. To easily build a
list of commits which need to be added, verify-commits.py can be edited to test
each commit with BITCOIN_VERIFY_COMMITS_ALLOW_REVSIG set to both 1 and 0, and
those which need it set to 1 printed.</p>
<div style="break-before: page; page-break-before: always;"></div><h3 id="usage-3"><a class="header" href="#usage-3">Usage</a></h3>
<p>To build dependencies for the current arch+OS:</p>
<pre><code>make
</code></pre>
<p>To build for another arch/OS:</p>
<pre><code>make HOST=host-platform-triplet
</code></pre>
<p>For example:</p>
<pre><code>make HOST=x86_64-w64-mingw32 -j4
</code></pre>
<p><strong>When configuring Bitcoin Core, CMake by default will ignore the depends output.</strong> In
order for it to pick up libraries, tools, and settings from the depends build,
you must specify the toolchain file.
In the above example, a file named <code>depends/x86_64-w64-mingw32/toolchain.cmake</code> will be
created. To use it during configuring Bitcoin Core:</p>
<pre><code>cmake -B build --toolchain depends/x86_64-w64-mingw32/toolchain.cmake
</code></pre>
<p>Common <code>host-platform-triplet</code>s for cross compilation are:</p>
<ul>
<li><code>i686-pc-linux-gnu</code> for Linux x86 32 bit</li>
<li><code>x86_64-pc-linux-gnu</code> for Linux x86 64 bit</li>
<li><code>x86_64-w64-mingw32</code> for Win64</li>
<li><code>x86_64-apple-darwin</code> for macOS</li>
<li><code>arm64-apple-darwin</code> for ARM macOS</li>
<li><code>arm-linux-gnueabihf</code> for Linux ARM 32 bit</li>
<li><code>aarch64-linux-gnu</code> for Linux ARM 64 bit</li>
<li><code>powerpc64-linux-gnu</code> for Linux POWER 64 bit (big endian)</li>
<li><code>powerpc64le-linux-gnu</code> for Linux POWER 64 bit (little endian)</li>
<li><code>riscv32-linux-gnu</code> for Linux RISC-V 32 bit</li>
<li><code>riscv64-linux-gnu</code> for Linux RISC-V 64 bit</li>
<li><code>s390x-linux-gnu</code> for Linux S390X</li>
</ul>
<p>The paths are automatically configured and no other options are needed.</p>
<h3 id="install-the-required-dependencies-ubuntu--debian"><a class="header" href="#install-the-required-dependencies-ubuntu--debian">Install the required dependencies: Ubuntu &amp; Debian</a></h3>
<h4 id="common"><a class="header" href="#common">Common</a></h4>
<pre><code>apt install cmake curl make patch
</code></pre>
<h4 id="gui"><a class="header" href="#gui">GUI</a></h4>
<p>Skip the following packages if you don't intend to use the GUI and will build with <a href="depends/index.html#dependency-options"><code>NO_QT=1</code></a>:</p>
<pre><code>apt install bison g++ pkg-config python3 xz-utils
</code></pre>
<h4 id="for-macos-cross-compilation"><a class="header" href="#for-macos-cross-compilation">For macOS cross compilation</a></h4>
<pre><code>apt install clang lld llvm zip
</code></pre>
<p>Clang 18 or later is required. You must also obtain the macOS SDK before
proceeding with a cross-compile. Under the depends directory, create a
subdirectory named <code>SDKs</code>. Then, place the extracted SDK under this new directory.
For more information, see <a href="depends/../contrib/macdeploy/README.html#sdk-extraction">SDK Extraction</a>.</p>
<h4 id="for-win64-cross-compilation"><a class="header" href="#for-win64-cross-compilation">For Win64 cross compilation</a></h4>
<pre><code>apt install g++-mingw-w64-x86-64-posix
</code></pre>
<h4 id="for-linux-including-i386-arm-cross-compilation"><a class="header" href="#for-linux-including-i386-arm-cross-compilation">For linux (including i386, ARM) cross compilation</a></h4>
<p>Common linux dependencies:</p>
<pre><code>sudo apt-get install g++-multilib binutils
</code></pre>
<p>For linux ARM cross compilation:</p>
<pre><code>sudo apt-get install g++-arm-linux-gnueabihf binutils-arm-linux-gnueabihf
</code></pre>
<p>For linux AARCH64 cross compilation:</p>
<pre><code>sudo apt-get install g++-aarch64-linux-gnu binutils-aarch64-linux-gnu
</code></pre>
<p>For linux POWER 64-bit cross compilation (there are no packages for 32-bit):</p>
<pre><code>sudo apt-get install g++-powerpc64-linux-gnu binutils-powerpc64-linux-gnu g++-powerpc64le-linux-gnu binutils-powerpc64le-linux-gnu
</code></pre>
<p>For linux RISC-V 64-bit cross compilation (there are no packages for 32-bit):</p>
<pre><code>sudo apt-get install g++-riscv64-linux-gnu binutils-riscv64-linux-gnu
</code></pre>
<p>For linux S390X cross compilation:</p>
<pre><code>sudo apt-get install g++-s390x-linux-gnu binutils-s390x-linux-gnu
</code></pre>
<h3 id="install-the-required-dependencies-freebsd"><a class="header" href="#install-the-required-dependencies-freebsd">Install the required dependencies: FreeBSD</a></h3>
<pre><code>pkg install bash
</code></pre>
<h3 id="install-the-required-dependencies-netbsd"><a class="header" href="#install-the-required-dependencies-netbsd">Install the required dependencies: NetBSD</a></h3>
<pre><code>pkgin install bash gmake
</code></pre>
<h3 id="install-the-required-dependencies-openbsd"><a class="header" href="#install-the-required-dependencies-openbsd">Install the required dependencies: OpenBSD</a></h3>
<pre><code>pkg_add bash gmake gtar
</code></pre>
<h3 id="dependency-options"><a class="header" href="#dependency-options">Dependency Options</a></h3>
<p>The following can be set when running make: <code>make FOO=bar</code></p>
<ul>
<li><code>SOURCES_PATH</code>: Downloaded sources will be placed here</li>
<li><code>BASE_CACHE</code>: Built packages will be placed here</li>
<li><code>SDK_PATH</code>: Path where SDKs can be found (used by macOS)</li>
<li><code>FALLBACK_DOWNLOAD_PATH</code>: If a source file can't be fetched, try here before giving up</li>
<li><code>C_STANDARD</code>: Set the C standard version used. Defaults to <code>c11</code>.</li>
<li><code>CXX_STANDARD</code>: Set the C++ standard version used. Defaults to <code>c++20</code>.</li>
<li><code>NO_BOOST</code>: Don't download/build/cache Boost</li>
<li><code>NO_LIBEVENT</code>: Don't download/build/cache Libevent</li>
<li><code>NO_QT</code>: Don't download/build/cache Qt and its dependencies</li>
<li><code>NO_QR</code>: Don't download/build/cache packages needed for enabling qrencode</li>
<li><code>NO_ZMQ</code>: Don't download/build/cache packages needed for enabling ZeroMQ</li>
<li><code>NO_WALLET</code>: Don't download/build/cache libs needed to enable the wallet</li>
<li><code>NO_BDB</code>: Don't download/build/cache BerkeleyDB</li>
<li><code>NO_SQLITE</code>: Don't download/build/cache SQLite</li>
<li><code>NO_USDT</code>: Don't download/build/cache packages needed for enabling USDT tracepoints</li>
<li><code>MULTIPROCESS</code>: Build libmultiprocess (experimental)</li>
<li><code>DEBUG</code>: Disable some optimizations and enable more runtime checking</li>
<li><code>HOST_ID_SALT</code>: Optional salt to use when generating host package ids</li>
<li><code>BUILD_ID_SALT</code>: Optional salt to use when generating build package ids</li>
<li><code>LOG</code>: Use file-based logging for individual packages. During a package build its log file
resides in the <code>depends</code> directory, and the log file is printed out automatically in case
of build error. After successful build log files are moved along with package archives</li>
<li><code>LTO</code>: Enable options needed for LTO. Does not add <code>-flto</code> related options to *FLAGS.</li>
<li><code>NO_HARDEN=1</code>: Don't use hardening options when building packages</li>
</ul>
<p>If some packages are not built, for example <code>make NO_WALLET=1</code>, the appropriate CMake cache
variables will be set when generating the Bitcoin Core buildsystem. In this case, <code>-DENABLE_WALLET=OFF</code>.</p>
<h3 id="additional-targets"><a class="header" href="#additional-targets">Additional targets</a></h3>
<pre><code>download: run 'make download' to fetch all sources without building them
download-osx: run 'make download-osx' to fetch all sources needed for macOS builds
download-win: run 'make download-win' to fetch all sources needed for win builds
download-linux: run 'make download-linux' to fetch all sources needed for linux builds
</code></pre>
<h3 id="other-documentation"><a class="header" href="#other-documentation">Other documentation</a></h3>
<ul>
<li><a href="depends/description.html">description.md</a>: General description of the depends system</li>
<li><a href="depends/packages.html">packages.md</a>: Steps for adding packages</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><p>This is a system of building and caching dependencies necessary for building Bitcoin.
There are several features that make it different from most similar systems:</p>
<h3 id="it-is-designed-to-be-builder-and-host-agnostic"><a class="header" href="#it-is-designed-to-be-builder-and-host-agnostic">It is designed to be builder and host agnostic</a></h3>
<p>In theory, binaries for any target OS/architecture can be created, from a
builder running any OS/architecture. In practice, build-side tools must be
specified when the defaults don't fit, and packages must be amended to work
on new hosts.</p>
<h3 id="no-reliance-on-timestamps"><a class="header" href="#no-reliance-on-timestamps">No reliance on timestamps</a></h3>
<p>File presence is used to determine what needs to be built. This makes the
results distributable and easily digestible by automated builders.</p>
<h3 id="each-build-only-has-its-specified-dependencies-available-at-build-time"><a class="header" href="#each-build-only-has-its-specified-dependencies-available-at-build-time">Each build only has its specified dependencies available at build-time.</a></h3>
<p>For each build, the sysroot is wiped and the (recursive) dependencies are
installed. This makes each build deterministic, since there will never be any
unknown files available to cause side-effects.</p>
<h3 id="each-package-is-cached-and-only-rebuilt-as-needed"><a class="header" href="#each-package-is-cached-and-only-rebuilt-as-needed">Each package is cached and only rebuilt as needed.</a></h3>
<p>Before building, a unique build-id is generated for each package. This id
consists of a hash of all files used to build the package (Makefiles, packages,
etc), and as well as a hash of the same data for each recursive dependency. If
any portion of a package's build recipe changes, it will be rebuilt as well as
any other package that depends on it. If any of the main makefiles (Makefile,
funcs.mk, etc) are changed, all packages will be rebuilt. After building, the
results are cached into a tarball that can be reused and distributed.</p>
<h3 id="package-build-results-are-relatively-deterministic"><a class="header" href="#package-build-results-are-relatively-deterministic">Package build results are (relatively) deterministic.</a></h3>
<p>Each package is configured and patched so that it will yield the same
build-results with each consequent build, within a reasonable set of
constraints. Some things like timestamp insertion are unavoidable, and are
beyond the scope of this system. Additionally, the toolchain itself must be
capable of deterministic results. When revisions are properly bumped, a cached
build should represent an exact single payload.</p>
<h3 id="sources-are-fetched-and-verified-automatically"><a class="header" href="#sources-are-fetched-and-verified-automatically">Sources are fetched and verified automatically</a></h3>
<p>Each package must define its source location and checksum. The build will fail
if the fetched source does not match. Sources may be pre-seeded and/or cached
as desired.</p>
<h3 id="self-cleaning"><a class="header" href="#self-cleaning">Self-cleaning</a></h3>
<p>Build and staging dirs are wiped after use, and any previous version of a
cached result is removed following a successful build. Automated builders
should be able to build each revision and store the results with no further
intervention.</p>
<div style="break-before: page; page-break-before: always;"></div><p>Each recipe consists of 3 main parts: defining identifiers, setting build
variables, and defining build commands.</p>
<p>The package "mylib" will be used here as an example</p>
<p>General tips:</p>
<ul>
<li>mylib_foo is written as $(package)_foo in order to make recipes more similar.</li>
<li>Secondary dependency packages relative to the bitcoin binaries/libraries (i.e.
those not in <code>ALLOWED_LIBRARIES</code> in <code>contrib/devtools/symbol-check.py</code>) don't
need to be shared and should be built statically whenever possible. See
<a href="depends/packages.html#secondary-dependencies">below</a> for more details.</li>
</ul>
<h2 id="identifiers"><a class="header" href="#identifiers">Identifiers</a></h2>
<p>Each package is required to define at least these variables:</p>
<pre><code>$(package)_version:
Version of the upstream library or program. If there is no version, a
placeholder such as 1.0 can be used.

$(package)_download_path:
Location of the upstream source, without the file-name. Usually http, https
or ftp. Secure transmission options like https should be preferred if
available.

$(package)_file_name:
The upstream source filename available at the download path.

$(package)_sha256_hash:
The sha256 hash of the upstream file
</code></pre>
<p>These variables are optional:</p>
<pre><code>$(package)_build_subdir:
cd to this dir before running configure/build/stage commands.

$(package)_download_file:
The file-name of the upstream source if it differs from how it should be
stored locally. This can be used to avoid storing file-names with strange
characters.

$(package)_dependencies:
Names of any other packages that this one depends on.

$(package)_patches:
Filenames of any patches needed to build the package

$(package)_extra_sources:
Any extra files that will be fetched via $(package)_fetch_cmds. These are
specified so that they can be fetched and verified via 'make download'.
</code></pre>
<h2 id="build-variables"><a class="header" href="#build-variables">Build Variables:</a></h2>
<p>After defining the main identifiers, build variables may be added or customized
before running the build commands. They should be added to a function called
$(package)_set_vars. For example:</p>
<pre><code>define $(package)_set_vars
...
endef
</code></pre>
<p>Most variables can be prefixed with the host, architecture, or both, to make
the modifications specific to that case. For example:</p>
<pre><code>Universal:     $(package)_cc=gcc
Linux only:    $(package)_linux_cc=gcc
x86_64 only:       $(package)_x86_64_cc = gcc
x86_64 linux only: $(package)_x86_64_linux_cc = gcc
</code></pre>
<p>These variables may be set to override or append their default values.</p>
<pre><code>$(package)_cc
$(package)_cxx
$(package)_objc
$(package)_objcxx
$(package)_ar
$(package)_ranlib
$(package)_nm
$(package)_cflags
$(package)_cxxflags
$(package)_ldflags
$(package)_cppflags
$(package)_config_env
$(package)_build_env
$(package)_stage_env
$(package)_build_opts
$(package)_config_opts
</code></pre>
<p>The *_env variables are used to add environment variables to the respective
commands.</p>
<p>Many variables respect a debug/release suffix as well, in order to use them for
only the appropriate build config. For example:</p>
<pre><code>$(package)_cflags_release = -O3
$(package)_cflags_i686_debug = -g
$(package)_config_opts_release = --disable-debug
</code></pre>
<p>These will be used in addition to the options that do not specify
debug/release. All builds are considered to be release unless DEBUG=1 is set by
the user. Other variables may be defined as needed.</p>
<h2 id="build-commands"><a class="header" href="#build-commands">Build commands:</a></h2>
<p>For each build, a unique build dir and staging dir are created. For example,
<code>work/build/mylib/1.0-1adac830f6e</code> and <code>work/staging/mylib/1.0-1adac830f6e</code>.</p>
<p>The following build commands are available for each recipe:</p>
<pre><code>$(package)_fetch_cmds:
Runs from: build dir
Fetch the source file. If undefined, it will be fetched and verified
against its hash.

$(package)_extract_cmds:
Runs from: build dir
Verify the source file against its hash and extract it. If undefined, the
source is assumed to be a tarball.

$(package)_preprocess_cmds:
Runs from: build dir/$(package)_build_subdir
Preprocess the source as necessary. If undefined, does nothing.

$(package)_config_cmds:
Runs from: build dir/$(package)_build_subdir
Configure the source. If undefined, does nothing.

$(package)_build_cmds:
Runs from: build dir/$(package)_build_subdir
Build the source. If undefined, does nothing.

$(package)_stage_cmds:
Runs from: build dir/$(package)_build_subdir
Stage the build results. If undefined, does nothing.
</code></pre>
<p>The following variables are available for each recipe:</p>
<pre><code>$(1)_staging_dir: package's destination sysroot path
$(1)_staging_prefix_dir: prefix path inside of the package's staging dir
$(1)_extract_dir: path to the package's extracted sources
$(1)_build_dir: path where configure/build/stage commands will be run
$(1)_patch_dir: path where the package's patches (if any) are found
</code></pre>
<p>Notes on build commands:</p>
<p>For packages built with autotools, $($(package)_autoconf) can be used in the
configure step to (usually) correctly configure automatically. Any
$($(package)_config_opts) will be appended.</p>
<p>Most autotools projects can be properly staged using:</p>
<pre><code>$(MAKE) DESTDIR=$($(package)_staging_dir) install
</code></pre>
<h2 id="build-outputs"><a class="header" href="#build-outputs">Build outputs:</a></h2>
<p>In general, the output of a depends package should not contain any libtool
archives. Instead, the package should output <code>.pc</code> (<code>pkg-config</code>) files where
possible.</p>
<p>From the <a href="https://wiki.gentoo.org/wiki/Project:Quality_Assurance/Handling_Libtool_Archives">Gentoo Wiki entry</a>:</p>
<blockquote>
<p>Libtool pulls in all direct and indirect dependencies into the .la files it
creates. This leads to massive overlinking, which is toxic to the Gentoo
ecosystem, as it leads to a massive number of unnecessary rebuilds.</p>
</blockquote>
<p>Where possible, packages are built with Position Independent Code. Either using
the Autotools <code>--with-pic</code> flag, or <code>CMAKE_POSITION_INDEPENDENT_CODE</code> with CMake.</p>
<h2 id="secondary-dependencies"><a class="header" href="#secondary-dependencies">Secondary dependencies:</a></h2>
<p>Secondary dependency packages relative to the bitcoin binaries/libraries (i.e.
those not in <code>ALLOWED_LIBRARIES</code> in <code>contrib/devtools/symbol-check.py</code>) don't
need to be shared and should be built statically whenever possible. This
improves general build reliability as illustrated by the following example:</p>
<p>When linking an executable against a shared library <code>libprimary</code> that has its
own shared dependency <code>libsecondary</code>, we may need to specify the path to
<code>libsecondary</code> on the link command using the <code>-rpath/-rpath-link</code> options, it is
not sufficient to just say <code>libprimary</code>.</p>
<p>For us, it's much easier to just link a static <code>libsecondary</code> into a shared
<code>libprimary</code>. Especially because in our case, we are linking against a dummy
<code>libprimary</code> anyway that we'll throw away. We don't care if the end-user has a
static or dynamic <code>libsecondary</code>, that's not our concern. With a static
<code>libsecondary</code>, when we need to link <code>libprimary</code> into our executable, there's no
dependency chain to worry about as <code>libprimary</code> has all the symbols.</p>
<h2 id="build-targets"><a class="header" href="#build-targets">Build targets:</a></h2>
<p>To build an individual package (useful for debugging), following build targets are available.</p>
<pre><code>make ${package}
make ${package}_fetched
make ${package}_extracted
make ${package}_preprocessed
make ${package}_configured
make ${package}_built
make ${package}_staged
make ${package}_postprocessed
make ${package}_cached
make ${package}_cached_checksum
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="bitcoin-core"><a class="header" href="#bitcoin-core">Bitcoin Core</a></h1>
<h2 id="setup"><a class="header" href="#setup">Setup</a></h2>
<p>Bitcoin Core is the original Bitcoin client and it builds the backbone of the network. It downloads and, by default, stores the entire history of Bitcoin transactions, which requires several hundred gigabytes or more of disk space. Depending on the speed of your computer and network connection, the synchronization process can take anywhere from a few hours to several days or more.</p>
<p>To download Bitcoin Core, visit <a href="https://bitcoincore.org/en/download/">bitcoincore.org</a>.</p>
<h2 id="running"><a class="header" href="#running">Running</a></h2>
<p>The following are some helpful notes on how to run Bitcoin Core on your native platform.</p>
<h3 id="unix"><a class="header" href="#unix">Unix</a></h3>
<p>Unpack the files into a directory and run:</p>
<ul>
<li><code>bin/bitcoin-qt</code> (GUI) or</li>
<li><code>bin/bitcoind</code> (headless)</li>
</ul>
<h3 id="windows"><a class="header" href="#windows">Windows</a></h3>
<p>Unpack the files into a directory, and then run bitcoin-qt.exe.</p>
<h3 id="macos"><a class="header" href="#macos">macOS</a></h3>
<p>Drag Bitcoin Core to your applications folder, and then run Bitcoin Core.</p>
<h3 id="need-help"><a class="header" href="#need-help">Need Help?</a></h3>
<ul>
<li>See the documentation at the <a href="https://en.bitcoin.it/wiki/Main_Page">Bitcoin Wiki</a>
for help and more information.</li>
<li>Ask for help on <a href="https://bitcoin.stackexchange.com">Bitcoin StackExchange</a>.</li>
<li>Ask for help on #bitcoin on Libera Chat. If you don't have an IRC client, you can use <a href="https://web.libera.chat/#bitcoin">web.libera.chat</a>.</li>
<li>Ask for help on the <a href="https://bitcointalk.org/">BitcoinTalk</a> forums, in the <a href="https://bitcointalk.org/index.php?board=4.0">Technical Support board</a>.</li>
</ul>
<h2 id="building-1"><a class="header" href="#building-1">Building</a></h2>
<p>The following are developer notes on how to build Bitcoin Core on your native platform. They are not complete guides, but include notes on the necessary libraries, compile flags, etc.</p>
<ul>
<li><a href="doc/dependencies.html">Dependencies</a></li>
<li><a href="doc/build-osx.html">macOS Build Notes</a></li>
<li><a href="doc/build-unix.html">Unix Build Notes</a></li>
<li><a href="doc/build-windows-msvc.html">Windows Build Notes</a></li>
<li><a href="doc/build-freebsd.html">FreeBSD Build Notes</a></li>
<li><a href="doc/build-openbsd.html">OpenBSD Build Notes</a></li>
<li><a href="doc/build-netbsd.html">NetBSD Build Notes</a></li>
</ul>
<h2 id="development"><a class="header" href="#development">Development</a></h2>
<p>The Bitcoin repo's <a href="doc//README.html">root README</a> contains relevant information on the development process and automated testing.</p>
<ul>
<li><a href="doc/developer-notes.html">Developer Notes</a></li>
<li><a href="doc/productivity.html">Productivity Notes</a></li>
<li><a href="doc/release-process.html">Release Process</a></li>
<li><a href="https://doxygen.bitcoincore.org/">Source Code Documentation (External Link)</a></li>
<li><a href="doc/translation_process.html">Translation Process</a></li>
<li><a href="doc/translation_strings_policy.html">Translation Strings Policy</a></li>
<li><a href="doc/JSON-RPC-interface.html">JSON-RPC Interface</a></li>
<li><a href="doc/REST-interface.html">Unauthenticated REST Interface</a></li>
<li><a href="doc/bips.html">BIPS</a></li>
<li><a href="doc/dnsseed-policy.html">Dnsseed Policy</a></li>
<li><a href="doc/benchmarking.html">Benchmarking</a></li>
<li><a href="doc/design/">Internal Design Docs</a></li>
</ul>
<h3 id="resources"><a class="header" href="#resources">Resources</a></h3>
<ul>
<li>Discuss on the <a href="https://bitcointalk.org/">BitcoinTalk</a> forums, in the <a href="https://bitcointalk.org/index.php?board=6.0">Development &amp; Technical Discussion board</a>.</li>
<li>Discuss project-specific development on #bitcoin-core-dev on Libera Chat. If you don't have an IRC client, you can use <a href="https://web.libera.chat/#bitcoin-core-dev">web.libera.chat</a>.</li>
</ul>
<h3 id="miscellaneous"><a class="header" href="#miscellaneous">Miscellaneous</a></h3>
<ul>
<li><a href="doc/assets-attribution.html">Assets Attribution</a></li>
<li><a href="doc/bitcoin-conf.html">bitcoin.conf Configuration File</a></li>
<li><a href="doc/cjdns.html">CJDNS Support</a></li>
<li><a href="doc/files.html">Files</a></li>
<li><a href="doc/fuzzing.html">Fuzz-testing</a></li>
<li><a href="doc/i2p.html">I2P Support</a></li>
<li><a href="doc/init.html">Init Scripts (systemd/upstart/openrc)</a></li>
<li><a href="doc/managing-wallets.html">Managing Wallets</a></li>
<li><a href="doc/multisig-tutorial.html">Multisig Tutorial</a></li>
<li><a href="doc/offline-signing-tutorial.html">Offline Signing Tutorial</a></li>
<li><a href="doc/p2p-bad-ports.html">P2P bad ports definition and list</a></li>
<li><a href="doc/psbt.html">PSBT support</a></li>
<li><a href="doc/reduce-memory.html">Reduce Memory</a></li>
<li><a href="doc/reduce-traffic.html">Reduce Traffic</a></li>
<li><a href="doc/tor.html">Tor Support</a></li>
<li><a href="doc/policy/README.html">Transaction Relay Policy</a></li>
<li><a href="doc/zmq.html">ZMQ</a></li>
</ul>
<h2 id="license-2"><a class="header" href="#license-2">License</a></h2>
<p>Distributed under the <a href="doc//COPYING">MIT software license</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="json-rpc-interface"><a class="header" href="#json-rpc-interface">JSON-RPC Interface</a></h1>
<p>The headless daemon <code>bitcoind</code> has the JSON-RPC API enabled by default, the GUI
<code>bitcoin-qt</code> has it disabled by default. This can be changed with the <code>-server</code>
option. In the GUI it is possible to execute RPC methods in the Debug Console
Dialog.</p>
<h2 id="endpoints"><a class="header" href="#endpoints">Endpoints</a></h2>
<p>There are two JSON-RPC endpoints on the server:</p>
<ol>
<li><code>/</code></li>
<li><code>/wallet/&lt;walletname&gt;/</code></li>
</ol>
<h3 id="-endpoint"><a class="header" href="#-endpoint"><code>/</code> endpoint</a></h3>
<p>This endpoint is always active.
It can always service non-wallet requests and can service wallet requests when
exactly one wallet is loaded.</p>
<h3 id="walletwalletname-endpoint"><a class="header" href="#walletwalletname-endpoint"><code>/wallet/&lt;walletname&gt;/</code> endpoint</a></h3>
<p>This endpoint is only activated when the wallet component has been compiled in.
It can service both wallet and non-wallet requests.
It MUST be used for wallet requests when two or more wallets are loaded.</p>
<p>This is the endpoint used by bitcoin-cli when a <code>-rpcwallet=</code> parameter is passed in.</p>
<p>Best practice would dictate using the <code>/wallet/&lt;walletname&gt;/</code> endpoint for ALL
requests when multiple wallets are in use.</p>
<h3 id="examples-3"><a class="header" href="#examples-3">Examples</a></h3>
<pre><code class="language-sh"># Get block count from the / endpoint when rpcuser=alice and rpcport=38332
$ curl --user alice --data-binary '{"jsonrpc": "2.0", "id": "0", "method": "getblockcount", "params": []}' -H 'content-type: application/json' localhost:38332/

# Get balance from the /wallet/walletname endpoint when rpcuser=alice, rpcport=38332 and rpcwallet=desc-wallet
$ curl --user alice --data-binary '{"jsonrpc": "2.0", "id": "0", "method": "getbalance", "params": []}' -H 'content-type: application/json' localhost:38332/wallet/desc-wallet

</code></pre>
<h2 id="parameter-passing"><a class="header" href="#parameter-passing">Parameter passing</a></h2>
<p>The JSON-RPC server supports both <em>by-position</em> and <em>by-name</em> <a href="https://www.jsonrpc.org/specification#parameter_structures">parameter
structures</a>
described in the JSON-RPC specification. For extra convenience, to avoid the
need to name every parameter value, all RPC methods accept a named parameter
called <code>args</code>, which can be set to an array of initial positional values that
are combined with named values.</p>
<p>Examples:</p>
<pre><code class="language-sh"># "params": ["mywallet", false, false, "", false, false, true]
bitcoin-cli createwallet mywallet false false "" false false true

# "params": {"wallet_name": "mywallet", "load_on_startup": true}
bitcoin-cli -named createwallet wallet_name=mywallet load_on_startup=true

# "params": {"args": ["mywallet"], "load_on_startup": true}
bitcoin-cli -named createwallet mywallet load_on_startup=true
</code></pre>
<h2 id="versioning"><a class="header" href="#versioning">Versioning</a></h2>
<p>The RPC interface might change from one major version of Bitcoin Core to the
next. This makes the RPC interface implicitly versioned on the major version.
The version tuple can be retrieved by e.g. the <code>getnetworkinfo</code> RPC in
<code>version</code>.</p>
<p>Usually deprecated features can be re-enabled during the grace-period of one
major version via the <code>-deprecatedrpc=</code> command line option. The release notes
of a new major release come with detailed instructions on what RPC features
were deprecated and how to re-enable them temporarily.</p>
<h2 id="json-rpc-11-vs-20"><a class="header" href="#json-rpc-11-vs-20">JSON-RPC 1.1 vs 2.0</a></h2>
<p>The server recognizes <a href="https://www.jsonrpc.org/specification">JSON-RPC v2.0</a> requests
and responds accordingly. A 2.0 request is identified by the presence of
<code>"jsonrpc": "2.0"</code> in the request body. If that key + value is not present in a request,
the legacy JSON-RPC v1.1 protocol is followed instead, which was the only available
protocol in v27.0 and prior releases.</p>
<div class="table-wrapper"><table><thead><tr><th></th><th>1.1</th><th>2.0</th></tr></thead><tbody>
<tr><td>Request marker</td><td><code>"version": "1.1"</code> (or none)</td><td><code>"jsonrpc": "2.0"</code></td></tr>
<tr><td>Response marker</td><td>(none)</td><td><code>"jsonrpc": "2.0"</code></td></tr>
<tr><td><code>"error"</code> and <code>"result"</code> fields in response</td><td>both present</td><td>only one is present</td></tr>
<tr><td>HTTP codes in response</td><td><code>200</code> unless there is any kind of RPC error (invalid parameters, method not found, etc)</td><td>Always <code>200</code> unless there is an actual HTTP server error (request parsing error, endpoint not found, etc)</td></tr>
<tr><td>Notifications: requests that get no reply</td><td>(not supported)</td><td>Supported for requests that exclude the "id" field. Returns HTTP status <code>204</code> "No Content"</td></tr>
</tbody></table>
</div>
<h2 id="security"><a class="header" href="#security">Security</a></h2>
<p>The RPC interface allows other programs to control Bitcoin Core,
including the ability to spend funds from your wallets, affect consensus
verification, read private data, and otherwise perform operations that
can cause loss of money, data, or privacy.  This section suggests how
you should use and configure Bitcoin Core to reduce the risk that its
RPC interface will be abused.</p>
<ul>
<li>
<p><strong>Securing the executable:</strong> Anyone with physical or remote access to
the computer, container, or virtual machine running Bitcoin Core can
compromise either the whole program or just the RPC interface.  This
includes being able to record any passphrases you enter for unlocking
your encrypted wallets or changing settings so that your Bitcoin Core
program tells you that certain transactions have multiple
confirmations even when they aren't part of the best block chain.  For
this reason, you should not use Bitcoin Core for security sensitive
operations on systems you do not exclusively control, such as shared
computers or virtual private servers.</p>
</li>
<li>
<p><strong>Securing local network access:</strong> By default, the RPC interface can
only be accessed by a client running on the same computer and only
after the client provides a valid authentication credential (username
and passphrase).  Any program on your computer with access to the file
system and local network can obtain this level of access.
Additionally, other programs on your computer can attempt to provide
an RPC interface on the same port as used by Bitcoin Core in order to
trick you into revealing your authentication credentials.  For this
reason, it is important to only use Bitcoin Core for
security-sensitive operations on a computer whose other programs you
trust.</p>
</li>
<li>
<p><strong>Securing remote network access:</strong> You may optionally allow other
computers to remotely control Bitcoin Core by setting the <code>rpcallowip</code>
and <code>rpcbind</code> configuration parameters.  These settings are only meant
for enabling connections over secure private networks or connections
that have been otherwise secured (e.g. using a VPN or port forwarding
with SSH or stunnel).  <strong>Do not enable RPC connections over the public
Internet.</strong>  Although Bitcoin Core's RPC interface does use
authentication, it does not use encryption, so your login credentials
are sent as clear text that can be read by anyone on your network
path.  Additionally, the RPC interface has not been hardened to
withstand arbitrary Internet traffic, so changing the above settings
to expose it to the Internet (even using something like a Tor onion
service) could expose you to unconsidered vulnerabilities.  See
<code>bitcoind -help</code> for more information about these settings and other
settings described in this document.</p>
<p>Related, if you use Bitcoin Core inside a Docker container, you may
need to expose the RPC port to the host system.  The default way to
do this in Docker also exposes the port to the public Internet.
Instead, expose it only on the host system's localhost, for example:
<code>-p 127.0.0.1:8332:8332</code></p>
</li>
<li>
<p><strong>Secure authentication:</strong> By default, when no <code>rpcpassword</code> is specified, Bitcoin Core generates unique
login credentials each time it restarts and puts them into a file
readable only by the user that started Bitcoin Core, allowing any of
that user's RPC clients with read access to the file to login
automatically.  The file is <code>.cookie</code> in the Bitcoin Core
configuration directory, and using these credentials is the preferred
RPC authentication method.  If you need to generate static login
credentials for your programs, you can use the script in the
<code>share/rpcauth</code> directory in the Bitcoin Core source tree.  As a final
fallback, you can directly use manually-chosen <code>rpcuser</code> and
<code>rpcpassword</code> configuration parameters---but you must ensure that you
choose a strong and unique passphrase (and still don't use insecure
networks, as mentioned above).</p>
</li>
<li>
<p><strong>Secure string handling:</strong> The RPC interface does not guarantee any
escaping of data beyond what's necessary to encode it as JSON,
although it does usually provide serialized data using a hex
representation of the bytes. If you use RPC data in your programs or
provide its data to other programs, you must ensure any problem strings
are properly escaped. For example, the <code>createwallet</code> RPC accepts
arguments such as <code>wallet_name</code> which is a string and could be used
for a path traversal attack without application level checks. Multiple
websites have been manipulated because they displayed decoded hex strings
that included HTML <code>&lt;script&gt;</code> tags. For this reason, and others, it is
recommended to display all serialized data in hex form only.</p>
</li>
</ul>
<h2 id="rpc-consistency-guarantees"><a class="header" href="#rpc-consistency-guarantees">RPC consistency guarantees</a></h2>
<p>State that can be queried via RPCs is guaranteed to be at least up-to-date with
the chain state immediately prior to the call's execution. However, the state
returned by RPCs that reflect the mempool may not be up-to-date with the
current mempool state.</p>
<h3 id="transaction-pool"><a class="header" href="#transaction-pool">Transaction Pool</a></h3>
<p>The mempool state returned via an RPC is consistent with itself and with the
chain state at the time of the call. Thus, the mempool state only encompasses
transactions that are considered mine-able by the node at the time of the RPC.</p>
<p>The mempool state returned via an RPC reflects all effects of mempool and chain
state related RPCs that returned prior to this call.</p>
<h3 id="wallet"><a class="header" href="#wallet">Wallet</a></h3>
<p>The wallet state returned via an RPC is consistent with itself and with the
chain state at the time of the call.</p>
<p>Wallet RPCs will return the latest chain state consistent with prior non-wallet
RPCs. The effects of all blocks (and transactions in blocks) at the time of the
call is reflected in the state of all wallet transactions. For example, if a
block contains transactions that conflicted with mempool transactions, the
wallet would reflect the removal of these mempool transactions in the state.</p>
<p>However, the wallet may not be up-to-date with the current state of the mempool
or the state of the mempool by an RPC that returned before this RPC. For
example, a wallet transaction that was BIP-125-replaced in the mempool prior to
this RPC may not yet be reflected as such in this RPC response.</p>
<h2 id="limitations"><a class="header" href="#limitations">Limitations</a></h2>
<p>There is a known issue in the JSON-RPC interface that can cause a node to crash if
too many http connections are being opened at the same time because the system runs
out of available file descriptors. To prevent this from happening you might
want to increase the number of maximum allowed file descriptors in your system
and try to prevent opening too many connections to your JSON-RPC interface at the
same time if this is under your control. It is hard to give general advice
since this depends on your system but if you make several hundred requests at
once you are definitely at risk of encountering this issue.</p>
<div style="break-before: page; page-break-before: always;"></div><p>\mainpage notitle</p>
<p>\section intro_sec Introduction</p>
<p>This is the developer documentation of the reference client for an experimental new digital currency called Bitcoin,
which enables instant payments to anyone, anywhere in the world. Bitcoin uses peer-to-peer technology to operate
with no central authority: managing transactions and issuing money are carried out collectively by the network.</p>
<p>The software is a community-driven open source project, released under the MIT license.</p>
<p>See https://github.com/bitcoin/bitcoin and https://bitcoincore.org/ for further information about the project.</p>
<p>\section Navigation
Use <a href="doc/modules.html"><code>Modules</code></a>, <a href="doc/namespaces.html"><code>Namespaces</code></a>, <a href="doc/classes.html"><code>Classes</code></a>, or <a href="doc/files.html"><code>Files</code></a> at the top of the page to start navigating the code.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="unauthenticated-rest-interface"><a class="header" href="#unauthenticated-rest-interface">Unauthenticated REST Interface</a></h1>
<p>The REST API can be enabled with the <code>-rest</code> option.</p>
<p>The interface runs on the same port as the JSON-RPC interface, by default port 8332 for mainnet, port 18332 for testnet,
port 48332 for testnet4, port 38332 for signet, and port 18443 for regtest.</p>
<h2 id="rest-interface-consistency-guarantees"><a class="header" href="#rest-interface-consistency-guarantees">REST Interface consistency guarantees</a></h2>
<p>The <a href="doc//doc/JSON-RPC-interface.html#rpc-consistency-guarantees">same guarantees as for the RPC Interface</a>
apply.</p>
<h2 id="limitations-1"><a class="header" href="#limitations-1">Limitations</a></h2>
<p>There is a known issue in the REST interface that can cause a node to crash if
too many http connections are being opened at the same time because the system runs
out of available file descriptors. To prevent this from happening you might
want to increase the number of maximum allowed file descriptors in your system
and try to prevent opening too many connections to your rest interface at the
same time if this is under your control. It is hard to give general advice
since this depends on your system but if you make several hundred requests at
once you are definitely at risk of encountering this issue.</p>
<h2 id="supported-api"><a class="header" href="#supported-api">Supported API</a></h2>
<h4 id="transactions"><a class="header" href="#transactions">Transactions</a></h4>
<p><code>GET /rest/tx/&lt;TX-HASH&gt;.&lt;bin|hex|json&gt;</code></p>
<p>Given a transaction hash: returns a transaction in binary, hex-encoded binary, or JSON formats.
Responds with 404 if the transaction doesn't exist.</p>
<p>By default, this endpoint will only search the mempool.
To query for a confirmed transaction, enable the transaction index via "txindex=1" command line / configuration option.</p>
<h4 id="blocks"><a class="header" href="#blocks">Blocks</a></h4>
<ul>
<li><code>GET /rest/block/&lt;BLOCK-HASH&gt;.&lt;bin|hex|json&gt;</code></li>
<li><code>GET /rest/block/notxdetails/&lt;BLOCK-HASH&gt;.&lt;bin|hex|json&gt;</code></li>
</ul>
<p>Given a block hash: returns a block, in binary, hex-encoded binary or JSON formats.
Responds with 404 if the block doesn't exist.</p>
<p>The HTTP request and response are both handled entirely in-memory.</p>
<p>With the /notxdetails/ option JSON response will only contain the transaction hash instead of the complete transaction details. The option only affects the JSON response.</p>
<h4 id="blockheaders"><a class="header" href="#blockheaders">Blockheaders</a></h4>
<p><code>GET /rest/headers/&lt;BLOCK-HASH&gt;.&lt;bin|hex|json&gt;?count=&lt;COUNT=5&gt;</code></p>
<p>Given a block hash: returns <COUNT> amount of blockheaders in upward direction.
Returns empty if the block doesn't exist or it isn't in the active chain.</p>
<p><em>Deprecated (but not removed) since 24.0:</em>
<code>GET /rest/headers/&lt;COUNT&gt;/&lt;BLOCK-HASH&gt;.&lt;bin|hex|json&gt;</code></p>
<h4 id="blockfilter-headers"><a class="header" href="#blockfilter-headers">Blockfilter Headers</a></h4>
<p><code>GET /rest/blockfilterheaders/&lt;FILTERTYPE&gt;/&lt;BLOCK-HASH&gt;.&lt;bin|hex|json&gt;?count=&lt;COUNT=5&gt;</code></p>
<p>Given a block hash: returns <COUNT> amount of blockfilter headers in upward
direction for the filter type <FILTERTYPE>.
Returns empty if the block doesn't exist or it isn't in the active chain.</p>
<p><em>Deprecated (but not removed) since 24.0:</em>
<code>GET /rest/blockfilterheaders/&lt;FILTERTYPE&gt;/&lt;COUNT&gt;/&lt;BLOCK-HASH&gt;.&lt;bin|hex|json&gt;</code></p>
<h4 id="blockfilters"><a class="header" href="#blockfilters">Blockfilters</a></h4>
<p><code>GET /rest/blockfilter/&lt;FILTERTYPE&gt;/&lt;BLOCK-HASH&gt;.&lt;bin|hex|json&gt;</code></p>
<p>Given a block hash: returns the block filter of the given block of type
<FILTERTYPE>.
Responds with 404 if the block doesn't exist.</p>
<h4 id="blockhash-by-height"><a class="header" href="#blockhash-by-height">Blockhash by height</a></h4>
<p><code>GET /rest/blockhashbyheight/&lt;HEIGHT&gt;.&lt;bin|hex|json&gt;</code></p>
<p>Given a height: returns hash of block in best-block-chain at height provided.
Responds with 404 if block not found.</p>
<h4 id="chaininfos"><a class="header" href="#chaininfos">Chaininfos</a></h4>
<p><code>GET /rest/chaininfo.json</code></p>
<p>Returns various state info regarding block chain processing.
Only supports JSON as output format.
Refer to the <code>getblockchaininfo</code> RPC help for details.</p>
<h4 id="deployment-info"><a class="header" href="#deployment-info">Deployment info</a></h4>
<p><code>GET /rest/deploymentinfo.json</code>
<code>GET /rest/deploymentinfo/&lt;BLOCKHASH&gt;.json</code></p>
<p>Returns an object containing various state info regarding deployments of
consensus changes at the current chain tip, or at <BLOCKHASH> if provided.
Only supports JSON as output format.
Refer to the <code>getdeploymentinfo</code> RPC help for details.</p>
<h4 id="query-utxo-set"><a class="header" href="#query-utxo-set">Query UTXO set</a></h4>
<ul>
<li><code>GET /rest/getutxos/&lt;TXID&gt;-&lt;N&gt;/&lt;TXID&gt;-&lt;N&gt;/.../&lt;TXID&gt;-&lt;N&gt;.&lt;bin|hex|json&gt;</code></li>
<li><code>GET /rest/getutxos/checkmempool/&lt;TXID&gt;-&lt;N&gt;/&lt;TXID&gt;-&lt;N&gt;/.../&lt;TXID&gt;-&lt;N&gt;.&lt;bin|hex|json&gt;</code></li>
</ul>
<p>The getutxos endpoint allows querying the UTXO set, given a set of outpoints.
With the <code>/checkmempool/</code> option, the mempool is also taken into account.
See <a href="https://github.com/bitcoin/bips/blob/master/bip-0064.mediawiki">BIP64</a> for
input and output serialization (relevant for <code>bin</code> and <code>hex</code> output formats).</p>
<p>Example:</p>
<pre><code>$ curl localhost:18332/rest/getutxos/checkmempool/b2cdfd7b89def827ff8af7cd9bff7627ff72e5e8b0f71210f92ea7a4000c5d75-0.json 2&gt;/dev/null | json_pp
{
   "chainHeight" : 325347,
   "chaintipHash" : "00000000fb01a7f3745a717f8caebee056c484e6e0bfe4a9591c235bb70506fb",
   "bitmap": "1",
   "utxos" : [
      {
         "height" : 2147483647,
         "value" : 8.8687,
         "scriptPubKey" : {
            "asm" : "OP_DUP OP_HASH160 1c7cebb529b86a04c683dfa87be49de35bcf589e OP_EQUALVERIFY OP_CHECKSIG",
            "desc" : "addr(mi7as51dvLJsizWnTMurtRmrP8hG2m1XvD)#gj9tznmy",
            "hex" : "76a9141c7cebb529b86a04c683dfa87be49de35bcf589e88ac",
            "type" : "pubkeyhash",
            "address" : "mi7as51dvLJsizWnTMurtRmrP8hG2m1XvD"
         }
      }
   ]
}
</code></pre>
<h4 id="memory-pool"><a class="header" href="#memory-pool">Memory pool</a></h4>
<p><code>GET /rest/mempool/info.json</code></p>
<p>Returns various information about the transaction mempool.
Only supports JSON as output format.
Refer to the <code>getmempoolinfo</code> RPC help for details.</p>
<p><code>GET /rest/mempool/contents.json?verbose=&lt;true|false&gt;&amp;mempool_sequence=&lt;false|true&gt;</code></p>
<p>Returns the transactions in the mempool.
Only supports JSON as output format.
Refer to the <code>getrawmempool</code> RPC help for details. Defaults to setting
<code>verbose=true</code> and <code>mempool_sequence=false</code>.</p>
<p><em>Query parameters for <code>verbose</code> and <code>mempool_sequence</code> available in 25.0 and up.</em></p>
<h2 id="risks"><a class="header" href="#risks">Risks</a></h2>
<p>Running a web browser on the same node with a REST enabled bitcoind can be a risk. Accessing prepared XSS websites could read out tx/block data of your node by placing links like <code>&lt;script src="http://127.0.0.1:8332/rest/tx/1234567890.json"&gt;</code> which might break the nodes privacy.</p>
<div style="break-before: page; page-break-before: always;"></div><p>The list of assets used in the bitcoin source and their attribution can now be found in <a href="doc/../contrib/debian/copyright">contrib/debian/copyright</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="assumeutxo-usage"><a class="header" href="#assumeutxo-usage">Assumeutxo Usage</a></h1>
<p>Assumeutxo is a feature that allows fast bootstrapping of a validating bitcoind
instance.</p>
<p>For notes on the design of Assumeutxo, please refer to <a href="doc//doc/design/assumeutxo.html">the design doc</a>.</p>
<h2 id="loading-a-snapshot"><a class="header" href="#loading-a-snapshot">Loading a snapshot</a></h2>
<p>There is currently no canonical source for snapshots, but any downloaded snapshot
will be checked against a hash that's been hardcoded in source code. If there is
no source for the snapshot you need, you can generate it yourself using
<code>dumptxoutset</code> on another node that is already synced (see
<a href="doc/assumeutxo.html#generating-a-snapshot">Generating a snapshot</a>).</p>
<p>Once you've obtained the snapshot, you can use the RPC command <code>loadtxoutset</code> to
load it.</p>
<pre><code>$ bitcoin-cli -rpcclienttimeout=0 loadtxoutset /path/to/input
</code></pre>
<p>After the snapshot has loaded, the syncing process of both the snapshot chain
and the background IBD chain can be monitored with the <code>getchainstates</code> RPC.</p>
<h3 id="pruning"><a class="header" href="#pruning">Pruning</a></h3>
<p>A pruned node can load a snapshot. To save space, it's possible to delete the
snapshot file as soon as <code>loadtxoutset</code> finishes.</p>
<p>The minimum <code>-prune</code> setting is 550 MiB, but this functionality ignores that
minimum and uses at least 1100 MiB.</p>
<p>As the background sync continues there will be temporarily two chainstate
directories, each multiple gigabytes in size (likely growing larger than the
downloaded snapshot).</p>
<h3 id="indexes"><a class="header" href="#indexes">Indexes</a></h3>
<p>Indexes work but don't take advantage of this feature. They always start building
from the genesis block and can only apply blocks in order. Once the background
validation reaches the snapshot block, indexes will continue to build all the
way to the tip.</p>
<p>For indexes that support pruning, note that these indexes only allow blocks that
were already indexed to be pruned. Blocks that are not indexed yet will also
not be pruned.</p>
<p>This means that, if the snapshot is old, then a lot of blocks after the snapshot
block will need to be downloaded, and these blocks can't be pruned until they
are indexed, so they could consume a lot of disk space until indexing catches up
to the snapshot block.</p>
<h2 id="generating-a-snapshot"><a class="header" href="#generating-a-snapshot">Generating a snapshot</a></h2>
<p>The RPC command <code>dumptxoutset</code> can be used to generate a snapshot for the current
tip (using type "latest") or a recent height (using type "rollback"). A generated
snapshot from one node can then be loaded
on any other node. However, keep in mind that the snapshot hash needs to be
listed in the chainparams to make it usable. If there is no snapshot hash for
the height you have chosen already, you will need to change the code there and
re-compile.</p>
<p>Using the type parameter "rollback", <code>dumptxoutset</code> can also be used to verify the
hardcoded snapshot hash in the source code by regenerating the snapshot and
comparing the hash.</p>
<p>Example usage:</p>
<pre><code>$ bitcoin-cli -rpcclienttimeout=0 dumptxoutset /path/to/output rollback
</code></pre>
<p>For most of the duration of <code>dumptxoutset</code> running the node is in a temporary
state that does not actually reflect reality, i.e. blocks are marked invalid
although we know they are not invalid. Because of this it is discouraged to
interact with the node in any other way during this time to avoid inconsistent
results and race conditions, particularly RPCs that interact with blockstorage.
This inconsistent state is also why network activity is temporarily disabled,
causing us to disconnect from all peers.</p>
<p><code>dumptxoutset</code> takes some time to complete, independent of hardware and
what parameter is chosen. Because of that it is recommended to increase the RPC
client timeout value (use <code>-rpcclienttimeout=0</code> for no timeout).</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="benchmarking"><a class="header" href="#benchmarking">Benchmarking</a></h1>
<p>Bitcoin Core has an internal benchmarking framework, with benchmarks
for cryptographic algorithms (e.g. SHA1, SHA256, SHA512, RIPEMD160, Poly1305, ChaCha20), rolling bloom filter, coins selection,
thread queue, wallet balance.</p>
<h2 id="running-1"><a class="header" href="#running-1">Running</a></h2>
<p>For benchmarking, you only need to compile <code>bench_bitcoin</code>.  The bench runner
warns if you configure with <code>-DCMAKE_BUILD_TYPE=Debug</code>, but consider if building without
it will impact the benchmark(s) you are interested in by unlatching log printers
and lock analysis.</p>
<pre><code>cmake -B build -DBUILD_BENCH=ON
cmake --build build -t bench_bitcoin
</code></pre>
<p>After compiling bitcoin-core, the benchmarks can be run with:</p>
<pre><code>build/src/bench/bench_bitcoin
</code></pre>
<p>The output will look similar to:</p>
<pre><code>|               ns/op |                op/s |    err% |     total | benchmark
|--------------------:|--------------------:|--------:|----------:|:----------
|       57,927,463.00 |               17.26 |    3.6% |      0.66 | `AddrManAdd`
|          677,816.00 |            1,475.33 |    4.9% |      0.01 | `AddrManGetAddr`

...

|             ns/byte |              byte/s |    err% |     total | benchmark
|--------------------:|--------------------:|--------:|----------:|:----------
|              127.32 |        7,854,302.69 |    0.3% |      0.00 | `Base58CheckEncode`
|               31.95 |       31,303,226.99 |    0.2% |      0.00 | `Base58Decode`

...
</code></pre>
<h2 id="help"><a class="header" href="#help">Help</a></h2>
<pre><code>build/src/bench/bench_bitcoin -h
</code></pre>
<p>To print the various options, like listing the benchmarks without running them
or using a regex filter to only run certain benchmarks.</p>
<h2 id="notes"><a class="header" href="#notes">Notes</a></h2>
<p>More benchmarks are needed for, in no particular order:</p>
<ul>
<li>Script Validation</li>
<li>Coins database</li>
<li>Memory pool</li>
<li>Cuckoo Cache</li>
<li>P2P throughput</li>
</ul>
<h2 id="going-further"><a class="header" href="#going-further">Going Further</a></h2>
<p>To monitor Bitcoin Core performance more in depth (like reindex or IBD): https://github.com/chaincodelabs/bitcoinperf</p>
<p>To generate Flame Graphs for Bitcoin Core: https://github.com/eklitzke/bitcoin/blob/flamegraphs/doc/flamegraphs.md</p>
<div style="break-before: page; page-break-before: always;"></div><p>BIPs that are implemented by Bitcoin Core:</p>
<ul>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0009.mediawiki"><code>BIP 9</code></a>: The changes allowing multiple soft-forks to be deployed in parallel have been implemented since <strong>v0.12.1</strong>  (<a href="https://github.com/bitcoin/bitcoin/pull/7575">PR #7575</a>)</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0011.mediawiki"><code>BIP 11</code></a>: Multisig outputs are standard since <strong>v0.6.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/669">PR #669</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0013.mediawiki"><code>BIP 13</code></a>: The address format for P2SH addresses has been implemented since <strong>v0.6.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/669">PR #669</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0014.mediawiki"><code>BIP 14</code></a>: The subversion string is being used as User Agent since <strong>v0.6.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/669">PR #669</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0016.mediawiki"><code>BIP 16</code></a>: The pay-to-script-hash evaluation rules have been implemented since <strong>v0.6.0</strong>, and took effect on <em>April 1st 2012</em> (<a href="https://github.com/bitcoin/bitcoin/pull/748">PR #748</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0021.mediawiki"><code>BIP 21</code></a>: The URI format for Bitcoin payments has been implemented since <strong>v0.6.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/176">PR #176</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0022.mediawiki"><code>BIP 22</code></a>: The 'getblocktemplate' (GBT) RPC protocol for mining has been implemented since <strong>v0.7.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/936">PR #936</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0023.mediawiki"><code>BIP 23</code></a>: Some extensions to GBT have been implemented since <strong>v0.10.0rc1</strong>, including longpolling and block proposals (<a href="https://github.com/bitcoin/bitcoin/pull/1816">PR #1816</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0030.mediawiki"><code>BIP 30</code></a>: The evaluation rules to forbid creating new transactions with the same txid as previous not-fully-spent transactions were implemented since <strong>v0.6.0</strong>, and the rule took effect on <em>March 15th 2012</em> (<a href="https://github.com/bitcoin/bitcoin/pull/915">PR #915</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0031.mediawiki"><code>BIP 31</code></a>: The 'pong' protocol message (and the protocol version bump to 60001) has been implemented since <strong>v0.6.1</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/1081">PR #1081</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0032.mediawiki"><code>BIP 32</code></a>: Hierarchical Deterministic Wallets has been implemented since <strong>v0.13.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/8035">PR #8035</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0034.mediawiki"><code>BIP 34</code></a>: The rule that requires blocks to contain their height (number) in the coinbase input, and the introduction of version 2 blocks has been implemented since <strong>v0.7.0</strong>. The rule took effect for version 2 blocks as of <em>block 224413</em> (March 5th 2013), and version 1 blocks are no longer allowed since <em>block 227931</em> (March 25th 2013) (<a href="https://github.com/bitcoin/bitcoin/pull/1526">PR #1526</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0035.mediawiki"><code>BIP 35</code></a>: The 'mempool' protocol message (and the protocol version bump to 60002) has been implemented since <strong>v0.7.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/1641">PR #1641</a>). As of <strong>v0.13.0</strong>, this is only available for <code>NODE_BLOOM</code> (BIP 111) peers.</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0037.mediawiki"><code>BIP 37</code></a>: The bloom filtering for transaction relaying, partial Merkle trees for blocks, and the protocol version bump to 70001 (enabling low-bandwidth SPV clients) has been implemented since <strong>v0.8.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/1795">PR #1795</a>). Disabled by default since <strong>v0.19.0</strong>, can be enabled by the <code>-peerbloomfilters</code> option.</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0042.mediawiki"><code>BIP 42</code></a>: The bug that would have caused the subsidy schedule to resume after block 13440000 was fixed in <strong>v0.9.2</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/3842">PR #3842</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0043.mediawiki"><code>BIP 43</code></a>: The experimental descriptor wallets introduced in <strong>v0.21.0</strong> by default use the Hierarchical Deterministic Wallet derivation proposed by BIP 43. (<a href="https://github.com/bitcoin/bitcoin/pull/16528">PR #16528</a>)</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0044.mediawiki"><code>BIP 44</code></a>: The experimental descriptor wallets introduced in <strong>v0.21.0</strong> by default use the Hierarchical Deterministic Wallet derivation proposed by BIP 44. (<a href="https://github.com/bitcoin/bitcoin/pull/16528">PR #16528</a>)</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0049.mediawiki"><code>BIP 49</code></a>: The experimental descriptor wallets introduced in <strong>v0.21.0</strong> by default use the Hierarchical Deterministic Wallet derivation proposed by BIP 49. (<a href="https://github.com/bitcoin/bitcoin/pull/16528">PR #16528</a>)</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0061.mediawiki"><code>BIP 61</code></a>: The 'reject' protocol message (and the protocol version bump to 70002) was added in <strong>v0.9.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/3185">PR #3185</a>). Starting <strong>v0.17.0</strong>, whether to send reject messages can be configured with the <code>-enablebip61</code> option, and support is deprecated (disabled by default) as of <strong>v0.18.0</strong>. Support was removed in <strong>v0.20.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/15437">PR #15437</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0065.mediawiki"><code>BIP 65</code></a>: The CHECKLOCKTIMEVERIFY softfork was merged in <strong>v0.12.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/6351">PR #6351</a>), and backported to <strong>v0.11.2</strong> and <strong>v0.10.4</strong>. Mempool-only CLTV was added in <a href="https://github.com/bitcoin/bitcoin/pull/6124">PR #6124</a>.</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0066.mediawiki"><code>BIP 66</code></a>: The strict DER rules and associated version 3 blocks have been implemented since <strong>v0.10.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/5713">PR #5713</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0068.mediawiki"><code>BIP 68</code></a>: Sequence locks have been implemented as of <strong>v0.12.1</strong>  (<a href="https://github.com/bitcoin/bitcoin/pull/7184">PR #7184</a>), and have been <em>buried</em> since <strong>v0.19.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/16060">PR #16060</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0070.mediawiki"><code>BIP 70</code></a> <a href="https://github.com/bitcoin/bips/blob/master/bip-0071.mediawiki"><code>71</code></a> <a href="https://github.com/bitcoin/bips/blob/master/bip-0072.mediawiki"><code>72</code></a>:
Payment Protocol support has been available in Bitcoin Core GUI since <strong>v0.9.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/5216">PR #5216</a>).
Support can be optionally disabled at build time since <strong>v0.18.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/14451">PR 14451</a>),
and it is disabled by default at build time since <strong>v0.19.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/15584">PR #15584</a>).
It has been removed as of <strong>v0.20.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/17165">PR 17165</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0084.mediawiki"><code>BIP 84</code></a>: The experimental descriptor wallets introduced in <strong>v0.21.0</strong> by default use the Hierarchical Deterministic Wallet derivation proposed by BIP 84. (<a href="https://github.com/bitcoin/bitcoin/pull/16528">PR #16528</a>)</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0086.mediawiki"><code>BIP 86</code></a>: Descriptor wallets by default use the Hierarchical Deterministic Wallet derivation proposed by BIP 86 since <strong>v23.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/22364">PR #22364</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0090.mediawiki"><code>BIP 90</code></a>: Trigger mechanism for activation of BIPs 34, 65, and 66 has been simplified to block height checks since <strong>v0.14.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/8391">PR #8391</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0094.mediawiki"><code>BIP 94</code></a>: Testnet 4 (<code>-testnet4</code>) supported as of <strong>v28.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/29775">PR #29775</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0111.mediawiki"><code>BIP 111</code></a>: <code>NODE_BLOOM</code> service bit added, and enforced for all peer versions as of <strong>v0.13.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/6579">PR #6579</a> and <a href="https://github.com/bitcoin/bitcoin/pull/6641">PR #6641</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0112.mediawiki"><code>BIP 112</code></a>: The CHECKSEQUENCEVERIFY opcode has been implemented since <strong>v0.12.1</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/7524">PR #7524</a>), and has been <em>buried</em> since <strong>v0.19.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/16060">PR #16060</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0113.mediawiki"><code>BIP 113</code></a>: Median time past lock-time calculations have been implemented since <strong>v0.12.1</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/6566">PR #6566</a>), and has been <em>buried</em> since <strong>v0.19.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/16060">PR #16060</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0130.mediawiki"><code>BIP 130</code></a>: direct headers announcement is negotiated with peer versions <code>&gt;=70012</code> as of <strong>v0.12.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/6494">PR 6494</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0133.mediawiki"><code>BIP 133</code></a>: feefilter messages are respected and sent for peer versions <code>&gt;=70013</code> as of <strong>v0.13.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/7542">PR 7542</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0141.mediawiki"><code>BIP 141</code></a>: Segregated Witness (Consensus Layer) as of <strong>v0.13.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/8149">PR 8149</a>), defined for mainnet as of <strong>v0.13.1</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/8937">PR 8937</a>), and <em>buried</em> since <strong>v0.19.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/16060">PR #16060</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0143.mediawiki"><code>BIP 143</code></a>: Transaction Signature Verification for Version 0 Witness Program as of <strong>v0.13.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/8149">PR 8149</a>), defined for mainnet as of <strong>v0.13.1</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/8937">PR 8937</a>), and <em>buried</em> since <strong>v0.19.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/16060">PR #16060</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0144.mediawiki"><code>BIP 144</code></a>: Segregated Witness as of <strong>0.13.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/8149">PR 8149</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0145.mediawiki"><code>BIP 145</code></a>: getblocktemplate updates for Segregated Witness as of <strong>v0.13.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/8149">PR 8149</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0147.mediawiki"><code>BIP 147</code></a>: NULLDUMMY softfork as of <strong>v0.13.1</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/8636">PR 8636</a> and <a href="https://github.com/bitcoin/bitcoin/pull/8937">PR 8937</a>), <em>buried</em> since <strong>v0.19.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/16060">PR #16060</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0152.mediawiki"><code>BIP 152</code></a>: Compact block transfer and related optimizations are used as of <strong>v0.13.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/8068">PR 8068</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0155.mediawiki"><code>BIP 155</code></a>: The 'addrv2' and 'sendaddrv2' messages which enable relay of Tor V3 addresses (and other networks) are supported as of <strong>v0.21.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/19954">PR 19954</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0157.mediawiki"><code>BIP 157</code></a>
<a href="https://github.com/bitcoin/bips/blob/master/bip-0158.mediawiki"><code>158</code></a>: Compact Block Filters for Light Clients can be indexed as of <strong>v0.19.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/14121">PR #14121</a>) and served to peers on the P2P network as of <strong>v0.21.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/16442">PR #16442</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0159.mediawiki"><code>BIP 159</code></a>: The <code>NODE_NETWORK_LIMITED</code> service bit is signalled as of <strong>v0.16.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/11740">PR 11740</a>), and such nodes are connected to as of <strong>v0.17.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/10387">PR 10387</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0173.mediawiki"><code>BIP 173</code></a>: Bech32 addresses for native Segregated Witness outputs are supported as of <strong>v0.16.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/11167">PR 11167</a>). Bech32 addresses are generated by default as of <strong>v0.20.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/16884">PR 16884</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0174.mediawiki"><code>BIP 174</code></a>: RPCs to operate on Partially Signed Bitcoin Transactions (PSBT) are present as of <strong>v0.17.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/13557">PR 13557</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0176.mediawiki"><code>BIP 176</code></a>: Bits Denomination [QT only] is supported as of <strong>v0.16.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/12035">PR 12035</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0324.mediawiki"><code>BIP 324</code></a>: The v2 transport protocol specified by BIP324 and the associated <code>NODE_P2P_V2</code> service bit are supported as of <strong>v26.0</strong>, but off by default (<a href="https://github.com/bitcoin/bitcoin/pull/28331">PR 28331</a>). On by default as of <strong>v27.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/29347">PR 29347</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0325.mediawiki"><code>BIP 325</code></a>: Signet test network is supported as of <strong>v0.21.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/18267">PR 18267</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0339.mediawiki"><code>BIP 339</code></a>: Relay of transactions by wtxid is supported as of <strong>v0.21.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/18044">PR 18044</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0340.mediawiki"><code>BIP 340</code></a>
<a href="https://github.com/bitcoin/bips/blob/master/bip-0341.mediawiki"><code>341</code></a>
<a href="https://github.com/bitcoin/bips/blob/master/bip-0342.mediawiki"><code>342</code></a>:
Validation rules for Taproot (including Schnorr signatures and Tapscript
leaves) are implemented as of <strong>v0.21.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/19953">PR 19953</a>),
with mainnet activation as of <strong>v0.21.1</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/21377">PR 21377</a>,
<a href="https://github.com/bitcoin/bitcoin/pull/21686">PR 21686</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0350.mediawiki"><code>BIP 350</code></a>: Addresses for native v1+ segregated Witness outputs use Bech32m instead of Bech32 as of <strong>v22.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/20861">PR 20861</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0371.mediawiki"><code>BIP 371</code></a>: Taproot fields for PSBT as of <strong>v24.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/22558">PR 22558</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0379.md"><code>BIP 379</code></a>: Miniscript was partially implemented in <strong>v24.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/24148">PR 24148</a>), and fully implemented as of <strong>v26.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/27255">PR 27255</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0380.mediawiki"><code>BIP 380</code></a>
<a href="https://github.com/bitcoin/bips/blob/master/bip-0381.mediawiki"><code>381</code></a>
<a href="https://github.com/bitcoin/bips/blob/master/bip-0382.mediawiki"><code>382</code></a>
<a href="https://github.com/bitcoin/bips/blob/master/bip-0383.mediawiki"><code>383</code></a>
<a href="https://github.com/bitcoin/bips/blob/master/bip-0384.mediawiki"><code>384</code></a>
<a href="https://github.com/bitcoin/bips/blob/master/bip-0385.mediawiki"><code>385</code></a>:
Output Script Descriptors, and most of Script Expressions are implemented as of <strong>v0.17.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/13697">PR 13697</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0386.mediawiki"><code>BIP 386</code></a>: tr() Output Script Descriptors are implemented as of <strong>v22.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/22051">PR 22051</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0387.mediawiki"><code>BIP 387</code></a>: Tapscript Multisig Output Script Descriptors are implemented as of <strong>v24.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/24043">PR 24043</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0431.mediawiki"><code>BIP 431</code></a>: transactions with nVersion=3 are standard and treated as Topologically Restricted Until Confirmation as of <strong>v28.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/29496">PR 29496</a>).</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="bitcoinconf-configuration-file"><a class="header" href="#bitcoinconf-configuration-file"><code>bitcoin.conf</code> Configuration File</a></h1>
<p>The configuration file is used by <code>bitcoind</code>, <code>bitcoin-qt</code> and <code>bitcoin-cli</code>.</p>
<p>All command-line options (except for <code>-?</code>, <code>-help</code>, <code>-version</code> and <code>-conf</code>) may be specified in a configuration file, and all configuration file options (except for <code>includeconf</code>) may also be specified on the command line. Command-line options override values set in the configuration file and configuration file options override values set in the GUI.</p>
<p>Changes to the configuration file while <code>bitcoind</code> or <code>bitcoin-qt</code> is running only take effect after restarting.</p>
<p>Users should never make any configuration changes which they do not understand. Furthermore, users should always be wary of accepting any configuration changes provided to them by another source (even if they believe that they do understand them).</p>
<h2 id="configuration-file-format"><a class="header" href="#configuration-file-format">Configuration File Format</a></h2>
<p>The configuration file is a plain text file and consists of <code>option=value</code> entries, one per line. Leading and trailing whitespaces are removed.</p>
<p>In contrast to the command-line usage:</p>
<ul>
<li>an option must be specified without leading <code>-</code>;</li>
<li>a value of the given option is mandatory; e.g., <code>testnet=1</code> (for chain selection options), <code>noconnect=1</code> (for negated options).</li>
</ul>
<h3 id="blank-lines"><a class="header" href="#blank-lines">Blank lines</a></h3>
<p>Blank lines are allowed and ignored by the parser.</p>
<h3 id="comments"><a class="header" href="#comments">Comments</a></h3>
<p>A comment starts with a number sign (<code>#</code>) and extends to the end of the line. All comments are ignored by the parser.</p>
<p>Comments may appear in two ways:</p>
<ul>
<li>on their own on an otherwise empty line (<em>preferable</em>);</li>
<li>after an <code>option=value</code> entry.</li>
</ul>
<h3 id="network-specific-options"><a class="header" href="#network-specific-options">Network specific options</a></h3>
<p>Network specific options can be:</p>
<ul>
<li>placed into sections with headers <code>[main]</code> (not <code>[mainnet]</code>), <code>[test]</code> (not <code>[testnet]</code>, for testnet3), <code>[testnet4]</code>, <code>[signet]</code> or <code>[regtest]</code>;</li>
<li>prefixed with a chain name; e.g., <code>regtest.maxmempool=100</code>.</li>
</ul>
<p>Network specific options take precedence over non-network specific options.
If multiple values for the same option are found with the same precedence, the
first one is generally chosen.</p>
<p>This means that given the following configuration, <code>regtest.rpcport</code> is set to <code>3000</code>:</p>
<pre><code>regtest=1
rpcport=2000
regtest.rpcport=3000

[regtest]
rpcport=4000
</code></pre>
<h2 id="configuration-file-path"><a class="header" href="#configuration-file-path">Configuration File Path</a></h2>
<p>The configuration file is not automatically created; you can create it using your favorite text editor. By default, the configuration file name is <code>bitcoin.conf</code> and it is located in the Bitcoin data directory, but both the Bitcoin data directory and the configuration file path may be changed using the <code>-datadir</code> and <code>-conf</code> command-line options.</p>
<p>The <code>includeconf=&lt;file&gt;</code> option in the <code>bitcoin.conf</code> file can be used to include additional configuration files.</p>
<h3 id="default-configuration-file-locations"><a class="header" href="#default-configuration-file-locations">Default configuration file locations</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Operating System</th><th>Data Directory</th><th>Example Path</th></tr></thead><tbody>
<tr><td>Windows</td><td><code>%LOCALAPPDATA%\Bitcoin\</code></td><td><code>C:\Users\username\AppData\Local\Bitcoin\bitcoin.conf</code></td></tr>
<tr><td>Linux</td><td><code>$HOME/.bitcoin/</code></td><td><code>/home/username/.bitcoin/bitcoin.conf</code></td></tr>
<tr><td>macOS</td><td><code>$HOME/Library/Application Support/Bitcoin/</code></td><td><code>/Users/username/Library/Application Support/Bitcoin/bitcoin.conf</code></td></tr>
</tbody></table>
</div>
<p>An example configuration file can be generated by <a href="doc/../contrib/devtools/gen-bitcoin-conf.sh">contrib/devtools/gen-bitcoin-conf.sh</a>.
Run this script after compiling to generate an up-to-date configuration file.
The output is placed under <code>share/examples/bitcoin.conf</code>.
To use the generated configuration file, copy the example file into your data directory and edit it there, like so:</p>
<pre><code># example copy command for linux user
cp share/examples/bitcoin.conf ~/.bitcoin
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="freebsd-build-guide"><a class="header" href="#freebsd-build-guide">FreeBSD Build Guide</a></h1>
<p><strong>Updated for FreeBSD <a href="https://www.freebsd.org/releases/14.0R/announce/">14.0</a></strong></p>
<p>This guide describes how to build bitcoind, command-line utilities, and GUI on FreeBSD.</p>
<h2 id="preparation-1"><a class="header" href="#preparation-1">Preparation</a></h2>
<h3 id="1-install-required-dependencies"><a class="header" href="#1-install-required-dependencies">1. Install Required Dependencies</a></h3>
<p>Run the following as root to install the base dependencies for building.</p>
<pre><code class="language-bash">pkg install boost-libs cmake git libevent pkgconf
</code></pre>
<p>See <a href="doc/dependencies.html">dependencies.md</a> for a complete overview.</p>
<h3 id="2-clone-bitcoin-repo"><a class="header" href="#2-clone-bitcoin-repo">2. Clone Bitcoin Repo</a></h3>
<p>Now that <code>git</code> and all the required dependencies are installed, let's clone the Bitcoin Core repository to a directory. All build scripts and commands will run from this directory.</p>
<pre><code class="language-bash">git clone https://github.com/bitcoin/bitcoin.git
</code></pre>
<h3 id="3-install-optional-dependencies"><a class="header" href="#3-install-optional-dependencies">3. Install Optional Dependencies</a></h3>
<h4 id="wallet-dependencies"><a class="header" href="#wallet-dependencies">Wallet Dependencies</a></h4>
<p>It is not necessary to build wallet functionality to run either <code>bitcoind</code> or <code>bitcoin-qt</code>.</p>
<h6 id="descriptor-wallet-support"><a class="header" href="#descriptor-wallet-support">Descriptor Wallet Support</a></h6>
<p><code>sqlite3</code> is required to support <a href="doc/descriptors.html">descriptor wallets</a>.
Skip if you don't intend to use descriptor wallets.</p>
<pre><code class="language-bash">pkg install sqlite3
</code></pre>
<h6 id="legacy-wallet-support"><a class="header" href="#legacy-wallet-support">Legacy Wallet Support</a></h6>
<p>BerkeleyDB is only required if legacy wallet support is required.</p>
<p>It is required to use Berkeley DB 4.8. You <strong>cannot</strong> use the BerkeleyDB library
from ports. However, you can build DB 4.8 yourself <a href="doc//depends">using depends</a>.</p>
<pre><code class="language-bash">pkg install gmake
gmake -C depends NO_BOOST=1 NO_LIBEVENT=1 NO_QT=1 NO_SQLITE=1 NO_ZMQ=1 NO_USDT=1
</code></pre>
<p>When the build is complete, the Berkeley DB installation location will be displayed:</p>
<pre><code>to: /path/to/bitcoin/depends/x86_64-unknown-freebsd[release-number]
</code></pre>
<p>Finally, set <code>BDB_PREFIX</code> to this path according to your shell:</p>
<pre><code>csh: setenv BDB_PREFIX [path displayed above]
</code></pre>
<pre><code>sh/bash: export BDB_PREFIX=[path displayed above]
</code></pre>
<h4 id="gui-dependencies"><a class="header" href="#gui-dependencies">GUI Dependencies</a></h4>
<h6 id="qt5"><a class="header" href="#qt5">Qt5</a></h6>
<p>Bitcoin Core includes a GUI built with the cross-platform Qt Framework. To compile the GUI, we need to install
the necessary parts of Qt, the libqrencode and pass <code>-DBUILD_GUI=ON</code>. Skip if you don't intend to use the GUI.</p>
<pre><code class="language-bash">pkg install qt5-buildtools qt5-core qt5-gui qt5-linguisttools qt5-testlib qt5-widgets
</code></pre>
<h6 id="libqrencode"><a class="header" href="#libqrencode">libqrencode</a></h6>
<p>The GUI will be able to encode addresses in QR codes unless this feature is explicitly disabled. To install libqrencode, run:</p>
<pre><code class="language-bash">pkg install libqrencode
</code></pre>
<p>Otherwise, if you don't need QR encoding support, use the <code>-DWITH_QRENCODE=OFF</code> option to disable this feature in order to compile the GUI.</p>
<hr />
<h4 id="notifications"><a class="header" href="#notifications">Notifications</a></h4>
<h6 id="zeromq"><a class="header" href="#zeromq">ZeroMQ</a></h6>
<p>Bitcoin Core can provide notifications via ZeroMQ. If the package is installed, support will be compiled in.</p>
<pre><code class="language-bash">pkg install libzmq4
</code></pre>
<h4 id="test-suite-dependencies"><a class="header" href="#test-suite-dependencies">Test Suite Dependencies</a></h4>
<p>There is an included test suite that is useful for testing code changes when developing.
To run the test suite (recommended), you will need to have Python 3 installed:</p>
<pre><code class="language-bash">pkg install python3 databases/py-sqlite3
</code></pre>
<hr />
<h2 id="building-bitcoin-core"><a class="header" href="#building-bitcoin-core">Building Bitcoin Core</a></h2>
<h3 id="1-configuration"><a class="header" href="#1-configuration">1. Configuration</a></h3>
<p>There are many ways to configure Bitcoin Core, here are a few common examples:</p>
<h5 id="descriptor-wallet-and-gui"><a class="header" href="#descriptor-wallet-and-gui">Descriptor Wallet and GUI:</a></h5>
<p>This disables legacy wallet support and enables the GUI, assuming <code>sqlite</code> and <code>qt</code> are installed.</p>
<pre><code class="language-bash">cmake -B build -DWITH_BDB=OFF -DBUILD_GUI=ON
</code></pre>
<p>Run <code>cmake -B build -LH</code> to see the full list of available options.</p>
<h5 id="descriptor--legacy-wallet-no-gui"><a class="header" href="#descriptor--legacy-wallet-no-gui">Descriptor &amp; Legacy Wallet. No GUI:</a></h5>
<p>This enables support for both wallet types, assuming
<code>sqlite3</code> and <code>db4</code> are both installed.</p>
<pre><code class="language-bash">cmake -B build -DBerkeleyDB_INCLUDE_DIR:PATH="${BDB_PREFIX}/include" -DWITH_BDB=ON
</code></pre>
<h5 id="no-wallet-or-gui"><a class="header" href="#no-wallet-or-gui">No Wallet or GUI</a></h5>
<pre><code class="language-bash">cmake -B build -DENABLE_WALLET=OFF
</code></pre>
<h3 id="2-compile"><a class="header" href="#2-compile">2. Compile</a></h3>
<pre><code class="language-bash">cmake --build build     # Use "-j N" for N parallel jobs.
ctest --test-dir build  # Use "-j N" for N parallel tests. Some tests are disabled if Python 3 is not available.
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="netbsd-build-guide"><a class="header" href="#netbsd-build-guide">NetBSD Build Guide</a></h1>
<p><strong>Updated for NetBSD <a href="https://netbsd.org/releases/formal-10/NetBSD-10.0.html">10.0</a></strong></p>
<p>This guide describes how to build bitcoind, command-line utilities, and GUI on NetBSD.</p>
<h2 id="preparation-2"><a class="header" href="#preparation-2">Preparation</a></h2>
<h3 id="1-install-required-dependencies-1"><a class="header" href="#1-install-required-dependencies-1">1. Install Required Dependencies</a></h3>
<p>Install the required dependencies the usual way you <a href="https://www.netbsd.org/docs/guide/en/chap-boot.html#chap-boot-pkgsrc">install software on NetBSD</a>.
The example commands below use <code>pkgin</code>.</p>
<pre><code class="language-bash">pkgin install git cmake pkg-config boost-headers libevent
</code></pre>
<p>NetBSD currently ships with an older version of <code>gcc</code> than is needed to build. You should upgrade your <code>gcc</code> and then pass this new version to the configure script.</p>
<p>For example, grab <code>gcc12</code>:</p>
<pre><code>pkgin install gcc12
</code></pre>
<p>Then, when configuring, pass the following:</p>
<pre><code class="language-bash">cmake -B build
    ...
    -DCMAKE_C_COMPILER="/usr/pkg/gcc12/bin/gcc" \
    -DCMAKE_CXX_COMPILER="/usr/pkg/gcc12/bin/g++" \
    ...
</code></pre>
<p>See <a href="doc/dependencies.html">dependencies.md</a> for a complete overview.</p>
<h3 id="2-clone-bitcoin-repo-1"><a class="header" href="#2-clone-bitcoin-repo-1">2. Clone Bitcoin Repo</a></h3>
<p>Clone the Bitcoin Core repository to a directory. All build scripts and commands will run from this directory.</p>
<pre><code class="language-bash">git clone https://github.com/bitcoin/bitcoin.git
</code></pre>
<h3 id="3-install-optional-dependencies-1"><a class="header" href="#3-install-optional-dependencies-1">3. Install Optional Dependencies</a></h3>
<h4 id="wallet-dependencies-1"><a class="header" href="#wallet-dependencies-1">Wallet Dependencies</a></h4>
<p>It is not necessary to build wallet functionality to run bitcoind or the GUI.</p>
<h6 id="descriptor-wallet-support-1"><a class="header" href="#descriptor-wallet-support-1">Descriptor Wallet Support</a></h6>
<p><code>sqlite3</code> is required to enable support for <a href="https://github.com/bitcoin/bitcoin/blob/master/doc/descriptors.md">descriptor wallets</a>.</p>
<pre><code class="language-bash">pkgin install sqlite3
</code></pre>
<h6 id="legacy-wallet-support-1"><a class="header" href="#legacy-wallet-support-1">Legacy Wallet Support</a></h6>
<p><code>db4</code> is required to enable support for legacy wallets.</p>
<pre><code class="language-bash">pkgin install db4
</code></pre>
<h4 id="gui-dependencies-1"><a class="header" href="#gui-dependencies-1">GUI Dependencies</a></h4>
<h6 id="qt5-1"><a class="header" href="#qt5-1">Qt5</a></h6>
<p>Bitcoin Core includes a GUI built with the cross-platform Qt Framework. To compile the GUI, we need to install
the necessary parts of Qt, the libqrencode and pass <code>-DBUILD_GUI=ON</code>. Skip if you don't intend to use the GUI.</p>
<pre><code class="language-bash">pkgin install qt5-qtbase qt5-qttools
</code></pre>
<h6 id="libqrencode-1"><a class="header" href="#libqrencode-1">libqrencode</a></h6>
<p>The GUI will be able to encode addresses in QR codes unless this feature is explicitly disabled. To install libqrencode, run:</p>
<pre><code class="language-bash">pkgin install qrencode
</code></pre>
<p>Otherwise, if you don't need QR encoding support, use the <code>-DWITH_QRENCODE=OFF</code> option to disable this feature in order to compile the GUI.</p>
<h4 id="test-suite-dependencies-1"><a class="header" href="#test-suite-dependencies-1">Test Suite Dependencies</a></h4>
<p>There is an included test suite that is useful for testing code changes when developing.
To run the test suite (recommended), you will need to have Python 3 installed:</p>
<pre><code class="language-bash">pkgin install python39
</code></pre>
<h3 id="building-bitcoin-core-1"><a class="header" href="#building-bitcoin-core-1">Building Bitcoin Core</a></h3>
<h3 id="1-configuration-1"><a class="header" href="#1-configuration-1">1. Configuration</a></h3>
<p>There are many ways to configure Bitcoin Core. Here is an example that
explicitly disables the wallet and GUI:</p>
<pre><code class="language-bash">cmake -B build -DENABLE_WALLET=OFF -DBUILD_GUI=OFF
</code></pre>
<p>Run <code>cmake -B build -LH</code> to see the full list of available options.</p>
<h3 id="2-compile-1"><a class="header" href="#2-compile-1">2. Compile</a></h3>
<p>Build and run the tests:</p>
<pre><code class="language-bash">cmake --build build     # Use "-j N" for N parallel jobs.
ctest --test-dir build  # Use "-j N" for N parallel tests. Some tests are disabled if Python 3 is not available.
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="openbsd-build-guide"><a class="header" href="#openbsd-build-guide">OpenBSD Build Guide</a></h1>
<p><strong>Updated for OpenBSD <a href="https://www.openbsd.org/75.html">7.5</a></strong></p>
<p>This guide describes how to build bitcoind, command-line utilities, and GUI on OpenBSD.</p>
<h2 id="preparation-3"><a class="header" href="#preparation-3">Preparation</a></h2>
<h3 id="1-install-required-dependencies-2"><a class="header" href="#1-install-required-dependencies-2">1. Install Required Dependencies</a></h3>
<p>Run the following as root to install the base dependencies for building.</p>
<pre><code class="language-bash">pkg_add git cmake boost libevent
</code></pre>
<p>See <a href="doc/dependencies.html">dependencies.md</a> for a complete overview.</p>
<h3 id="2-clone-bitcoin-repo-2"><a class="header" href="#2-clone-bitcoin-repo-2">2. Clone Bitcoin Repo</a></h3>
<p>Clone the Bitcoin Core repository to a directory. All build scripts and commands will run from this directory.</p>
<pre><code class="language-bash">git clone https://github.com/bitcoin/bitcoin.git
</code></pre>
<h3 id="3-install-optional-dependencies-2"><a class="header" href="#3-install-optional-dependencies-2">3. Install Optional Dependencies</a></h3>
<h4 id="wallet-dependencies-2"><a class="header" href="#wallet-dependencies-2">Wallet Dependencies</a></h4>
<p>It is not necessary to build wallet functionality to run either <code>bitcoind</code> or <code>bitcoin-qt</code>.</p>
<h6 id="descriptor-wallet-support-2"><a class="header" href="#descriptor-wallet-support-2">Descriptor Wallet Support</a></h6>
<p>SQLite is required to support <a href="doc/descriptors.html">descriptor wallets</a>.</p>
<pre><code class="language-bash">pkg_add sqlite3
</code></pre>
<h6 id="legacy-wallet-support-2"><a class="header" href="#legacy-wallet-support-2">Legacy Wallet Support</a></h6>
<p>BerkeleyDB is only required to support legacy wallets.</p>
<p>It is recommended to use Berkeley DB 4.8. You cannot use the BerkeleyDB library
from ports. However you can build it yourself, <a href="doc//depends">using depends</a>.</p>
<p>Refer to <a href="doc//depends/README.html">depends/README.md</a> for detailed instructions.</p>
<pre><code class="language-bash">gmake -C depends NO_BOOST=1 NO_LIBEVENT=1 NO_QT=1 NO_SQLITE=1 NO_ZMQ=1 NO_USDT=1
...
to: /path/to/bitcoin/depends/*-unknown-openbsd*
</code></pre>
<p>Then set <code>BDB_PREFIX</code>:</p>
<pre><code class="language-bash">export BDB_PREFIX="[path displayed above]"
</code></pre>
<h4 id="gui-dependencies-2"><a class="header" href="#gui-dependencies-2">GUI Dependencies</a></h4>
<h6 id="qt5-2"><a class="header" href="#qt5-2">Qt5</a></h6>
<p>Bitcoin Core includes a GUI built with the cross-platform Qt Framework. To compile the GUI, we need to install
the necessary parts of Qt, the libqrencode and pass <code>-DBUILD_GUI=ON</code>. Skip if you don't intend to use the GUI.</p>
<pre><code class="language-bash">pkg_add qtbase qttools
</code></pre>
<h6 id="libqrencode-2"><a class="header" href="#libqrencode-2">libqrencode</a></h6>
<p>The GUI will be able to encode addresses in QR codes unless this feature is explicitly disabled. To install libqrencode, run:</p>
<pre><code class="language-bash">pkg_add libqrencode
</code></pre>
<p>Otherwise, if you don't need QR encoding support, use the <code>-DWITH_QRENCODE=OFF</code> option to disable this feature in order to compile the GUI.</p>
<hr />
<h4 id="notifications-1"><a class="header" href="#notifications-1">Notifications</a></h4>
<h6 id="zeromq-1"><a class="header" href="#zeromq-1">ZeroMQ</a></h6>
<p>Bitcoin Core can provide notifications via ZeroMQ. If the package is installed, support will be compiled in.</p>
<pre><code class="language-bash">pkg_add zeromq
</code></pre>
<h4 id="test-suite-dependencies-2"><a class="header" href="#test-suite-dependencies-2">Test Suite Dependencies</a></h4>
<p>There is an included test suite that is useful for testing code changes when developing.
To run the test suite (recommended), you will need to have Python 3 installed:</p>
<pre><code class="language-bash">pkg_add python  # Select the newest version of the package.
</code></pre>
<h2 id="building-bitcoin-core-2"><a class="header" href="#building-bitcoin-core-2">Building Bitcoin Core</a></h2>
<h3 id="1-configuration-2"><a class="header" href="#1-configuration-2">1. Configuration</a></h3>
<p>There are many ways to configure Bitcoin Core, here are a few common examples:</p>
<h5 id="descriptor-wallet-and-gui-1"><a class="header" href="#descriptor-wallet-and-gui-1">Descriptor Wallet and GUI:</a></h5>
<p>This enables descriptor wallet support and the GUI, assuming SQLite and Qt 5 are installed.</p>
<pre><code class="language-bash">cmake -B build -DWITH_SQLITE=ON -DBUILD_GUI=ON
</code></pre>
<p>Run <code>cmake -B build -LH</code> to see the full list of available options.</p>
<h5 id="descriptor--legacy-wallet-no-gui-1"><a class="header" href="#descriptor--legacy-wallet-no-gui-1">Descriptor &amp; Legacy Wallet. No GUI:</a></h5>
<p>This enables support for both wallet types:</p>
<pre><code class="language-bash">cmake -B build -DBerkeleyDB_INCLUDE_DIR:PATH="${BDB_PREFIX}/include" -DWITH_BDB=ON
</code></pre>
<h3 id="2-compile-2"><a class="header" href="#2-compile-2">2. Compile</a></h3>
<pre><code class="language-bash">cmake --build build     # Use "-j N" for N parallel jobs.
ctest --test-dir build  # Use "-j N" for N parallel tests. Some tests are disabled if Python 3 is not available.
</code></pre>
<h2 id="resource-limits"><a class="header" href="#resource-limits">Resource limits</a></h2>
<p>If the build runs into out-of-memory errors, the instructions in this section
might help.</p>
<p>The standard ulimit restrictions in OpenBSD are very strict:</p>
<pre><code class="language-bash">data(kbytes)         1572864
</code></pre>
<p>This is, unfortunately, in some cases not enough to compile some <code>.cpp</code> files in the project,
(see issue <a href="https://github.com/bitcoin/bitcoin/issues/6658">#6658</a>).
If your user is in the <code>staff</code> group the limit can be raised with:</p>
<pre><code class="language-bash">ulimit -d 3000000
</code></pre>
<p>The change will only affect the current shell and processes spawned by it. To
make the change system-wide, change <code>datasize-cur</code> and <code>datasize-max</code> in
<code>/etc/login.conf</code>, and reboot.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="macos-build-guide"><a class="header" href="#macos-build-guide">macOS Build Guide</a></h1>
<p><strong>Updated for MacOS <a href="https://www.apple.com/macos/macos-sequoia/">15</a></strong></p>
<p>This guide describes how to build bitcoind, command-line utilities, and GUI on macOS.</p>
<h2 id="preparation-4"><a class="header" href="#preparation-4">Preparation</a></h2>
<p>The commands in this guide should be executed in a Terminal application.
macOS comes with a built-in Terminal located in:</p>
<pre><code class="language-bash">/Applications/Utilities/Terminal.app
</code></pre>
<h3 id="1-xcode-command-line-tools"><a class="header" href="#1-xcode-command-line-tools">1. Xcode Command Line Tools</a></h3>
<p>The Xcode Command Line Tools are a collection of build tools for macOS.
These tools must be installed in order to build Bitcoin Core from source.</p>
<p>To install, run the following command from your terminal:</p>
<pre><code class="language-bash">xcode-select --install
</code></pre>
<p>Upon running the command, you should see a popup appear.
Click on <code>Install</code> to continue the installation process.</p>
<h3 id="2-homebrew-package-manager"><a class="header" href="#2-homebrew-package-manager">2. Homebrew Package Manager</a></h3>
<p>Homebrew is a package manager for macOS that allows one to install packages from the command line easily.
While several package managers are available for macOS, this guide will focus on Homebrew as it is the most popular.
Since the examples in this guide which walk through the installation of a package will use Homebrew, it is recommended that you install it to follow along.
Otherwise, you can adapt the commands to your package manager of choice.</p>
<p>To install the Homebrew package manager, see: https://brew.sh</p>
<p>Note: If you run into issues while installing Homebrew or pulling packages, refer to <a href="https://docs.brew.sh/Troubleshooting">Homebrew's troubleshooting page</a>.</p>
<h3 id="3-install-required-dependencies"><a class="header" href="#3-install-required-dependencies">3. Install Required Dependencies</a></h3>
<p>The first step is to download the required dependencies.
These dependencies represent the packages required to get a barebones installation up and running.</p>
<p>See <a href="doc/dependencies.html">dependencies.md</a> for a complete overview.</p>
<p>To install, run the following from your terminal:</p>
<pre><code class="language-bash">brew install cmake boost pkg-config libevent
</code></pre>
<h3 id="4-clone-bitcoin-repository"><a class="header" href="#4-clone-bitcoin-repository">4. Clone Bitcoin repository</a></h3>
<p><code>git</code> should already be installed by default on your system.
Now that all the required dependencies are installed, let's clone the Bitcoin Core repository to a directory.
All build scripts and commands will run from this directory.</p>
<pre><code class="language-bash">git clone https://github.com/bitcoin/bitcoin.git
</code></pre>
<h3 id="5-install-optional-dependencies"><a class="header" href="#5-install-optional-dependencies">5. Install Optional Dependencies</a></h3>
<h4 id="wallet-dependencies-3"><a class="header" href="#wallet-dependencies-3">Wallet Dependencies</a></h4>
<p>It is not necessary to build wallet functionality to run <code>bitcoind</code> or  <code>bitcoin-qt</code>.</p>
<h6 id="descriptor-wallet-support-3"><a class="header" href="#descriptor-wallet-support-3">Descriptor Wallet Support</a></h6>
<p><code>sqlite</code> is required to support for descriptor wallets.</p>
<p>macOS ships with a useable <code>sqlite</code> package, meaning you don't need to
install anything.</p>
<h6 id="legacy-wallet-support-3"><a class="header" href="#legacy-wallet-support-3">Legacy Wallet Support</a></h6>
<p><code>berkeley-db@4</code> is only required to support for legacy wallets.
Skip if you don't intend to use legacy wallets.</p>
<pre><code class="language-bash">brew install berkeley-db@4
</code></pre>
<hr />
<h4 id="gui-dependencies-3"><a class="header" href="#gui-dependencies-3">GUI Dependencies</a></h4>
<h6 id="qt"><a class="header" href="#qt">Qt</a></h6>
<p>Bitcoin Core includes a GUI built with the cross-platform Qt Framework. To compile the GUI, we need to install
Qt, libqrencode and pass <code>-DBUILD_GUI=ON</code>. Skip if you don't intend to use the GUI.</p>
<pre><code class="language-bash">brew install qt@5
</code></pre>
<p>Note: Building with Qt binaries downloaded from the Qt website is not officially supported.
See the notes in <a href="https://github.com/bitcoin/bitcoin/issues/7714">#7714</a>.</p>
<h6 id="libqrencode-3"><a class="header" href="#libqrencode-3">libqrencode</a></h6>
<p>The GUI will be able to encode addresses in QR codes unless this feature is explicitly disabled. To install libqrencode, run:</p>
<pre><code class="language-bash">brew install qrencode
</code></pre>
<p>Otherwise, if you don't need QR encoding support, you can pass <code>-DWITH_QRENCODE=OFF</code> to disable this feature.</p>
<hr />
<h4 id="zmq-dependencies"><a class="header" href="#zmq-dependencies">ZMQ Dependencies</a></h4>
<p>Support for ZMQ notifications requires the following dependency.
Skip if you do not need ZMQ functionality.</p>
<pre><code class="language-bash">brew install zeromq
</code></pre>
<p>Check out the <a href="doc/build-osx.html#further-configuration">further configuration</a> section for more information.</p>
<p>For more information on ZMQ, see: <a href="doc/zmq.html">zmq.md</a></p>
<hr />
<h4 id="test-suite-dependencies-3"><a class="header" href="#test-suite-dependencies-3">Test Suite Dependencies</a></h4>
<p>There is an included test suite that is useful for testing code changes when developing.
To run the test suite (recommended), you will need to have Python 3 installed:</p>
<pre><code class="language-bash">brew install python
</code></pre>
<hr />
<h4 id="deploy-dependencies"><a class="header" href="#deploy-dependencies">Deploy Dependencies</a></h4>
<p>You can <a href="doc/build-osx.html#3-deploy-optional">deploy</a> a <code>.zip</code> containing the Bitcoin Core application.
It is required that you have <code>python</code> installed.</p>
<h2 id="building-bitcoin-core-3"><a class="header" href="#building-bitcoin-core-3">Building Bitcoin Core</a></h2>
<h3 id="1-configuration-3"><a class="header" href="#1-configuration-3">1. Configuration</a></h3>
<p>There are many ways to configure Bitcoin Core, here are a few common examples:</p>
<h5 id="wallet-bdb--sqlite-support-no-gui"><a class="header" href="#wallet-bdb--sqlite-support-no-gui">Wallet (BDB + SQlite) Support, No GUI:</a></h5>
<p>If <code>berkeley-db@4</code> or <code>sqlite</code> are not installed, this will throw an error.</p>
<pre><code class="language-bash">cmake -B build -DWITH_BDB=ON
</code></pre>
<h5 id="wallet-only-sqlite-and-gui-support"><a class="header" href="#wallet-only-sqlite-and-gui-support">Wallet (only SQlite) and GUI Support:</a></h5>
<p>This enables the GUI.
If <code>sqlite</code> or <code>qt</code> are not installed, this will throw an error.</p>
<pre><code class="language-bash">cmake -B build -DBUILD_GUI=ON
</code></pre>
<h5 id="no-wallet-or-gui-1"><a class="header" href="#no-wallet-or-gui-1">No Wallet or GUI</a></h5>
<pre><code class="language-bash">cmake -B build -DENABLE_WALLET=OFF
</code></pre>
<h5 id="further-configuration"><a class="header" href="#further-configuration">Further Configuration</a></h5>
<p>You may want to dig deeper into the configuration options to achieve your desired behavior.
Examine the output of the following command for a full list of configuration options:</p>
<pre><code class="language-bash">cmake -B build -LH
</code></pre>
<h3 id="2-compile-3"><a class="header" href="#2-compile-3">2. Compile</a></h3>
<p>After configuration, you are ready to compile.
Run the following in your terminal to compile Bitcoin Core:</p>
<pre><code class="language-bash">cmake --build build     # Use "-j N" here for N parallel jobs.
ctest --test-dir build  # Use "-j N" for N parallel tests. Some tests are disabled if Python 3 is not available.
</code></pre>
<h3 id="3-deploy-optional"><a class="header" href="#3-deploy-optional">3. Deploy (optional)</a></h3>
<p>You can also create a  <code>.zip</code> containing the <code>.app</code> bundle by running the following command:</p>
<pre><code class="language-bash">cmake --build build --target deploy
</code></pre>
<h2 id="running-bitcoin-core"><a class="header" href="#running-bitcoin-core">Running Bitcoin Core</a></h2>
<p>Bitcoin Core should now be available at <code>./build/src/bitcoind</code>.
If you compiled support for the GUI, it should be available at <code>./build/src/qt/bitcoin-qt</code>.</p>
<p>The first time you run <code>bitcoind</code> or <code>bitcoin-qt</code>, it will start downloading the blockchain.
This process could take many hours, or even days on slower than average systems.</p>
<p>By default, blockchain and wallet data files will be stored in:</p>
<pre><code class="language-bash">/Users/${USER}/Library/Application Support/Bitcoin/
</code></pre>
<p>Before running, you may create an empty configuration file:</p>
<pre><code class="language-shell">mkdir -p "/Users/${USER}/Library/Application Support/Bitcoin"

touch "/Users/${USER}/Library/Application Support/Bitcoin/bitcoin.conf"

chmod 600 "/Users/${USER}/Library/Application Support/Bitcoin/bitcoin.conf"
</code></pre>
<p>You can monitor the download process by looking at the debug.log file:</p>
<pre><code class="language-shell">tail -f $HOME/Library/Application\ Support/Bitcoin/debug.log
</code></pre>
<h2 id="other-commands"><a class="header" href="#other-commands">Other commands:</a></h2>
<pre><code class="language-shell">./build/src/bitcoind -daemon      # Starts the bitcoin daemon.
./build/src/bitcoin-cli --help    # Outputs a list of command-line options.
./build/src/bitcoin-cli help      # Outputs a list of RPC commands when the daemon is running.
./build/src/qt/bitcoin-qt -server # Starts the bitcoin-qt server mode, allows bitcoin-cli control
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="unix-build-notes"><a class="header" href="#unix-build-notes">UNIX BUILD NOTES</a></h1>
<p>Some notes on how to build Bitcoin Core in Unix.</p>
<p>(For BSD specific instructions, see <code>build-*bsd.md</code> in this directory.)</p>
<h2 id="to-build"><a class="header" href="#to-build">To Build</a></h2>
<pre><code class="language-bash">cmake -B build
cmake --build build    # use "-j N" for N parallel jobs
cmake --install build  # optional
</code></pre>
<p>See below for instructions on how to <a href="doc/build-unix.html#linux-distribution-specific-instructions">install the dependencies on popular Linux
distributions</a>, or the
<a href="doc/build-unix.html#dependencies">dependencies</a> section for a complete overview.</p>
<h2 id="memory-requirements"><a class="header" href="#memory-requirements">Memory Requirements</a></h2>
<p>C++ compilers are memory-hungry. It is recommended to have at least 1.5 GB of
memory available when compiling Bitcoin Core. On systems with less, gcc can be
tuned to conserve memory with additional <code>CMAKE_CXX_FLAGS</code>:</p>
<pre><code>cmake -B build -DCMAKE_CXX_FLAGS="--param ggc-min-expand=1 --param ggc-min-heapsize=32768"
</code></pre>
<p>Alternatively, or in addition, debugging information can be skipped for compilation.
For the default build type <code>RelWithDebInfo</code>, the default compile flags are
<code>-O2 -g</code>, and can be changed with:</p>
<pre><code>cmake -B build -DCMAKE_CXX_FLAGS_RELWITHDEBINFO="-O2 -g0"
</code></pre>
<p>Finally, clang (often less resource hungry) can be used instead of gcc, which is used by default:</p>
<pre><code>cmake -B build -DCMAKE_CXX_COMPILER=clang++ -DCMAKE_C_COMPILER=clang
</code></pre>
<h2 id="linux-distribution-specific-instructions"><a class="header" href="#linux-distribution-specific-instructions">Linux Distribution Specific Instructions</a></h2>
<h3 id="ubuntu--debian"><a class="header" href="#ubuntu--debian">Ubuntu &amp; Debian</a></h3>
<h4 id="dependency-build-instructions"><a class="header" href="#dependency-build-instructions">Dependency Build Instructions</a></h4>
<p>Build requirements:</p>
<pre><code>sudo apt-get install build-essential cmake pkg-config python3
</code></pre>
<p>Now, you can either build from self-compiled <a href="doc/build-unix.html#dependencies">depends</a> or install the required dependencies:</p>
<pre><code>sudo apt-get install libevent-dev libboost-dev
</code></pre>
<p>SQLite is required for the descriptor wallet:</p>
<pre><code>sudo apt install libsqlite3-dev
</code></pre>
<p>Berkeley DB is only required for the legacy wallet. Ubuntu and Debian have their own <code>libdb-dev</code> and <code>libdb++-dev</code> packages,
but these will install Berkeley DB 5.3 or later. This will break binary wallet compatibility with the distributed
executables, which are based on BerkeleyDB 4.8. Otherwise, you can build Berkeley DB <a href="doc/build-unix.html#berkeley-db">yourself</a>.</p>
<p>To build Bitcoin Core without wallet, see <a href="doc/build-unix.html#disable-wallet-mode"><em>Disable-wallet mode</em></a></p>
<p>ZMQ dependencies (provides ZMQ API):</p>
<pre><code>sudo apt-get install libzmq3-dev
</code></pre>
<p>User-Space, Statically Defined Tracing (USDT) dependencies:</p>
<pre><code>sudo apt install systemtap-sdt-dev
</code></pre>
<p>GUI dependencies:</p>
<p>Bitcoin Core includes a GUI built with the cross-platform Qt Framework. To compile the GUI, we need to install
the necessary parts of Qt, the libqrencode and pass <code>-DBUILD_GUI=ON</code>. Skip if you don't intend to use the GUI.</p>
<pre><code>sudo apt-get install qtbase5-dev qttools5-dev qttools5-dev-tools
</code></pre>
<p>Additionally, to support Wayland protocol for modern desktop environments:</p>
<pre><code>sudo apt install qtwayland5
</code></pre>
<p>The GUI will be able to encode addresses in QR codes unless this feature is explicitly disabled. To install libqrencode, run:</p>
<pre><code>sudo apt-get install libqrencode-dev
</code></pre>
<p>Otherwise, if you don't need QR encoding support, use the <code>-DWITH_QRENCODE=OFF</code> option to disable this feature in order to compile the GUI.</p>
<h3 id="fedora"><a class="header" href="#fedora">Fedora</a></h3>
<h4 id="dependency-build-instructions-1"><a class="header" href="#dependency-build-instructions-1">Dependency Build Instructions</a></h4>
<p>Build requirements:</p>
<pre><code>sudo dnf install gcc-c++ cmake make python3
</code></pre>
<p>Now, you can either build from self-compiled <a href="doc/build-unix.html#dependencies">depends</a> or install the required dependencies:</p>
<pre><code>sudo dnf install libevent-devel boost-devel
</code></pre>
<p>SQLite is required for the descriptor wallet:</p>
<pre><code>sudo dnf install sqlite-devel
</code></pre>
<p>Berkeley DB is only required for the legacy wallet. Fedora releases have only <code>libdb-devel</code> and <code>libdb-cxx-devel</code> packages, but these will install
Berkeley DB 5.3 or later. This will break binary wallet compatibility with the distributed executables, which
are based on Berkeley DB 4.8. Otherwise, you can build Berkeley DB <a href="doc/build-unix.html#berkeley-db">yourself</a>.</p>
<p>To build Bitcoin Core without wallet, see <a href="doc/build-unix.html#disable-wallet-mode"><em>Disable-wallet mode</em></a></p>
<p>ZMQ dependencies (provides ZMQ API):</p>
<pre><code>sudo dnf install zeromq-devel
</code></pre>
<p>User-Space, Statically Defined Tracing (USDT) dependencies:</p>
<pre><code>sudo dnf install systemtap-sdt-devel
</code></pre>
<p>GUI dependencies:</p>
<p>Bitcoin Core includes a GUI built with the cross-platform Qt Framework. To compile the GUI, we need to install
the necessary parts of Qt, the libqrencode and pass <code>-DBUILD_GUI=ON</code>. Skip if you don't intend to use the GUI.</p>
<pre><code>sudo dnf install qt5-qttools-devel qt5-qtbase-devel
</code></pre>
<p>Additionally, to support Wayland protocol for modern desktop environments:</p>
<pre><code>sudo dnf install qt5-qtwayland
</code></pre>
<p>The GUI will be able to encode addresses in QR codes unless this feature is explicitly disabled. To install libqrencode, run:</p>
<pre><code>sudo dnf install qrencode-devel
</code></pre>
<p>Otherwise, if you don't need QR encoding support, use the <code>-DWITH_QRENCODE=OFF</code> option to disable this feature in order to compile the GUI.</p>
<h2 id="dependencies"><a class="header" href="#dependencies">Dependencies</a></h2>
<p>See <a href="doc/dependencies.html">dependencies.md</a> for a complete overview, and
<a href="doc//depends/README.html">depends</a> on how to compile them yourself, if you wish to
not use the packages of your Linux distribution.</p>
<h3 id="berkeley-db"><a class="header" href="#berkeley-db">Berkeley DB</a></h3>
<p>The legacy wallet uses Berkeley DB. To ensure backwards compatibility it is
recommended to use Berkeley DB 4.8. If you have to build it yourself, and don't
want to use any other libraries built in depends, you can do:</p>
<pre><code class="language-bash">make -C depends NO_BOOST=1 NO_LIBEVENT=1 NO_QT=1 NO_SQLITE=1 NO_ZMQ=1 NO_USDT=1
...
to: /path/to/bitcoin/depends/x86_64-pc-linux-gnu
</code></pre>
<p>and configure using the following:</p>
<pre><code class="language-bash">export BDB_PREFIX="/path/to/bitcoin/depends/x86_64-pc-linux-gnu"

cmake -B build -DBerkeleyDB_INCLUDE_DIR:PATH="${BDB_PREFIX}/include" -DWITH_BDB=ON
</code></pre>
<p><strong>Note</strong>: Make sure that <code>BDB_PREFIX</code> is an absolute path.</p>
<p><strong>Note</strong>: You only need Berkeley DB if the legacy wallet is enabled (see <a href="doc/build-unix.html#disable-wallet-mode"><em>Disable-wallet mode</em></a>).</p>
<h2 id="disable-wallet-mode"><a class="header" href="#disable-wallet-mode">Disable-wallet mode</a></h2>
<p>When the intention is to only run a P2P node, without a wallet, Bitcoin Core can
be compiled in disable-wallet mode with:</p>
<pre><code>cmake -B build -DENABLE_WALLET=OFF
</code></pre>
<p>In this case there is no dependency on SQLite or Berkeley DB.</p>
<p>Mining is also possible in disable-wallet mode using the <code>getblocktemplate</code> RPC call.</p>
<h2 id="additional-configure-flags"><a class="header" href="#additional-configure-flags">Additional Configure Flags</a></h2>
<p>A list of additional configure flags can be displayed with:</p>
<pre><code>cmake -B build -LH
</code></pre>
<h2 id="setup-and-build-example-arch-linux"><a class="header" href="#setup-and-build-example-arch-linux">Setup and Build Example: Arch Linux</a></h2>
<p>This example lists the steps necessary to setup and build a command line only distribution of the latest changes on Arch Linux:</p>
<pre><code>pacman --sync --needed cmake boost gcc git libevent make python sqlite
git clone https://github.com/bitcoin/bitcoin.git
cd bitcoin/
cmake -B build
cmake --build build
ctest --test-dir build
./build/src/bitcoind
</code></pre>
<p>If you intend to work with legacy Berkeley DB wallets, see <a href="doc/build-unix.html#berkeley-db">Berkeley DB</a> section.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="windows--msvc-build-guide"><a class="header" href="#windows--msvc-build-guide">Windows / MSVC Build Guide</a></h1>
<p>This guide describes how to build bitcoind, command-line utilities, and GUI on Windows using Microsoft Visual Studio.</p>
<p>For cross-compiling options, please see <a href="doc/./build-windows.html"><code>build-windows.md</code></a>.</p>
<h2 id="preparation-5"><a class="header" href="#preparation-5">Preparation</a></h2>
<h3 id="1-visual-studio"><a class="header" href="#1-visual-studio">1. Visual Studio</a></h3>
<p>This guide relies on using CMake and vcpkg package manager provided with the Visual Studio installation.
Here are requirements for the Visual Studio installation:</p>
<ol>
<li>Minimum required version: Visual Studio 2022 version 17.6.</li>
<li>Installed components:</li>
</ol>
<ul>
<li>The "Desktop development with C++" workload.</li>
</ul>
<p>The commands in this guide should be executed in "Developer PowerShell for VS 2022" or "Developer Command Prompt for VS 2022".
The former is assumed hereinafter.</p>
<h3 id="2-git"><a class="header" href="#2-git">2. Git</a></h3>
<p>Download and install <a href="https://git-scm.com/download/win">Git for Windows</a>. Once installed, Git is available from PowerShell or the Command Prompt.</p>
<h3 id="3-clone-bitcoin-repository"><a class="header" href="#3-clone-bitcoin-repository">3. Clone Bitcoin Repository</a></h3>
<p>Clone the Bitcoin Core repository to a directory. All build scripts and commands will run from this directory.</p>
<pre><code>git clone https://github.com/bitcoin/bitcoin.git
</code></pre>
<h2 id="triplets-and-presets"><a class="header" href="#triplets-and-presets">Triplets and Presets</a></h2>
<p>The Bitcoin Core project supports the following vcpkg triplets:</p>
<ul>
<li><code>x64-windows</code> (both CRT and library linkage is dynamic)</li>
<li><code>x64-windows-static</code> (both CRT and library linkage is static)</li>
</ul>
<p>To facilitate build process, the Bitcoin Core project provides presets, which are used in this guide.</p>
<p>Available presets can be listed as follows:</p>
<pre><code>cmake --list-presets
</code></pre>
<p>By default, all presets set <code>BUILD_GUI</code> to <code>ON</code>.</p>
<h2 id="building-2"><a class="header" href="#building-2">Building</a></h2>
<p>CMake will put the resulting object files, libraries, and executables into a dedicated build directory.</p>
<p>In the following instructions, the "Debug" configuration can be specified instead of the "Release" one.</p>
<h3 id="4-building-with-static-linking-with-gui"><a class="header" href="#4-building-with-static-linking-with-gui">4. Building with Static Linking with GUI</a></h3>
<pre><code>cmake -B build --preset vs2022-static          # It might take a while if the vcpkg binary cache is unpopulated or invalidated.
cmake --build build --config Release           # Use "-j N" for N parallel jobs.
ctest --test-dir build --build-config Release  # Use "-j N" for N parallel tests. Some tests are disabled if Python 3 is not available.
cmake --install build --config Release         # Optional.
</code></pre>
<h3 id="5-building-with-dynamic-linking-without-gui"><a class="header" href="#5-building-with-dynamic-linking-without-gui">5. Building with Dynamic Linking without GUI</a></h3>
<pre><code>cmake -B build --preset vs2022 -DBUILD_GUI=OFF # It might take a while if the vcpkg binary cache is unpopulated or invalidated.
cmake --build build --config Release           # Use "-j N" for N parallel jobs.
ctest --test-dir build --build-config Release  # Use "-j N" for N parallel tests. Some tests are disabled if Python 3 is not available.
</code></pre>
<h2 id="performance-notes"><a class="header" href="#performance-notes">Performance Notes</a></h2>
<h3 id="6-vcpkg-manifest-default-features"><a class="header" href="#6-vcpkg-manifest-default-features">6. vcpkg Manifest Default Features</a></h3>
<p>One can skip vcpkg manifest default features to speedup the configuration step.
For example, the following invocation will skip all features except for "wallet" and "tests" and their dependencies:</p>
<pre><code>cmake -B build --preset vs2022 -DVCPKG_MANIFEST_NO_DEFAULT_FEATURES=ON -DVCPKG_MANIFEST_FEATURES="wallet;tests" -DBUILD_GUI=OFF
</code></pre>
<p>Available features are listed in the <a href="doc//vcpkg.json"><code>vcpkg.json</code></a> file.</p>
<h3 id="7-antivirus-software"><a class="header" href="#7-antivirus-software">7. Antivirus Software</a></h3>
<p>To improve the build process performance, one might add the Bitcoin repository directory to the Microsoft Defender Antivirus exclusions.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="windows-build-notes"><a class="header" href="#windows-build-notes">WINDOWS BUILD NOTES</a></h1>
<p>Below are some notes on how to build Bitcoin Core for Windows.</p>
<p>The options known to work for building Bitcoin Core on Windows are:</p>
<ul>
<li>On Linux, using the <a href="https://www.mingw-w64.org/">Mingw-w64</a> cross compiler tool chain.</li>
<li>On Windows, using <a href="https://learn.microsoft.com/en-us/windows/wsl/about">Windows Subsystem for Linux (WSL)</a> and Mingw-w64.</li>
<li>On Windows, using <a href="https://visualstudio.microsoft.com">Microsoft Visual Studio</a>. See <a href="doc/./build-windows-msvc.html"><code>build-windows-msvc.md</code></a>.</li>
</ul>
<p>Other options which may work, but which have not been extensively tested are (please contribute instructions):</p>
<ul>
<li>On Windows, using a POSIX compatibility layer application such as <a href="https://www.cygwin.com/">cygwin</a> or <a href="https://www.msys2.org/">msys2</a>.</li>
</ul>
<p>The instructions below work on Ubuntu and Debian. Make sure the distribution's <code>g++-mingw-w64-x86-64-posix</code>
package meets the minimum required <code>g++</code> version specified in <a href="doc/dependencies.html">dependencies.md</a>.</p>
<h2 id="installing-windows-subsystem-for-linux"><a class="header" href="#installing-windows-subsystem-for-linux">Installing Windows Subsystem for Linux</a></h2>
<p>Follow the upstream installation instructions, available <a href="https://learn.microsoft.com/en-us/windows/wsl/install">here</a>.</p>
<h2 id="cross-compilation-for-ubuntu-and-windows-subsystem-for-linux"><a class="header" href="#cross-compilation-for-ubuntu-and-windows-subsystem-for-linux">Cross-compilation for Ubuntu and Windows Subsystem for Linux</a></h2>
<p>The steps below can be performed on Ubuntu or WSL. The depends system
will also work on other Linux distributions, however the commands for
installing the toolchain will be different.</p>
<p>See <a href="doc/../depends/README.html">README.md</a> in the depends directory for which
dependencies to install and <a href="doc/dependencies.html">dependencies.md</a> for a complete overview.</p>
<p>If you want to build the Windows installer using the <code>deploy</code> build target, you will need <a href="https://nsis.sourceforge.io/Main_Page">NSIS</a>:</p>
<pre><code>apt install nsis
</code></pre>
<p>Acquire the source in the usual way:</p>
<pre><code>git clone https://github.com/bitcoin/bitcoin.git
cd bitcoin
</code></pre>
<p>Note that for WSL the Bitcoin Core source path MUST be somewhere in the default mount file system, for
example /usr/src/bitcoin, AND not under /mnt/d/. If this is not the case the dependency autoconf scripts will fail.
This means you cannot use a directory that is located directly on the host Windows file system to perform the build.</p>
<p>Build using:</p>
<pre><code>gmake -C depends HOST=x86_64-w64-mingw32  # Use "-j N" for N parallel jobs.
cmake -B build --toolchain depends/x86_64-w64-mingw32/toolchain.cmake
cmake --build build     # Use "-j N" for N parallel jobs.
</code></pre>
<h2 id="depends-system"><a class="header" href="#depends-system">Depends system</a></h2>
<p>For further documentation on the depends system see <a href="doc/../depends/README.html">README.md</a> in the depends directory.</p>
<h2 id="installation"><a class="header" href="#installation">Installation</a></h2>
<p>After building using the Windows subsystem it can be useful to copy the compiled
executables to a directory on the Windows drive in the same directory structure
as they appear in the release <code>.zip</code> archive. This can be done in the following
way. This will install to <code>c:\workspace\bitcoin</code>, for example:</p>
<pre><code>cmake --install build --prefix /mnt/c/workspace/bitcoin
</code></pre>
<p>You can also create an installer using:</p>
<pre><code>cmake --build build --target deploy
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="cjdns-support-in-bitcoin-core"><a class="header" href="#cjdns-support-in-bitcoin-core">CJDNS support in Bitcoin Core</a></h1>
<p>It is possible to run Bitcoin Core over CJDNS, an encrypted IPv6 network that
uses public-key cryptography for address allocation and a distributed hash table
for routing.</p>
<h2 id="what-is-cjdns"><a class="header" href="#what-is-cjdns">What is CJDNS?</a></h2>
<p>CJDNS is like a distributed, shared VPN with multiple entry points where every
participant can reach any other participant. All participants use addresses from
the <code>fc00::/8</code> network (reserved IPv6 range). Installation and configuration is
done outside of Bitcoin Core, similarly to a VPN (either in the host/OS or on
the network router). See https://github.com/cjdelisle/cjdns#readme and
https://github.com/hyperboria/docs#hyperboriadocs for more information.</p>
<p>Compared to IPv4/IPv6, CJDNS provides end-to-end encryption and protects nodes
from traffic analysis and filtering.</p>
<p>Used with Tor and I2P, CJDNS is a complementary option that can enhance network
redundancy and robustness for both the Bitcoin network and individual nodes.</p>
<p>Each network has different characteristics. For instance, Tor is widely used but
somewhat centralized. I2P connections have a source address and I2P is slow.
CJDNS is fast but does not hide the sender and the recipient from intermediate
routers.</p>
<h2 id="installing-cjdns-and-finding-a-peer-to-connect-to-the-network"><a class="header" href="#installing-cjdns-and-finding-a-peer-to-connect-to-the-network">Installing CJDNS and finding a peer to connect to the network</a></h2>
<p>To install and set up CJDNS, follow the instructions at
https://github.com/cjdelisle/cjdns#how-to-install-cjdns.</p>
<p>You need to initiate an outbound connection to a peer on the CJDNS network
before it will work with your Bitcoin Core node. This is described in steps
<a href="https://github.com/cjdelisle/cjdns#2-find-a-friend">"2. Find a friend"</a> and
<a href="https://github.com/cjdelisle/cjdns#3-connect-your-node-to-your-friends-node">"3. Connect your node to your friend's
node"</a>
in the CJDNS documentation.</p>
<p>One quick way to accomplish these two steps is to query for available public
peers on <a href="https://github.com/hyperboria">Hyperboria</a> by running the following:</p>
<pre><code>git clone https://github.com/hyperboria/peers hyperboria-peers
cd hyperboria-peers
./testAvailable.py
</code></pre>
<p>For each peer, the <code>./testAvailable.py</code> script prints the filename of the peer's
credentials followed by the ping result.</p>
<p>Choose one or several peers, copy their credentials from their respective files,
paste them into the relevant IPv4 or IPv6 "connectTo" JSON object in the
<code>cjdroute.conf</code> file you created in step <a href="https://github.com/cjdelisle/cjdns#1-generate-a-new-configuration-file">"1. Generate a new configuration
file"</a>,
and save the file.</p>
<h2 id="launching-cjdns"><a class="header" href="#launching-cjdns">Launching CJDNS</a></h2>
<p>Typically, CJDNS might be launched from its directory with
<code>sudo ./cjdroute &lt; cjdroute.conf</code> and it sheds permissions after setting up the
<a href="https://en.wikipedia.org/wiki/TUN/TAP">TUN</a> interface. You may also <a href="https://github.com/cjdelisle/cjdns/blob/master/doc/non-root-user.md">launch it as an
unprivileged user</a>
with some additional setup.</p>
<p>The network connection can be checked by running <code>./tools/peerStats</code> from the
CJDNS directory.</p>
<h2 id="run-bitcoin-core-with-cjdns"><a class="header" href="#run-bitcoin-core-with-cjdns">Run Bitcoin Core with CJDNS</a></h2>
<p>Once you are connected to the CJDNS network, the following Bitcoin Core
configuration option makes CJDNS peers automatically reachable:</p>
<pre><code>-cjdnsreachable
</code></pre>
<p>When enabled, this option tells Bitcoin Core that it is running in an
environment where a connection to an <code>fc00::/8</code> address will be to the CJDNS
network instead of to an <a href="https://datatracker.ietf.org/doc/html/rfc4193">RFC4193</a>
IPv6 local network. This helps Bitcoin Core perform better address management:</p>
<ul>
<li>Your node can consider incoming <code>fc00::/8</code> connections to be from the CJDNS
network rather than from an IPv6 private one.</li>
<li>If one of your node's local addresses is <code>fc00::/8</code>, then it can choose to
gossip that address to peers.</li>
</ul>
<h2 id="additional-configuration-options-related-to-cjdns"><a class="header" href="#additional-configuration-options-related-to-cjdns">Additional configuration options related to CJDNS</a></h2>
<pre><code>-onlynet=cjdns
</code></pre>
<p>Make automatic outbound connections only to CJDNS addresses. Inbound and manual
connections are not affected by this option. It can be specified multiple times
to allow multiple networks, e.g. onlynet=cjdns, onlynet=i2p, onlynet=onion.</p>
<p>CJDNS support was added to Bitcoin Core in version 23.0 and there may be fewer
CJDNS peers than Tor or IP ones. You can use <code>bitcoin-cli -addrinfo</code> to see the
number of CJDNS addresses known to your node.</p>
<p>In general, a node can be run with both an onion service and CJDNS (or any/all
of IPv4/IPv6/onion/I2P/CJDNS), which can provide a potential fallback if one of
the networks has issues. There are a number of ways to configure this; see
<a href="https://github.com/bitcoin/bitcoin/blob/master/doc/tor.md">doc/tor.md</a> for
details.</p>
<h2 id="cjdns-related-information-in-bitcoin-core"><a class="header" href="#cjdns-related-information-in-bitcoin-core">CJDNS-related information in Bitcoin Core</a></h2>
<p>There are several ways to see your CJDNS address in Bitcoin Core:</p>
<ul>
<li>in the "Local addresses" output of CLI <code>-netinfo</code></li>
<li>in the "localaddresses" output of RPC <code>getnetworkinfo</code></li>
</ul>
<p>To see which CJDNS peers your node is connected to, use <code>bitcoin-cli -netinfo 4</code>
or the <code>getpeerinfo</code> RPC (i.e. <code>bitcoin-cli getpeerinfo</code>).</p>
<p>You can use the <code>getnodeaddresses</code> RPC to fetch a number of CJDNS peers known to your node; run <code>bitcoin-cli help getnodeaddresses</code> for details.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="dependencies-1"><a class="header" href="#dependencies-1">Dependencies</a></h1>
<p>These are the dependencies used by Bitcoin Core.
You can find installation instructions in the <code>build-*.md</code> file for your platform.
"Runtime" and "Version Used" are both in reference to the release binaries.</p>
<div class="table-wrapper"><table><thead><tr><th>Dependency</th><th>Minimum required</th></tr></thead><tbody>
<tr><td><a href="https://clang.llvm.org">Clang</a></td><td><a href="https://github.com/bitcoin/bitcoin/pull/30263">16.0</a></td></tr>
<tr><td><a href="https://cmake.org/">CMake</a></td><td><a href="https://github.com/bitcoin/bitcoin/pull/30454">3.22</a></td></tr>
<tr><td><a href="https://gcc.gnu.org">GCC</a></td><td><a href="https://github.com/bitcoin/bitcoin/pull/29091">11.1</a></td></tr>
<tr><td><a href="https://www.python.org">Python</a> (scripts, tests)</td><td><a href="https://github.com/bitcoin/bitcoin/pull/30527">3.10</a></td></tr>
<tr><td><a href="https://sourceware.org/systemtap/">systemtap</a> (<a href="doc/tracing.html">tracing</a>)</td><td>N/A</td></tr>
</tbody></table>
</div>
<h2 id="required"><a class="header" href="#required">Required</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Dependency</th><th>Releases</th><th>Version used</th><th>Minimum required</th><th>Runtime</th></tr></thead><tbody>
<tr><td><a href="doc/../depends/packages/boost.mk">Boost</a></td><td><a href="https://www.boost.org/users/download/">link</a></td><td><a href="https://github.com/bitcoin/bitcoin/pull/26557">1.81.0</a></td><td><a href="https://github.com/bitcoin/bitcoin/pull/29066">1.73.0</a></td><td>No</td></tr>
<tr><td><a href="doc/../depends/packages/libevent.mk">libevent</a></td><td><a href="https://github.com/libevent/libevent/releases">link</a></td><td><a href="https://github.com/bitcoin/bitcoin/pull/21991">2.1.12-stable</a></td><td><a href="https://github.com/bitcoin/bitcoin/pull/24681">2.1.8</a></td><td>No</td></tr>
<tr><td>glibc</td><td><a href="https://www.gnu.org/software/libc/">link</a></td><td>N/A</td><td><a href="https://github.com/bitcoin/bitcoin/pull/29987">2.31</a></td><td>Yes</td></tr>
<tr><td>Linux Kernel</td><td><a href="https://www.kernel.org/">link</a></td><td>N/A</td><td><a href="https://github.com/bitcoin/bitcoin/pull/27699">3.17.0</a></td><td>Yes</td></tr>
</tbody></table>
</div>
<h2 id="optional"><a class="header" href="#optional">Optional</a></h2>
<h3 id="gui-1"><a class="header" href="#gui-1">GUI</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Dependency</th><th>Releases</th><th>Version used</th><th>Minimum required</th><th>Runtime</th></tr></thead><tbody>
<tr><td><a href="doc/../depends/packages/fontconfig.mk">Fontconfig</a></td><td><a href="https://www.freedesktop.org/wiki/Software/fontconfig/">link</a></td><td><a href="https://github.com/bitcoin/bitcoin/pull/23495">2.12.6</a></td><td>2.6</td><td>Yes</td></tr>
<tr><td><a href="doc/../depends/packages/freetype.mk">FreeType</a></td><td><a href="https://freetype.org">link</a></td><td><a href="https://github.com/bitcoin/bitcoin/commit/01544dd78ccc0b0474571da854e27adef97137fb">2.11.0</a></td><td>2.3.0</td><td>Yes</td></tr>
<tr><td><a href="doc/../depends/packages/qrencode.mk">qrencode</a></td><td><a href="https://fukuchi.org/works/qrencode/">link</a></td><td><a href="https://github.com/bitcoin/bitcoin/pull/27312">4.1.1</a></td><td></td><td>No</td></tr>
<tr><td><a href="doc/../depends/packages/qt.mk">Qt</a></td><td><a href="https://download.qt.io/official_releases/qt/">link</a></td><td><a href="https://github.com/bitcoin/bitcoin/pull/30198">5.15.14</a></td><td><a href="https://github.com/bitcoin/bitcoin/pull/24132">5.11.3</a></td><td>No</td></tr>
</tbody></table>
</div>
<h3 id="notifications-2"><a class="header" href="#notifications-2">Notifications</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Dependency</th><th>Releases</th><th>Version used</th><th>Minimum required</th><th>Runtime</th></tr></thead><tbody>
<tr><td><a href="doc/../depends/packages/zeromq.mk">ZeroMQ</a></td><td><a href="https://github.com/zeromq/libzmq/releases">link</a></td><td><a href="https://github.com/bitcoin/bitcoin/pull/23956">4.3.4</a></td><td>4.0.0</td><td>No</td></tr>
</tbody></table>
</div>
<h3 id="wallet-1"><a class="header" href="#wallet-1">Wallet</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Dependency</th><th>Releases</th><th>Version used</th><th>Minimum required</th><th>Runtime</th></tr></thead><tbody>
<tr><td><a href="doc/../depends/packages/bdb.mk">Berkeley DB</a> (legacy wallet)</td><td><a href="https://www.oracle.com/technetwork/database/database-technologies/berkeleydb/downloads/index.html">link</a></td><td>4.8.30</td><td>4.8.x</td><td>No</td></tr>
<tr><td><a href="doc/../depends/packages/sqlite.mk">SQLite</a></td><td><a href="https://sqlite.org">link</a></td><td><a href="https://github.com/bitcoin/bitcoin/pull/25378">3.38.5</a></td><td><a href="https://github.com/bitcoin/bitcoin/pull/19077">3.7.17</a></td><td>No</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="support-for-output-descriptors-in-bitcoin-core"><a class="header" href="#support-for-output-descriptors-in-bitcoin-core">Support for Output Descriptors in Bitcoin Core</a></h1>
<p>Since Bitcoin Core v0.17, there is support for Output Descriptors. This is a
simple language which can be used to describe collections of output scripts.
Supporting RPCs are:</p>
<ul>
<li><code>scantxoutset</code> takes as input descriptors to scan for, and also reports
specialized descriptors for the matching UTXOs.</li>
<li><code>getdescriptorinfo</code> analyzes a descriptor, and reports a canonicalized version
with checksum added.</li>
<li><code>deriveaddresses</code> takes as input a descriptor and computes the corresponding
addresses.</li>
<li><code>listunspent</code> outputs a specialized descriptor for the reported unspent outputs.</li>
<li><code>getaddressinfo</code> outputs a descriptor for solvable addresses (since v0.18).</li>
<li><code>importmulti</code> takes as input descriptors to import into a legacy wallet
(since v0.18).</li>
<li><code>generatetodescriptor</code> takes as input a descriptor and generates coins to it
(<code>regtest</code> only, since v0.19).</li>
<li><code>utxoupdatepsbt</code> takes as input descriptors to add information to the psbt
(since v0.19).</li>
<li><code>createmultisig</code> and <code>addmultisigaddress</code> return descriptors as well (since v0.20).</li>
<li><code>importdescriptors</code> takes as input descriptors to import into a descriptor wallet
(since v0.21).</li>
<li><code>listdescriptors</code> outputs descriptors imported into a descriptor wallet (since v22).</li>
<li><code>scanblocks</code> takes as input descriptors to scan for in blocks and returns the
relevant blockhashes (since v25).</li>
</ul>
<p>This document describes the language. For the specifics on usage, see the RPC
documentation for the functions mentioned above.</p>
<h2 id="features-1"><a class="header" href="#features-1">Features</a></h2>
<p>Output descriptors currently support:</p>
<ul>
<li>Pay-to-pubkey scripts (P2PK), through the <code>pk</code> function.</li>
<li>Pay-to-pubkey-hash scripts (P2PKH), through the <code>pkh</code> function.</li>
<li>Pay-to-witness-pubkey-hash scripts (P2WPKH), through the <code>wpkh</code> function.</li>
<li>Pay-to-script-hash scripts (P2SH), through the <code>sh</code> function.</li>
<li>Pay-to-witness-script-hash scripts (P2WSH), through the <code>wsh</code> function.</li>
<li>Pay-to-taproot outputs (P2TR), through the <code>tr</code> function.</li>
<li>Multisig scripts, through the <code>multi</code> function.</li>
<li>Multisig scripts where the public keys are sorted lexicographically, through the <code>sortedmulti</code> function.</li>
<li>Multisig scripts inside taproot script trees, through the <code>multi_a</code> (and <code>sortedmulti_a</code>) function.</li>
<li>Any type of supported address through the <code>addr</code> function.</li>
<li>Raw hex scripts through the <code>raw</code> function.</li>
<li>Public keys (compressed and uncompressed) in hex notation, or BIP32 extended pubkeys with derivation paths.</li>
</ul>
<h2 id="examples-4"><a class="header" href="#examples-4">Examples</a></h2>
<ul>
<li><code>pk(0279be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798)</code> describes a P2PK output with the specified public key.</li>
<li><code>pkh(02c6047f9441ed7d6d3045406e95c07cd85c778e4b8cef3ca7abac09b95c709ee5)</code> describes a P2PKH output with the specified public key.</li>
<li><code>wpkh(02f9308a019258c31049344f85f89d5229b531c845836f99b08601f113bce036f9)</code> describes a P2WPKH output with the specified public key.</li>
<li><code>sh(wpkh(03fff97bd5755eeea420453a14355235d382f6472f8568a18b2f057a1460297556))</code> describes a P2SH-P2WPKH output with the specified public key.</li>
<li><code>combo(0279be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798)</code> describes any P2PK, P2PKH, P2WPKH, or P2SH-P2WPKH output with the specified public key.</li>
<li><code>sh(wsh(pkh(02e493dbf1c10d80f3581e4904930b1404cc6c13900ee0758474fa94abe8c4cd13)))</code> describes an (overly complicated) P2SH-P2WSH-P2PKH output with the specified public key.</li>
<li><code>multi(1,022f8bde4d1a07209355b4a7250a5c5128e88b84bddc619ab7cba8d569b240efe4,025cbdf0646e5db4eaa398f365f2ea7a0e3d419b7e0330e39ce92bddedcac4f9bc)</code> describes a bare <em>1-of-2</em> multisig output with keys in the specified order.</li>
<li><code>sh(multi(2,022f01e5e15cca351daff3843fb70f3c2f0a1bdd05e5af888a67784ef3e10a2a01,03acd484e2f0c7f65309ad178a9f559abde09796974c57e714c35f110dfc27ccbe))</code> describes a P2SH <em>2-of-2</em> multisig output with keys in the specified order.</li>
<li><code>sh(sortedmulti(2,03acd484e2f0c7f65309ad178a9f559abde09796974c57e714c35f110dfc27ccbe,022f01e5e15cca351daff3843fb70f3c2f0a1bdd05e5af888a67784ef3e10a2a01))</code> describes a P2SH <em>2-of-2</em> multisig output with keys sorted lexicographically in the resulting redeemScript.</li>
<li><code>wsh(multi(2,03a0434d9e47f3c86235477c7b1ae6ae5d3442d49b1943c2b752a68e2a47e247c7,03774ae7f858a9411e5ef4246b70c65aac5649980be5c17891bbec17895da008cb,03d01115d548e7561b15c38f004d734633687cf4419620095bc5b0f47070afe85a))</code> describes a P2WSH <em>2-of-3</em> multisig output with keys in the specified order.</li>
<li><code>sh(wsh(multi(1,03f28773c2d975288bc7d1d205c3748651b075fbc6610e58cddeeddf8f19405aa8,03499fdf9e895e719cfd64e67f07d38e3226aa7b63678949e6e49b241a60e823e4,02d7924d4f7d43ea965a465ae3095ff41131e5946f3c85f79e44adbcf8e27e080e)))</code> describes a P2SH-P2WSH <em>1-of-3</em> multisig output with keys in the specified order.</li>
<li><code>pk(xpub661MyMwAqRbcFtXgS5sYJABqqG9YLmC4Q1Rdap9gSE8NqtwybGhePY2gZ29ESFjqJoCu1Rupje8YtGqsefD265TMg7usUDFdp6W1EGMcet8)</code> describes a P2PK output with the public key of the specified xpub.</li>
<li><code>pkh(xpub68Gmy5EdvgibQVfPdqkBBCHxA5htiqg55crXYuXoQRKfDBFA1WEjWgP6LHhwBZeNK1VTsfTFUHCdrfp1bgwQ9xv5ski8PX9rL2dZXvgGDnw/1/2)</code> describes a P2PKH output with child key <em>1/2</em> of the specified xpub.</li>
<li><code>pkh([d34db33f/44'/0'/0']xpub6ERApfZwUNrhLCkDtcHTcxd75RbzS1ed54G1LkBUHQVHQKqhMkhgbmJbZRkrgZw4koxb5JaHWkY4ALHY2grBGRjaDMzQLcgJvLJuZZvRcEL/1/*)</code> describes a set of P2PKH outputs, but additionally specifies that the specified xpub is a child of a master with fingerprint <code>d34db33f</code>, and derived using path <code>44'/0'/0'</code>.</li>
<li><code>wsh(multi(1,xpub661MyMwAqRbcFW31YEwpkMuc5THy2PSt5bDMsktWQcFF8syAmRUapSCGu8ED9W6oDMSgv6Zz8idoc4a6mr8BDzTJY47LJhkJ8UB7WEGuduB/1/0/*,xpub69H7F5d8KSRgmmdJg2KhpAK8SR3DjMwAdkxj3ZuxV27CprR9LgpeyGmXUbC6wb7ERfvrnKZjXoUmmDznezpbZb7ap6r1D3tgFxHmwMkQTPH/0/0/*))</code> describes a set of <em>1-of-2</em> P2WSH multisig outputs where the first multisig key is the <em>1/0/<code>i</code></em> child of the first specified xpub and the second multisig key is the <em>0/0/<code>i</code></em> child of the second specified xpub, and <code>i</code> is any number in a configurable range (<code>0-1000</code> by default).</li>
<li><code>wsh(sortedmulti(1,xpub661MyMwAqRbcFW31YEwpkMuc5THy2PSt5bDMsktWQcFF8syAmRUapSCGu8ED9W6oDMSgv6Zz8idoc4a6mr8BDzTJY47LJhkJ8UB7WEGuduB/1/0/*,xpub69H7F5d8KSRgmmdJg2KhpAK8SR3DjMwAdkxj3ZuxV27CprR9LgpeyGmXUbC6wb7ERfvrnKZjXoUmmDznezpbZb7ap6r1D3tgFxHmwMkQTPH/0/0/*))</code> describes a set of <em>1-of-2</em> P2WSH multisig outputs where one multisig key is the <em>1/0/<code>i</code></em> child of the first specified xpub and the other multisig key is the <em>0/0/<code>i</code></em> child of the second specified xpub, and <code>i</code> is any number in a configurable range (<code>0-1000</code> by default). The order of public keys in the resulting witnessScripts is determined by the lexicographic order of the public keys at that index.</li>
<li><code>tr(c6047f9441ed7d6d3045406e95c07cd85c778e4b8cef3ca7abac09b95c709ee5,{pk(fff97bd5755eeea420453a14355235d382f6472f8568a18b2f057a1460297556),pk(e493dbf1c10d80f3581e4904930b1404cc6c13900ee0758474fa94abe8c4cd13)})</code> describes a P2TR output with the <code>c6...</code> x-only pubkey as internal key, and two script paths.</li>
<li><code>tr(c6047f9441ed7d6d3045406e95c07cd85c778e4b8cef3ca7abac09b95c709ee5,sortedmulti_a(2,2f8bde4d1a07209355b4a7250a5c5128e88b84bddc619ab7cba8d569b240efe4,5cbdf0646e5db4eaa398f365f2ea7a0e3d419b7e0330e39ce92bddedcac4f9bc))</code> describes a P2TR output with the <code>c6...</code> x-only pubkey as internal key, and a single <code>multi_a</code> script that needs 2 signatures with 2 specified x-only keys, which will be sorted lexicographically.</li>
<li><code>wsh(sortedmulti(2,[6f53d49c/44h/1h/0h]tpubDDjsCRDQ9YzyaAq9rspCfq8RZFrWoBpYnLxK6sS2hS2yukqSczgcYiur8Scx4Hd5AZatxTuzMtJQJhchufv1FRFanLqUP7JHwusSSpfcEp2/0/*,[e6807791/44h/1h/0h]tpubDDAfvogaaAxaFJ6c15ht7Tq6ZmiqFYfrSmZsHu7tHXBgnjMZSHAeHSwhvjARNA6Qybon4ksPksjRbPDVp7yXA1KjTjSd5x18KHqbppnXP1s/0/*,[367c9cfa/44h/1h/0h]tpubDDtPnSgWYk8dDnaDwnof4ehcnjuL5VoUt1eW2MoAed1grPHuXPDnkX1fWMvXfcz3NqFxPbhqNZ3QBdYjLz2hABeM9Z2oqMR1Gt2HHYDoCgh/0/*))#av0kxgw0</code> describes a <em>2-of-3</em> multisig. For brevity, the internal "change" descriptor accompanying the above external "receiving" descriptor is not included here, but it typically differs only in the xpub derivation steps, ending in <code>/1/*</code> for change addresses.</li>
</ul>
<h2 id="reference"><a class="header" href="#reference">Reference</a></h2>
<p>Descriptors consist of several types of expressions. The top level expression is either a <code>SCRIPT</code>, or <code>SCRIPT#CHECKSUM</code> where <code>CHECKSUM</code> is an 8-character alphanumeric descriptor checksum.</p>
<p><code>SCRIPT</code> expressions:</p>
<ul>
<li><code>sh(SCRIPT)</code> (top level only): P2SH embed the argument.</li>
<li><code>wsh(SCRIPT)</code> (top level or inside <code>sh</code> only): P2WSH embed the argument.</li>
<li><code>pk(KEY)</code> (anywhere): P2PK output for the given public key.</li>
<li><code>pkh(KEY)</code> (not inside <code>tr</code>): P2PKH output for the given public key (use <code>addr</code> if you only know the pubkey hash).</li>
<li><code>wpkh(KEY)</code> (top level or inside <code>sh</code> only): P2WPKH output for the given compressed pubkey.</li>
<li><code>combo(KEY)</code> (top level only): an alias for the collection of <code>pk(KEY)</code> and <code>pkh(KEY)</code>. If the key is compressed, it also includes <code>wpkh(KEY)</code> and <code>sh(wpkh(KEY))</code>.</li>
<li><code>multi(k,KEY_1,KEY_2,...,KEY_n)</code> (not inside <code>tr</code>): k-of-n multisig script using OP_CHECKMULTISIG.</li>
<li><code>sortedmulti(k,KEY_1,KEY_2,...,KEY_n)</code> (not inside <code>tr</code>): k-of-n multisig script with keys sorted lexicographically in the resulting script.</li>
<li><code>multi_a(k,KEY_1,KEY_2,...,KEY_N)</code> (only inside <code>tr</code>): k-of-n multisig script using OP_CHECKSIG, OP_CHECKSIGADD, and OP_NUMEQUAL.</li>
<li><code>sortedmulti_a(k,KEY_1,KEY_2,...,KEY_N)</code> (only inside <code>tr</code>): similar to <code>multi_a</code>, but the (x-only) public keys in it will be sorted lexicographically.</li>
<li><code>tr(KEY)</code> or <code>tr(KEY,TREE)</code> (top level only): P2TR output with the specified key as internal key, and optionally a tree of script paths.</li>
<li><code>addr(ADDR)</code> (top level only): the script which ADDR expands to.</li>
<li><code>raw(HEX)</code> (top level only): the script whose hex encoding is HEX.</li>
<li><code>rawtr(KEY)</code> (top level only): P2TR output with the specified key as output key. NOTE: while it's possible to use this to construct wallets, it has several downsides, like being unable to prove no hidden script path exists. Use at your own risk.</li>
</ul>
<p><code>KEY</code> expressions:</p>
<ul>
<li>Optionally, key origin information, consisting of:
<ul>
<li>An open bracket <code>[</code></li>
<li>Exactly 8 hex characters for the fingerprint of the key where the derivation starts (see BIP32 for details)</li>
<li>Followed by zero or more <code>/NUM</code> or <code>/NUM'</code> path elements to indicate unhardened or hardened derivation steps between the fingerprint and the key or xpub/xprv root that follows</li>
<li>A closing bracket <code>]</code></li>
</ul>
</li>
<li>Followed by the actual key, which is either:
<ul>
<li>Hex encoded public keys (either 66 characters starting with <code>02</code> or <code>03</code> for a compressed pubkey, or 130 characters starting with <code>04</code> for an uncompressed pubkey).
<ul>
<li>Inside <code>wpkh</code> and <code>wsh</code>, only compressed public keys are permitted.</li>
<li>Inside <code>tr</code> and <code>rawtr</code>, x-only pubkeys are also permitted (64 hex characters).</li>
</ul>
</li>
<li><a href="https://en.bitcoin.it/wiki/Wallet_import_format">WIF</a> encoded private keys may be specified instead of the corresponding public key, with the same meaning.</li>
<li><code>xpub</code> encoded extended public key or <code>xprv</code> encoded extended private key (as defined in <a href="https://github.com/bitcoin/bips/blob/master/bip-0032.mediawiki">BIP 32</a>).
<ul>
<li>Followed by zero or more <code>/NUM</code> unhardened and <code>/NUM'</code> hardened BIP32 derivation steps.
<ul>
<li>No more than one of these derivation steps may be of the form <code>&lt;NUM;NUM;...;NUM&gt;</code> (including hardened indicators with either or both <code>NUM</code>). If such specifiers are included, the descriptor will be parsed as multiple descriptors where the first descriptor uses all of the first <code>NUM</code> in the pair, and the second descriptor uses the second <code>NUM</code> in the pair for all <code>KEY</code> expressions, and so on.</li>
</ul>
</li>
<li>Optionally followed by a single <code>/*</code> or <code>/*'</code> final step to denote all (direct) unhardened or hardened children.</li>
<li>The usage of hardened derivation steps requires providing the private key.</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>(Anywhere a <code>'</code> suffix is permitted to denote hardened derivation, the suffix <code>h</code> can be used instead.)</p>
<p><code>TREE</code> expressions:</p>
<ul>
<li>any <code>SCRIPT</code> expression</li>
<li>An open brace <code>{</code>, a <code>TREE</code> expression, a comma <code>,</code>, a <code>TREE</code> expression, and a closing brace <code>}</code></li>
</ul>
<p><code>ADDR</code> expressions are any type of supported address:</p>
<ul>
<li>P2PKH addresses (base58, of the form <code>1...</code> for mainnet or <code>[nm]...</code> for testnet). Note that P2PKH addresses in descriptors cannot be used for P2PK outputs (use the <code>pk</code> function instead).</li>
<li>P2SH addresses (base58, of the form <code>3...</code> for mainnet or <code>2...</code> for testnet, defined in <a href="https://github.com/bitcoin/bips/blob/master/bip-0013.mediawiki">BIP 13</a>).</li>
<li>Segwit addresses (bech32 and bech32m, of the form <code>bc1...</code> for mainnet or <code>tb1...</code> for testnet, defined in <a href="https://github.com/bitcoin/bips/blob/master/bip-0173.mediawiki">BIP 173</a> and <a href="https://github.com/bitcoin/bips/blob/master/bip-0350.mediawiki">BIP 350</a>).</li>
</ul>
<h2 id="explanation"><a class="header" href="#explanation">Explanation</a></h2>
<h3 id="single-key-scripts"><a class="header" href="#single-key-scripts">Single-key scripts</a></h3>
<p>Many single-key constructions are used in practice, generally including
P2PK, P2PKH, P2WPKH, and P2SH-P2WPKH. Many more combinations are
imaginable, though they may not be optimal: P2SH-P2PK, P2SH-P2PKH,
P2WSH-P2PK, P2WSH-P2PKH, P2SH-P2WSH-P2PK, P2SH-P2WSH-P2PKH.</p>
<p>To describe these, we model these as functions. The functions <code>pk</code>
(P2PK), <code>pkh</code> (P2PKH) and <code>wpkh</code> (P2WPKH) take as input a <code>KEY</code> expression, and return the
corresponding <em>scriptPubKey</em>. The functions <code>sh</code> (P2SH) and <code>wsh</code> (P2WSH)
take as input a <code>SCRIPT</code> expression, and return the script describing P2SH and P2WSH
outputs with the input as embedded script. The names of the functions do
not contain "p2" for brevity.</p>
<h3 id="multisig"><a class="header" href="#multisig">Multisig</a></h3>
<p>Several pieces of software use multi-signature (multisig) scripts based
on Bitcoin's OP_CHECKMULTISIG opcode. To support these, we introduce the
<code>multi(k,key_1,key_2,...,key_n)</code> and <code>sortedmulti(k,key_1,key_2,...,key_n)</code>
functions. They represent a <em>k-of-n</em>
multisig policy, where any <em>k</em> out of the <em>n</em> provided <code>KEY</code> expressions must
sign.</p>
<p>Key order is significant for <code>multi()</code>. A <code>multi()</code> expression describes a multisig script
with keys in the specified order, and in a search for TXOs, it will not match
outputs with multisig scriptPubKeys that have the same keys in a different
order. Also, to prevent a combinatorial explosion of the search space, if more
than one of the <code>multi()</code> key arguments is a BIP32 wildcard path ending in <code>/*</code>
or <code>*'</code>, the <code>multi()</code> expression only matches multisig scripts with the <code>i</code>th
child key from each wildcard path in lockstep, rather than scripts with any
combination of child keys from each wildcard path.</p>
<p>Key order does not matter for <code>sortedmulti()</code>. <code>sortedmulti()</code> behaves in the same way
as <code>multi()</code> does but the keys are reordered in the resulting script such that they
are lexicographically ordered as described in BIP67.</p>
<h4 id="basic-multisig-example"><a class="header" href="#basic-multisig-example">Basic multisig example</a></h4>
<p>For a good example of a basic M-of-N multisig between multiple participants using descriptor
wallets and PSBTs, as well as a signing flow, see <a href="doc//test/functional/wallet_multisig_descriptor_psbt.py">this functional test</a>.</p>
<p>Disclaimers: It is important to note that this example serves as a quick-start and is kept basic for readability. A downside of the approach
outlined here is that each participant must maintain (and backup) two separate wallets: a signer and the corresponding multisig.
It should also be noted that privacy best-practices are not "by default" here - participants should take care to only use the signer to sign
transactions related to the multisig. Lastly, it is not recommended to use anything other than a Bitcoin Core descriptor wallet to serve as your
signer(s). Other wallets, whether hardware or software, likely impose additional checks and safeguards to prevent users from signing transactions that
could lead to loss of funds, or are deemed security hazards. Conforming to various 3rd-party checks and verifications is not in the scope of this example.</p>
<p>The basic steps are:</p>
<ol>
<li>Every participant generates an xpub. The most straightforward way is to create a new descriptor wallet which we will refer to as
the participant's signer wallet. Avoid reusing this wallet for any purpose other than signing transactions from the
corresponding multisig we are about to create. Hint: extract the wallet's xpubs using <code>listdescriptors</code> and pick the one from the
<code>pkh</code> descriptor since it's least likely to be accidentally reused (legacy addresses)</li>
<li>Create a watch-only descriptor wallet (blank, private keys disabled). Now the multisig is created by importing the external and internal descriptors:
<code>wsh(sortedmulti(&lt;M&gt;,XPUB1/0/*,XPUB2/0/*,â€¦,XPUBN/0/*))</code> and <code>wsh(sortedmulti(&lt;M&gt;,XPUB1/1/*,XPUB2/1/*,â€¦,XPUBN/1/*))</code>
(one descriptor w/ <code>0</code> for receiving addresses and another w/ <code>1</code> for change). Every participant does this. All key origin information (master key fingerprint and all derivation steps) should be included with xpubs for proper support of hardware devices / external signers</li>
<li>A receiving address is generated for the multisig. As a check to ensure step 2 was done correctly, every participant
should verify they get the same addresses</li>
<li>Funds are sent to the resulting address</li>
<li>A sending transaction from the multisig is created using <code>walletcreatefundedpsbt</code> (anyone can initiate this). It is simple to do
this in the GUI by going to the <code>Send</code> tab in the multisig wallet and creating an unsigned transaction (PSBT)</li>
<li>At least <code>M</code> participants check the PSBT with their multisig using <code>decodepsbt</code> to verify the transaction is OK before signing it.</li>
<li>(If OK) the participant signs the PSBT with their signer wallet using <code>walletprocesspsbt</code>. It is simple to do this in the GUI by
loading the PSBT from file and signing it</li>
<li>The signed PSBTs are collected with <code>combinepsbt</code>, finalized w/ <code>finalizepsbt</code>, and then the resulting transaction is broadcasted
to the network. Note that any wallet (eg one of the signers or multisig) is capable of doing this.</li>
<li>Checks that balances are correct after the transaction has been included in a block</li>
</ol>
<p>You may prefer a daisy chained signing flow where each participant signs the PSBT one after another until
the PSBT has been signed <code>M</code> times and is "complete." For the most part, the steps above remain the same, except (6, 7)
change slightly from signing the original PSBT in parallel to signing it in series. <code>combinepsbt</code> is not necessary with
this signing flow and the last (<code>m</code>th) signer can just broadcast the PSBT after signing. Note that a parallel signing flow may be
preferable in cases where there are more signers. This signing flow is also included in the test / Python example.
<a href="doc//test/functional/wallet_multisig_descriptor_psbt.py">The test</a> is meant to be documentation as much as it is a functional test, so
it is kept as simple and readable as possible.</p>
<h3 id="bip32-derived-keys-and-chains"><a class="header" href="#bip32-derived-keys-and-chains">BIP32 derived keys and chains</a></h3>
<p>Most modern wallet software and hardware uses keys that are derived using
BIP32 ("HD keys"). We support these directly by permitting strings
consisting of an extended public key (commonly referred to as an <em>xpub</em>)
plus derivation path anywhere a public key is expected. The derivation
path consists of a sequence of 0 or more integers (in the range
<em>0..2<sup>31</sup>-1</em>) each optionally followed by <code>'</code> or <code>h</code>, and
separated by <code>/</code> characters. The string may optionally end with the
literal <code>/*</code> or <code>/*'</code> (or <code>/*h</code>) to refer to all unhardened or hardened
child keys in a configurable range (by default <code>0-1000</code>, inclusive).</p>
<p>Whenever a public key is described using a hardened derivation step, the
script cannot be computed without access to the corresponding private
key.</p>
<h3 id="key-origin-identification"><a class="header" href="#key-origin-identification">Key origin identification</a></h3>
<p>In order to describe scripts whose signing keys reside on another device,
it may be necessary to identify the master key and derivation path an
xpub was derived with.</p>
<p>For example, when following BIP44, it would be useful to describe a
change chain directly as <code>xpub.../44'/0'/0'/1/*</code> where <code>xpub...</code>
corresponds with the master key <code>m</code>. Unfortunately, since there are
hardened derivation steps that follow the xpub, this descriptor does not
let you compute scripts without access to the corresponding private keys.
Instead, it should be written as <code>xpub.../1/*</code>, where xpub corresponds to
<code>m/44'/0'/0'</code>.</p>
<p>When interacting with a hardware device, it may be necessary to include
the entire path from the master down. <a href="https://github.com/bitcoin/bips/blob/master/bip-0174.mediawiki">BIP174</a> standardizes this by
providing the master key <em>fingerprint</em> (first 32 bit of the Hash160 of
the master pubkey), plus all derivation steps. To support constructing
these, we permit providing this key origin information inside the
descriptor language, even though it does not affect the actual
scriptPubKeys it refers to.</p>
<p>Every public key can be prefixed by an 8-character hexadecimal
fingerprint plus optional derivation steps (hardened and unhardened)
surrounded by brackets, identifying the master and derivation path the key or xpub
that follows was derived with.</p>
<p>Note that the fingerprint of the parent only serves as a fast way to detect
parent and child nodes in software, and software must be willing to deal with
collisions.</p>
<h3 id="including-private-keys"><a class="header" href="#including-private-keys">Including private keys</a></h3>
<p>Often it is useful to communicate a description of scripts along with the
necessary private keys. For this reason, anywhere a public key or xpub is
supported, a private key in WIF format or xprv may be provided instead.
This is useful when private keys are necessary for hardened derivation
steps, for signing transactions, or for dumping wallet descriptors
including private key material.</p>
<p>For example, after importing the following 2-of-3 multisig descriptor
into a wallet, one could use <code>signrawtransactionwithwallet</code>
to sign a transaction with the first key:</p>
<pre><code>sh(multi(2,xprv.../84'/0'/0'/0/0,xpub1...,xpub2...))
</code></pre>
<p>Note how the first key is an xprv private key with a specific derivation path,
while the other two are public keys.</p>
<h3 id="specifying-receiving-and-change-descriptors-in-one-descriptor"><a class="header" href="#specifying-receiving-and-change-descriptors-in-one-descriptor">Specifying receiving and change descriptors in one descriptor</a></h3>
<p>Since receiving and change addresses are frequently derived from the same
extended key(s) but with a single derivation index changed, it is convenient
to be able to specify a descriptor that can derive at the two different
indexes. Thus a single tuple of indexes is allowed in each derivation path
following the extended key. When this descriptor is parsed, multiple descriptors
will be produced, the first one will use the first index in the tuple for all
key expressions, the second will use the second index, the third will use the
third index, and so on..</p>
<p>For example, a descriptor of the form:</p>
<pre><code>multi(2,xpub.../&lt;0;1;2&gt;/0/*,xpub.../&lt;2;3;4&gt;/*)
</code></pre>
<p>will expand to the two descriptors</p>
<p>multi(2,xpub.../0/0/<em>,xpub.../2/</em>)
multi(2,xpub.../1/0/<em>,xpub.../3/</em>)
multi(2,xpub.../2/0/<em>,xpub.../4</em>)</p>
<p>When this tuple contains only two elements, wallet implementations can use the
first descriptor for receiving addresses and the second descriptor for change addresses.</p>
<h3 id="compatibility-with-old-wallets"><a class="header" href="#compatibility-with-old-wallets">Compatibility with old wallets</a></h3>
<p>In order to easily represent the sets of scripts currently supported by
existing Bitcoin Core wallets, a convenience function <code>combo</code> is
provided, which takes as input a public key, and describes a set of P2PK,
P2PKH, P2WPKH, and P2SH-P2WPKH scripts for that key. In case the key is
uncompressed, the set only includes P2PK and P2PKH scripts.</p>
<h3 id="checksums"><a class="header" href="#checksums">Checksums</a></h3>
<p>Descriptors can optionally be suffixed with a checksum to protect against
typos or copy-paste errors.</p>
<p>These checksums consist of 8 alphanumeric characters. As long as errors are
restricted to substituting characters in <code>0123456789()[],'/*abcdefgh@:$%{}</code>
for others in that set and changes in letter case, up to 4 errors will always
be detected in descriptors up to 501 characters, and up to 3 errors in longer
ones. For larger numbers of errors, or other types of errors, there is a
roughly 1 in a trillion chance of not detecting the errors.</p>
<p>All RPCs in Bitcoin Core will include the checksum in their output. Only
certain RPCs require checksums on input, including <code>deriveaddresses</code> and
<code>importmulti</code>. The checksum for a descriptor without one can be computed
using the <code>getdescriptorinfo</code> RPC.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="developer-notes"><a class="header" href="#developer-notes">Developer Notes</a></h1>
<!-- markdown-toc start -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="doc/developer-notes.html#developer-notes">Developer Notes</a>
<ul>
<li><a href="doc/developer-notes.html#coding-style-general">Coding Style (General)</a></li>
<li><a href="doc/developer-notes.html#coding-style-c">Coding Style (C++)</a></li>
<li><a href="doc/developer-notes.html#coding-style-python">Coding Style (Python)</a></li>
<li><a href="doc/developer-notes.html#coding-style-doxygen-compatible-comments">Coding Style (Doxygen-compatible comments)</a>
<ul>
<li><a href="doc/developer-notes.html#generating-documentation">Generating Documentation</a></li>
</ul>
</li>
<li><a href="doc/developer-notes.html#development-tips-and-tricks">Development tips and tricks</a>
<ul>
<li><a href="doc/developer-notes.html#compiling-for-debugging">Compiling for debugging</a></li>
<li><a href="doc/developer-notes.html#show-sources-in-debugging">Show sources in debugging</a></li>
<li><a href="doc/developer-notes.html#debuglog"><code>debug.log</code></a></li>
<li><a href="doc/developer-notes.html#signet-testnet-and-regtest-modes">Signet, testnet, and regtest modes</a></li>
<li><a href="doc/developer-notes.html#debug_lockorder">DEBUG_LOCKORDER</a></li>
<li><a href="doc/developer-notes.html#debug_lockcontention">DEBUG_LOCKCONTENTION</a></li>
<li><a href="doc/developer-notes.html#valgrind-suppressions-file">Valgrind suppressions file</a></li>
<li><a href="doc/developer-notes.html#compiling-for-test-coverage">Compiling for test coverage</a></li>
<li><a href="doc/developer-notes.html#performance-profiling-with-perf">Performance profiling with perf</a></li>
<li><a href="doc/developer-notes.html#sanitizers">Sanitizers</a></li>
</ul>
</li>
<li><a href="doc/developer-notes.html#lockingmutex-usage-notes">Locking/mutex usage notes</a></li>
<li><a href="doc/developer-notes.html#threads">Threads</a></li>
<li><a href="doc/developer-notes.html#ignoring-ideeditor-files">Ignoring IDE/editor files</a></li>
</ul>
</li>
<li><a href="doc/developer-notes.html#development-guidelines">Development guidelines</a>
<ul>
<li><a href="doc/developer-notes.html#general-bitcoin-core">General Bitcoin Core</a></li>
<li><a href="doc/developer-notes.html#wallet">Wallet</a></li>
<li><a href="doc/developer-notes.html#general-c">General C++</a></li>
<li><a href="doc/developer-notes.html#c-data-structures">C++ data structures</a></li>
<li><a href="doc/developer-notes.html#strings-and-formatting">Strings and formatting</a></li>
<li><a href="doc/developer-notes.html#shadowing">Shadowing</a></li>
<li><a href="doc/developer-notes.html#lifetimebound">Lifetimebound</a></li>
<li><a href="doc/developer-notes.html#threads-and-synchronization">Threads and synchronization</a></li>
<li><a href="doc/developer-notes.html#scripts">Scripts</a>
<ul>
<li><a href="doc/developer-notes.html#shebang">Shebang</a></li>
</ul>
</li>
<li><a href="doc/developer-notes.html#source-code-organization">Source code organization</a></li>
<li><a href="doc/developer-notes.html#gui">GUI</a></li>
<li><a href="doc/developer-notes.html#subtrees">Subtrees</a></li>
<li><a href="doc/developer-notes.html#upgrading-leveldb">Upgrading LevelDB</a>
<ul>
<li><a href="doc/developer-notes.html#file-descriptor-counts">File Descriptor Counts</a></li>
<li><a href="doc/developer-notes.html#consensus-compatibility">Consensus Compatibility</a></li>
</ul>
</li>
<li><a href="doc/developer-notes.html#scripted-diffs">Scripted diffs</a>
<ul>
<li><a href="doc/developer-notes.html#suggestions-and-examples">Suggestions and examples</a></li>
</ul>
</li>
<li><a href="doc/developer-notes.html#release-notes">Release notes</a></li>
<li><a href="doc/developer-notes.html#rpc-interface-guidelines">RPC interface guidelines</a></li>
<li><a href="doc/developer-notes.html#internal-interface-guidelines">Internal interface guidelines</a></li>
</ul>
</li>
</ul>
<!-- markdown-toc end -->
<h2 id="coding-style-general"><a class="header" href="#coding-style-general">Coding Style (General)</a></h2>
<p>Various coding styles have been used during the history of the codebase,
and the result is not very consistent. However, we're now trying to converge to
a single style, which is specified below. When writing patches, favor the new
style over attempting to mimic the surrounding style, except for move-only
commits.</p>
<p>Do not submit patches solely to modify the style of existing code.</p>
<h2 id="coding-style-c"><a class="header" href="#coding-style-c">Coding Style (C++)</a></h2>
<ul>
<li>
<p><strong>Indentation and whitespace rules</strong> as specified in
<a href="doc//src/.clang-format">src/.clang-format</a>. You can use the provided
<a href="doc//contrib/devtools/README.html#clang-format-diffpy">clang-format-diff script</a>
tool to clean up patches automatically before submission.</p>
<ul>
<li>Braces on new lines for classes, functions, methods.</li>
<li>Braces on the same line for everything else.</li>
<li>4 space indentation (no tabs) for every block except namespaces.</li>
<li>No indentation for <code>public</code>/<code>protected</code>/<code>private</code> or for <code>namespace</code>.</li>
<li>No extra spaces inside parenthesis; don't do <code>( this )</code>.</li>
<li>No space after function names; one space after <code>if</code>, <code>for</code> and <code>while</code>.</li>
<li>If an <code>if</code> only has a single-statement <code>then</code>-clause, it can appear
on the same line as the <code>if</code>, without braces. In every other case,
braces are required, and the <code>then</code> and <code>else</code> clauses must appear
correctly indented on a new line.</li>
<li>There's no hard limit on line width, but prefer to keep lines to &lt;100
characters if doing so does not decrease readability. Break up long
function declarations over multiple lines using the Clang Format
<a href="https://clang.llvm.org/docs/ClangFormatStyleOptions.html">AlignAfterOpenBracket</a>
style option.</li>
</ul>
</li>
<li>
<p><strong>Symbol naming conventions</strong>. These are preferred in new code, but are not
required when doing so would need changes to significant pieces of existing
code.</p>
<ul>
<li>
<p>Variable (including function arguments) and namespace names are all lowercase and may use <code>_</code> to
separate words (snake_case).</p>
<ul>
<li>Class member variables have a <code>m_</code> prefix.</li>
<li>Global variables have a <code>g_</code> prefix.</li>
</ul>
</li>
<li>
<p>Constant names are all uppercase, and use <code>_</code> to separate words.</p>
</li>
<li>
<p>Enumerator constants may be <code>snake_case</code>, <code>PascalCase</code> or <code>ALL_CAPS</code>.
This is a more tolerant policy than the <a href="https://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#Renum-caps">C++ Core
Guidelines</a>,
which recommend using <code>snake_case</code>.  Please use what seems appropriate.</p>
</li>
<li>
<p>Class names, function names, and method names are UpperCamelCase
(PascalCase). Do not prefix class names with <code>C</code>. See <a href="doc/developer-notes.html#internal-interface-naming-style">Internal interface
naming style</a> for an exception to this
convention.</p>
</li>
<li>
<p>Test suite naming convention: The Boost test suite in file
<code>src/test/foo_tests.cpp</code> should be named <code>foo_tests</code>. Test suite names
must be unique.</p>
</li>
</ul>
</li>
<li>
<p><strong>Miscellaneous</strong></p>
<ul>
<li><code>++i</code> is preferred over <code>i++</code>.</li>
<li><code>nullptr</code> is preferred over <code>NULL</code> or <code>(void*)0</code>.</li>
<li><code>static_assert</code> is preferred over <code>assert</code> where possible. Generally; compile-time checking is preferred over run-time checking.</li>
<li>Use a named cast or functional cast, not a C-Style cast. When casting
between integer types, use functional casts such as <code>int(x)</code> or <code>int{x}</code>
instead of <code>(int) x</code>. When casting between more complex types, use <code>static_cast</code>.
Use <code>reinterpret_cast</code> and <code>const_cast</code> as appropriate.</li>
<li>Prefer <a href="https://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#Res-list"><code>list initialization ({})</code></a> where possible.
For example <code>int x{0};</code> instead of <code>int x = 0;</code> or <code>int x(0);</code></li>
<li>Recursion is checked by clang-tidy and thus must be made explicit. Use
<code>NOLINTNEXTLINE(misc-no-recursion)</code> to suppress the check.</li>
</ul>
</li>
</ul>
<p>For function calls a namespace should be specified explicitly, unless such functions have been declared within it.
Otherwise, <a href="https://en.cppreference.com/w/cpp/language/adl">argument-dependent lookup</a>, also known as ADL, could be
triggered that makes code harder to maintain and reason about:</p>
<pre><code class="language-c++">#include &lt;filesystem&gt;

namespace fs {
class path : public std::filesystem::path
{
};
// The intention is to disallow this function.
bool exists(const fs::path&amp; p) = delete;
} // namespace fs

int main()
{
    //fs::path p; // error
    std::filesystem::path p; // compiled
    exists(p); // ADL being used for unqualified name lookup
}
</code></pre>
<p>Block style example:</p>
<pre><code class="language-c++">int g_count{0};

namespace foo {
class Class
{
    std::string m_name;

public:
    bool Function(const std::string&amp; s, int n)
    {
        // Comment summarising what this section of code does
        for (int i = 0; i &lt; n; ++i) {
            int total_sum{0};
            // When something fails, return early
            if (!Something()) return false;
            ...
            if (SomethingElse(i)) {
                total_sum += ComputeSomething(g_count);
            } else {
                DoSomething(m_name, total_sum);
            }
        }

        // Success return is usually at the end
        return true;
    }
}
} // namespace foo
</code></pre>
<h2 id="coding-style-c-functions-and-methods"><a class="header" href="#coding-style-c-functions-and-methods">Coding Style (C++ functions and methods)</a></h2>
<ul>
<li>
<p>When ordering function parameters, place input parameters first, then any
in-out parameters, followed by any output parameters.</p>
</li>
<li>
<p><em>Rationale</em>: API consistency.</p>
</li>
<li>
<p>Prefer returning values directly to using in-out or output parameters. Use
<code>std::optional</code> where helpful for returning values.</p>
</li>
<li>
<p><em>Rationale</em>: Less error-prone (no need for assumptions about what the output
is initialized to on failure), easier to read, and often the same or better
performance.</p>
</li>
<li>
<p>Generally, use <code>std::optional</code> to represent optional by-value inputs (and
instead of a magic default value, if there is no real default). Non-optional
input parameters should usually be values or const references, while
non-optional in-out and output parameters should usually be references, as
they cannot be null.</p>
</li>
</ul>
<h2 id="coding-style-c-named-arguments"><a class="header" href="#coding-style-c-named-arguments">Coding Style (C++ named arguments)</a></h2>
<p>When passing named arguments, use a format that clang-tidy understands. The
argument names can otherwise not be verified by clang-tidy.</p>
<p>For example:</p>
<pre><code class="language-c++">void function(Addrman&amp; addrman, bool clear);

int main()
{
    function(g_addrman, /*clear=*/false);
}
</code></pre>
<h3 id="running-clang-tidy"><a class="header" href="#running-clang-tidy">Running clang-tidy</a></h3>
<p>To run clang-tidy on Ubuntu/Debian, install the dependencies:</p>
<pre><code class="language-sh">apt install clang-tidy clang
</code></pre>
<p>Configure with clang as the compiler:</p>
<pre><code class="language-sh">cmake -B build -DCMAKE_C_COMPILER=clang -DCMAKE_CXX_COMPILER=clang++ -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
cmake --build build -j $(nproc)
</code></pre>
<p>The output is denoised of errors from external dependencies.</p>
<p>To run clang-tidy on all source files:</p>
<pre><code class="language-sh">( cd ./src/ &amp;&amp; run-clang-tidy -p ../build -j $(nproc) )
</code></pre>
<p>To run clang-tidy on the changed source lines:</p>
<pre><code class="language-sh">git diff | ( cd ./src/ &amp;&amp; clang-tidy-diff -p2 -path ../build -j $(nproc) )
</code></pre>
<h2 id="coding-style-python"><a class="header" href="#coding-style-python">Coding Style (Python)</a></h2>
<p>Refer to <a href="doc//test/functional/README.html#style-guidelines">/test/functional/README.md#style-guidelines</a>.</p>
<h2 id="coding-style-doxygen-compatible-comments"><a class="header" href="#coding-style-doxygen-compatible-comments">Coding Style (Doxygen-compatible comments)</a></h2>
<p>Bitcoin Core uses <a href="https://www.doxygen.nl/">Doxygen</a> to generate its official documentation.</p>
<p>Use Doxygen-compatible comment blocks for functions, methods, and fields.</p>
<p>For example, to describe a function use:</p>
<pre><code class="language-c++">/**
 * ... Description ...
 *
 * @param[in]  arg1 input description...
 * @param[in]  arg2 input description...
 * @param[out] arg3 output description...
 * @return Return cases...
 * @throws Error type and cases...
 * @pre  Pre-condition for function...
 * @post Post-condition for function...
 */
bool function(int arg1, const char *arg2, std::string&amp; arg3)
</code></pre>
<p>A complete list of <code>@xxx</code> commands can be found at https://www.doxygen.nl/manual/commands.html.
As Doxygen recognizes the comments by the delimiters (<code>/**</code> and <code>*/</code> in this case), you don't
<em>need</em> to provide any commands for a comment to be valid; just a description text is fine.</p>
<p>To describe a class, use the same construct above the class definition:</p>
<pre><code class="language-c++">/**
 * Alerts are for notifying old versions if they become too obsolete and
 * need to upgrade. The message is displayed in the status bar.
 * @see GetWarnings()
 */
class CAlert
</code></pre>
<p>To describe a member or variable use:</p>
<pre><code class="language-c++">//! Description before the member
int var;
</code></pre>
<p>or</p>
<pre><code class="language-c++">int var; //!&lt; Description after the member
</code></pre>
<p>Also OK:</p>
<pre><code class="language-c++">///
/// ... Description ...
///
bool function2(int arg1, const char *arg2)
</code></pre>
<p>Not picked up by Doxygen:</p>
<pre><code class="language-c++">//
// ... Description ...
//
</code></pre>
<p>Also not picked up by Doxygen:</p>
<pre><code class="language-c++">/*
 * ... Description ...
 */
</code></pre>
<p>A full list of comment syntaxes picked up by Doxygen can be found at https://www.doxygen.nl/manual/docblocks.html,
but the above styles are favored.</p>
<p>Recommendations:</p>
<ul>
<li>
<p>Avoiding duplicating type and input/output information in function
descriptions.</p>
</li>
<li>
<p>Use backticks (``) to refer to <code>argument</code> names in function and
parameter descriptions.</p>
</li>
<li>
<p>Backticks aren't required when referring to functions Doxygen already knows
about; it will build hyperlinks for these automatically. See
https://www.doxygen.nl/manual/autolink.html for complete info.</p>
</li>
<li>
<p>Avoid linking to external documentation; links can break.</p>
</li>
<li>
<p>Javadoc and all valid Doxygen comments are stripped from Doxygen source code
previews (<code>STRIP_CODE_COMMENTS = YES</code> in <a href="doc//doc/Doxyfile.in">Doxyfile.in</a>). If
you want a comment to be preserved, it must instead use <code>//</code> or <code>/* */</code>.</p>
</li>
</ul>
<h3 id="generating-documentation"><a class="header" href="#generating-documentation">Generating Documentation</a></h3>
<p>Assuming the build directory is named <code>build</code>,
the documentation can be generated with <code>cmake --build build --target docs</code>.
The resulting files will be located in <code>build/doc/doxygen/html</code>;
open <code>index.html</code> in that directory to view the homepage.</p>
<p>Before building the <code>docs</code> target, you'll need to install these dependencies:</p>
<p>Linux: <code>sudo apt install doxygen graphviz</code></p>
<p>MacOS: <code>brew install doxygen graphviz</code></p>
<h2 id="development-tips-and-tricks"><a class="header" href="#development-tips-and-tricks">Development tips and tricks</a></h2>
<h3 id="compiling-for-debugging"><a class="header" href="#compiling-for-debugging">Compiling for debugging</a></h3>
<p>When using the default build configuration by running <code>cmake -B build</code>, the
<code>-DCMAKE_BUILD_TYPE</code> is set to <code>RelWithDebInfo</code>. This option adds debug symbols
but also performs some compiler optimizations that may make debugging trickier
as the code may not correspond directly to the source.</p>
<p>If you need to build exclusively for debugging, set the <code>-DCMAKE_BUILD_TYPE</code>
to <code>Debug</code> (i.e. <code>-DCMAKE_BUILD_TYPE=Debug</code>). You can always check the cmake
build options of an existing build with <code>ccmake build</code>.</p>
<h3 id="show-sources-in-debugging"><a class="header" href="#show-sources-in-debugging">Show sources in debugging</a></h3>
<p>If you have ccache enabled, absolute paths are stripped from debug information
with the <code>-fdebug-prefix-map</code> and <code>-fmacro-prefix-map</code> options (if supported by the
compiler). This might break source file detection in case you move binaries
after compilation, debug from the directory other than the project root or use
an IDE that only supports absolute paths for debugging (e.g. it won't stop at breakpoints).</p>
<p>There are a few possible fixes:</p>
<ol>
<li>Configure source file mapping.</li>
</ol>
<p>For <code>gdb</code> create or append to <a href="https://sourceware.org/gdb/current/onlinedocs/gdb#gdbinit-man"><code>.gdbinit</code> file</a>:</p>
<pre><code>set substitute-path ./src /path/to/project/root/src
</code></pre>
<p>For <code>lldb</code> create or append to <a href="https://lldb.llvm.org/man/lldb.html#configuration-files"><code>.lldbinit</code> file</a>:</p>
<pre><code>settings set target.source-map ./src /path/to/project/root/src
</code></pre>
<ol start="2">
<li>Add a symlink to the <code>./src</code> directory:</li>
</ol>
<pre><code>ln -s /path/to/project/root/src src
</code></pre>
<ol start="3">
<li>
<p>Use <code>debugedit</code> to modify debug information in the binary.</p>
</li>
<li>
<p>If your IDE has an option for this, change your breakpoints to use the file name only.</p>
</li>
</ol>
<h3 id="debuglog"><a class="header" href="#debuglog"><code>debug.log</code></a></h3>
<p>If the code is behaving strangely, take a look in the <code>debug.log</code> file in the data directory;
error and debugging messages are written there.</p>
<p>Debug logging can be enabled on startup with the <code>-debug</code> and <code>-loglevel</code>
configuration options and toggled while bitcoind is running with the <code>logging</code>
RPC.  For instance, launching bitcoind with <code>-debug</code> or <code>-debug=1</code> will turn on
all log categories and <code>-loglevel=trace</code> will turn on all log severity levels.</p>
<p>The Qt code routes <code>qDebug()</code> output to <code>debug.log</code> under category "qt": run with <code>-debug=qt</code>
to see it.</p>
<h3 id="signet-testnet-and-regtest-modes"><a class="header" href="#signet-testnet-and-regtest-modes">Signet, testnet, and regtest modes</a></h3>
<p>If you are testing multi-machine code that needs to operate across the internet,
you can run with either the <code>-signet</code> or the <code>-testnet</code> config option to test
with "play bitcoins" on a test network.</p>
<p>If you are testing something that can run on one machine, run with the
<code>-regtest</code> option.  In regression test mode, blocks can be created on demand;
see <a href="doc//test/functional">test/functional/</a> for tests that run in <code>-regtest</code> mode.</p>
<h3 id="debug_lockorder"><a class="header" href="#debug_lockorder">DEBUG_LOCKORDER</a></h3>
<p>Bitcoin Core is a multi-threaded application, and deadlocks or other
multi-threading bugs can be very difficult to track down. The <code>-DCMAKE_BUILD_TYPE=Debug</code>
build option adds <code>-DDEBUG_LOCKORDER</code> to the compiler flags. This inserts
run-time checks to keep track of which locks are held and adds warnings to the
<code>debug.log</code> file if inconsistencies are detected.</p>
<h3 id="debug_lockcontention"><a class="header" href="#debug_lockcontention">DEBUG_LOCKCONTENTION</a></h3>
<p>Defining <code>DEBUG_LOCKCONTENTION</code> adds a "lock" logging category to the logging
RPC that, when enabled, logs the location and duration of each lock contention
to the <code>debug.log</code> file.</p>
<p>The <code>-DCMAKE_BUILD_TYPE=Debug</code> build option adds <code>-DDEBUG_LOCKCONTENTION</code> to the
compiler flags. You may also enable it manually by building with <code>-DDEBUG_LOCKCONTENTION</code> added to your CPPFLAGS,
i.e. <code>CPPFLAGS="-DDEBUG_LOCKCONTENTION"</code>, then build and run bitcoind.</p>
<p>You can then use the <code>-debug=lock</code> configuration option at bitcoind startup or
<code>bitcoin-cli logging '["lock"]'</code> at runtime to turn on lock contention logging.
It can be toggled off again with <code>bitcoin-cli logging [] '["lock"]'</code>.</p>
<h3 id="assertions-and-checks"><a class="header" href="#assertions-and-checks">Assertions and Checks</a></h3>
<p>The util file <code>src/util/check.h</code> offers helpers to protect against coding and
internal logic bugs. They must never be used to validate user, network or any
other input.</p>
<ul>
<li><code>assert</code> or <code>Assert</code> should be used to document assumptions when any
violation would mean that it is not safe to continue program execution. The
code is always compiled with assertions enabled.
<ul>
<li>For example, a nullptr dereference or any other logic bug in validation
code means the program code is faulty and must terminate immediately.</li>
</ul>
</li>
<li><code>CHECK_NONFATAL</code> should be used for recoverable internal logic bugs. On
failure, it will throw an exception, which can be caught to recover from the
error.
<ul>
<li>For example, a nullptr dereference or any other logic bug in RPC code
means that the RPC code is faulty and cannot be executed. However, the
logic bug can be shown to the user and the program can continue to run.</li>
</ul>
</li>
<li><code>Assume</code> should be used to document assumptions when program execution can
safely continue even if the assumption is violated. In debug builds it
behaves like <code>Assert</code>/<code>assert</code> to notify developers and testers about
nonfatal errors. In production it doesn't warn or log anything, though the
expression is always evaluated.
<ul>
<li>For example it can be assumed that a variable is only initialized once,
but a failed assumption does not result in a fatal bug. A failed
assumption may or may not result in a slightly degraded user experience,
but it is safe to continue program execution.</li>
</ul>
</li>
</ul>
<h3 id="valgrind-suppressions-file"><a class="header" href="#valgrind-suppressions-file">Valgrind suppressions file</a></h3>
<p>Valgrind is a programming tool for memory debugging, memory leak detection, and
profiling. The repo contains a Valgrind suppressions file
(<a href="https://github.com/bitcoin/bitcoin/blob/master/contrib/valgrind.supp"><code>valgrind.supp</code></a>)
which includes known Valgrind warnings in our dependencies that cannot be fixed
in-tree. Example use:</p>
<pre><code class="language-shell">$ valgrind --suppressions=contrib/valgrind.supp build/src/test/test_bitcoin
$ valgrind --suppressions=contrib/valgrind.supp --leak-check=full \
      --show-leak-kinds=all build/src/test/test_bitcoin --log_level=test_suite
$ valgrind -v --leak-check=full build/src/bitcoind -printtoconsole
$ ./build/test/functional/test_runner.py --valgrind
</code></pre>
<h3 id="compiling-for-test-coverage"><a class="header" href="#compiling-for-test-coverage">Compiling for test coverage</a></h3>
<p>LCOV can be used to generate a test coverage report based upon <code>ctest</code>
execution. LCOV must be installed on your system (e.g. the <code>lcov</code> package
on Debian/Ubuntu).</p>
<p>To enable LCOV report generation during test runs:</p>
<pre><code class="language-shell">cmake -B build -DCMAKE_BUILD_TYPE=Coverage
cmake --build build
cmake -P build/Coverage.cmake

# A coverage report will now be accessible at `./build/test_bitcoin.coverage/index.html`,
# which covers unit tests, and `./build/total.coverage/index.html`, which covers
# unit and functional tests.
</code></pre>
<p>Additional LCOV options can be specified using <code>LCOV_OPTS</code>, but may be dependent
on the version of LCOV. For example, when using LCOV <code>2.x</code>, branch coverage can be
enabled by setting <code>LCOV_OPTS="--rc branch_coverage=1"</code>:</p>
<pre><code>cmake -DLCOV_OPTS="--rc branch_coverage=1" -P build/Coverage.cmake
</code></pre>
<p>To enable test parallelism:</p>
<pre><code>cmake -DJOBS=$(nproc) -P build/Coverage.cmake
</code></pre>
<h3 id="performance-profiling-with-perf"><a class="header" href="#performance-profiling-with-perf">Performance profiling with perf</a></h3>
<p>Profiling is a good way to get a precise idea of where time is being spent in
code. One tool for doing profiling on Linux platforms is called
<a href="https://www.brendangregg.com/perf.html"><code>perf</code></a>, and has been integrated into
the functional test framework. Perf can observe a running process and sample
(at some frequency) where its execution is.</p>
<p>Perf installation is contingent on which kernel version you're running; see
<a href="https://askubuntu.com/questions/50145/how-to-install-perf-monitoring-tool">this thread</a>
for specific instructions.</p>
<p>Certain kernel parameters may need to be set for perf to be able to inspect the
running process's stack.</p>
<pre><code class="language-sh">$ sudo sysctl -w kernel.perf_event_paranoid=-1
$ sudo sysctl -w kernel.kptr_restrict=0
</code></pre>
<p>Make sure you <a href="https://lwn.net/Articles/420403/">understand the security
trade-offs</a> of setting these kernel
parameters.</p>
<p>To profile a running bitcoind process for 60 seconds, you could use an
invocation of <code>perf record</code> like this:</p>
<pre><code class="language-sh">$ perf record \
    -g --call-graph dwarf --per-thread -F 140 \
    -p `pgrep bitcoind` -- sleep 60
</code></pre>
<p>You could then analyze the results by running:</p>
<pre><code class="language-sh">perf report --stdio | c++filt | less
</code></pre>
<p>or using a graphical tool like <a href="https://github.com/KDAB/hotspot">Hotspot</a>.</p>
<p>See the functional test documentation for how to invoke perf within tests.</p>
<h3 id="sanitizers"><a class="header" href="#sanitizers">Sanitizers</a></h3>
<p>Bitcoin Core can be compiled with various "sanitizers" enabled, which add
instrumentation for issues regarding things like memory safety, thread race
conditions, or undefined behavior. This is controlled with the
<code>-DSANITIZERS</code> cmake build flag, which should be a comma separated list of
sanitizers to enable. The sanitizer list should correspond to supported
<code>-fsanitize=</code> options in your compiler. These sanitizers have runtime overhead,
so they are most useful when testing changes or producing debugging builds.</p>
<p>Some examples:</p>
<pre><code class="language-bash"># Enable both the address sanitizer and the undefined behavior sanitizer
cmake -B build -DSANITIZERS=address,undefined

# Enable the thread sanitizer
cmake -B build -DSANITIZERS=thread
</code></pre>
<p>If you are compiling with GCC you will typically need to install corresponding
"san" libraries to actually compile with these flags, e.g. libasan for the
address sanitizer, libtsan for the thread sanitizer, and libubsan for the
undefined sanitizer. If you are missing required libraries, the build
will fail with a linker error when testing the sanitizer flags.</p>
<p>The test suite should pass cleanly with the <code>thread</code> and <code>undefined</code> sanitizers. You
may need to use a suppressions file, see <code>test/sanitizer_suppressions</code>. They may be
used as follows:</p>
<pre><code class="language-bash">export LSAN_OPTIONS="suppressions=$(pwd)/test/sanitizer_suppressions/lsan"
export TSAN_OPTIONS="suppressions=$(pwd)/test/sanitizer_suppressions/tsan:halt_on_error=1:second_deadlock_stack=1"
export UBSAN_OPTIONS="suppressions=$(pwd)/test/sanitizer_suppressions/ubsan:print_stacktrace=1:halt_on_error=1:report_error_type=1"
</code></pre>
<p>See the CI config for more examples, and upstream documentation for more information
about any additional options.</p>
<p>Not all sanitizer options can be enabled at the same time, e.g. trying to build
with <code>-DSANITIZERS=address,thread</code> will fail in the build as
these sanitizers are mutually incompatible. Refer to your compiler manual to
learn more about these options and which sanitizers are supported by your
compiler.</p>
<p>Additional resources:</p>
<ul>
<li><a href="https://clang.llvm.org/docs/AddressSanitizer.html">AddressSanitizer</a></li>
<li><a href="https://clang.llvm.org/docs/LeakSanitizer.html">LeakSanitizer</a></li>
<li><a href="https://clang.llvm.org/docs/MemorySanitizer.html">MemorySanitizer</a></li>
<li><a href="https://clang.llvm.org/docs/ThreadSanitizer.html">ThreadSanitizer</a></li>
<li><a href="https://clang.llvm.org/docs/UndefinedBehaviorSanitizer.html">UndefinedBehaviorSanitizer</a></li>
<li><a href="https://gcc.gnu.org/onlinedocs/gcc/Instrumentation-Options.html">GCC Instrumentation Options</a></li>
<li><a href="https://github.com/google/sanitizers/wiki">Google Sanitizers Wiki</a></li>
</ul>
<h2 id="lockingmutex-usage-notes"><a class="header" href="#lockingmutex-usage-notes">Locking/mutex usage notes</a></h2>
<p>The code is multi-threaded and uses mutexes and the
<code>LOCK</code> and <code>TRY_LOCK</code> macros to protect data structures.</p>
<p>Deadlocks due to inconsistent lock ordering (thread 1 locks <code>cs_main</code> and then
<code>cs_wallet</code>, while thread 2 locks them in the opposite order: result, deadlock
as each waits for the other to release its lock) are a problem. Compile with
<code>-DDEBUG_LOCKORDER</code> (or use <code>-DCMAKE_BUILD_TYPE=Debug</code>) to get lock order inconsistencies
reported in the <code>debug.log</code> file.</p>
<p>Re-architecting the core code so there are better-defined interfaces
between the various components is a goal, with any necessary locking
done by the components (e.g. see the self-contained <code>FillableSigningProvider</code> class
and its <code>cs_KeyStore</code> lock for example).</p>
<h2 id="threads"><a class="header" href="#threads">Threads</a></h2>
<ul>
<li>
<p><a href="https://doxygen.bitcoincore.org/bitcoind_8cpp.html#a0ddf1224851353fc92bfbff6f499fa97">Main thread (<code>bitcoind</code>)</a>
: Started from <code>main()</code> in <code>bitcoind.cpp</code>. Responsible for starting up and
shutting down the application.</p>
</li>
<li>
<p><a href="https://doxygen.bitcoincore.org/namespacenode.html#ab4305679079866f0f420f7dbf278381d">Init load (<code>b-initload</code>)</a>
: Performs various loading tasks that are part of init but shouldn't block the node from being started: external block import,
reindex, reindex-chainstate, main chain activation, spawn indexes background sync threads and mempool load.</p>
</li>
<li>
<p><a href="https://doxygen.bitcoincore.org/class_c_check_queue.html#a6e7fa51d3a25e7cb65446d4b50e6a987">CCheckQueue::Loop (<code>b-scriptch.x</code>)</a>
: Parallel script validation threads for transactions in blocks.</p>
</li>
<li>
<p><a href="https://doxygen.bitcoincore.org/httpserver_8cpp.html#abb9f6ea8819672bd9a62d3695070709c">ThreadHTTP (<code>b-http</code>)</a>
: Libevent thread to listen for RPC and REST connections.</p>
</li>
<li>
<p><a href="https://doxygen.bitcoincore.org/httpserver_8cpp.html#aa6a7bc27265043bc0193220c5ae3a55f">HTTP worker threads(<code>b-httpworker.x</code>)</a>
: Threads to service RPC and REST requests.</p>
</li>
<li>
<p><a href="https://doxygen.bitcoincore.org/class_base_index.html#a96a7407421fbf877509248bbe64f8d87">Indexer threads (<code>b-txindex</code>, etc)</a>
: One thread per indexer.</p>
</li>
<li>
<p><a href="https://doxygen.bitcoincore.org/class_c_scheduler.html#a14d2800815da93577858ea078aed1fba">SchedulerThread (<code>b-scheduler</code>)</a>
: Does asynchronous background tasks like dumping wallet contents, dumping
addrman and running asynchronous validationinterface callbacks.</p>
</li>
<li>
<p><a href="https://doxygen.bitcoincore.org/torcontrol_8cpp.html#a52a3efff23634500bb42c6474f306091">TorControlThread (<code>b-torcontrol</code>)</a>
: Libevent thread for tor connections.</p>
</li>
<li>
<p>Net threads:</p>
<ul>
<li>
<p><a href="https://doxygen.bitcoincore.org/class_c_connman.html#aacdbb7148575a31bb33bc345e2bf22a9">ThreadMessageHandler (<code>b-msghand</code>)</a>
: Application level message handling (sending and receiving). Almost
all net_processing and validation logic runs on this thread.</p>
</li>
<li>
<p><a href="https://doxygen.bitcoincore.org/class_c_connman.html#aa7c6970ed98a4a7bafbc071d24897d13">ThreadDNSAddressSeed (<code>b-dnsseed</code>)</a>
: Loads addresses of peers from the DNS.</p>
</li>
<li>
<p>ThreadMapPort (<code>b-mapport</code>)
: Universal plug-and-play startup/shutdown.</p>
</li>
<li>
<p><a href="https://doxygen.bitcoincore.org/class_c_connman.html#a765597cbfe99c083d8fa3d61bb464e34">ThreadSocketHandler (<code>b-net</code>)</a>
: Sends/Receives data from peers on port 8333.</p>
</li>
<li>
<p><a href="https://doxygen.bitcoincore.org/class_c_connman.html#a0b787caf95e52a346a2b31a580d60a62">ThreadOpenAddedConnections (<code>b-addcon</code>)</a>
: Opens network connections to added nodes.</p>
</li>
<li>
<p><a href="https://doxygen.bitcoincore.org/class_c_connman.html#a55e9feafc3bab78e5c9d408c207faa45">ThreadOpenConnections (<code>b-opencon</code>)</a>
: Initiates new connections to peers.</p>
</li>
<li>
<p><a href="https://doxygen.bitcoincore.org/class_c_connman.html#a57787b4f9ac847d24065fbb0dd6e70f8">ThreadI2PAcceptIncoming (<code>b-i2paccept</code>)</a>
: Listens for and accepts incoming I2P connections through the I2P SAM proxy.</p>
</li>
</ul>
</li>
</ul>
<h2 id="ignoring-ideeditor-files"><a class="header" href="#ignoring-ideeditor-files">Ignoring IDE/editor files</a></h2>
<p>In closed-source environments in which everyone uses the same IDE, it is common
to add temporary files it produces to the project-wide <code>.gitignore</code> file.</p>
<p>However, in open source software such as Bitcoin Core, where everyone uses
their own editors/IDE/tools, it is less common. Only you know what files your
editor produces and this may change from version to version. The canonical way
to do this is thus to create your local gitignore. Add this to <code>~/.gitconfig</code>:</p>
<pre><code>[core]
        excludesfile = /home/.../.gitignore_global
</code></pre>
<p>(alternatively, type the command <code>git config --global core.excludesfile ~/.gitignore_global</code>
on a terminal)</p>
<p>Then put your favourite tool's temporary filenames in that file, e.g.</p>
<pre><code># NetBeans
nbproject/
</code></pre>
<p>Another option is to create a per-repository excludes file <code>.git/info/exclude</code>.
These are not committed but apply only to one repository.</p>
<p>If a set of tools is used by the build system or scripts the repository (for
example, lcov) it is perfectly acceptable to add its files to <code>.gitignore</code>
and commit them.</p>
<h1 id="development-guidelines"><a class="header" href="#development-guidelines">Development guidelines</a></h1>
<p>A few non-style-related recommendations for developers, as well as points to
pay attention to for reviewers of Bitcoin Core code.</p>
<h2 id="general-bitcoin-core"><a class="header" href="#general-bitcoin-core">General Bitcoin Core</a></h2>
<ul>
<li>
<p>New features should be exposed on RPC first, then can be made available in the GUI.</p>
<ul>
<li><em>Rationale</em>: RPC allows for better automatic testing. The test suite for
the GUI is very limited.</li>
</ul>
</li>
<li>
<p>Make sure pull requests pass CI before merging.</p>
<ul>
<li>
<p><em>Rationale</em>: Makes sure that they pass thorough testing, and that the tester will keep passing
on the master branch. Otherwise, all new pull requests will start failing the tests, resulting in
confusion and mayhem.</p>
</li>
<li>
<p><em>Explanation</em>: If the test suite is to be updated for a change, this has to
be done first.</p>
</li>
</ul>
</li>
</ul>
<h2 id="logging"><a class="header" href="#logging">Logging</a></h2>
<p>The macros <code>LogInfo</code>, <code>LogDebug</code>, <code>LogTrace</code>, <code>LogWarning</code> and <code>LogError</code> are available for
logging messages. They should be used as follows:</p>
<ul>
<li>
<p><code>LogDebug(BCLog::CATEGORY, fmt, params...)</code> is what you want
most of the time, and it should be used for log messages that are
useful for debugging and can reasonably be enabled on a production
system (that has sufficient free storage space). They will be logged
if the program is started with <code>-debug=category</code> or <code>-debug=1</code>.</p>
</li>
<li>
<p><code>LogInfo(fmt, params...)</code> should only be used rarely, e.g. for startup
messages or for infrequent and important events such as a new block tip
being found or a new outbound connection being made. These log messages
are unconditional, so care must be taken that they can't be used by an
attacker to fill up storage. Note that <code>LogPrintf(fmt, params...)</code> is
a deprecated alias for <code>LogInfo</code>.</p>
</li>
<li>
<p><code>LogError(fmt, params...)</code> should be used in place of <code>LogInfo</code> for
severe problems that require the node (or a subsystem) to shut down
entirely (e.g., insufficient storage space).</p>
</li>
<li>
<p><code>LogWarning(fmt, params...)</code> should be used in place of <code>LogInfo</code> for
severe problems that the node admin should address, but are not
severe enough to warrant shutting down the node (e.g., system time
appears to be wrong, unknown soft fork appears to have activated).</p>
</li>
<li>
<p><code>LogTrace(BCLog::CATEGORY, fmt, params...)</code> should be used in place of
<code>LogDebug</code> for log messages that would be unusable on a production
system, e.g. due to being too noisy in normal use, or too resource
intensive to process. These will be logged if the startup
options <code>-debug=category -loglevel=category:trace</code> or <code>-debug=1 -loglevel=trace</code> are selected.</p>
</li>
</ul>
<p>Note that the format strings and parameters of <code>LogDebug</code> and <code>LogTrace</code>
are only evaluated if the logging category is enabled, so you must be
careful to avoid side-effects in those expressions.</p>
<h2 id="wallet-2"><a class="header" href="#wallet-2">Wallet</a></h2>
<ul>
<li>Make sure that no crashes happen with run-time option <code>-disablewallet</code>.</li>
</ul>
<h2 id="general-c"><a class="header" href="#general-c">General C++</a></h2>
<p>For general C++ guidelines, you may refer to the <a href="https://isocpp.github.io/CppCoreGuidelines/">C++ Core
Guidelines</a>.</p>
<p>Common misconceptions are clarified in those sections:</p>
<ul>
<li>
<p>Passing (non-)fundamental types in the <a href="https://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#Rf-conventional">C++ Core
Guideline</a>.</p>
</li>
<li>
<p>If you use the <code>.h</code>, you must link the <code>.cpp</code>.</p>
<ul>
<li><em>Rationale</em>: Include files define the interface for the code in implementation files. Including one but
not linking the other is confusing. Please avoid that. Moving functions from
the <code>.h</code> to the <code>.cpp</code> should not result in build errors.</li>
</ul>
</li>
<li>
<p>Use the RAII (Resource Acquisition Is Initialization) paradigm where possible. For example, by using
<code>unique_ptr</code> for allocations in a function.</p>
<ul>
<li><em>Rationale</em>: This avoids memory and resource leaks, and ensures exception safety.</li>
</ul>
</li>
</ul>
<h2 id="c-data-structures"><a class="header" href="#c-data-structures">C++ data structures</a></h2>
<ul>
<li>
<p>Never use the <code>std::map []</code> syntax when reading from a map, but instead use <code>.find()</code>.</p>
<ul>
<li><em>Rationale</em>: <code>[]</code> does an insert (of the default element) if the item doesn't
exist in the map yet. This has resulted in memory leaks in the past, as well as
race conditions (expecting read-read behavior). Using <code>[]</code> is fine for <em>writing</em> to a map.</li>
</ul>
</li>
<li>
<p>Do not compare an iterator from one data structure with an iterator of
another data structure (even if of the same type).</p>
<ul>
<li><em>Rationale</em>: Behavior is undefined. In C++ parlor this means "may reformat
the universe", in practice this has resulted in at least one hard-to-debug crash bug.</li>
</ul>
</li>
<li>
<p>Watch out for out-of-bounds vector access. <code>&amp;vch[vch.size()]</code> is illegal,
including <code>&amp;vch[0]</code> for an empty vector. Use <code>vch.data()</code> and <code>vch.data() + vch.size()</code> instead.</p>
</li>
<li>
<p>Vector bounds checking is only enabled in debug mode. Do not rely on it.</p>
</li>
<li>
<p>Initialize all non-static class members where they are defined.
If this is skipped for a good reason (i.e., optimization on the critical
path), add an explicit comment about this.</p>
<ul>
<li><em>Rationale</em>: Ensure determinism by avoiding accidental use of uninitialized
values. Also, static analyzers balk about this.
Initializing the members in the declaration makes it easy to
spot uninitialized ones.</li>
</ul>
</li>
</ul>
<pre><code class="language-cpp">class A
{
    uint32_t m_count{0};
}
</code></pre>
<ul>
<li>
<p>By default, declare constructors <code>explicit</code>.</p>
<ul>
<li><em>Rationale</em>: This is a precaution to avoid unintended
<a href="https://en.cppreference.com/w/cpp/language/converting_constructor">conversions</a>.</li>
</ul>
</li>
<li>
<p>Use explicitly signed or unsigned <code>char</code>s, or even better <code>uint8_t</code> and
<code>int8_t</code>. Do not use bare <code>char</code> unless it is to pass to a third-party API.
This type can be signed or unsigned depending on the architecture, which can
lead to interoperability problems or dangerous conditions such as
out-of-bounds array accesses.</p>
</li>
<li>
<p>Prefer explicit constructions over implicit ones that rely on 'magical' C++ behavior.</p>
<ul>
<li><em>Rationale</em>: Easier to understand what is happening, thus easier to spot mistakes, even for those
that are not language lawyers.</li>
</ul>
</li>
<li>
<p>Use <code>Span</code> as function argument when it can operate on any range-like container.</p>
<ul>
<li><em>Rationale</em>: Compared to <code>Foo(const vector&lt;int&gt;&amp;)</code> this avoids the need for a (potentially expensive)
conversion to vector if the caller happens to have the input stored in another type of container.
However, be aware of the pitfalls documented in <a href="doc/../src/span.h">span.h</a>.</li>
</ul>
</li>
</ul>
<pre><code class="language-cpp">void Foo(Span&lt;const int&gt; data);

std::vector&lt;int&gt; vec{1,2,3};
Foo(vec);
</code></pre>
<ul>
<li>
<p>Prefer <code>enum class</code> (scoped enumerations) over <code>enum</code> (traditional enumerations) where possible.</p>
<ul>
<li><em>Rationale</em>: Scoped enumerations avoid two potential pitfalls/problems with traditional C++ enumerations: implicit conversions to <code>int</code>, and name clashes due to enumerators being exported to the surrounding scope.</li>
</ul>
</li>
<li>
<p><code>switch</code> statement on an enumeration example:</p>
</li>
</ul>
<pre><code class="language-cpp">enum class Tabs {
    info,
    console,
    network_graph,
    peers
};

int GetInt(Tabs tab)
{
    switch (tab) {
    case Tabs::info: return 0;
    case Tabs::console: return 1;
    case Tabs::network_graph: return 2;
    case Tabs::peers: return 3;
    } // no default case, so the compiler can warn about missing cases
    assert(false);
}
</code></pre>
<p><em>Rationale</em>: The comment documents skipping <code>default:</code> label, and it complies with <code>clang-format</code> rules. The assertion prevents firing of <code>-Wreturn-type</code> warning on some compilers.</p>
<h2 id="strings-and-formatting"><a class="header" href="#strings-and-formatting">Strings and formatting</a></h2>
<ul>
<li>
<p>Use <code>std::string</code>, avoid C string manipulation functions.</p>
<ul>
<li><em>Rationale</em>: C++ string handling is marginally safer, less scope for
buffer overflows, and surprises with <code>\0</code> characters. Also, some C string manipulations
tend to act differently depending on platform, or even the user locale.</li>
</ul>
</li>
<li>
<p>Use <code>ToIntegral</code> from <a href="doc//src/util/strencodings.h"><code>strencodings.h</code></a> for number parsing. In legacy code you might also find <code>ParseInt*</code> family of functions, <code>ParseDouble</code> or <code>LocaleIndependentAtoi</code>.</p>
<ul>
<li><em>Rationale</em>: These functions do overflow checking and avoid pesky locale issues.</li>
</ul>
</li>
<li>
<p>Avoid using locale dependent functions if possible. You can use the provided
<a href="doc//test/lint/lint-locale-dependence.py"><code>lint-locale-dependence.py</code></a>
to check for accidental use of locale dependent functions.</p>
<ul>
<li>
<p><em>Rationale</em>: Unnecessary locale dependence can cause bugs that are very tricky to isolate and fix.</p>
</li>
<li>
<p>These functions are known to be locale dependent:
<code>alphasort</code>, <code>asctime</code>, <code>asprintf</code>, <code>atof</code>, <code>atoi</code>, <code>atol</code>, <code>atoll</code>, <code>atoq</code>,
<code>btowc</code>, <code>ctime</code>, <code>dprintf</code>, <code>fgetwc</code>, <code>fgetws</code>, <code>fprintf</code>, <code>fputwc</code>,
<code>fputws</code>, <code>fscanf</code>, <code>fwprintf</code>, <code>getdate</code>, <code>getwc</code>, <code>getwchar</code>, <code>isalnum</code>,
<code>isalpha</code>, <code>isblank</code>, <code>iscntrl</code>, <code>isdigit</code>, <code>isgraph</code>, <code>islower</code>, <code>isprint</code>,
<code>ispunct</code>, <code>isspace</code>, <code>isupper</code>, <code>iswalnum</code>, <code>iswalpha</code>, <code>iswblank</code>,
<code>iswcntrl</code>, <code>iswctype</code>, <code>iswdigit</code>, <code>iswgraph</code>, <code>iswlower</code>, <code>iswprint</code>,
<code>iswpunct</code>, <code>iswspace</code>, <code>iswupper</code>, <code>iswxdigit</code>, <code>isxdigit</code>, <code>mblen</code>,
<code>mbrlen</code>, <code>mbrtowc</code>, <code>mbsinit</code>, <code>mbsnrtowcs</code>, <code>mbsrtowcs</code>, <code>mbstowcs</code>,
<code>mbtowc</code>, <code>mktime</code>, <code>putwc</code>, <code>putwchar</code>, <code>scanf</code>, <code>snprintf</code>, <code>sprintf</code>,
<code>sscanf</code>, <code>stoi</code>, <code>stol</code>, <code>stoll</code>, <code>strcasecmp</code>, <code>strcasestr</code>, <code>strcoll</code>,
<code>strfmon</code>, <code>strftime</code>, <code>strncasecmp</code>, <code>strptime</code>, <code>strtod</code>, <code>strtof</code>,
<code>strtoimax</code>, <code>strtol</code>, <code>strtold</code>, <code>strtoll</code>, <code>strtoq</code>, <code>strtoul</code>,
<code>strtoull</code>, <code>strtoumax</code>, <code>strtouq</code>, <code>strxfrm</code>, <code>swprintf</code>, <code>tolower</code>,
<code>toupper</code>, <code>towctrans</code>, <code>towlower</code>, <code>towupper</code>, <code>ungetwc</code>, <code>vasprintf</code>,
<code>vdprintf</code>, <code>versionsort</code>, <code>vfprintf</code>, <code>vfscanf</code>, <code>vfwprintf</code>, <code>vprintf</code>,
<code>vscanf</code>, <code>vsnprintf</code>, <code>vsprintf</code>, <code>vsscanf</code>, <code>vswprintf</code>, <code>vwprintf</code>,
<code>wcrtomb</code>, <code>wcscasecmp</code>, <code>wcscoll</code>, <code>wcsftime</code>, <code>wcsncasecmp</code>, <code>wcsnrtombs</code>,
<code>wcsrtombs</code>, <code>wcstod</code>, <code>wcstof</code>, <code>wcstoimax</code>, <code>wcstol</code>, <code>wcstold</code>,
<code>wcstoll</code>, <code>wcstombs</code>, <code>wcstoul</code>, <code>wcstoull</code>, <code>wcstoumax</code>, <code>wcswidth</code>,
<code>wcsxfrm</code>, <code>wctob</code>, <code>wctomb</code>, <code>wctrans</code>, <code>wctype</code>, <code>wcwidth</code>, <code>wprintf</code></p>
</li>
</ul>
</li>
<li>
<p>For <code>strprintf</code>, <code>LogInfo</code>, <code>LogDebug</code>, etc formatting characters don't need size specifiers.</p>
<ul>
<li><em>Rationale</em>: Bitcoin Core uses tinyformat, which is type safe. Leave them out to avoid confusion.</li>
</ul>
</li>
<li>
<p>Use <code>.c_str()</code> sparingly. Its only valid use is to pass C++ strings to C functions that take NULL-terminated
strings.</p>
<ul>
<li>
<p>Do not use it when passing a sized array (so along with <code>.size()</code>). Use <code>.data()</code> instead to get a pointer
to the raw data.</p>
<ul>
<li><em>Rationale</em>: Although this is guaranteed to be safe starting with C++11, <code>.data()</code> communicates the intent better.</li>
</ul>
</li>
<li>
<p>Do not use it when passing strings to <code>tfm::format</code>, <code>strprintf</code>, <code>LogInfo</code>, <code>LogDebug</code>, etc.</p>
<ul>
<li><em>Rationale</em>: This is redundant. Tinyformat handles strings.</li>
</ul>
</li>
<li>
<p>Do not use it to convert to <code>QString</code>. Use <code>QString::fromStdString()</code>.</p>
<ul>
<li><em>Rationale</em>: Qt has built-in functionality for converting their string
type from/to C++. No need to roll your own.</li>
</ul>
</li>
<li>
<p>In cases where you do call <code>.c_str()</code>, you might want to additionally check that the string does not contain embedded '\0' characters, because
it will (necessarily) truncate the string. This might be used to hide parts of the string from logging or to circumvent
checks. If a use of strings is sensitive to this, take care to check the string for embedded NULL characters first
and reject it if there are any (see <code>ParsePrechecks</code> in <code>strencodings.cpp</code> for an example).</p>
</li>
</ul>
</li>
</ul>
<h2 id="shadowing"><a class="header" href="#shadowing">Shadowing</a></h2>
<p>Although the shadowing warning (<code>-Wshadow</code>) is not enabled by default (it prevents issues arising
from using a different variable with the same name),
please name variables so that their names do not shadow variables defined in the source code.</p>
<p>When using nested cycles, do not name the inner cycle variable the same as in
the outer cycle, etc.</p>
<h2 id="lifetimebound"><a class="header" href="#lifetimebound">Lifetimebound</a></h2>
<p>The <a href="https://clang.llvm.org/docs/AttributeReference.html#lifetimebound">Clang <code>lifetimebound</code>
attribute</a>
can be used to tell the compiler that a lifetime is bound to an object and
potentially see a compile-time warning if the object has a shorter lifetime from
the invalid use of a temporary. You can use the attribute by adding a <code>LIFETIMEBOUND</code>
annotation defined in <code>src/attributes.h</code>; please grep the codebase for examples.</p>
<h2 id="threads-and-synchronization"><a class="header" href="#threads-and-synchronization">Threads and synchronization</a></h2>
<ul>
<li>
<p>Prefer <code>Mutex</code> type to <code>RecursiveMutex</code> one.</p>
</li>
<li>
<p>Consistently use <a href="https://clang.llvm.org/docs/ThreadSafetyAnalysis.html">Clang Thread Safety Analysis</a> annotations to
get compile-time warnings about potential race conditions or deadlocks in code.</p>
<ul>
<li>
<p>In functions that are declared separately from where they are defined, the
thread safety annotations should be added exclusively to the function
declaration. Annotations on the definition could lead to false positives
(lack of compile failure) at call sites between the two.</p>
</li>
<li>
<p>Prefer locks that are in a class rather than global, and that are
internal to a class (private or protected) rather than public.</p>
</li>
<li>
<p>Combine annotations in function declarations with run-time asserts in
function definitions (<code>AssertLockNotHeld()</code> can be omitted if <code>LOCK()</code> is
called unconditionally after it because <code>LOCK()</code> does the same check as
<code>AssertLockNotHeld()</code> internally, for non-recursive mutexes):</p>
</li>
</ul>
</li>
</ul>
<pre><code class="language-C++">// txmempool.h
class CTxMemPool
{
public:
    ...
    mutable RecursiveMutex cs;
    ...
    void UpdateTransactionsFromBlock(...) EXCLUSIVE_LOCKS_REQUIRED(::cs_main, cs);
    ...
}

// txmempool.cpp
void CTxMemPool::UpdateTransactionsFromBlock(...)
{
    AssertLockHeld(::cs_main);
    AssertLockHeld(cs);
    ...
}
</code></pre>
<pre><code class="language-C++">// validation.h
class Chainstate
{
protected:
    ...
    Mutex m_chainstate_mutex;
    ...
public:
    ...
    bool ActivateBestChain(
        BlockValidationState&amp; state,
        std::shared_ptr&lt;const CBlock&gt; pblock = nullptr)
        EXCLUSIVE_LOCKS_REQUIRED(!m_chainstate_mutex)
        LOCKS_EXCLUDED(::cs_main);
    ...
    bool PreciousBlock(BlockValidationState&amp; state, CBlockIndex* pindex)
        EXCLUSIVE_LOCKS_REQUIRED(!m_chainstate_mutex)
        LOCKS_EXCLUDED(::cs_main);
    ...
}

// validation.cpp
bool Chainstate::PreciousBlock(BlockValidationState&amp; state, CBlockIndex* pindex)
{
    AssertLockNotHeld(m_chainstate_mutex);
    AssertLockNotHeld(::cs_main);
    {
        LOCK(cs_main);
        ...
    }

    return ActivateBestChain(state, std::shared_ptr&lt;const CBlock&gt;());
}
</code></pre>
<ul>
<li>
<p>Build and run tests with <code>-DDEBUG_LOCKORDER</code> to verify that no potential
deadlocks are introduced. This is defined by default when
building with <code>-DCMAKE_BUILD_TYPE=Debug</code>.</p>
</li>
<li>
<p>When using <code>LOCK</code>/<code>TRY_LOCK</code> be aware that the lock exists in the context of
the current scope, so surround the statement and the code that needs the lock
with braces.</p>
<p>OK:</p>
</li>
</ul>
<pre><code class="language-c++">{
    TRY_LOCK(cs_vNodes, lockNodes);
    ...
}
</code></pre>
<p>Wrong:</p>
<pre><code class="language-c++">TRY_LOCK(cs_vNodes, lockNodes);
{
    ...
}
</code></pre>
<h2 id="scripts"><a class="header" href="#scripts">Scripts</a></h2>
<p>Write scripts in Python rather than bash, when possible.</p>
<h3 id="shebang"><a class="header" href="#shebang">Shebang</a></h3>
<ul>
<li>
<p>Use <code>#!/usr/bin/env bash</code> instead of obsolete <code>#!/bin/bash</code>.</p>
<ul>
<li>
<p><a href="https://github.com/dylanaraps/pure-bash-bible#shebang"><em>Rationale</em></a>:</p>
<p><code>#!/bin/bash</code> assumes it is always installed to /bin/ which can cause issues;</p>
<p><code>#!/usr/bin/env bash</code> searches the user's PATH to find the bash binary.</p>
</li>
</ul>
<p>OK:</p>
</li>
</ul>
<pre><code class="language-bash">#!/usr/bin/env bash
</code></pre>
<p>Wrong:</p>
<pre><code class="language-bash">#!/bin/bash
</code></pre>
<h2 id="source-code-organization"><a class="header" href="#source-code-organization">Source code organization</a></h2>
<ul>
<li>
<p>Implementation code should go into the <code>.cpp</code> file and not the <code>.h</code>, unless necessary due to template usage or
when performance due to inlining is critical.</p>
<ul>
<li><em>Rationale</em>: Shorter and simpler header files are easier to read and reduce compile time.</li>
</ul>
</li>
<li>
<p>Use only the lowercase alphanumerics (<code>a-z0-9</code>), underscore (<code>_</code>) and hyphen (<code>-</code>) in source code filenames.</p>
<ul>
<li><em>Rationale</em>: <code>grep</code>:ing and auto-completing filenames is easier when using a consistent
naming pattern. Potential problems when building on case-insensitive filesystems are
avoided when using only lowercase characters in source code filenames.</li>
</ul>
</li>
<li>
<p>Every <code>.cpp</code> and <code>.h</code> file should <code>#include</code> every header file it directly uses classes, functions or other
definitions from, even if those headers are already included indirectly through other headers.</p>
<ul>
<li><em>Rationale</em>: Excluding headers because they are already indirectly included results in compilation
failures when those indirect dependencies change. Furthermore, it obscures what the real code
dependencies are.</li>
</ul>
</li>
<li>
<p>Don't import anything into the global namespace (<code>using namespace ...</code>). Use
fully specified types such as <code>std::string</code>.</p>
<ul>
<li><em>Rationale</em>: Avoids symbol conflicts.</li>
</ul>
</li>
<li>
<p>Terminate namespaces with a comment (<code>// namespace mynamespace</code>). The comment
should be placed on the same line as the brace closing the namespace, e.g.</p>
</li>
</ul>
<pre><code class="language-c++">namespace mynamespace {
...
} // namespace mynamespace

namespace {
...
} // namespace
</code></pre>
<ul>
<li>
<p><em>Rationale</em>: Avoids confusion about the namespace context.</p>
</li>
<li>
<p>Use <code>#include &lt;primitives/transaction.h&gt;</code> bracket syntax instead of
<code>#include "primitives/transactions.h"</code> quote syntax.</p>
<ul>
<li><em>Rationale</em>: Bracket syntax is less ambiguous because the preprocessor
searches a fixed list of include directories without taking location of the
source file into account. This allows quoted includes to stand out more when
the location of the source file actually is relevant.</li>
</ul>
</li>
<li>
<p>Use include guards to avoid the problem of double inclusion. The header file
<code>foo/bar.h</code> should use the include guard identifier <code>BITCOIN_FOO_BAR_H</code>, e.g.</p>
</li>
</ul>
<pre><code class="language-c++">#ifndef BITCOIN_FOO_BAR_H
#define BITCOIN_FOO_BAR_H
...
#endif // BITCOIN_FOO_BAR_H
</code></pre>
<h2 id="gui-2"><a class="header" href="#gui-2">GUI</a></h2>
<ul>
<li>
<p>Do not display or manipulate dialogs in model code (classes <code>*Model</code>).</p>
<ul>
<li><em>Rationale</em>: Model classes pass through events and data from the core, they
should not interact with the user. That's where View classes come in. The converse also
holds: try to not directly access core data structures from Views.</li>
</ul>
</li>
<li>
<p>Avoid adding slow or blocking code in the GUI thread. In particular, do not
add new <code>interfaces::Node</code> and <code>interfaces::Wallet</code> method calls, even if they
may be fast now, in case they are changed to lock or communicate across
processes in the future.</p>
<p>Prefer to offload work from the GUI thread to worker threads (see
<code>RPCExecutor</code> in console code as an example) or take other steps (see
https://doc.qt.io/archives/qq/qq27-responsive-guis.html) to keep the GUI
responsive.</p>
<ul>
<li><em>Rationale</em>: Blocking the GUI thread can increase latency, and lead to
hangs and deadlocks.</li>
</ul>
</li>
</ul>
<h2 id="subtrees"><a class="header" href="#subtrees">Subtrees</a></h2>
<p>Several parts of the repository are subtrees of software maintained elsewhere.</p>
<p>Some of these are maintained by active developers of Bitcoin Core, in which case
changes should go directly upstream without being PRed directly against the project.
They will be merged back in the next subtree merge.</p>
<p>Others are external projects without a tight relationship with our project. Changes
to these should also be sent upstream, but bugfixes may also be prudent to PR against
a Bitcoin Core subtree, so that they can be integrated quickly. Cosmetic changes
should be taken upstream.</p>
<p>There is a tool in <code>test/lint/git-subtree-check.sh</code> (<a href="doc/../test/lint#git-subtree-checksh">instructions</a>)
to check a subtree directory for consistency with its upstream repository.</p>
<p>Current subtrees include:</p>
<ul>
<li>
<p>src/leveldb</p>
<ul>
<li>Subtree at https://github.com/bitcoin-core/leveldb-subtree ; maintained by Core contributors.</li>
<li>Upstream at https://github.com/google/leveldb ; maintained by Google. Open
important PRs to the subtree to avoid delay.</li>
<li><strong>Note</strong>: Follow the instructions in <a href="doc/developer-notes.html#upgrading-leveldb">Upgrading LevelDB</a> when
merging upstream changes to the LevelDB subtree.</li>
</ul>
</li>
<li>
<p>src/crc32c</p>
<ul>
<li>Used by leveldb for hardware acceleration of CRC32C checksums for data integrity.</li>
<li>Subtree at https://github.com/bitcoin-core/crc32c-subtree ; maintained by Core contributors.</li>
<li>Upstream at https://github.com/google/crc32c ; maintained by Google.</li>
</ul>
</li>
<li>
<p>src/secp256k1</p>
<ul>
<li>Upstream at https://github.com/bitcoin-core/secp256k1/ ; maintained by Core contributors.</li>
</ul>
</li>
<li>
<p>src/crypto/ctaes</p>
<ul>
<li>Upstream at https://github.com/bitcoin-core/ctaes ; maintained by Core contributors.</li>
</ul>
</li>
<li>
<p>src/minisketch</p>
<ul>
<li>Upstream at https://github.com/sipa/minisketch ; maintained by Core contributors.</li>
</ul>
</li>
</ul>
<h2 id="upgrading-leveldb"><a class="header" href="#upgrading-leveldb">Upgrading LevelDB</a></h2>
<p>Extra care must be taken when upgrading LevelDB. This section explains issues
you must be aware of.</p>
<h3 id="file-descriptor-counts"><a class="header" href="#file-descriptor-counts">File Descriptor Counts</a></h3>
<p>In most configurations, we use the default LevelDB value for <code>max_open_files</code>,
which is 1000 at the time of this writing. If LevelDB actually uses this many
file descriptors, it will cause problems with Bitcoin's <code>select()</code> loop, because
it may cause new sockets to be created where the fd value is &gt;= 1024. For this
reason, on 64-bit Unix systems, we rely on an internal LevelDB optimization that
uses <code>mmap()</code> + <code>close()</code> to open table files without actually retaining
references to the table file descriptors. If you are upgrading LevelDB, you must
sanity check the changes to make sure that this assumption remains valid.</p>
<p>In addition to reviewing the upstream changes in <code>env_posix.cc</code>, you can use <code>lsof</code> to
check this. For example, on Linux this command will show open <code>.ldb</code> file counts:</p>
<pre><code class="language-bash">$ lsof -p $(pidof bitcoind) |\
    awk 'BEGIN { fd=0; mem=0; } /ldb$/ { if ($4 == "mem") mem++; else fd++ } END { printf "mem = %s, fd = %s\n", mem, fd}'
mem = 119, fd = 0
</code></pre>
<p>The <code>mem</code> value shows how many files are mmap'ed, and the <code>fd</code> value shows you
many file descriptors these files are using. You should check that <code>fd</code> is a
small number (usually 0 on 64-bit hosts).</p>
<p>See the notes in the <code>SetMaxOpenFiles()</code> function in <code>dbwrapper.cc</code> for more
details.</p>
<h3 id="consensus-compatibility"><a class="header" href="#consensus-compatibility">Consensus Compatibility</a></h3>
<p>It is possible for LevelDB changes to inadvertently change consensus
compatibility between nodes. This happened in Bitcoin 0.8 (when LevelDB was
first introduced). When upgrading LevelDB, you should review the upstream changes
to check for issues affecting consensus compatibility.</p>
<p>For example, if LevelDB had a bug that accidentally prevented a key from being
returned in an edge case, and that bug was fixed upstream, the bug "fix" would
be an incompatible consensus change. In this situation, the correct behavior
would be to revert the upstream fix before applying the updates to Bitcoin's
copy of LevelDB. In general, you should be wary of any upstream changes affecting
what data is returned from LevelDB queries.</p>
<h2 id="scripted-diffs"><a class="header" href="#scripted-diffs">Scripted diffs</a></h2>
<p>For reformatting and refactoring commits where the changes can be easily automated using a bash script, we use
scripted-diff commits. The bash script is included in the commit message and our CI job checks that
the result of the script is identical to the commit. This aids reviewers since they can verify that the script
does exactly what it is supposed to do. It is also helpful for rebasing (since the same script can just be re-run
on the new master commit).</p>
<p>To create a scripted-diff:</p>
<ul>
<li>start the commit message with <code>scripted-diff:</code> (and then a description of the diff on the same line)</li>
<li>in the commit message include the bash script between lines containing just the following text:
<ul>
<li><code>-BEGIN VERIFY SCRIPT-</code></li>
<li><code>-END VERIFY SCRIPT-</code></li>
</ul>
</li>
</ul>
<p>The scripted-diff is verified by the tool <code>test/lint/commit-script-check.sh</code>. The tool's default behavior, when supplied
with a commit is to verify all scripted-diffs from the beginning of time up to said commit. Internally, the tool passes
the first supplied argument to <code>git rev-list --reverse</code> to determine which commits to verify script-diffs for, ignoring
commits that don't conform to the commit message format described above.</p>
<p>For development, it might be more convenient to verify all scripted-diffs in a range <code>A..B</code>, for example:</p>
<pre><code class="language-bash">test/lint/commit-script-check.sh origin/master..HEAD
</code></pre>
<h3 id="suggestions-and-examples"><a class="header" href="#suggestions-and-examples">Suggestions and examples</a></h3>
<p>If you need to replace in multiple files, prefer <code>git ls-files</code> to <code>find</code> or globbing, and <code>git grep</code> to <code>grep</code>, to
avoid changing files that are not under version control.</p>
<p>For efficient replacement scripts, reduce the selection to the files that potentially need to be modified, so for
example, instead of a blanket <code>git ls-files src | xargs sed -i s/apple/orange/</code>, use
<code>git grep -l apple src | xargs sed -i s/apple/orange/</code>.</p>
<p>Also, it is good to keep the selection of files as specific as possible â€” for example, replace only in directories where
you expect replacements â€” because it reduces the risk that a rebase of your commit by re-running the script will
introduce accidental changes.</p>
<p>Some good examples of scripted-diff:</p>
<ul>
<li>
<p><a href="https://github.com/bitcoin/bitcoin/commit/301bd41a2e6765b185bd55f4c541f9e27aeea29d">scripted-diff: Rename InitInterfaces to NodeContext</a>
uses an elegant script to replace occurrences of multiple terms in all source files.</p>
</li>
<li>
<p><a href="https://github.com/bitcoin/bitcoin/commit/8922d7f6b751a3e6b3b9f6fb7961c442877fb65a">scripted-diff: Remove g_connman, g_banman globals</a>
replaces specific terms in a list of specific source files.</p>
</li>
<li>
<p><a href="https://github.com/bitcoin/bitcoin/commit/fac03ec43a15ad547161e37e53ea82482cc508f9">scripted-diff: Replace fprintf with tfm::format</a>
does a global replacement but excludes certain directories.</p>
</li>
</ul>
<p>To find all previous uses of scripted diffs in the repository, do:</p>
<pre><code>git log --grep="-BEGIN VERIFY SCRIPT-"
</code></pre>
<h2 id="release-notes"><a class="header" href="#release-notes">Release notes</a></h2>
<p>Release notes should be written for any PR that:</p>
<ul>
<li>introduces a notable new feature</li>
<li>fixes a significant bug</li>
<li>changes an API or configuration model</li>
<li>makes any other visible change to the end-user experience.</li>
</ul>
<p>Release notes should be added to a PR-specific release note file at
<code>/doc/release-notes-&lt;PR number&gt;.md</code> to avoid conflicts between multiple PRs.
All <code>release-notes*</code> files are merged into a single <code>release-notes-&lt;version&gt;.md</code> file prior to the release.</p>
<h2 id="rpc-interface-guidelines"><a class="header" href="#rpc-interface-guidelines">RPC interface guidelines</a></h2>
<p>A few guidelines for introducing and reviewing new RPC interfaces:</p>
<ul>
<li>
<p>Method naming: use consecutive lower-case names such as <code>getrawtransaction</code> and <code>submitblock</code>.</p>
<ul>
<li><em>Rationale</em>: Consistency with the existing interface.</li>
</ul>
</li>
<li>
<p>Argument and field naming: please consider whether there is already a naming
style or spelling convention in the API for the type of object in question
(<code>blockhash</code>, for example), and if so, try to use that. If not, use snake case
<code>fee_delta</code> (and not, e.g. <code>feedelta</code> or camel case <code>feeDelta</code>).</p>
<ul>
<li><em>Rationale</em>: Consistency with the existing interface.</li>
</ul>
</li>
<li>
<p>Use the JSON parser for parsing, don't manually parse integers or strings from
arguments unless absolutely necessary.</p>
<ul>
<li>
<p><em>Rationale</em>: Introduces hand-rolled string manipulation code at both the caller and callee sites,
which is error-prone, and it is easy to get things such as escaping wrong.
JSON already supports nested data structures, no need to re-invent the wheel.</p>
</li>
<li>
<p><em>Exception</em>: AmountFromValue can parse amounts as string. This was introduced because many JSON
parsers and formatters hard-code handling decimal numbers as floating-point
values, resulting in potential loss of precision. This is unacceptable for
monetary values. <strong>Always</strong> use <code>AmountFromValue</code> and <code>ValueFromAmount</code> when
inputting or outputting monetary values. The only exceptions to this are
<code>prioritisetransaction</code> and <code>getblocktemplate</code> because their interface
is specified as-is in BIP22.</p>
</li>
</ul>
</li>
<li>
<p>Missing arguments and 'null' should be treated the same: as default values. If there is no
default value, both cases should fail in the same way. The easiest way to follow this
guideline is to detect unspecified arguments with <code>params[x].isNull()</code> instead of
<code>params.size() &lt;= x</code>. The former returns true if the argument is either null or missing,
while the latter returns true if is missing, and false if it is null.</p>
<ul>
<li><em>Rationale</em>: Avoids surprises when switching to name-based arguments. Missing name-based arguments
are passed as 'null'.</li>
</ul>
</li>
<li>
<p>Try not to overload methods on argument type. E.g. don't make <code>getblock(true)</code> and <code>getblock("hash")</code>
do different things.</p>
<ul>
<li>
<p><em>Rationale</em>: This is impossible to use with <code>bitcoin-cli</code>, and can be surprising to users.</p>
</li>
<li>
<p><em>Exception</em>: Some RPC calls can take both an <code>int</code> and <code>bool</code>, most notably when a bool was switched
to a multi-value, or due to other historical reasons. <strong>Always</strong> have false map to 0 and
true to 1 in this case.</p>
</li>
</ul>
</li>
<li>
<p>For new RPC methods, if implementing a <code>verbosity</code> argument, use integer verbosity rather than boolean.
Disallow usage of boolean verbosity (see <code>ParseVerbosity()</code> in <a href="doc//src/rpc/util.h">util.h</a>).</p>
<ul>
<li><em>Rationale</em>: Integer verbosity allows for multiple values. Undocumented boolean verbosity is deprecated
and new RPC methods should prevent its use.</li>
</ul>
</li>
<li>
<p>Don't forget to fill in the argument names correctly in the RPC command table.</p>
<ul>
<li><em>Rationale</em>: If not, the call cannot be used with name-based arguments.</li>
</ul>
</li>
<li>
<p>Add every non-string RPC argument <code>(method, idx, name)</code> to the table <code>vRPCConvertParams</code> in <code>rpc/client.cpp</code>.</p>
<ul>
<li><em>Rationale</em>: <code>bitcoin-cli</code> and the GUI debug console use this table to determine how to
convert a plaintext command line to JSON. If the types don't match, the method can be unusable
from there.</li>
</ul>
</li>
<li>
<p>A RPC method must either be a wallet method or a non-wallet method. Do not
introduce new methods that differ in behavior based on the presence of a wallet.</p>
<ul>
<li><em>Rationale</em>: As well as complicating the implementation and interfering
with the introduction of multi-wallet, wallet and non-wallet code should be
separated to avoid introducing circular dependencies between code units.</li>
</ul>
</li>
<li>
<p>Try to make the RPC response a JSON object.</p>
<ul>
<li><em>Rationale</em>: If a RPC response is not a JSON object, then it is harder to avoid API breakage if
new data in the response is needed.</li>
</ul>
</li>
<li>
<p>Wallet RPCs call BlockUntilSyncedToCurrentChain to maintain consistency with
<code>getblockchaininfo</code>'s state immediately prior to the call's execution. Wallet
RPCs whose behavior does <em>not</em> depend on the current chainstate may omit this
call.</p>
<ul>
<li><em>Rationale</em>: In previous versions of Bitcoin Core, the wallet was always
in-sync with the chainstate (by virtue of them all being updated in the
same cs_main lock). In order to maintain the behavior that wallet RPCs
return results as of at least the highest best-known block an RPC
client may be aware of prior to entering a wallet RPC call, we must block
until the wallet is caught up to the chainstate as of the RPC call's entry.
This also makes the API much easier for RPC clients to reason about.</li>
</ul>
</li>
<li>
<p>Be aware of RPC method aliases and generally avoid registering the same
callback function pointer for different RPCs.</p>
<ul>
<li>
<p><em>Rationale</em>: RPC methods registered with the same function pointer will be
considered aliases and only the first method name will show up in the
<code>help</code> RPC command list.</p>
</li>
<li>
<p><em>Exception</em>: Using RPC method aliases may be appropriate in cases where a
new RPC is replacing a deprecated RPC, to avoid both RPCs confusingly
showing up in the command list.</p>
</li>
</ul>
</li>
<li>
<p>Use <em>invalid</em> bech32 addresses (e.g. in the constant array <code>EXAMPLE_ADDRESS</code>) for
<code>RPCExamples</code> help documentation.</p>
<ul>
<li><em>Rationale</em>: Prevent accidental transactions by users and encourage the use
of bech32 addresses by default.</li>
</ul>
</li>
<li>
<p>Use the <code>UNIX_EPOCH_TIME</code> constant when describing UNIX epoch time or
timestamps in the documentation.</p>
<ul>
<li><em>Rationale</em>: User-facing consistency.</li>
</ul>
</li>
<li>
<p>Use <code>fs::path::u8string()</code>/<code>fs::path::utf8string()</code> and <code>fs::u8path()</code> functions when converting path
to JSON strings, not <code>fs::PathToString</code> and <code>fs::PathFromString</code></p>
<ul>
<li><em>Rationale</em>: JSON strings are Unicode strings, not byte strings, and
RFC8259 requires JSON to be encoded as UTF-8.</li>
</ul>
</li>
</ul>
<h2 id="internal-interface-guidelines"><a class="header" href="#internal-interface-guidelines">Internal interface guidelines</a></h2>
<p>Internal interfaces between parts of the codebase that are meant to be
independent (node, wallet, GUI), are defined in
<a href="doc/../src/interfaces/"><code>src/interfaces/</code></a>. The main interface classes defined
there are <a href="doc/../src/interfaces/chain.h"><code>interfaces::Chain</code></a>, used by wallet to
access the node's latest chain state,
<a href="doc/../src/interfaces/node.h"><code>interfaces::Node</code></a>, used by the GUI to control the
node, <a href="doc/../src/interfaces/wallet.h"><code>interfaces::Wallet</code></a>, used by the GUI
to control an individual wallet and <a href="doc/../src/interfaces/mining.h"><code>interfaces::Mining</code></a>,
used by RPC to generate block templates. There are also more specialized interface
types like <a href="doc/../src/interfaces/handler.h"><code>interfaces::Handler</code></a>
<a href="doc/../src/interfaces/chain.h"><code>interfaces::ChainClient</code></a> passed to and from
various interface methods.</p>
<p>Interface classes are written in a particular style so node, wallet, and GUI
code doesn't need to run in the same process, and so the class declarations
work more easily with tools and libraries supporting interprocess
communication:</p>
<ul>
<li>
<p>Interface classes should be abstract and have methods that are <a href="https://en.cppreference.com/w/cpp/language/abstract_class">pure
virtual</a>. This
allows multiple implementations to inherit from the same interface class,
particularly so one implementation can execute functionality in the local
process, and other implementations can forward calls to remote processes.</p>
</li>
<li>
<p>Interface method definitions should wrap existing functionality instead of
implementing new functionality. Any substantial new node or wallet
functionality should be implemented in <a href="doc/../src/node/"><code>src/node/</code></a> or
<a href="doc/../src/wallet/"><code>src/wallet/</code></a> and just exposed in
<a href="doc/../src/interfaces/"><code>src/interfaces/</code></a> instead of being implemented there,
so it can be more modular and accessible to unit tests.</p>
</li>
<li>
<p>Interface method parameter and return types should either be serializable or
be other interface classes. Interface methods shouldn't pass references to
objects that can't be serialized or accessed from another process.</p>
<p>Examples:</p>
<pre><code class="language-c++">// Good: takes string argument and returns interface class pointer
virtual unique_ptr&lt;interfaces::Wallet&gt; loadWallet(std::string filename) = 0;

// Bad: returns CWallet reference that can't be used from another process
virtual CWallet&amp; loadWallet(std::string filename) = 0;
</code></pre>
<pre><code class="language-c++">// Good: accepts and returns primitive types
virtual bool findBlock(const uint256&amp; hash, int&amp; out_height, int64_t&amp; out_time) = 0;

// Bad: returns pointer to internal node in a linked list inaccessible to
// other processes
virtual const CBlockIndex* findBlock(const uint256&amp; hash) = 0;
</code></pre>
<pre><code class="language-c++">// Good: takes plain callback type and returns interface pointer
using TipChangedFn = std::function&lt;void(int block_height, int64_t block_time)&gt;;
virtual std::unique_ptr&lt;interfaces::Handler&gt; handleTipChanged(TipChangedFn fn) = 0;

// Bad: returns boost connection specific to local process
using TipChangedFn = std::function&lt;void(int block_height, int64_t block_time)&gt;;
virtual boost::signals2::scoped_connection connectTipChanged(TipChangedFn fn) = 0;
</code></pre>
</li>
<li>
<p>Interface methods should not be overloaded.</p>
<p><em>Rationale</em>: consistency and friendliness to code generation tools.</p>
<p>Example:</p>
<pre><code class="language-c++">// Good: method names are unique
virtual bool disconnectByAddress(const CNetAddr&amp; net_addr) = 0;
virtual bool disconnectById(NodeId id) = 0;

// Bad: methods are overloaded by type
virtual bool disconnect(const CNetAddr&amp; net_addr) = 0;
virtual bool disconnect(NodeId id) = 0;
</code></pre>
</li>
</ul>
<h3 id="internal-interface-naming-style"><a class="header" href="#internal-interface-naming-style">Internal interface naming style</a></h3>
<ul>
<li>
<p>Interface method names should be <code>lowerCamelCase</code> and standalone function names should be
<code>UpperCamelCase</code>.</p>
<p><em>Rationale</em>: consistency and friendliness to code generation tools.</p>
<p>Examples:</p>
<pre><code class="language-c++">// Good: lowerCamelCase method name
virtual void blockConnected(const CBlock&amp; block, int height) = 0;

// Bad: uppercase class method
virtual void BlockConnected(const CBlock&amp; block, int height) = 0;
</code></pre>
<pre><code class="language-c++">// Good: UpperCamelCase standalone function name
std::unique_ptr&lt;Node&gt; MakeNode(LocalInit&amp; init);

// Bad: lowercase standalone function
std::unique_ptr&lt;Node&gt; makeNode(LocalInit&amp; init);
</code></pre>
<p>Note: This last convention isn't generally followed outside of
<a href="doc/../src/interfaces/"><code>src/interfaces/</code></a>, though it did come up for discussion
before in <a href="https://github.com/bitcoin/bitcoin/pull/14635">#14635</a>.</p>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="expectations-for-dns-seed-operators"><a class="header" href="#expectations-for-dns-seed-operators">Expectations for DNS Seed operators</a></h1>
<p>Bitcoin Core attempts to minimize the level of trust in DNS seeds,
but DNS seeds still pose a small amount of risk for the network.
As such, DNS seeds must be run by entities which have some minimum
level of trust within the Bitcoin community.</p>
<p>Other implementations of Bitcoin software may also use the same
seeds and may be more exposed. In light of this exposure, this
document establishes some basic expectations for operating dnsseeds.</p>
<ol start="0">
<li>
<p>A DNS seed operating organization or person is expected to follow good
host security practices, maintain control of applicable infrastructure,
and not sell or transfer control of the DNS seed. Any hosting services
contracted by the operator are equally expected to uphold these expectations.</p>
</li>
<li>
<p>The DNS seed results must consist exclusively of fairly selected and
functioning Bitcoin nodes from the public network to the best of the
operator's understanding and capability.</p>
</li>
<li>
<p>For the avoidance of doubt, the results may be randomized but must not
single-out any group of hosts to receive different results unless due to an
urgent technical necessity and disclosed.</p>
</li>
<li>
<p>The results may not be served with a DNS TTL of less than one minute.</p>
</li>
<li>
<p>Any logging of DNS queries should be only that which is necessary
for the operation of the service or urgent health of the Bitcoin
network and must not be retained longer than necessary nor disclosed
to any third party.</p>
</li>
<li>
<p>Information gathered as a result of the operators node-spidering
(not from DNS queries) may be freely published or retained, but only
if this data was not made more complete by biasing node connectivity
(a violation of expectation (1)).</p>
</li>
<li>
<p>Operators are encouraged, but not required, to publicly document the
details of their operating practices.</p>
</li>
<li>
<p>A reachable email contact address must be published for inquiries
related to the DNS seed operation.</p>
</li>
</ol>
<p>If these expectations cannot be satisfied the operator should
discontinue providing services and contact the active Bitcoin
Core development team as well as posting on
<a href="https://groups.google.com/g/bitcoindev">bitcoin-dev</a>.</p>
<p>Behavior outside of these expectations may be reasonable in some
situations but should be discussed in public in advance.</p>
<h2 id="see-also"><a class="header" href="#see-also">See also</a></h2>
<ul>
<li><a href="https://github.com/sipa/bitcoin-seeder">bitcoin-seeder</a> is a reference implementation of a DNS seed.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="support-for-signing-transactions-outside-of-bitcoin-core"><a class="header" href="#support-for-signing-transactions-outside-of-bitcoin-core">Support for signing transactions outside of Bitcoin Core</a></h1>
<p>Bitcoin Core can be launched with <code>-signer=&lt;cmd&gt;</code> where <code>&lt;cmd&gt;</code> is an external tool which can sign transactions and perform other functions. For example, it can be used to communicate with a hardware wallet.</p>
<h2 id="example-usage"><a class="header" href="#example-usage">Example usage</a></h2>
<p>The following example is based on the <a href="https://github.com/bitcoin-core/HWI">HWI</a> tool. Version 2.0 or newer is required. Although this tool is hosted under the Bitcoin Core GitHub organization and maintained by Bitcoin Core developers, it should be used with caution. It is considered experimental and has far less review than Bitcoin Core itself. Be particularly careful when running tools such as these on a computer with private keys on it.</p>
<p>When using a hardware wallet, consult the manufacturer website for (alternative) software they recommend. As long as their software conforms to the standard below, it should be able to work with Bitcoin Core.</p>
<p>Start Bitcoin Core:</p>
<pre><code class="language-sh">$ bitcoind -signer=../HWI/hwi.py
</code></pre>
<h3 id="device-setup"><a class="header" href="#device-setup">Device setup</a></h3>
<p>Follow the hardware manufacturers instructions for the initial device setup, as well as their instructions for creating a backup. Alternatively, for some devices, you can use the <code>setup</code>, <code>restore</code> and <code>backup</code> commands provided by <a href="https://github.com/bitcoin-core/HWI">HWI</a>.</p>
<h3 id="create-wallet-and-import-keys"><a class="header" href="#create-wallet-and-import-keys">Create wallet and import keys</a></h3>
<p>Get a list of signing devices / services:</p>
<pre><code>$ bitcoin-cli enumeratesigners
{
  "signers": [
    {
      "fingerprint": "c8df832a"
    }
]
</code></pre>
<p>The master key fingerprint is used to identify a device.</p>
<p>Create a wallet, this automatically imports the public keys:</p>
<pre><code class="language-sh">$ bitcoin-cli createwallet "hww" true true "" true true true
</code></pre>
<h3 id="verify-an-address"><a class="header" href="#verify-an-address">Verify an address</a></h3>
<p>Display an address on the device:</p>
<pre><code class="language-sh">$ bitcoin-cli -rpcwallet=&lt;wallet&gt; getnewaddress
$ bitcoin-cli -rpcwallet=&lt;wallet&gt; walletdisplayaddress &lt;address&gt;
</code></pre>
<p>Replace <code>&lt;address&gt;</code> with the result of <code>getnewaddress</code>.</p>
<h3 id="spending"><a class="header" href="#spending">Spending</a></h3>
<p>Under the hood this uses a <a href="doc/psbt.html">Partially Signed Bitcoin Transaction</a>.</p>
<pre><code class="language-sh">$ bitcoin-cli -rpcwallet=&lt;wallet&gt; sendtoaddress &lt;address&gt; &lt;amount&gt;
</code></pre>
<p>This prompts your hardware wallet to sign, and fail if it's not connected. If successful
it automatically broadcasts the transaction.</p>
<pre><code class="language-sh">{"complete": true, "txid": &lt;txid&gt;}
</code></pre>
<h2 id="signer-api"><a class="header" href="#signer-api">Signer API</a></h2>
<p>In order to be compatible with Bitcoin Core any signer command should conform to the specification below. This specification is subject to change. Ideally a BIP should propose a standard so that other wallets can also make use of it.</p>
<p>Prerequisite knowledge:</p>
<ul>
<li><a href="doc/descriptors.html">Output Descriptors</a></li>
<li>Partially Signed Bitcoin Transaction (<a href="doc/psbt.html">PSBT</a>)</li>
</ul>
<h3 id="enumerate-required"><a class="header" href="#enumerate-required"><code>enumerate</code> (required)</a></h3>
<p>Usage:</p>
<pre><code>$ &lt;cmd&gt; enumerate
[
    {
        "fingerprint": "00000000"
    }
]
</code></pre>
<p>The command MUST return an (empty) array with at least a <code>fingerprint</code> field.</p>
<p>A future extension could add an optional return field with device capabilities. Perhaps a descriptor with wildcards. For example: <code>["pkh("44'/0'/$'/{0,1}/*"), sh(wpkh("49'/0'/$'/{0,1}/*")), wpkh("84'/0'/$'/{0,1}/*")]</code>. This would indicate the device supports legacy, wrapped SegWit and native SegWit. In addition it restricts the derivation paths that can used for those, to maintain compatibility with other wallet software. It also indicates the device, or the driver, doesn't support multisig.</p>
<p>A future extension could add an optional return field <code>reachable</code>, in case <code>&lt;cmd&gt;</code> knows a signer exists but can't currently reach it.</p>
<h3 id="signtransaction-required"><a class="header" href="#signtransaction-required"><code>signtransaction</code> (required)</a></h3>
<p>Usage:</p>
<pre><code>$ &lt;cmd&gt; --fingerprint=&lt;fingerprint&gt; (--testnet) signtransaction &lt;psbt&gt;
base64_encode_signed_psbt
</code></pre>
<p>The command returns a psbt with any signatures.</p>
<p>The <code>psbt</code> SHOULD include bip32 derivations. The command SHOULD fail if none of the bip32 derivations match a key owned by the device.</p>
<p>The command SHOULD fail if the user cancels.</p>
<p>The command MAY complain if <code>--testnet</code> is set, but any of the BIP32 derivation paths contain a coin type other than <code>1h</code> (and vice versa).</p>
<h3 id="getdescriptors-optional"><a class="header" href="#getdescriptors-optional"><code>getdescriptors</code> (optional)</a></h3>
<p>Usage:</p>
<pre><code>$ &lt;cmd&gt; --fingerprint=&lt;fingerprint&gt; (--testnet) getdescriptors &lt;account&gt;
&lt;xpub&gt;
</code></pre>
<p>Returns descriptors supported by the device. Example:</p>
<pre><code>$ &lt;cmd&gt; --fingerprint=00000000 --testnet getdescriptors
{
  "receive": [
    "pkh([00000000/44h/0h/0h]xpub6C.../0/*)#fn95jwmg",
    "sh(wpkh([00000000/49h/0h/0h]xpub6B..../0/*))#j4r9hntt",
    "wpkh([00000000/84h/0h/0h]xpub6C.../0/*)#qw72dxa9"
  ],
  "internal": [
    "pkh([00000000/44h/0h/0h]xpub6C.../1/*)#c8q40mts",
    "sh(wpkh([00000000/49h/0h/0h]xpub6B..../1/*))#85dn0v75",
    "wpkh([00000000/84h/0h/0h]xpub6C..../1/*)#36mtsnda"
  ]
}
</code></pre>
<h3 id="displayaddress-optional"><a class="header" href="#displayaddress-optional"><code>displayaddress</code> (optional)</a></h3>
<p>Usage:</p>
<pre><code>&lt;cmd&gt; --fingerprint=&lt;fingerprint&gt; (--testnet) displayaddress --desc descriptor
</code></pre>
<p>Example, display the first native SegWit receive address on Testnet:</p>
<pre><code>&lt;cmd&gt; --fingerprint=00000000 --testnet displayaddress --desc "wpkh([00000000/84h/1h/0h]tpubDDUZ..../0/0)"
</code></pre>
<p>The command MUST be able to figure out the address type from the descriptor.</p>
<p>The command MUST return an object containing <code>{"address": "[the address]"}</code>.
As a sanity check, for devices that support this, it SHOULD ask the device to derive the address.</p>
<p>If <descriptor> contains a master key fingerprint, the command MUST fail if it does not match the fingerprint known by the device.</p>
<p>If <descriptor> contains an xpub, the command MUST fail if it does not match the xpub known by the device.</p>
<p>The command MAY complain if <code>--testnet</code> is set, but the BIP32 coin type is not <code>1h</code> (and vice versa).</p>
<h2 id="how-bitcoin-core-uses-the-signer-api"><a class="header" href="#how-bitcoin-core-uses-the-signer-api">How Bitcoin Core uses the Signer API</a></h2>
<p>The <code>enumeratesigners</code> RPC simply calls <code>&lt;cmd&gt; enumerate</code>.</p>
<p>The <code>createwallet</code> RPC calls:</p>
<ul>
<li><code>&lt;cmd&gt; --fingerprint=00000000 getdescriptors 0</code></li>
</ul>
<p>It then imports descriptors for all support address types, in a BIP44/49/84 compatible manner.</p>
<p>The <code>walletdisplayaddress</code> RPC reuses some code from <code>getaddressinfo</code> on the provided address and obtains the inferred descriptor. It then calls <code>&lt;cmd&gt; --fingerprint=00000000 displayaddress --desc=&lt;descriptor&gt;</code>.</p>
<p><code>sendtoaddress</code> and <code>sendmany</code> check <code>inputs-&gt;bip32_derivs</code> to see if any inputs have the same <code>master_fingerprint</code> as the signer. If so, it calls <code>&lt;cmd&gt; --fingerprint=00000000 signtransaction &lt;psbt&gt;</code>. It waits for the device to return a (partially) signed psbt, tries to finalize it and broadcasts the transaction.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="bitcoin-core-file-system"><a class="header" href="#bitcoin-core-file-system">Bitcoin Core file system</a></h1>
<p><strong>Contents</strong></p>
<ul>
<li>
<p><a href="doc/files.html#data-directory-location">Data directory location</a></p>
</li>
<li>
<p><a href="doc/files.html#data-directory-layout">Data directory layout</a></p>
</li>
<li>
<p><a href="doc/files.html#multi-wallet-environment">Multi-wallet environment</a></p>
<ul>
<li>
<p><a href="doc/files.html#berkeley-db-database-based-wallets">Berkeley DB database based wallets</a></p>
</li>
<li>
<p><a href="doc/files.html#sqlite-database-based-wallets">SQLite database based wallets</a></p>
</li>
</ul>
</li>
<li>
<p><a href="doc/files.html#gui-settings">GUI settings</a></p>
</li>
<li>
<p><a href="doc/files.html#legacy-subdirectories-and-files">Legacy subdirectories and files</a></p>
</li>
<li>
<p><a href="doc/files.html#notes">Notes</a></p>
</li>
</ul>
<h2 id="data-directory-location"><a class="header" href="#data-directory-location">Data directory location</a></h2>
<p>The data directory is the default location where the Bitcoin Core files are stored.</p>
<ol>
<li>The default data directory paths for supported platforms are:</li>
</ol>
<div class="table-wrapper"><table><thead><tr><th>Platform</th><th>Data directory path</th></tr></thead><tbody>
<tr><td>Linux</td><td><code>$HOME/.bitcoin/</code></td></tr>
<tr><td>macOS</td><td><code>$HOME/Library/Application Support/Bitcoin/</code></td></tr>
<tr><td>Windows</td><td><code>%LOCALAPPDATA%\Bitcoin\</code> <sup><a href="doc/files.html#note1">[1]</a></sup></td></tr>
</tbody></table>
</div>
<ol start="2">
<li>
<p>A custom data directory path can be specified with the <code>-datadir</code> option.</p>
</li>
<li>
<p>All content of the data directory, except for <code>bitcoin.conf</code> file, is chain-specific. This means the actual data directory paths for non-mainnet cases differ:</p>
</li>
</ol>
<div class="table-wrapper"><table><thead><tr><th>Chain option</th><th>Data directory path</th></tr></thead><tbody>
<tr><td><code>-chain=main</code> (default)</td><td><em>path_to_datadir</em><code>/</code></td></tr>
<tr><td><code>-chain=test</code> or <code>-testnet</code></td><td><em>path_to_datadir</em><code>/testnet3/</code></td></tr>
<tr><td><code>-chain=testnet4</code> or <code>-testnet4</code></td><td><em>path_to_datadir</em><code>/testnet4/</code></td></tr>
<tr><td><code>-chain=signet</code> or <code>-signet</code></td><td><em>path_to_datadir</em><code>/signet/</code></td></tr>
<tr><td><code>-chain=regtest</code> or <code>-regtest</code></td><td><em>path_to_datadir</em><code>/regtest/</code></td></tr>
</tbody></table>
</div>
<h2 id="data-directory-layout"><a class="header" href="#data-directory-layout">Data directory layout</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Subdirectory</th><th>File(s)</th><th>Description</th></tr></thead><tbody>
<tr><td><code>blocks/</code></td><td></td><td>Blocks directory; can be specified by <code>-blocksdir</code> option (except for <code>blocks/index/</code>)</td></tr>
<tr><td><code>blocks/index/</code></td><td>LevelDB database</td><td>Block index; <code>-blocksdir</code> option does not affect this path</td></tr>
<tr><td><code>blocks/</code></td><td><code>blkNNNNN.dat</code><sup><a href="doc/files.html#note2">[2]</a></sup></td><td>Actual Bitcoin blocks (dumped in network format, 128 MiB per file)</td></tr>
<tr><td><code>blocks/</code></td><td><code>revNNNNN.dat</code><sup><a href="doc/files.html#note2">[2]</a></sup></td><td>Block undo data (custom format)</td></tr>
<tr><td><code>blocks/</code></td><td><code>xor.dat</code></td><td>Rolling XOR pattern for block and undo data files</td></tr>
<tr><td><code>chainstate/</code></td><td>LevelDB database</td><td>Blockchain state (a compact representation of all currently unspent transaction outputs (UTXOs) and metadata about the transactions they are from)</td></tr>
<tr><td><code>indexes/txindex/</code></td><td>LevelDB database</td><td>Transaction index; <em>optional</em>, used if <code>-txindex=1</code></td></tr>
<tr><td><code>indexes/blockfilter/basic/db/</code></td><td>LevelDB database</td><td>Blockfilter index LevelDB database for the basic filtertype; <em>optional</em>, used if <code>-blockfilterindex=basic</code></td></tr>
<tr><td><code>indexes/blockfilter/basic/</code></td><td><code>fltrNNNNN.dat</code><sup><a href="doc/files.html#note2">[2]</a></sup></td><td>Blockfilter index filters for the basic filtertype; <em>optional</em>, used if <code>-blockfilterindex=basic</code></td></tr>
<tr><td><code>indexes/coinstats/db/</code></td><td>LevelDB database</td><td>Coinstats index; <em>optional</em>, used if <code>-coinstatsindex=1</code></td></tr>
<tr><td><code>wallets/</code></td><td></td><td><a href="doc/files.html#multi-wallet-environment">Contains wallets</a>; can be specified by <code>-walletdir</code> option; if <code>wallets/</code> subdirectory does not exist, wallets reside in the <a href="doc/files.html#data-directory-location">data directory</a></td></tr>
<tr><td><code>./</code></td><td><code>anchors.dat</code></td><td>Anchor IP address database, created on shutdown and deleted at startup. Anchors are last known outgoing block-relay-only peers that are tried to re-connect to on startup</td></tr>
<tr><td><code>./</code></td><td><code>banlist.json</code></td><td>Stores the addresses/subnets of banned nodes.</td></tr>
<tr><td><code>./</code></td><td><code>bitcoin.conf</code></td><td>User-defined <a href="doc/bitcoin-conf.html">configuration settings</a> for <code>bitcoind</code> or <code>bitcoin-qt</code>. File is not written to by the software and must be created manually. Path can be specified by <code>-conf</code> option</td></tr>
<tr><td><code>./</code></td><td><code>bitcoind.pid</code></td><td>Stores the process ID (PID) of <code>bitcoind</code> or <code>bitcoin-qt</code> while running; created at start and deleted on shutdown; can be specified by <code>-pid</code> option</td></tr>
<tr><td><code>./</code></td><td><code>debug.log</code></td><td>Contains debug information and general logging generated by <code>bitcoind</code> or <code>bitcoin-qt</code>; can be specified by <code>-debuglogfile</code> option</td></tr>
<tr><td><code>./</code></td><td><code>fee_estimates.dat</code></td><td>Stores statistics used to estimate minimum transaction fees required for confirmation</td></tr>
<tr><td><code>./</code></td><td><code>guisettings.ini.bak</code></td><td>Backup of former <a href="doc/files.html#gui-settings">GUI settings</a> after <code>-resetguisettings</code> option is used</td></tr>
<tr><td><code>./</code></td><td><code>ip_asn.map</code></td><td>IP addresses to Autonomous System Numbers (ASNs) mapping used for bucketing of the peers; path can be specified with the <code>-asmap</code> option</td></tr>
<tr><td><code>./</code></td><td><code>mempool.dat</code></td><td>Dump of the mempool's transactions</td></tr>
<tr><td><code>./</code></td><td><code>onion_v3_private_key</code></td><td>Cached Tor onion service private key for <code>-listenonion</code> option</td></tr>
<tr><td><code>./</code></td><td><code>i2p_private_key</code></td><td>Private key that corresponds to our I2P address. When <code>-i2psam=</code> is specified the contents of this file is used to identify ourselves for making outgoing connections to I2P peers and possibly accepting incoming ones. Automatically generated if it does not exist.</td></tr>
<tr><td><code>./</code></td><td><code>peers.dat</code></td><td>Peer IP address database (custom format)</td></tr>
<tr><td><code>./</code></td><td><code>settings.json</code></td><td>Read-write settings set through GUI or RPC interfaces, augmenting manual settings from <a href="doc/bitcoin-conf.html">bitcoin.conf</a>. File is created automatically if read-write settings storage is not disabled with <code>-nosettings</code> option. Path can be specified with <code>-settings</code> option</td></tr>
<tr><td><code>./</code></td><td><code>.cookie</code></td><td>Session RPC authentication cookie; if used, created at start and deleted on shutdown; can be specified by <code>-rpccookiefile</code> option</td></tr>
<tr><td><code>./</code></td><td><code>.lock</code></td><td>Data directory lock file</td></tr>
</tbody></table>
</div>
<h2 id="multi-wallet-environment"><a class="header" href="#multi-wallet-environment">Multi-wallet environment</a></h2>
<p>Wallets are Berkeley DB (BDB) or SQLite databases.</p>
<ol>
<li>
<p>Each user-defined wallet named "wallet_name" resides in the <code>wallets/wallet_name/</code> subdirectory.</p>
</li>
<li>
<p>The default (unnamed) wallet resides in <code>wallets/</code> subdirectory; if the latter does not exist, the wallet resides in the data directory.</p>
</li>
<li>
<p>A wallet database path can be specified with the <code>-wallet</code> option.</p>
</li>
<li>
<p><code>wallet.dat</code> files must not be shared across different node instances, as that can result in key-reuse and double-spends due the lack of synchronization between instances.</p>
</li>
<li>
<p>Any copy or backup of the wallet should be done through a <code>backupwallet</code> call in order to update and lock the wallet, preventing any file corruption caused by updates during the copy.</p>
</li>
</ol>
<h3 id="berkeley-db-database-based-wallets"><a class="header" href="#berkeley-db-database-based-wallets">Berkeley DB database based wallets</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Subdirectory</th><th>File(s)</th><th>Description</th></tr></thead><tbody>
<tr><td><code>database/</code></td><td>BDB logging files</td><td>Part of BDB environment; created at start and deleted on shutdown; a user <em>must keep it as safe</em> as personal wallet <code>wallet.dat</code></td></tr>
<tr><td><code>./</code></td><td><code>db.log</code></td><td>BDB error file</td></tr>
<tr><td><code>./</code></td><td><code>wallet.dat</code></td><td>Personal wallet (a BDB database) with keys and transactions</td></tr>
<tr><td><code>./</code></td><td><code>.walletlock</code></td><td>BDB wallet lock file</td></tr>
</tbody></table>
</div>
<h3 id="sqlite-database-based-wallets"><a class="header" href="#sqlite-database-based-wallets">SQLite database based wallets</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Subdirectory</th><th>File</th><th>Description</th></tr></thead><tbody>
<tr><td><code>./</code></td><td><code>wallet.dat</code></td><td>Personal wallet (a SQLite database) with keys and transactions</td></tr>
<tr><td><code>./</code></td><td><code>wallet.dat-journal</code></td><td>SQLite Rollback Journal file for <code>wallet.dat</code>. Usually created at start and deleted on shutdown. A user <em>must keep it as safe</em> as the <code>wallet.dat</code> file.</td></tr>
</tbody></table>
</div>
<h2 id="gui-settings"><a class="header" href="#gui-settings">GUI settings</a></h2>
<p><code>bitcoin-qt</code> uses <a href="https://doc.qt.io/qt-5/qsettings.html"><code>QSettings</code></a> class; this implies platform-specific <a href="https://doc.qt.io/qt-5/qsettings.html#locations-where-application-settings-are-stored">locations where application settings are stored</a>.</p>
<h2 id="legacy-subdirectories-and-files"><a class="header" href="#legacy-subdirectories-and-files">Legacy subdirectories and files</a></h2>
<p>These subdirectories and files are no longer used by Bitcoin Core:</p>
<div class="table-wrapper"><table><thead><tr><th>Path</th><th>Description</th><th>Repository notes</th></tr></thead><tbody>
<tr><td><code>banlist.dat</code></td><td>Stores the addresses/subnets of banned nodes; superseded by <code>banlist.json</code> in 22.0 and completely ignored in 23.0</td><td><a href="https://github.com/bitcoin/bitcoin/pull/20966">PR #20966</a>, <a href="https://github.com/bitcoin/bitcoin/pull/22570">PR #22570</a></td></tr>
<tr><td><code>blktree/</code></td><td>Blockchain index; replaced by <code>blocks/index/</code> in <a href="https://github.com/bitcoin/bitcoin/blob/master/doc/release-notes/release-notes-0.8.0.md#improvements">0.8.0</a></td><td><a href="https://github.com/bitcoin/bitcoin/pull/2231">PR #2231</a>, <a href="https://github.com/bitcoin/bitcoin/commit/8fdc94cc8f0341e96b1edb3a5b56811c0b20bd15"><code>8fdc94cc</code></a></td></tr>
<tr><td><code>coins/</code></td><td>Unspent transaction output database; replaced by <code>chainstate/</code> in 0.8.0</td><td><a href="https://github.com/bitcoin/bitcoin/pull/2231">PR #2231</a>, <a href="https://github.com/bitcoin/bitcoin/commit/8fdc94cc8f0341e96b1edb3a5b56811c0b20bd15"><code>8fdc94cc</code></a></td></tr>
<tr><td><code>blkindex.dat</code></td><td>Blockchain index BDB database; replaced by {<code>chainstate/</code>, <code>blocks/index/</code>, <code>blocks/revNNNNN.dat</code><sup><a href="doc/files.html#note2">[2]</a></sup>} in 0.8.0</td><td><a href="https://github.com/bitcoin/bitcoin/pull/1677">PR #1677</a></td></tr>
<tr><td><code>blk000?.dat</code></td><td>Block data (custom format, 2 GiB per file); replaced by <code>blocks/blkNNNNN.dat</code><sup><a href="doc/files.html#note2">[2]</a></sup> in 0.8.0</td><td><a href="https://github.com/bitcoin/bitcoin/pull/1677">PR #1677</a></td></tr>
<tr><td><code>addr.dat</code></td><td>Peer IP address BDB database; replaced by <code>peers.dat</code> in <a href="https://github.com/bitcoin/bitcoin/blob/master/doc/release-notes/release-notes-0.7.0.md">0.7.0</a></td><td><a href="https://github.com/bitcoin/bitcoin/pull/1198">PR #1198</a>, <a href="https://github.com/bitcoin/bitcoin/commit/928d3a011cc66c7f907c4d053f674ea77dc611cc"><code>928d3a01</code></a></td></tr>
<tr><td><code>onion_private_key</code></td><td>Cached Tor onion service private key for <code>-listenonion</code> option. Was used for Tor v2 services; replaced by <code>onion_v3_private_key</code> in <a href="https://github.com/bitcoin/bitcoin/blob/master/doc/release-notes/release-notes-0.21.0.md">0.21.0</a></td><td><a href="https://github.com/bitcoin/bitcoin/pull/19954">PR #19954</a></td></tr>
</tbody></table>
</div>
<h2 id="notes-1"><a class="header" href="#notes-1">Notes</a></h2>
<p><a name="note1">1</a>. The <code>/</code> (slash, U+002F) is used as the platform-independent path component separator in this document.</p>
<p><a name="note2">2</a>. <code>NNNNN</code> matches <code>[0-9]{5}</code> regex.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="fuzzing-bitcoin-core-using-libfuzzer"><a class="header" href="#fuzzing-bitcoin-core-using-libfuzzer">Fuzzing Bitcoin Core using libFuzzer</a></h1>
<h2 id="quickstart-guide"><a class="header" href="#quickstart-guide">Quickstart guide</a></h2>
<p>To quickly get started fuzzing Bitcoin Core using <a href="https://llvm.org/docs/LibFuzzer.html">libFuzzer</a>:</p>
<pre><code class="language-sh">$ git clone https://github.com/bitcoin/bitcoin
$ cd bitcoin/
$ cmake --preset=libfuzzer
# macOS users: If you have problem with this step then make sure to read "macOS hints for
# libFuzzer" on https://github.com/bitcoin/bitcoin/blob/master/doc/fuzzing.md#macos-hints-for-libfuzzer
$ cmake --build build_fuzz
$ FUZZ=process_message build_fuzz/src/test/fuzz/fuzz
# abort fuzzing using ctrl-c
</code></pre>
<p>One can use <code>--prefix=libfuzzer-nosan</code> to do the same without common sanitizers enabled.
See <a href="doc/fuzzing.html#run-without-sanitizers-for-increased-throughput">further</a> for more information.</p>
<p>There is also a runner script to execute all fuzz targets. Refer to
<code>./test/fuzz/test_runner.py --help</code> for more details.</p>
<h2 id="overview-of-bitcoin-core-fuzzing"><a class="header" href="#overview-of-bitcoin-core-fuzzing">Overview of Bitcoin Core fuzzing</a></h2>
<p><a href="https://github.com/google/fuzzing/">Google</a> has a good overview of fuzzing in general, with contributions from key architects of some of the most-used fuzzers. <a href="https://agroce.github.io/bitcoin_report.pdf">This paper</a> includes an external overview of the status of Bitcoin Core fuzzing, as of summer 2021.  <a href="https://blog.regehr.org/archives/1687">John Regehr</a> provides good advice on writing code that assists fuzzers in finding bugs, which is useful for developers to keep in mind.</p>
<h2 id="fuzzing-harnesses-and-output"><a class="header" href="#fuzzing-harnesses-and-output">Fuzzing harnesses and output</a></h2>
<p><a href="https://github.com/bitcoin/bitcoin/blob/master/src/test/fuzz/process_message.cpp"><code>process_message</code></a> is a fuzzing harness for the <a href="https://github.com/bitcoin/bitcoin/blob/master/src/net_processing.cpp"><code>ProcessMessage(...)</code> function (<code>net_processing</code>)</a>. The available fuzzing harnesses are found in <a href="https://github.com/bitcoin/bitcoin/tree/master/src/test/fuzz"><code>src/test/fuzz/</code></a>.</p>
<p>The fuzzer will output <code>NEW</code> every time it has created a test input that covers new areas of the code under test. For more information on how to interpret the fuzzer output, see the <a href="https://llvm.org/docs/LibFuzzer.html">libFuzzer documentation</a>.</p>
<p>If you specify a corpus directory then any new coverage increasing inputs will be saved there:</p>
<pre><code class="language-sh">$ mkdir -p process_message-seeded-from-thin-air/
$ FUZZ=process_message build_fuzz/src/test/fuzz/fuzz process_message-seeded-from-thin-air/
INFO: Seed: 840522292
INFO: Loaded 1 modules   (424174 inline 8-bit counters): 424174 [0x55e121ef9ab8, 0x55e121f613a6),
INFO: Loaded 1 PC tables (424174 PCs): 424174 [0x55e121f613a8,0x55e1225da288),
INFO:        0 files found in process_message-seeded-from-thin-air/
INFO: -max_len is not provided; libFuzzer will not generate inputs larger than 4096 bytes
INFO: A corpus is not provided, starting from an empty corpus
#2      INITED cov: 94 ft: 95 corp: 1/1b exec/s: 0 rss: 150Mb
#3      NEW    cov: 95 ft: 96 corp: 2/3b lim: 4 exec/s: 0 rss: 150Mb L: 2/2 MS: 1 InsertByte-
#4      NEW    cov: 96 ft: 98 corp: 3/7b lim: 4 exec/s: 0 rss: 150Mb L: 4/4 MS: 1 CrossOver-
#21     NEW    cov: 96 ft: 100 corp: 4/11b lim: 4 exec/s: 0 rss: 150Mb L: 4/4 MS: 2 ChangeBit-CrossOver-
#324    NEW    cov: 101 ft: 105 corp: 5/12b lim: 6 exec/s: 0 rss: 150Mb L: 6/6 MS: 5 CrossOver-ChangeBit-CopyPart-ChangeBit-ChangeBinInt-
#1239   REDUCE cov: 102 ft: 106 corp: 6/24b lim: 14 exec/s: 0 rss: 150Mb L: 13/13 MS: 5 ChangeBit-CrossOver-EraseBytes-ChangeBit-InsertRepeatedBytes-
#1272   REDUCE cov: 102 ft: 106 corp: 6/23b lim: 14 exec/s: 0 rss: 150Mb L: 12/12 MS: 3 ChangeBinInt-ChangeBit-EraseBytes-
        NEW_FUNC[1/677]: 0x55e11f456690 in std::_Function_base::~_Function_base() /usr/lib/gcc/x86_64-linux-gnu/8/../../../../include/c++/8/bits/std_function.h:255
        NEW_FUNC[2/677]: 0x55e11f465800 in CDataStream::CDataStream(std::vector&lt;unsigned char, std::allocator&lt;unsigned char&gt; &gt; const&amp;, int, int) src/./streams.h:248
#2125   REDUCE cov: 4820 ft: 4867 corp: 7/29b lim: 21 exec/s: 0 rss: 155Mb L: 6/12 MS: 2 CopyPart-CMP- DE: "block"-
        NEW_FUNC[1/9]: 0x55e11f64d790 in std::_Rb_tree&lt;uint256, std::pair&lt;uint256 const, std::chrono::duration&lt;long, std::ratio&lt;1l, 1000000l&gt; &gt; &gt;, std::_Select1st&lt;std::pair&lt;uint256 const, std::chrono::duration&lt;long, std::ratio&lt;1l, 1000000l&gt; &gt; &gt; &gt;, std::less&lt;uint256&gt;, std::allocator&lt;std::pair&lt;uint256 const, std::chrono::duration&lt;long, std::ratio&lt;1l, 1000000l&gt; &gt; &gt; &gt; &gt;::~_Rb_tree() /usr/lib/gcc/x86_64-linux-gnu/8/../../../../include/c++/8/bits/stl_tree.h:972
        NEW_FUNC[2/9]: 0x55e11f64d870 in std::_Rb_tree&lt;uint256, std::pair&lt;uint256 const, std::chrono::duration&lt;long, std::ratio&lt;1l, 1000000l&gt; &gt; &gt;, std::_Select1st&lt;std::pair&lt;uint256 const, std::chrono::duration&lt;long, std::ratio&lt;1l, 1000000l&gt; &gt; &gt; &gt;, std::less&lt;uint256&gt;, std::allocator&lt;std::pair&lt;uint256 const, std::chrono::duration&lt;long, std::ratio&lt;1l, 1000000l&gt; &gt; &gt; &gt; &gt;::_M_erase(std::_Rb_tree_node&lt;std::pair&lt;uint256 const, std::chrono::duration&lt;long, std::ratio&lt;1l, 1000000l&gt; &gt; &gt; &gt;*) /usr/lib/gcc/x86_64-linux-gnu/8/../../../../include/c++/8/bits/stl_tree.h:1875
#2228   NEW    cov: 4898 ft: 4971 corp: 8/35b lim: 21 exec/s: 0 rss: 156Mb L: 6/12 MS: 3 EraseBytes-CopyPart-PersAutoDict- DE: "block"-
        NEW_FUNC[1/5]: 0x55e11f46df70 in std::enable_if&lt;__and_&lt;std::allocator_traits&lt;zero_after_free_allocator&lt;char&gt; &gt;::__construct_helper&lt;char, unsigned char const&amp;&gt;::type&gt;::value, void&gt;::type std::allocator_traits&lt;zero_after_free_allocator&lt;char&gt; &gt;::_S_construct&lt;char, unsigned char const&amp;&gt;(zero_after_free_allocator&lt;char&gt;&amp;, char*, unsigned char const&amp;) /usr/lib/gcc/x86_64-linux-gnu/8/../../../../include/c++/8/bits/alloc_traits.h:243
        NEW_FUNC[2/5]: 0x55e11f477390 in std::vector&lt;unsigned char, std::allocator&lt;unsigned char&gt; &gt;::data() /usr/lib/gcc/x86_64-linux-gnu/8/../../../../include/c++/8/bits/stl_vector.h:1056
#2456   NEW    cov: 4933 ft: 5042 corp: 9/55b lim: 21 exec/s: 0 rss: 160Mb L: 20/20 MS: 3 ChangeByte-InsertRepeatedBytes-PersAutoDict- DE: "block"-
#2467   NEW    cov: 4933 ft: 5043 corp: 10/76b lim: 21 exec/s: 0 rss: 161Mb L: 21/21 MS: 1 InsertByte-
#4215   NEW    cov: 4941 ft: 5129 corp: 17/205b lim: 29 exec/s: 4215 rss: 350Mb L: 29/29 MS: 5 InsertByte-ChangeBit-CopyPart-InsertRepeatedBytes-CrossOver-
#4567   REDUCE cov: 4941 ft: 5129 corp: 17/204b lim: 29 exec/s: 4567 rss: 404Mb L: 24/29 MS: 2 ChangeByte-EraseBytes-
#6642   NEW    cov: 4941 ft: 5138 corp: 18/244b lim: 43 exec/s: 2214 rss: 450Mb L: 43/43 MS: 3 CopyPart-CMP-CrossOver- DE: "verack"-
# abort fuzzing using ctrl-c
$ ls process_message-seeded-from-thin-air/
349ac589fc66a09abc0b72bb4ae445a7a19e2cd8 4df479f1f421f2ea64b383cd4919a272604087a7
a640312c98dcc55d6744730c33e41c5168c55f09 b135de16e4709558c0797c15f86046d31c5d86d7
c000f7b41b05139de8b63f4cbf7d1ad4c6e2aa7f fc52cc00ec1eb1c08470e69f809ae4993fa70082
$ cat --show-nonprinting process_message-seeded-from-thin-air/349ac589fc66a09abc0b72bb4ae445a7a19e2cd8
block^@M-^?M-^?M-^?M-^?M-^?nM-^?M-^?
</code></pre>
<p>In this case the fuzzer managed to create a <code>block</code> message which when passed to <code>ProcessMessage(...)</code> increased coverage.</p>
<p>It is possible to specify <code>bitcoind</code> arguments to the <code>fuzz</code> executable.
Depending on the test, they may be ignored or consumed and alter the behavior
of the test. Just make sure to use double-dash to distinguish them from the
fuzzer's own arguments:</p>
<pre><code class="language-sh">$ FUZZ=address_deserialize_v2 build_fuzz/src/test/fuzz/fuzz -runs=1 fuzz_corpora/address_deserialize_v2 --checkaddrman=5 --printtoconsole=1
</code></pre>
<h2 id="fuzzing-corpora"><a class="header" href="#fuzzing-corpora">Fuzzing corpora</a></h2>
<p>The project's collection of seed corpora is found in the <a href="https://github.com/bitcoin-core/qa-assets"><code>bitcoin-core/qa-assets</code></a> repo.</p>
<p>To fuzz <code>process_message</code> using the <a href="https://github.com/bitcoin-core/qa-assets"><code>bitcoin-core/qa-assets</code></a> seed corpus:</p>
<pre><code class="language-sh">$ git clone https://github.com/bitcoin-core/qa-assets
$ FUZZ=process_message build_fuzz/src/test/fuzz/fuzz qa-assets/fuzz_corpora/process_message/
INFO: Seed: 1346407872
INFO: Loaded 1 modules   (424174 inline 8-bit counters): 424174 [0x55d8a9004ab8, 0x55d8a906c3a6),
INFO: Loaded 1 PC tables (424174 PCs): 424174 [0x55d8a906c3a8,0x55d8a96e5288),
INFO:      991 files found in qa-assets/fuzz_corpora/process_message/
INFO: -max_len is not provided; libFuzzer will not generate inputs larger than 4096 bytes
INFO: seed corpus: files: 991 min: 1b max: 1858b total: 288291b rss: 150Mb
#993    INITED cov: 7063 ft: 8236 corp: 25/3821b exec/s: 0 rss: 181Mb
â€¦
</code></pre>
<h2 id="run-without-sanitizers-for-increased-throughput"><a class="header" href="#run-without-sanitizers-for-increased-throughput">Run without sanitizers for increased throughput</a></h2>
<p>Fuzzing on a harness compiled with <code>-DSANITIZERS=address,fuzzer,undefined</code> is
good for finding bugs. However, the very slow execution even under libFuzzer
will limit the ability to find new coverage. A good approach is to perform
occasional long runs without the additional bug-detectors
(<code>--preset=libfuzzer-nosan</code>) and then merge new inputs into a corpus as described in
the qa-assets repo
(https://github.com/bitcoin-core/qa-assets/blob/main/.github/PULL_REQUEST_TEMPLATE.md).
Patience is useful; even with improved throughput, libFuzzer may need days and
10s of millions of executions to reach deep/hard targets.</p>
<h2 id="reproduce-a-fuzzer-crash-reported-by-the-ci"><a class="header" href="#reproduce-a-fuzzer-crash-reported-by-the-ci">Reproduce a fuzzer crash reported by the CI</a></h2>
<ul>
<li><code>cd</code> into the <code>qa-assets</code> directory and update it with <code>git pull qa-assets</code></li>
<li>locate the crash case described in the CI output, e.g. <code>Test unit written to ./crash-1bc91feec9fc00b107d97dc225a9f2cdaa078eb6</code></li>
<li>make sure to compile with all sanitizers, if they are needed (fuzzing runs
more slowly with sanitizers enabled, but a crash should be reproducible very
quickly from a crash case)</li>
<li>run the fuzzer with the case number appended to the seed corpus path:
<code>FUZZ=process_message build_fuzz/src/test/fuzz/fuzz qa-assets/fuzz_corpora/process_message/1bc91feec9fc00b107d97dc225a9f2cdaa078eb6</code></li>
</ul>
<h2 id="submit-improved-coverage"><a class="header" href="#submit-improved-coverage">Submit improved coverage</a></h2>
<p>If you find coverage increasing inputs when fuzzing you are highly encouraged to submit them for inclusion in the <a href="https://github.com/bitcoin-core/qa-assets"><code>bitcoin-core/qa-assets</code></a> repo.</p>
<p>Every single pull request submitted against the Bitcoin Core repo is automatically tested against all inputs in the <a href="https://github.com/bitcoin-core/qa-assets"><code>bitcoin-core/qa-assets</code></a> repo. Contributing new coverage increasing inputs is an easy way to help make Bitcoin Core more robust.</p>
<h2 id="macos-hints-for-libfuzzer"><a class="header" href="#macos-hints-for-libfuzzer">macOS hints for libFuzzer</a></h2>
<p>The default Clang/LLVM version supplied by Apple on macOS does not include
fuzzing libraries, so macOS users will need to install a full version, for
example using <code>brew install llvm</code>.</p>
<p>You may also need to take care of giving the correct path for <code>clang</code> and
<code>clang++</code>, like <code>CC=/path/to/clang CXX=/path/to/clang++</code> if the non-systems
<code>clang</code> does not come first in your path.</p>
<p>Full configuration step that was tested on macOS with <code>brew</code> installed <code>llvm</code>:</p>
<pre><code class="language-sh">$ cmake --preset=libfuzzer \
   -DCMAKE_C_COMPILER="$(brew --prefix llvm)/bin/clang" \
   -DCMAKE_CXX_COMPILER="$(brew --prefix llvm)/bin/clang++" \
   -DAPPEND_LDFLAGS=-Wl,-no_warn_duplicate_libraries
</code></pre>
<p>Read the <a href="https://llvm.org/docs/LibFuzzer.html">libFuzzer documentation</a> for more information. This <a href="https://github.com/google/fuzzing/blob/master/tutorial/libFuzzerTutorial.md">libFuzzer tutorial</a> might also be of interest.</p>
<h1 id="fuzzing-bitcoin-core-using-afl"><a class="header" href="#fuzzing-bitcoin-core-using-afl">Fuzzing Bitcoin Core using afl++</a></h1>
<h2 id="quickstart-guide-1"><a class="header" href="#quickstart-guide-1">Quickstart guide</a></h2>
<p>To quickly get started fuzzing Bitcoin Core using <a href="https://github.com/AFLplusplus/AFLplusplus">afl++</a>:</p>
<pre><code class="language-sh">$ git clone https://github.com/bitcoin/bitcoin
$ cd bitcoin/
$ git clone https://github.com/AFLplusplus/AFLplusplus
$ make -C AFLplusplus/ source-only
# If afl-clang-lto is not available, see
# https://github.com/AFLplusplus/AFLplusplus#a-selecting-the-best-afl-compiler-for-instrumenting-the-target
$ cmake -B build_fuzz \
   -DCMAKE_C_COMPILER="$(pwd)/AFLplusplus/afl-clang-lto" \
   -DCMAKE_CXX_COMPILER="$(pwd)/AFLplusplus/afl-clang-lto++" \
   -DBUILD_FOR_FUZZING=ON
$ cmake --build build_fuzz
# For macOS you may need to ignore x86 compilation checks when running "cmake --build". If so,
# try compiling using: AFL_NO_X86=1 cmake --build build_fuzz
$ mkdir -p inputs/ outputs/
$ echo A &gt; inputs/thin-air-input
$ FUZZ=bech32 ./AFLplusplus/afl-fuzz -i inputs/ -o outputs/ -- build_fuzz/src/test/fuzz/fuzz
# You may have to change a few kernel parameters to test optimally - afl-fuzz
# will print an error and suggestion if so.
</code></pre>
<p>Read the <a href="https://github.com/AFLplusplus/AFLplusplus">afl++ documentation</a> for more information.</p>
<h1 id="fuzzing-bitcoin-core-using-honggfuzz"><a class="header" href="#fuzzing-bitcoin-core-using-honggfuzz">Fuzzing Bitcoin Core using Honggfuzz</a></h1>
<h2 id="quickstart-guide-2"><a class="header" href="#quickstart-guide-2">Quickstart guide</a></h2>
<p>To quickly get started fuzzing Bitcoin Core using <a href="https://github.com/google/honggfuzz">Honggfuzz</a>:</p>
<pre><code class="language-sh">$ git clone https://github.com/bitcoin/bitcoin
$ cd bitcoin/
$ git clone https://github.com/google/honggfuzz
$ cd honggfuzz/
$ make
$ cd ..
$ cmake -B build_fuzz \
   -DCMAKE_C_COMPILER="$(pwd)/honggfuzz/hfuzz_cc/hfuzz-clang" \
   -DCMAKE_CXX_COMPILER="$(pwd)/honggfuzz/hfuzz_cc/hfuzz-clang++" \
   -DBUILD_FOR_FUZZING=ON \
   -DSANITIZERS=address,undefined
$ cmake --build build_fuzz
$ mkdir -p inputs/
$ FUZZ=process_message ./honggfuzz/honggfuzz -i inputs/ -- build_fuzz/src/test/fuzz/fuzz
</code></pre>
<p>Read the <a href="https://github.com/google/honggfuzz/blob/master/docs/USAGE.md">Honggfuzz documentation</a> for more information.</p>
<h1 id="oss-fuzz"><a class="header" href="#oss-fuzz">OSS-Fuzz</a></h1>
<p>Bitcoin Core participates in Google's <a href="https://github.com/google/oss-fuzz/tree/master/projects/bitcoin-core">OSS-Fuzz</a>
program, which includes a dashboard of <a href="https://issues.oss-fuzz.com/issues?q=bitcoin-core%20status:open">publicly disclosed vulnerabilities</a>.</p>
<p>Bitcoin Core follows its <a href="https://bitcoincore.org/en/security-advisories/">security disclosure policy</a>,
which may differ from Google's standard
<a href="https://google.github.io/oss-fuzz/getting-started/bug-disclosure-guidelines/">90-day disclosure window</a>
.</p>
<p>OSS-Fuzz also produces <a href="https://oss-fuzz.com/coverage-report/job/libfuzzer_asan_bitcoin-core/latest">a fuzzing coverage report</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="bootstrappable-bitcoin-core-builds-1"><a class="header" href="#bootstrappable-bitcoin-core-builds-1">Bootstrappable Bitcoin Core Builds</a></h1>
<p>See <a href="doc/../contrib/guix/README.html">contrib/guix/README.md</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="i2p-support-in-bitcoin-core"><a class="header" href="#i2p-support-in-bitcoin-core">I2P support in Bitcoin Core</a></h1>
<p>It is possible to run Bitcoin Core as an
<a href="https://en.wikipedia.org/wiki/I2P">I2P (Invisible Internet Project)</a>
service and connect to such services.</p>
<p>This <a href="https://geti2p.net/en/about/glossary">glossary</a> may be useful to get
started with I2P terminology.</p>
<h2 id="run-bitcoin-core-with-an-i2p-router-proxy"><a class="header" href="#run-bitcoin-core-with-an-i2p-router-proxy">Run Bitcoin Core with an I2P router (proxy)</a></h2>
<p>A running I2P router (proxy) is required with the <a href="https://geti2p.net/en/docs/api/samv3">SAM</a>
application bridge enabled. The following routers are recommended for use with Bitcoin Core:</p>
<ul>
<li><a href="https://geti2p.net">i2prouter (I2P Router)</a>, the official implementation in
Java. The SAM bridge is not enabled by default; it must be started manually,
or configured to start automatically, in the Clients page in the
router console (<code>http://127.0.0.1:7657/configclients</code>) or in the <code>clients.config</code> file.</li>
<li><a href="https://github.com/PurpleI2P/i2pd">i2pd (I2P Daemon)</a>
(<a href="https://i2pd.readthedocs.io/en/latest">documentation</a>), a lighter
alternative in C++. It enables the SAM bridge by default.</li>
</ul>
<p>Note the IP address and port the SAM proxy is listening to; usually, it is
<code>127.0.0.1:7656</code>.</p>
<p>Once an I2P router with SAM enabled is up and running, use the following Bitcoin
Core configuration options:</p>
<pre><code>-i2psam=&lt;ip:port&gt;
     I2P SAM proxy to reach I2P peers and accept I2P connections (default:
     none)

-i2pacceptincoming
     Whether to accept inbound I2P connections (default: 1). Ignored if
     -i2psam is not set. Listening for inbound I2P connections is
     done through the SAM proxy, not by binding to a local address and
     port.
</code></pre>
<p>In a typical situation, this suffices:</p>
<pre><code>bitcoind -i2psam=127.0.0.1:7656
</code></pre>
<h2 id="additional-configuration-options-related-to-i2p"><a class="header" href="#additional-configuration-options-related-to-i2p">Additional configuration options related to I2P</a></h2>
<pre><code>-debug=i2p
</code></pre>
<p>Set the <code>debug=i2p</code> config logging option to see additional information in the
debug log about your I2P configuration and connections. Run <code>bitcoin-cli help logging</code> for more information.</p>
<pre><code>-onlynet=i2p
</code></pre>
<p>Make automatic outbound connections only to I2P addresses. Inbound and manual
connections are not affected by this option. It can be specified multiple times
to allow multiple networks, e.g. onlynet=onion, onlynet=i2p.</p>
<p>I2P support was added to Bitcoin Core in version 22.0 and there may be fewer I2P
peers than Tor or IP ones. Therefore, using I2P alone without other networks may
make a node more susceptible to <a href="https://en.bitcoin.it/wiki/Weaknesses#Sybil_attack">Sybil
attacks</a>. You can use
<code>bitcoin-cli -addrinfo</code> to see the number of I2P addresses known to your node.</p>
<p>Another consideration with <code>onlynet=i2p</code> is that the initial blocks download
phase when syncing up a new node can be very slow. This phase can be sped up by
using other networks, for instance <code>onlynet=onion</code>, at the same time.</p>
<p>In general, a node can be run with both onion and I2P hidden services (or
any/all of IPv4/IPv6/onion/I2P/CJDNS), which can provide a potential fallback if
one of the networks has issues.</p>
<h2 id="persistent-vs-transient-i2p-addresses"><a class="header" href="#persistent-vs-transient-i2p-addresses">Persistent vs transient I2P addresses</a></h2>
<p>The first time Bitcoin Core connects to the I2P router, it automatically
generates a persistent I2P address and its corresponding private key by default,
unless <code>-i2pacceptincoming=0</code> is set.  The private key is saved in a file named
<code>i2p_private_key</code> in the Bitcoin Core data directory.  The persistent I2P
address is used for making outbound connections and accepting inbound
connections.</p>
<p>In the I2P network, the receiver of an inbound connection sees the address of
the initiator.  This is unlike the Tor network, where the recipient does not
know who is connecting to it.</p>
<p>If your node is configured by setting <code>-i2pacceptincoming=0</code> to not accept
inbound I2P connections, then it will use a random transient I2P address for
itself on each outbound connection to make it harder to discriminate,
fingerprint or analyze it based on its I2P address.</p>
<p>I2P addresses are designed to be long-lived.  Waiting for tunnels to be built
for every peer connection adds delay to connection setup time.  Therefore, I2P
listening should only be turned off if really needed.</p>
<h2 id="fetching-i2p-related-information-from-bitcoin-core"><a class="header" href="#fetching-i2p-related-information-from-bitcoin-core">Fetching I2P-related information from Bitcoin Core</a></h2>
<p>There are several ways to see your I2P address in Bitcoin Core if accepting
incoming I2P connections (<code>-i2pacceptincoming</code>):</p>
<ul>
<li>in the "Local addresses" output of CLI <code>-netinfo</code></li>
<li>in the "localaddresses" output of RPC <code>getnetworkinfo</code></li>
<li>in the debug log (grep for <code>AddLocal</code>; the I2P address ends in <code>.b32.i2p</code>)</li>
</ul>
<p>To see which I2P peers your node is connected to, use <code>bitcoin-cli -netinfo 4</code>
or the <code>getpeerinfo</code> RPC (e.g. <code>bitcoin-cli getpeerinfo</code>).</p>
<p>You can use the <code>getnodeaddresses</code> RPC to fetch a number of I2P peers known to your node; run <code>bitcoin-cli help getnodeaddresses</code> for details.</p>
<h2 id="compatibility"><a class="header" href="#compatibility">Compatibility</a></h2>
<p>Bitcoin Core uses the <a href="https://geti2p.net/en/docs/api/samv3">SAM v3.1</a> protocol
to connect to the I2P network. Any I2P router that supports it can be used.</p>
<h2 id="ports-in-i2p-and-bitcoin-core"><a class="header" href="#ports-in-i2p-and-bitcoin-core">Ports in I2P and Bitcoin Core</a></h2>
<p>One particularity of SAM v3.1 is that it does not support ports,
unlike newer versions of SAM (v3.2 and up) that do support them and default the
port numbers to 0. From the point of view of peers that use newer versions of
SAM or other protocols that support ports, a SAM v3.1 peer is connecting to them
on port 0, from source port 0.</p>
<p>To allow future upgrades to newer versions of SAM, Bitcoin Core sets its
listening port to 0 when listening for incoming I2P connections and advertises
its own I2P address with port 0. Furthermore, it will not attempt to connect to
I2P addresses with a non-zero port number because with SAM v3.1 the destination
port (<code>TO_PORT</code>) is always set to 0 and is not in the control of Bitcoin Core.</p>
<h2 id="bandwidth"><a class="header" href="#bandwidth">Bandwidth</a></h2>
<p>By default, your node shares bandwidth and transit tunnels with the I2P network
in order to increase your anonymity with cover traffic, help the I2P router used
by your node integrate optimally with the network, and give back to the network.
It's important that the nodes of a popular application like Bitcoin contribute
as much to the I2P network as they consume.</p>
<p>It is possible, though strongly discouraged, to change your I2P router
configuration to limit the amount of I2P traffic relayed by your node.</p>
<p>With <code>i2pd</code>, this can be done by adjusting the <code>bandwidth</code>, <code>share</code> and
<code>transittunnels</code> options in your <code>i2pd.conf</code> file. For example, to limit total
I2P traffic to 256KB/s and share 50% of this limit for a maximum of 20 transit
tunnels:</p>
<pre><code>bandwidth = 256
share = 50

[limits]
transittunnels = 20
</code></pre>
<p>Similar bandwidth configuration options for the Java I2P router can be found in
<code>http://127.0.0.1:7657/config</code> under the "Bandwidth" tab.</p>
<p>Before doing this, please see the "Participating Traffic Considerations" section
in <a href="https://geti2p.net/en/docs/applications/embedding">Embedding I2P in your Application</a>.</p>
<p>In most cases, the default router settings should work fine.</p>
<h2 id="bundling-i2p-in-a-bitcoin-application"><a class="header" href="#bundling-i2p-in-a-bitcoin-application">Bundling I2P in a Bitcoin application</a></h2>
<p>Please see the "General Guidance for Developers" section in https://geti2p.net/en/docs/api/samv3
if you are developing a downstream application that may be bundling I2P with Bitcoin.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="sample-init-scripts-and-service-configuration-for-bitcoind"><a class="header" href="#sample-init-scripts-and-service-configuration-for-bitcoind">Sample init scripts and service configuration for bitcoind</a></h1>
<p>Sample scripts and configuration files for systemd, Upstart and OpenRC
can be found in the contrib/init folder.</p>
<pre><code>contrib/init/bitcoind.service:    systemd service unit configuration
contrib/init/bitcoind.openrc:     OpenRC compatible SysV style init script
contrib/init/bitcoind.openrcconf: OpenRC conf.d file
contrib/init/bitcoind.conf:       Upstart service configuration file
contrib/init/bitcoind.init:       CentOS compatible SysV style init script
</code></pre>
<h2 id="service-user"><a class="header" href="#service-user">Service User</a></h2>
<p>All three Linux startup configurations assume the existence of a "bitcoin" user
and group.  They must be created before attempting to use these scripts.
The macOS configuration assumes bitcoind will be set up for the current user.</p>
<h2 id="configuration"><a class="header" href="#configuration">Configuration</a></h2>
<p>Running bitcoind as a daemon does not require any manual configuration. You may
set the <code>rpcauth</code> setting in the <code>bitcoin.conf</code> configuration file to override
the default behaviour of using a special cookie for authentication.</p>
<p>This password does not have to be remembered or typed as it is mostly used
as a fixed token that bitcoind and client programs read from the configuration
file, however it is recommended that a strong and secure password be used
as this password is security critical to securing the wallet should the
wallet be enabled.</p>
<p>If bitcoind is run with the "-server" flag (set by default), and no rpcpassword is set,
it will use a special cookie file for authentication. The cookie is generated with random
content when the daemon starts, and deleted when it exits. Read access to this file
controls who can access it through RPC.</p>
<p>By default the cookie is stored in the data directory, but its location can be
overridden with the option <code>-rpccookiefile</code>. Default file permissions for the
cookie are "owner" (i.e. user read/writeable) via default application-wide file
umask of <code>0077</code>, but these can be overridden with the <code>-rpccookieperms</code> option.</p>
<p>This allows for running bitcoind without having to do any manual configuration.</p>
<p><code>conf</code>, <code>pid</code>, and <code>wallet</code> accept relative paths which are interpreted as
relative to the data directory. <code>wallet</code> <em>only</em> supports relative paths.</p>
<p>To generate an example configuration file that describes the configuration settings,
see <a href="doc/../contrib/devtools/README.html#gen-bitcoin-confsh">contrib/devtools/README.md</a>.</p>
<h2 id="paths"><a class="header" href="#paths">Paths</a></h2>
<h3 id="linux"><a class="header" href="#linux">Linux</a></h3>
<p>All three configurations assume several paths that might need to be adjusted.</p>
<pre><code>Binary:              /usr/bin/bitcoind
Configuration file:  /etc/bitcoin/bitcoin.conf
Data directory:      /var/lib/bitcoind
PID file:            /var/run/bitcoind/bitcoind.pid (OpenRC and Upstart) or
                     /run/bitcoind/bitcoind.pid (systemd)
Lock file:           /var/lock/subsys/bitcoind (CentOS)
</code></pre>
<p>The PID directory (if applicable) and data directory should both be owned by the
bitcoin user and group. It is advised for security reasons to make the
configuration file and data directory only readable by the bitcoin user and
group. Access to bitcoin-cli and other bitcoind rpc clients can then be
controlled by group membership.</p>
<p>NOTE: When using the systemd .service file, the creation of the aforementioned
directories and the setting of their permissions is automatically handled by
systemd. Directories are given a permission of 710, giving the bitcoin group
access to files under it <em>if</em> the files themselves give permission to the
bitcoin group to do so. This does not allow
for the listing of files under the directory.</p>
<p>NOTE: It is not currently possible to override <code>datadir</code> in
<code>/etc/bitcoin/bitcoin.conf</code> with the current systemd, OpenRC, and Upstart init
files out-of-the-box. This is because the command line options specified in the
init files take precedence over the configurations in
<code>/etc/bitcoin/bitcoin.conf</code>. However, some init systems have their own
configuration mechanisms that would allow for overriding the command line
options specified in the init files (e.g. setting <code>BITCOIND_DATADIR</code> for
OpenRC).</p>
<h3 id="macos-1"><a class="header" href="#macos-1">macOS</a></h3>
<pre><code>Binary:              /usr/local/bin/bitcoind
Configuration file:  ~/Library/Application Support/Bitcoin/bitcoin.conf
Data directory:      ~/Library/Application Support/Bitcoin
Lock file:           ~/Library/Application Support/Bitcoin/.lock
</code></pre>
<h2 id="installing-service-configuration"><a class="header" href="#installing-service-configuration">Installing Service Configuration</a></h2>
<h3 id="systemd"><a class="header" href="#systemd">systemd</a></h3>
<p>Installing this .service file consists of just copying it to
/usr/lib/systemd/system directory, followed by the command
<code>systemctl daemon-reload</code> in order to update running systemd configuration.</p>
<p>To test, run <code>systemctl start bitcoind</code> and to enable for system startup run
<code>systemctl enable bitcoind</code></p>
<p>NOTE: When installing for systemd in Debian/Ubuntu the .service file needs to be copied to the /lib/systemd/system directory instead.</p>
<h3 id="openrc"><a class="header" href="#openrc">OpenRC</a></h3>
<p>Rename bitcoind.openrc to bitcoind and drop it in /etc/init.d.  Double
check ownership and permissions and make it executable.  Test it with
<code>/etc/init.d/bitcoind start</code> and configure it to run on startup with
<code>rc-update add bitcoind</code></p>
<h3 id="upstart-for-debianubuntu-based-distributions"><a class="header" href="#upstart-for-debianubuntu-based-distributions">Upstart (for Debian/Ubuntu based distributions)</a></h3>
<p>Upstart is the default init system for Debian/Ubuntu versions older than 15.04. If you are using version 15.04 or newer and haven't manually configured upstart you should follow the systemd instructions instead.</p>
<p>Drop bitcoind.conf in /etc/init.  Test by running <code>service bitcoind start</code>
it will automatically start on reboot.</p>
<p>NOTE: This script is incompatible with CentOS 5 and Amazon Linux 2014 as they
use old versions of Upstart and do not supply the start-stop-daemon utility.</p>
<h3 id="centos"><a class="header" href="#centos">CentOS</a></h3>
<p>Copy bitcoind.init to /etc/init.d/bitcoind. Test by running <code>service bitcoind start</code>.</p>
<p>Using this script, you can adjust the path and flags to the bitcoind program by
setting the BITCOIND and FLAGS environment variables in the file
/etc/sysconfig/bitcoind. You can also use the DAEMONOPTS environment variable here.</p>
<h3 id="macos-2"><a class="header" href="#macos-2">macOS</a></h3>
<p>Copy org.bitcoin.bitcoind.plist into ~/Library/LaunchAgents. Load the launch agent by
running <code>launchctl load ~/Library/LaunchAgents/org.bitcoin.bitcoind.plist</code>.</p>
<p>This Launch Agent will cause bitcoind to start whenever the user logs in.</p>
<p>NOTE: This approach is intended for those wanting to run bitcoind as the current user.
You will need to modify org.bitcoin.bitcoind.plist if you intend to use it as a
Launch Daemon with a dedicated bitcoin user.</p>
<h2 id="auto-respawn"><a class="header" href="#auto-respawn">Auto-respawn</a></h2>
<p>Auto respawning is currently only configured for Upstart and systemd.
Reasonable defaults have been chosen but YMMV.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="managing-the-wallet"><a class="header" href="#managing-the-wallet">Managing the Wallet</a></h1>
<h2 id="1-backing-up-and-restoring-the-wallet"><a class="header" href="#1-backing-up-and-restoring-the-wallet">1. Backing Up and Restoring The Wallet</a></h2>
<h3 id="11-creating-the-wallet"><a class="header" href="#11-creating-the-wallet">1.1 Creating the Wallet</a></h3>
<p>Since version 0.21, Bitcoin Core no longer has a default wallet.
Wallets can be created with the <code>createwallet</code> RPC or with the <code>Create wallet</code> GUI menu item.</p>
<p>In the GUI, the <code>Create a new wallet</code> button is displayed on the main screen when there is no wallet loaded. Alternatively, there is the option <code>File</code> -&gt;<code>Create wallet</code>.</p>
<p>The following command, for example, creates a descriptor wallet. More information about this command may be found by running <code>bitcoin-cli help createwallet</code>.</p>
<pre><code>$ bitcoin-cli createwallet "wallet-01"
</code></pre>
<p>By default, wallets are created in the <code>wallets</code> folder of the data directory, which varies by operating system, as shown below. The user can change the default by using the <code>-datadir</code> or <code>-walletdir</code> initialization parameters.</p>
<div class="table-wrapper"><table><thead><tr><th>Operating System</th><th style="text-align: left">Default wallet directory</th></tr></thead><tbody>
<tr><td>Linux</td><td style="text-align: left"><code>/home/&lt;user&gt;/.bitcoin/wallets</code></td></tr>
<tr><td>Windows</td><td style="text-align: left"><code>C:\Users\&lt;user&gt;\AppData\Local\Bitcoin\wallets</code></td></tr>
<tr><td>macOS</td><td style="text-align: left"><code>/Users/&lt;user&gt;/Library/Application Support/Bitcoin/wallets</code></td></tr>
</tbody></table>
</div>
<h3 id="12-encrypting-the-wallet"><a class="header" href="#12-encrypting-the-wallet">1.2 Encrypting the Wallet</a></h3>
<p>The <code>wallet.dat</code> file is not encrypted by default and is, therefore, vulnerable if an attacker gains access to the device where the wallet or the backups are stored.</p>
<p>Wallet encryption may prevent unauthorized access. However, this significantly increases the risk of losing coins due to forgotten passphrases. There is no way to recover a passphrase. This tradeoff should be well thought out by the user.</p>
<p>Wallet encryption may also not protect against more sophisticated attacks. An attacker can, for example, obtain the password by installing a keylogger on the user's machine.</p>
<p>After encrypting the wallet or changing the passphrase, a new backup needs to be created immediately. The reason is that the keypool is flushed and a new HD seed is generated after encryption. Any bitcoins received by the new seed cannot be recovered from the previous backups.</p>
<p>The wallet's private key may be encrypted with the following command:</p>
<pre><code>$ bitcoin-cli -rpcwallet="wallet-01" encryptwallet "passphrase"
</code></pre>
<p>Once encrypted, the passphrase can be changed with the <code>walletpassphrasechange</code> command.</p>
<pre><code>$ bitcoin-cli -rpcwallet="wallet-01" walletpassphrasechange "oldpassphrase" "newpassphrase"
</code></pre>
<p>The argument passed to <code>-rpcwallet</code> is the name of the wallet to be encrypted.</p>
<p>Only the wallet's private key is encrypted. All other wallet information, such as transactions, is still visible.</p>
<p>The wallet's private key can also be encrypted in the <code>createwallet</code> command via the <code>passphrase</code> argument:</p>
<pre><code>$ bitcoin-cli -named createwallet wallet_name="wallet-01" passphrase="passphrase"
</code></pre>
<p>Note that if the passphrase is lost, all the coins in the wallet will also be lost forever.</p>
<h3 id="13-unlocking-the-wallet"><a class="header" href="#13-unlocking-the-wallet">1.3 Unlocking the Wallet</a></h3>
<p>If the wallet is encrypted and the user tries any operation related to private keys, such as sending bitcoins, an error message will be displayed.</p>
<pre><code>$ bitcoin-cli -rpcwallet="wallet-01" sendtoaddress "tb1qw508d6qejxtdg4y5r3zarvary0c5xw7kxpjzsx" 0.01
error code: -13
error message:
Error: Please enter the wallet passphrase with walletpassphrase first.
</code></pre>
<p>To unlock the wallet and allow it to run these operations, the <code>walletpassphrase</code> RPC is required.</p>
<p>This command takes the passphrase and an argument called <code>timeout</code>, which specifies the time in seconds that the wallet decryption key is stored in memory. After this period expires, the user needs to execute this RPC again.</p>
<pre><code>$ bitcoin-cli -rpcwallet="wallet-01" walletpassphrase "passphrase" 120
</code></pre>
<p>In the GUI, there is no specific menu item to unlock the wallet. When the user sends bitcoins, the passphrase will be prompted automatically.</p>
<h3 id="14-backing-up-the-wallet"><a class="header" href="#14-backing-up-the-wallet">1.4 Backing Up the Wallet</a></h3>
<p>To backup the wallet, the <code>backupwallet</code> RPC or the <code>Backup Wallet</code> GUI menu item must be used to ensure the file is in a safe state when the copy is made.</p>
<p>In the RPC, the destination parameter must include the name of the file. Otherwise, the command will return an error message like "Error: Wallet backup failed!" for descriptor wallets. If it is a legacy wallet, it will be copied and a file will be created with the default file name <code>wallet.dat</code>.</p>
<pre><code>$ bitcoin-cli -rpcwallet="wallet-01" backupwallet /home/node01/Backups/backup-01.dat
</code></pre>
<p>In the GUI, the wallet is selected in the <code>Wallet</code> drop-down list in the upper right corner. If this list is not present, the wallet can be loaded in <code>File</code> -&gt;<code>Open Wallet</code> if necessary. Then, the backup can be done in <code>File</code> -&gt; <code>Backup Walletâ€¦</code>.</p>
<p>This backup file can be stored on one or multiple offline devices, which must be reliable enough to work in an emergency and be malware free. Backup files can be regularly tested to avoid problems in the future.</p>
<p>If the computer has malware, it can compromise the wallet when recovering the backup file. One way to minimize this is to not connect the backup to an online device.</p>
<p>If both the wallet and all backups are lost for any reason, the bitcoins related to this wallet will become permanently inaccessible.</p>
<h3 id="15-backup-frequency"><a class="header" href="#15-backup-frequency">1.5 Backup Frequency</a></h3>
<p>The original Bitcoin Core wallet was a collection of unrelated private keys. If a non-HD wallet had received funds to an address and then was restored from a backup made before the address was generated, then any funds sent to that address would have been lost because there was no deterministic mechanism to derive the address again.</p>
<p>Bitcoin Core <a href="https://github.com/bitcoin/bitcoin/blob/master/doc/release-notes/release-notes-0.13.0.md">version 0.13</a> introduced HD wallets with deterministic key derivation. With HD wallets, users no longer lose funds when restoring old backups because all addresses are derived from the HD wallet seed.</p>
<p>This means that a single backup is enough to recover the coins at any time. It is still recommended to make regular backups (once a week) or after a significant number of new transactions to maintain the metadata, such as labels. Metadata cannot be retrieved from a blockchain rescan, so if the backup is too old, the metadata will be lost forever.</p>
<p>Wallets created before version 0.13 are not HD and must be backed up every 100 keys used since the previous backup, or even more often to maintain the metadata.</p>
<h3 id="16-restoring-the-wallet-from-a-backup"><a class="header" href="#16-restoring-the-wallet-from-a-backup">1.6 Restoring the Wallet From a Backup</a></h3>
<p>To restore a wallet, the <code>restorewallet</code> RPC or the <code>Restore Wallet</code> GUI menu item (<code>File</code> -&gt; <code>Restore Walletâ€¦</code>) must be used.</p>
<pre><code>$ bitcoin-cli restorewallet "restored-wallet" /home/node01/Backups/backup-01.dat
</code></pre>
<p>After that, <code>getwalletinfo</code> can be used to check if the wallet has been fully restored.</p>
<pre><code>$ bitcoin-cli -rpcwallet="restored-wallet" getwalletinfo
</code></pre>
<p>The restored wallet can also be loaded in the GUI via <code>File</code> -&gt;<code>Open wallet</code>.</p>
<h2 id="wallet-passphrase"><a class="header" href="#wallet-passphrase">Wallet Passphrase</a></h2>
<p>Understanding wallet security is crucial for safely storing your Bitcoin. A key aspect is the wallet passphrase, used for encryption. Let's explore its nuances, role, encryption process, and limitations.</p>
<ul>
<li>
<p><strong>Not the Seed:</strong>
The wallet passphrase and the seed are two separate components in wallet security. The seed, or HD seed, functions as a master key for deriving private and public keys in a hierarchical deterministic (HD) wallet. In contrast, the passphrase serves as an additional layer of security specifically designed to secure the private keys within the wallet. The passphrase serves as a safeguard, demanding an additional layer of authentication to access funds in the wallet.</p>
</li>
<li>
<p><strong>Protection Against Unauthorized Access:</strong>
The passphrase serves as a protective measure, securing your funds in situations where an unauthorized user gains access to your unlocked computer or device while your wallet application is active. Without the passphrase, they would be unable to access your wallet's funds or execute transactions. However, it's essential to be aware that someone with access can potentially compromise the security of your passphrase by installing a keylogger.</p>
</li>
<li>
<p><strong>Doesn't Encrypt Metadata or Public Keys:</strong>
It's important to note that the passphrase primarily secures the private keys and access to funds within the wallet. It does not encrypt metadata associated with transactions or public keys. Information about your transaction history and the public keys involved may still be visible.</p>
</li>
<li>
<p><strong>Risk of Fund Loss if Forgotten or Lost:</strong>
If the wallet passphrase is too complex and is subsequently forgotten or lost, there is a risk of losing access to the funds permanently. A forgotten passphrase will result in the inability to unlock the wallet and access the funds.</p>
</li>
</ul>
<h2 id="migrating-legacy-wallets-to-descriptor-wallets"><a class="header" href="#migrating-legacy-wallets-to-descriptor-wallets">Migrating Legacy Wallets to Descriptor Wallets</a></h2>
<p>Legacy wallets (traditional non-descriptor wallets) can be migrated to become Descriptor wallets
through the use of the <code>migratewallet</code> RPC. Migrated wallets will have all of their addresses and private keys added to
a newly created Descriptor wallet that has the same name as the original wallet. Because Descriptor
wallets do not support having private keys and watch-only scripts, there may be up to two
additional wallets created after migration. In addition to a descriptor wallet of the same name,
there may also be a wallet named <code>&lt;name&gt;_watchonly</code> and <code>&lt;name&gt;_solvables</code>. <code>&lt;name&gt;_watchonly</code>
contains all of the watchonly scripts. <code>&lt;name&gt;_solvables</code> contains any scripts which the wallet
knows but is not watching the corresponding P2(W)SH scripts.</p>
<p>Migrated wallets will also generate new addresses differently. While the same BIP 32 seed will be
used, the BIP 44, 49, 84, and 86 standard derivation paths will be used. After migrating, a new
backup of the wallet(s) will need to be created.</p>
<p>Given that there is an extremely large number of possible configurations for the scripts that
Legacy wallets can know about, be watching for, and be able to sign for, <code>migratewallet</code> only
makes a best effort attempt to capture all of these things into Descriptor wallets. There may be
unforeseen configurations which result in some scripts being excluded. If a migration fails
unexpectedly or otherwise misses any scripts, please create an issue on GitHub. A backup of the
original wallet can be found in the wallet directory with the name <code>&lt;name&gt;-&lt;timestamp&gt;.legacy.bak</code>.</p>
<p>The backup can be restored using the methods discussed in the
<a href="doc/managing-wallets.html#16-restoring-the-wallet-from-a-backup">Restoring the Wallet From a Backup</a> section.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="multiprocess-bitcoin"><a class="header" href="#multiprocess-bitcoin">Multiprocess Bitcoin</a></h1>
<p><em>This document describes usage of the multiprocess feature. For design information, see the <a href="doc/design/multiprocess.html">design/multiprocess.md</a> file.</em></p>
<h2 id="build-option"><a class="header" href="#build-option">Build Option</a></h2>
<p>On Unix systems, the <code>-DWITH_MULTIPROCESS=ON</code> build option can be passed to build the supplemental <code>bitcoin-node</code> and <code>bitcoin-gui</code> multiprocess executables.</p>
<h2 id="debugging"><a class="header" href="#debugging">Debugging</a></h2>
<p>The <code>-debug=ipc</code> command line option can be used to see requests and responses between processes.</p>
<h2 id="installation-1"><a class="header" href="#installation-1">Installation</a></h2>
<p>The multiprocess feature requires <a href="https://capnproto.org/">Cap'n Proto</a> and <a href="https://github.com/chaincodelabs/libmultiprocess">libmultiprocess</a> as dependencies. A simple way to get started using it without installing these dependencies manually is to use the <a href="doc/../depends">depends system</a> with the <code>MULTIPROCESS=1</code> <a href="doc/../depends#dependency-options">dependency option</a> passed to make:</p>
<pre><code>cd &lt;BITCOIN_SOURCE_DIRECTORY&gt;
make -C depends NO_QT=1 MULTIPROCESS=1
# Set host platform to output of gcc -dumpmachine or clang -dumpmachine or check the depends/ directory for the generated subdirectory name
HOST_PLATFORM="x86_64-pc-linux-gnu"
cmake -B build --toolchain=depends/$HOST_PLATFORM/toolchain.cmake
cmake --build build
build/src/bitcoin-node -regtest -printtoconsole -debug=ipc
BITCOIND=$(pwd)/build/src/bitcoin-node build/test/functional/test_runner.py
</code></pre>
<p>The <code>cmake</code> build will pick up settings and library locations from the depends directory, so there is no need to pass <code>-DWITH_MULTIPROCESS=ON</code> as a separate flag when using the depends system (it's controlled by the <code>MULTIPROCESS=1</code> option).</p>
<p>Alternately, you can install <a href="https://capnproto.org/">Cap'n Proto</a> and <a href="https://github.com/chaincodelabs/libmultiprocess">libmultiprocess</a> packages on your system, and just run <code>cmake -B build -DWITH_MULTIPROCESS=ON</code> without using the depends system. The <code>cmake</code> build will be able to locate the installed packages via <a href="https://www.freedesktop.org/wiki/Software/pkg-config/">pkg-config</a>. See <a href="https://github.com/chaincodelabs/libmultiprocess/blob/master/doc/install.md">Installation</a> section of the libmultiprocess readme for install steps. See <a href="doc/build-unix.html">build-unix.md</a> and <a href="doc/build-osx.html">build-osx.md</a> for information about installing dependencies in general.</p>
<h2 id="usage-4"><a class="header" href="#usage-4">Usage</a></h2>
<p><code>bitcoin-node</code> is a drop-in replacement for <code>bitcoind</code>, and <code>bitcoin-gui</code> is a drop-in replacement for <code>bitcoin-qt</code>, and there are no differences in use or external behavior between the new and old executables. But internally after <a href="https://github.com/bitcoin/bitcoin/pull/10102">#10102</a>, <code>bitcoin-gui</code> will spawn a <code>bitcoin-node</code> process to run P2P and RPC code, communicating with it across a socket pair, and <code>bitcoin-node</code> will spawn <code>bitcoin-wallet</code> to run wallet code, also communicating over a socket pair. This will let node, wallet, and GUI code run in separate address spaces for better isolation, and allow future improvements like being able to start and stop components independently on different machines and environments.
<a href="https://github.com/bitcoin/bitcoin/pull/19460">#19460</a> also adds a new <code>bitcoin-node</code> <code>-ipcbind</code> option and an <code>bitcoind-wallet</code> <code>-ipcconnect</code> option to allow new wallet processes to connect to an existing node process.
And <a href="https://github.com/bitcoin/bitcoin/pull/19461">#19461</a> adds a new <code>bitcoin-gui</code> <code>-ipcconnect</code> option to allow new GUI processes to connect to an existing node process.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="1-multisig-tutorial"><a class="header" href="#1-multisig-tutorial">1. Multisig Tutorial</a></h1>
<p>Currently, it is possible to create a multisig wallet using Bitcoin Core only.</p>
<p>Although there is already a brief explanation about the multisig in the <a href="https://github.com/bitcoin/bitcoin/blob/master/doc/descriptors.md#multisig">Descriptors documentation</a>, this tutorial proposes to use the signet (instead of regtest), bringing the reader closer to a real environment and explaining some functions in more detail.</p>
<p>This tutorial uses <a href="https://github.com/stedolan/jq">jq</a> JSON processor to process the results from RPC and stores the relevant values in bash variables. This makes the tutorial reproducible and easier to follow step by step.</p>
<p>Before starting this tutorial, start the bitcoin node on the signet network.</p>
<pre><code class="language-bash">./build/src/bitcoind -signet -daemon
</code></pre>
<p>This tutorial also uses the default WPKH derivation path to get the xpubs and does not conform to <a href="https://github.com/bitcoin/bips/blob/master/bip-0045.mediawiki">BIP 45</a> or <a href="https://github.com/bitcoin/bips/blob/master/bip-0087.mediawiki">BIP 87</a>.</p>
<p>At the time of writing, there is no way to extract a specific path from wallets in Bitcoin Core. For this, an external signer/xpub can be used.</p>
<h2 id="11-basic-multisig-workflow"><a class="header" href="#11-basic-multisig-workflow">1.1 Basic Multisig Workflow</a></h2>
<h3 id="11-create-the-descriptor-wallets"><a class="header" href="#11-create-the-descriptor-wallets">1.1 Create the Descriptor Wallets</a></h3>
<p>For a 2-of-3 multisig, create 3 descriptor wallets. It is important that they are of the descriptor type in order to retrieve the wallet descriptors. These wallets contain HD seed and private keys, which will be used to sign the PSBTs and derive the xpub.</p>
<p>These three wallets should not be used directly for privacy reasons (public key reuse). They should only be used to sign transactions for the (watch-only) multisig wallet.</p>
<pre><code class="language-bash">for ((n=1;n&lt;=3;n++))
do
 ./build/src/bitcoin-cli -signet createwallet "participant_${n}"
done
</code></pre>
<p>Extract the xpub of each wallet. To do this, the <code>listdescriptors</code> RPC is used. By default, Bitcoin Core single-sig wallets are created using path <code>m/44'/1'/0'</code> for PKH, <code>m/84'/1'/0'</code> for WPKH, <code>m/49'/1'/0'</code> for P2WPKH-nested-in-P2SH and <code>m/86'/1'/0'</code> for P2TR based accounts. Each of them uses the chain 0 for external addresses and chain 1 for internal ones, as shown in the example below.</p>
<pre><code>wpkh([1004658e/84'/1'/0']tpubDCBEcmVKbfC9KfdydyLbJ2gfNL88grZu1XcWSW9ytTM6fitvaRmVyr8Ddf7SjZ2ZfMx9RicjYAXhuh3fmLiVLPodPEqnQQURUfrBKiiVZc8/0/*)#g8l47ngv

wpkh([1004658e/84'/1'/0']tpubDCBEcmVKbfC9KfdydyLbJ2gfNL88grZu1XcWSW9ytTM6fitvaRmVyr8Ddf7SjZ2ZfMx9RicjYAXhuh3fmLiVLPodPEqnQQURUfrBKiiVZc8/1/*)#en65rxc5
</code></pre>
<p>The suffix (after #) is the checksum. Descriptors can optionally be suffixed with a checksum to protect against typos or copy-paste errors.
All RPCs in Bitcoin Core will include the checksum in their output.</p>
<pre><code class="language-bash">declare -A xpubs

for ((n=1;n&lt;=3;n++))
do
 xpubs["internal_xpub_${n}"]=$(./build/src/bitcoin-cli -signet -rpcwallet="participant_${n}" listdescriptors | jq '.descriptors | [.[] | select(.desc | startswith("wpkh") and contains("/1/*"))][0] | .desc' | grep -Po '(?&lt;=\().*(?=\))')

 xpubs["external_xpub_${n}"]=$(./build/src/bitcoin-cli -signet -rpcwallet="participant_${n}" listdescriptors | jq '.descriptors | [.[] | select(.desc | startswith("wpkh") and contains("/0/*") )][0] | .desc' | grep -Po '(?&lt;=\().*(?=\))')
done
</code></pre>
<p><code>jq</code> is used to extract the xpub from the <code>wpkh</code> descriptor.</p>
<p>The following command can be used to verify if the xpub was generated correctly.</p>
<pre><code class="language-bash">for x in "${!xpubs[@]}"; do printf "[%s]=%s\n" "$x" "${xpubs[$x]}" ; done
</code></pre>
<p>As previously mentioned, this step extracts the <code>m/84'/1'/0'</code> account instead of the path defined in <a href="https://github.com/bitcoin/bips/blob/master/bip-0045.mediawiki">BIP 45</a> or <a href="https://github.com/bitcoin/bips/blob/master/bip-0087.mediawiki">BIP 87</a>, since there is no way to extract a specific path in Bitcoin Core at the time of writing.</p>
<h3 id="12-define-the-multisig-descriptors"><a class="header" href="#12-define-the-multisig-descriptors">1.2 Define the Multisig Descriptors</a></h3>
<p>Define the external and internal multisig descriptors, add the checksum and then, join both in a JSON array.</p>
<pre><code class="language-bash">external_desc="wsh(sortedmulti(2,${xpubs["external_xpub_1"]},${xpubs["external_xpub_2"]},${xpubs["external_xpub_3"]}))"
internal_desc="wsh(sortedmulti(2,${xpubs["internal_xpub_1"]},${xpubs["internal_xpub_2"]},${xpubs["internal_xpub_3"]}))"

external_desc_sum=$(./build/src/bitcoin-cli -signet getdescriptorinfo $external_desc | jq '.descriptor')
internal_desc_sum=$(./build/src/bitcoin-cli -signet getdescriptorinfo $internal_desc | jq '.descriptor')

multisig_ext_desc="{\"desc\": $external_desc_sum, \"active\": true, \"internal\": false, \"timestamp\": \"now\"}"
multisig_int_desc="{\"desc\": $internal_desc_sum, \"active\": true, \"internal\": true, \"timestamp\": \"now\"}"

multisig_desc="[$multisig_ext_desc, $multisig_int_desc]"
</code></pre>
<p><code>external_desc</code> and <code>internal_desc</code> specify the output type (<code>wsh</code>, in this case) and the xpubs involved. They also use BIP 67 (<code>sortedmulti</code>), so the wallet can be recreated without worrying about the order of xpubs. Conceptually, descriptors describe a list of scriptPubKey (along with information for spending from it) [<a href="https://github.com/bitcoin/bitcoin/issues/21199#issuecomment-780772418">source</a>].</p>
<p>Note that at least two descriptors are usually used, one for internal derivation paths and one for external ones. There are discussions about eliminating this redundancy, as can be seen in the issue <a href="https://github.com/bitcoin/bitcoin/issues/17190">#17190</a>.</p>
<p>After creating the descriptors, it is necessary to add the checksum, which is required by the <code>importdescriptors</code> RPC.</p>
<p>The checksum for a descriptor without one can be computed using the <code>getdescriptorinfo</code> RPC. The response has the <code>descriptor</code> field, which is the descriptor with the checksum added.</p>
<p>There are other fields that can be added to the descriptors:</p>
<ul>
<li><code>active</code>: Sets the descriptor to be the active one for the corresponding output type (<code>wsh</code>, in this case).</li>
<li><code>internal</code>: Indicates whether matching outputs should be treated as something other than incoming payments (e.g. change).</li>
<li><code>timestamp</code>: Sets the time from which to start rescanning the blockchain for the descriptor, in UNIX epoch time.</li>
</ul>
<p>Documentation for these and other parameters can be found by typing <code>./build/src/bitcoin-cli help importdescriptors</code>.</p>
<p><code>multisig_desc</code> concatenates external and internal descriptors in a JSON array and then it will be used to create the multisig wallet.</p>
<h3 id="13-create-the-multisig-wallet"><a class="header" href="#13-create-the-multisig-wallet">1.3 Create the Multisig Wallet</a></h3>
<p>To create the multisig wallet, first create an empty one (no keys, HD seed and private keys disabled).</p>
<p>Then import the descriptors created in the previous step using the <code>importdescriptors</code> RPC.</p>
<p>After that, <code>getwalletinfo</code> can be used to check if the wallet was created successfully.</p>
<pre><code class="language-bash">./build/src/bitcoin-cli -signet -named createwallet wallet_name="multisig_wallet_01" disable_private_keys=true blank=true

./build/src/bitcoin-cli  -signet -rpcwallet="multisig_wallet_01" importdescriptors "$multisig_desc"

./build/src/bitcoin-cli  -signet -rpcwallet="multisig_wallet_01" getwalletinfo
</code></pre>
<p>Once the wallets have already been created and this tutorial needs to be repeated or resumed, it is not necessary to recreate them, just load them with the command below:</p>
<pre><code class="language-bash">for ((n=1;n&lt;=3;n++)); do ./build/src/bitcoin-cli -signet loadwallet "participant_${n}"; done
</code></pre>
<h3 id="14-fund-the-wallet"><a class="header" href="#14-fund-the-wallet">1.4 Fund the wallet</a></h3>
<p>The wallet can receive signet coins by generating a new address and passing it as parameters to <code>getcoins.py</code> script.</p>
<p>This script will print a captcha in dot-matrix to the terminal, using unicode Braille characters. After solving the captcha, the coins will be sent directly to the address or wallet (according to the parameters).</p>
<p>The url used by the script can also be accessed directly. At time of writing, the url is <a href="https://signetfaucet.com"><code>https://signetfaucet.com</code></a>.</p>
<p>Coins received by the wallet must have at least 1 confirmation before they can be spent. It is necessary to wait for a new block to be mined before continuing.</p>
<pre><code class="language-bash">receiving_address=$(./build/src/bitcoin-cli -signet -rpcwallet="multisig_wallet_01" getnewaddress)

./contrib/signet/getcoins.py -c ./build/src/bitcoin-cli -a $receiving_address
</code></pre>
<p>To copy the receiving address onto the clipboard, use the following command. This can be useful when getting coins via the signet faucet mentioned above.</p>
<pre><code class="language-bash">echo -n "$receiving_address" | xclip -sel clip
</code></pre>
<p>The <code>getbalances</code> RPC may be used to check the balance. Coins with <code>trusted</code> status can be spent.</p>
<pre><code class="language-bash">./build/src/bitcoin-cli -signet -rpcwallet="multisig_wallet_01" getbalances
</code></pre>
<h3 id="15-create-a-psbt"><a class="header" href="#15-create-a-psbt">1.5 Create a PSBT</a></h3>
<p>Unlike singlesig wallets, multisig wallets cannot create and sign transactions directly because they require the signatures of the co-signers. Instead they create a Partially Signed Bitcoin Transaction (PSBT).</p>
<p>PSBT is a data format that allows wallets and other tools to exchange information about a Bitcoin transaction and the signatures necessary to complete it. [<a href="https://bitcoinops.org/en/topics/psbt/">source</a>]</p>
<p>The current PSBT version (v0) is defined in <a href="https://github.com/bitcoin/bips/blob/master/bip-0174.mediawiki">BIP 174</a>.</p>
<p>For simplicity, the destination address is taken from the <code>participant_1</code> wallet in the code above, but it can be any valid bitcoin address.</p>
<p>The <code>walletcreatefundedpsbt</code> RPC is used to create and fund a transaction in the PSBT format. It is the first step in creating the PSBT.</p>
<pre><code class="language-bash">balance=$(./build/src/bitcoin-cli -signet -rpcwallet="multisig_wallet_01" getbalance)

amount=$(echo "$balance * 0.8" | bc -l | sed -e 's/^\./0./' -e 's/^-\./-0./')

destination_addr=$(./build/src/bitcoin-cli -signet -rpcwallet="participant_1" getnewaddress)

funded_psbt=$(./build/src/bitcoin-cli -signet -named -rpcwallet="multisig_wallet_01" walletcreatefundedpsbt outputs="{\"$destination_addr\": $amount}" | jq -r '.psbt')
</code></pre>
<p>There is also the <code>createpsbt</code> RPC, which serves the same purpose, but it has no access to the wallet or to the UTXO set. It is functionally the same as <code>createrawtransaction</code> and just drops the raw transaction into an otherwise blank PSBT. [<a href="https://bitcointalk.org/index.php?topic=5131043.msg50573609#msg50573609">source</a>] In most cases, <code>walletcreatefundedpsbt</code> solves the problem.</p>
<p>The <code>send</code> RPC can also return a PSBT if more signatures are needed to sign the transaction.</p>
<h3 id="16-decode-or-analyze-the-psbt"><a class="header" href="#16-decode-or-analyze-the-psbt">1.6 Decode or Analyze the PSBT</a></h3>
<p>Optionally, the PSBT can be decoded to a JSON format using <code>decodepsbt</code> RPC.</p>
<p>The <code>analyzepsbt</code> RPC analyzes and provides information about the current status of a PSBT and its inputs, e.g. missing signatures.</p>
<pre><code class="language-bash">./build/src/bitcoin-cli -signet decodepsbt $funded_psbt

./build/src/bitcoin-cli -signet analyzepsbt $funded_psbt
</code></pre>
<h3 id="17-update-the-psbt"><a class="header" href="#17-update-the-psbt">1.7 Update the PSBT</a></h3>
<p>In the code above, two PSBTs are created. One signed by <code>participant_1</code> wallet and other, by the <code>participant_2</code> wallet.</p>
<p>The <code>walletprocesspsbt</code> is used by the wallet to sign a PSBT.</p>
<pre><code class="language-bash">psbt_1=$(./build/src/bitcoin-cli -signet -rpcwallet="participant_1" walletprocesspsbt $funded_psbt | jq '.psbt')

psbt_2=$(./build/src/bitcoin-cli -signet -rpcwallet="participant_2" walletprocesspsbt $funded_psbt | jq '.psbt')
</code></pre>
<h3 id="18-combine-the-psbt"><a class="header" href="#18-combine-the-psbt">1.8 Combine the PSBT</a></h3>
<p>The PSBT, if signed separately by the co-signers, must be combined into one transaction before being finalized. This is done by <code>combinepsbt</code> RPC.</p>
<pre><code class="language-bash">combined_psbt=$(./build/src/bitcoin-cli -signet combinepsbt "[$psbt_1, $psbt_2]")
</code></pre>
<p>There is an RPC called <code>joinpsbts</code>, but it has a different purpose than <code>combinepsbt</code>. <code>joinpsbts</code> joins the inputs from multiple distinct PSBTs into one PSBT.</p>
<p>In the example above, the PSBTs are the same, but signed by different participants. If the user tries to merge them using <code>joinpsbts</code>, the error <code>Input txid:pos exists in multiple PSBTs</code> is returned. To be able to merge different PSBTs into one, they must have different inputs and outputs.</p>
<h3 id="19-finalize-and-broadcast-the-psbt"><a class="header" href="#19-finalize-and-broadcast-the-psbt">1.9 Finalize and Broadcast the PSBT</a></h3>
<p>The <code>finalizepsbt</code> RPC is used to produce a network serialized transaction which can be broadcast with <code>sendrawtransaction</code>.</p>
<p>It checks that all inputs have complete scriptSigs and scriptWitnesses and, if so, encodes them into network serialized transactions.</p>
<pre><code class="language-bash">finalized_psbt_hex=$(./build/src/bitcoin-cli -signet finalizepsbt $combined_psbt | jq -r '.hex')

./build/src/bitcoin-cli -signet sendrawtransaction $finalized_psbt_hex
</code></pre>
<h3 id="110-alternative-workflow-psbt-sequential-signatures"><a class="header" href="#110-alternative-workflow-psbt-sequential-signatures">1.10 Alternative Workflow (PSBT sequential signatures)</a></h3>
<p>Instead of each wallet signing the original PSBT and combining them later, the wallets can also sign the PSBTs sequentially. This is less scalable than the previously presented parallel workflow, but it works.</p>
<p>After that, the rest of the process is the same: the PSBT is finalized and transmitted to the network.</p>
<pre><code class="language-bash">psbt_1=$(./build/src/bitcoin-cli -signet -rpcwallet="participant_1" walletprocesspsbt $funded_psbt | jq -r '.psbt')

psbt_2=$(./build/src/bitcoin-cli -signet -rpcwallet="participant_2" walletprocesspsbt $psbt_1 | jq -r '.psbt')

finalized_psbt_hex=$(./build/src/bitcoin-cli -signet finalizepsbt $psbt_2 | jq -r '.hex')

./build/src/bitcoin-cli -signet sendrawtransaction $finalized_psbt_hex
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="offline-signing-tutorial"><a class="header" href="#offline-signing-tutorial">Offline Signing Tutorial</a></h1>
<p>This tutorial will describe how to use two instances of Bitcoin Core, one online and one offline, to greatly increase security by not having private keys reside on a networked device.</p>
<p>Maintaining an air-gap between private keys and any network connections drastically reduces the opportunity for those keys to be exfiltrated from the user.</p>
<p>This workflow uses <a href="https://github.com/bitcoin/bitcoin/blob/master/doc/psbt.md">Partially Signed Bitcoin Transactions</a> (PSBTs) to transfer the transaction to and from the offline wallet for signing using the private keys.</p>
<blockquote>
<p>[!NOTE]
While this tutorial demonstrates the process using <code>signet</code> network, you should omit the <code>-signet</code> flag in the provided commands when working with <code>mainnet</code>.</p>
</blockquote>
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<p>In this tutorial we have two hosts, both running Bitcoin v25.0</p>
<ul>
<li><code>offline</code> host which is disconnected from all networks (internet, Tor, wifi, bluetooth etc.) and does not have, or need, a copy of the blockchain.</li>
<li><code>online</code> host which is a regular online node with a synced blockchain.</li>
</ul>
<p>We are going to first create an <code>offline_wallet</code> on the offline host. We will then create a <code>watch_only_wallet</code> on the online host using public key descriptors exported from the <code>offline_wallet</code>. Next we will receive some coins into the wallet. In order to spend these coins we'll create an unsigned PSBT using the <code>watch_only_wallet</code>, sign the PSBT using the private keys in the <code>offline_wallet</code>, and finally broadcast the signed PSBT using the online host.</p>
<h3 id="requirements-1"><a class="header" href="#requirements-1">Requirements</a></h3>
<ul>
<li><a href="https://jqlang.github.io/jq/">jq</a> installation - This tutorial uses jq to process certain fields from JSON RPC responses, but this convenience is optional.</li>
</ul>
<h3 id="create-and-prepare-the-offline_wallet"><a class="header" href="#create-and-prepare-the-offline_wallet">Create and Prepare the <code>offline_wallet</code></a></h3>
<ol>
<li>On the offline machine create a wallet named <code>offline_wallet</code> secured by a wallet <code>passphrase</code>. This wallet will contain private keys and must remain unconnected to any networks at all times.</li>
</ol>
<pre><code class="language-sh">[offline]$ ./build/src/bitcoin-cli -signet -named createwallet \
                wallet_name="offline_wallet" \
                passphrase="** enter passphrase **"

{
  "name": "offline_wallet"
}
</code></pre>
<blockquote>
<p>[!NOTE]
The use of a passphrase is crucial to encrypt the wallet.dat file. This encryption ensures that even if an unauthorized individual gains access to the offline host, they won't be able to access the wallet's contents. Further details about securing your wallet can be found in  <a href="https://github.com/bitcoin/bitcoin/blob/master/doc/managing-wallets.md#12-encrypting-the-wallet">Managing the Wallet</a></p>
</blockquote>
<ol start="2">
<li>Export the public key-only descriptors from the offline host to a JSON file named <code>descriptors.json</code>. We use <code>jq</code> here to extract the <code>.descriptors</code> field from the full RPC response.</li>
</ol>
<pre><code class="language-sh">[offline]$ ./build/src/bitcoin-cli -signet -rpcwallet="offline_wallet" listdescriptors \
             | jq -r '.descriptors' \
             &gt;&gt; /path/to/descriptors.json
</code></pre>
<blockquote>
<p>[!NOTE]
The <code>descriptors.json</code> file will be transferred to the online machine (e.g. using a USB flash drive) where it can be imported to create a related watch-only wallet.</p>
</blockquote>
<h3 id="create-the-online-watch_only_wallet"><a class="header" href="#create-the-online-watch_only_wallet">Create the online <code>watch_only_wallet</code></a></h3>
<ol>
<li>On the online machine create a blank watch-only wallet which has private keys disabled and is named <code>watch_only_wallet</code>. This is achieved by using the <code>createwallet</code> options: <code>disable_private_keys=true, blank=true</code>.</li>
</ol>
<p>The <code>watch_only_wallet</code> wallet will be used to track and validate incoming transactions, create unsigned PSBTs when spending coins, and broadcast signed and finalized PSBTs.</p>
<blockquote>
<p>[!NOTE]
<code>disable_private_keys</code> indicates that the wallet should refuse to import private keys, i.e. will be a dedicated watch-only wallet.</p>
</blockquote>
<pre><code class="language-sh">[online]$ ./build/src/bitcoin-cli -signet -named createwallet \
              wallet_name="watch_only_wallet" \
              disable_private_keys=true \
              blank=true

{
  "name": "watch_only_wallet"
}
</code></pre>
<ol start="2">
<li>Import the <code>offline_wallet</code>s public key descriptors to the online <code>watch_only_wallet</code> using the <code>descriptors.json</code> file created on the offline wallet.</li>
</ol>
<pre><code class="language-sh">[online]$ ./build/src/bitcoin-cli -signet -rpcwallet="watch_only_wallet" importdescriptors "$(cat /path/to/descriptors.json)"

[
  {
    "success": true
  },
  {
    "success": true
  },
  {
    "success": true
  },
  {
    "success": true
  },
  {
    "success": true
  },
  {
    "success": true
  },
  {
    "success": true
  },
  {
    "success": true
  }
]
</code></pre>
<blockquote>
<p>[!NOTE]
Multiple success values indicate that multiple descriptors, for different address types, have been successfully imported. This allows generating different address types on the <code>watch_only_wallet</code>.</p>
</blockquote>
<h3 id="fund-the-offline_wallet"><a class="header" href="#fund-the-offline_wallet">Fund the <code>offline_wallet</code></a></h3>
<p>At this point, it's important to understand that both the <code>offline_wallet</code> and online <code>watch_only_wallet</code> share the same public keys. As a result, they generate the same addresses. Transactions can be created using either wallet, but valid signatures can only be added by the <code>offline_wallet</code> as only it has the private keys.</p>
<ol>
<li>Generate an address to receive coins. You can use <em>either</em> the <code>offline_wallet</code> or the online <code>watch_only_wallet</code> to generate this address, as they will produce the same addresses. For the sake of this guide, we'll use the online <code>watch_only_wallet</code> to generate the address.</li>
</ol>
<pre><code class="language-sh">[online]$ ./build/src/bitcoin-cli -signet -rpcwallet="watch_only_wallet" getnewaddress

tb1qtu5qgc6ddhmqm5yqjvhg83qgk2t4ewajg0h6yh
</code></pre>
<ol start="2">
<li>
<p>Visit a faucet like https://signetfaucet.com and enter your address from the previous command to receive a small amount of signet coins to this address.</p>
</li>
<li>
<p>Confirm that coins were received using the online <code>watch_only_wallet</code>. Note that the transaction may take a few moments before being received on your local node, depending on its connectivity. Just re-run the command periodically until the transaction is received.</p>
</li>
</ol>
<pre><code class="language-sh">[online]$ ./build/src/bitcoin-cli -signet -rpcwallet="watch_only_wallet" listunspent

[
  {
    "txid": "0f3953dfc3eb8e753cd1633151837c5b9953992914ff32b7de08c47f1f29c762",
    "vout": 1,
    "address": "tb1qtu5qgc6ddhmqm5yqjvhg83qgk2t4ewajg0h6yh",
    "label": "",
    "scriptPubKey": "00145f2804634d6df60dd080932e83c408b2975cbbb2",
    "amount": 0.01000000,
    "confirmations": 4,
    "spendable": true,
    "solvable": true,
    "desc": "wpkh([306c734f/84h/1h/0h/0/0]025932ccee7590158f7e08bb36290d135d30a0b045163da896e1cd7645ec4223a9)#xytvyr4a",
    "parent_descs": [
      "wpkh([306c734f/84h/1h/0h]tpubDCJnY92ib4Zu3qd6wrBXEjG436tQdA2tDiJU2iSJYjkNS1darssPWKaBfojhjUF5vMLBcxbN2r93pmFMz2zyTEZuNx9JDo9rWqoHhATW3Uz/0/*)#7mh08dkg"
    ],
    "safe": true
  }
]
</code></pre>
<h3 id="create-and-export-an-unsigned-psbt"><a class="header" href="#create-and-export-an-unsigned-psbt">Create and Export an Unsigned PSBT</a></h3>
<ol>
<li>
<p>Get a destination address for the transaction. In this tutorial we'll be sending funds to the address <code>tb1q9k5w0nhnhyeh78snpxh0t5t7c3lxdeg3erez32</code>, but if you don't need the coins for further testing you could send the coins back to the faucet.</p>
</li>
<li>
<p>Create a funded but unsigned PSBT to the destination address with the online <code>watch_only_wallet</code> by using <code>send [{"address":amount},...]</code> and export the unsigned PSBT to a file <code>funded_psbt.txt</code> for easy portability to the <code>offline_wallet</code> for signing:</p>
</li>
</ol>
<pre><code class="language-sh">[online]$ ./build/src/bitcoin-cli -signet -rpcwallet="watch_only_wallet" send \
              '{"tb1q9k5w0nhnhyeh78snpxh0t5t7c3lxdeg3erez32": 0.009}' \
              | jq -r '.psbt' \
              &gt;&gt; /path/to/funded_psbt.txt

[online]$ cat /path/to/funded_psbt.txt

cHNidP8BAHECAAAAAWLHKR9/xAjetzL/FCmZU5lbfINRMWPRPHWO68PfUzkPAQAAAAD9////AoA4AQAAAAAAFgAULajnzvO5M38eEwmu9dF+xH5m5RGs0g0AAAAAABYAFMaT0f/Wp2DCZzL6dkJ3GhWj4Y9vAAAAAAABAHECAAAAAY+dRPEBrGopkw4ugSzS9npzJDEIrE/bq1XXI0KbYnYrAQAAAAD+////ArKaXgAAAAAAFgAUwEc4LdoxSjbWo/2Ue+HS+QjwfiBAQg8AAAAAABYAFF8oBGNNbfYN0ICTLoPECLKXXLuyYW8CAAEBH0BCDwAAAAAAFgAUXygEY01t9g3QgJMug8QIspdcu7IiBgJZMszudZAVj34IuzYpDRNdMKCwRRY9qJbhzXZF7EIjqRgwbHNPVAAAgAEAAIAAAACAAAAAAAAAAAAAACICA7BlBnyAR4F2UkKuSX9MFhYCsn6j//z9i7lHDm1O0CU0GDBsc09UAACAAQAAgAAAAIABAAAAAAAAAAA=
</code></pre>
<blockquote>
<p>[!NOTE]
Leaving the <code>input</code> array empty in the above <code>walletcreatefundedpsbt</code> command is permitted and will cause the wallet to automatically select appropriate inputs for the transaction.</p>
</blockquote>
<h3 id="decode-and-analyze-the-unsigned-psbt"><a class="header" href="#decode-and-analyze-the-unsigned-psbt">Decode and Analyze the Unsigned PSBT</a></h3>
<p>Decode and analyze the unsigned PSBT on the <code>offline_wallet</code> using the <code>funded_psbt.txt</code> file:</p>
<pre><code class="language-sh">[offline]$ ./build/src/bitcoin-cli -signet decodepsbt $(cat /path/to/funded_psbt.txt)

{
    ...
}

[offline]$ ./build/src/bitcoin-cli -signet analyzepsbt $(cat /path/to/funded_psbt.txt)

{
  "inputs": [
    {
      "has_utxo": true,
      "is_final": false,
      "next": "signer",
      "missing": {
        "signatures": [
          "5f2804634d6df60dd080932e83c408b2975cbbb2"
        ]
      }
    }
  ],
  "estimated_vsize": 141,
  "estimated_feerate": 0.00100000,
  "fee": 0.00014100,
  "next": "signer"
}
</code></pre>
<p>Notice that the analysis of the PSBT shows that "signatures" are missing and should be provided by the private key corresponding to the public key hash (hash160) "5f2804634d6df60dd080932e83c408b2975cbbb2"</p>
<h3 id="process-and-sign-the-psbt"><a class="header" href="#process-and-sign-the-psbt">Process and Sign the PSBT</a></h3>
<ol>
<li>Unlock the <code>offline_wallet</code> with the Passphrase:</li>
</ol>
<p>Use the walletpassphrase command to unlock the <code>offline_wallet</code> with the passphrase. You should specify the passphrase and a timeout (in seconds) for how long you want the wallet to remain unlocked.</p>
<pre><code class="language-sh">[offline]$ ./build/src/bitcoin-cli -signet -rpcwallet="offline_wallet" walletpassphrase "** enter passphrase **" 60
</code></pre>
<ol start="2">
<li>Process, sign and finalize the PSBT on the <code>offline_wallet</code> using the <code>walletprocesspsbt</code> command, saving the output to a file <code>final_psbt.txt</code>.</li>
</ol>
<pre><code class="language-sh">[offline]$ ./build/src/bitcoin-cli -signet -rpcwallet="offline_wallet" walletprocesspsbt \
               $(cat /path/to/funded_psbt.txt) \
               | jq -r .hex \
               &gt;&gt; /path/to/final_psbt.txt
</code></pre>
<h3 id="broadcast-the-signed-and-finalized-psbt"><a class="header" href="#broadcast-the-signed-and-finalized-psbt">Broadcast the Signed and Finalized PSBT</a></h3>
<p>Broadcast the funded, signed and finalized PSBT <code>final_psbt.txt</code> using <code>sendrawtransaction</code> with an online node:</p>
<pre><code class="language-sh">[online]$ ./build/src/bitcoin-cli -signet sendrawtransaction $(cat /path/to/final_psbt.txt)

c2430a0e46df472b04b0ca887bbcd5c4abf7b2ce2eb71de981444a80e2b96d52
</code></pre>
<h3 id="confirm-wallet-balance"><a class="header" href="#confirm-wallet-balance">Confirm Wallet Balance</a></h3>
<p>Confirm the updated balance of the offline wallet using the <code>watch_only_wallet</code>.</p>
<pre><code class="language-sh">[online]$ ./build/src/bitcoin-cli -signet -rpcwallet="watch_only_wallet" getbalances

{
  "mine": {
    "trusted": 0.00085900,
    "untrusted_pending": 0.00000000,
    "immature": 0.00000000
  },
  "lastprocessedblock": {
    "hash": "0000003065c0669fff27edb4a71928cb48e5a6cfcdf06f491a83fd86822d18a6",
    "height": 159592
  }
}
</code></pre>
<p>You can also show transactions related to the wallet using <code>listtransactions</code></p>
<pre><code class="language-sh">[online]$ ./build/src/bitcoin-cli -signet -rpcwallet="watch_only_wallet" listtransactions

{
    ...
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><p>When Bitcoin Core automatically opens outgoing P2P connections, it chooses
a peer (address and port) from its list of potential peers. This list is
populated with unchecked data gossiped over the P2P network by other peers.</p>
<p>A malicious actor may gossip an address:port where no Bitcoin node is listening,
or one where a service is listening that is not related to the Bitcoin network.
As a result, this service may occasionally get connection attempts from Bitcoin
nodes.</p>
<p>"Bad" ports are ones used by services which are usually not open to the public
and usually require authentication. A connection attempt (by Bitcoin Core,
trying to connect because it thinks there is a Bitcoin node on that
address:port) to such service may be considered a malicious action by an
ultra-paranoid administrator. An example for such a port is 22 (ssh). On the
other hand, connection attempts to public services that usually do not require
authentication are unlikely to be considered a malicious action,
e.g. port 80 (http).</p>
<p>Below is a list of "bad" ports which Bitcoin Core avoids when choosing a peer to
connect to. If a node is listening on such a port, it will likely receive fewer
incoming connections.</p>
<pre><code>1:     tcpmux
7:     echo
9:     discard
11:    systat
13:    daytime
15:    netstat
17:    qotd
19:    chargen
20:    ftp data
21:    ftp access
22:    ssh
23:    telnet
25:    smtp
37:    time
42:    name
43:    nicname
53:    domain
69:    tftp
77:    priv-rjs
79:    finger
87:    ttylink
95:    supdup
101:   hostname
102:   iso-tsap
103:   gppitnp
104:   acr-nema
109:   pop2
110:   pop3
111:   sunrpc
113:   auth
115:   sftp
117:   uucp-path
119:   nntp
123:   NTP
135:   loc-srv /epmap
137:   netbios
139:   netbios
143:   imap2
161:   snmp
179:   BGP
389:   ldap
427:   SLP (Also used by Apple Filing Protocol)
465:   smtp+ssl
512:   print / exec
513:   login
514:   shell
515:   printer
526:   tempo
530:   courier
531:   chat
532:   netnews
540:   uucp
548:   AFP (Apple Filing Protocol)
554:   rtsp
556:   remotefs
563:   nntp+ssl
587:   smtp (rfc6409)
601:   syslog-conn (rfc3195)
636:   ldap+ssl
989:   ftps-data
990:   ftps
993:   ldap+ssl
995:   pop3+ssl
1719:  h323gatestat
1720:  h323hostcall
1723:  pptp
2049:  nfs
3659:  apple-sasl / PasswordServer
4045:  lockd
5060:  sip
5061:  sips
6000:  X11
6566:  sane-port
6665:  Alternate IRC
6666:  Alternate IRC
6667:  Standard IRC
6668:  Alternate IRC
6669:  Alternate IRC
6697:  IRC + TLS
10080: Amanda
</code></pre>
<p>For further information see:</p>
<p><a href="https://github.com/bitcoin/bitcoin/pull/23306#issuecomment-947516736">pull/23306</a></p>
<p><a href="https://github.com/bitcoin/bitcoin/pull/23542">pull/23542</a></p>
<p><a href="https://fetch.spec.whatwg.org/#port-blocking">fetch.spec.whatwg.org</a></p>
<p><a href="https://chromium.googlesource.com/chromium/src.git/+/refs/heads/main/net/base/port_util.cc">chromium.googlesource.com</a></p>
<p><a href="https://hg.mozilla.org/mozilla-central/file/tip/netwerk/base/nsIOService.cpp">hg.mozilla.org</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="productivity-notes"><a class="header" href="#productivity-notes">Productivity Notes</a></h1>
<h2 id="table-of-contents"><a class="header" href="#table-of-contents">Table of Contents</a></h2>
<ul>
<li><a href="doc/productivity.html#general">General</a>
<ul>
<li><a href="doc/productivity.html#cache-compilations-with-ccache">Cache compilations with <code>ccache</code></a></li>
<li><a href="doc/productivity.html#disable-features-when-generating-the-build-system">Disable features when generating the build system</a></li>
<li><a href="doc/productivity.html#make-use-of-your-threads-with--j">Make use of your threads with <code>-j</code></a></li>
<li><a href="doc/productivity.html#only-build-what-you-need">Only build what you need</a></li>
<li><a href="doc/productivity.html#compile-on-multiple-machines">Compile on multiple machines</a></li>
<li><a href="doc/productivity.html#multiple-working-directories-with-git-worktrees">Multiple working directories with <code>git worktrees</code></a></li>
<li><a href="doc/productivity.html#interactive-dummy-rebases-for-fixups-and-execs-with-git-merge-base">Interactive "dummy rebases" for fixups and execs with <code>git merge-base</code></a></li>
</ul>
</li>
<li><a href="doc/productivity.html#writing-code">Writing code</a>
<ul>
<li><a href="doc/productivity.html#format-cc-diffs-with-clang-format-diffpy">Format C/C++ diffs with <code>clang-format-diff.py</code></a></li>
<li><a href="doc/productivity.html#format-python-diffs-with-yapf-diffpy">Format Python diffs with <code>yapf-diff.py</code></a></li>
</ul>
</li>
<li><a href="doc/productivity.html#rebasingmerging-code">Rebasing/Merging code</a>
<ul>
<li><a href="doc/productivity.html#more-conflict-context-with-mergeconflictstyle-diff3">More conflict context with <code>merge.conflictstyle diff3</code></a></li>
</ul>
</li>
<li><a href="doc/productivity.html#reviewing-code">Reviewing code</a>
<ul>
<li><a href="doc/productivity.html#reduce-mental-load-with-git-diff-options">Reduce mental load with <code>git diff</code> options</a></li>
<li><a href="doc/productivity.html#reference-prs-easily-with-refspecs">Reference PRs easily with <code>refspec</code>s</a></li>
<li><a href="doc/productivity.html#diff-the-diffs-with-git-range-diff">Diff the diffs with <code>git range-diff</code></a></li>
</ul>
</li>
</ul>
<h2 id="general"><a class="header" href="#general">General</a></h2>
<h3 id="cache-compilations-with-ccache"><a class="header" href="#cache-compilations-with-ccache">Cache compilations with <code>ccache</code></a></h3>
<p>The easiest way to faster compile times is to cache compiles. <code>ccache</code> is a way to do so, from its description at the time of writing:</p>
<blockquote>
<p>ccache is a compiler cache. It speeds up recompilation by caching the result of previous compilations and detecting when the same compilation is being done again. Supported languages are C, C++, Objective-C and Objective-C++.</p>
</blockquote>
<p>Install <code>ccache</code> through your distribution's package manager, and run <code>cmake -B build</code> with your normal configuration options to pick it up.</p>
<p>To use ccache for all your C/C++ projects, follow the symlinks method <a href="https://ccache.dev/manual/latest.html#_run_modes">here</a> to set it up.</p>
<p>To get the most out of ccache, put something like this in <code>~/.ccache/ccache.conf</code>:</p>
<pre><code>max_size = 50.0G  # or whatever cache size you prefer; default is 5G; 0 means unlimited
base_dir = /home/yourname  # or wherever you keep your source files
</code></pre>
<p>Note: base_dir is required for ccache to share cached compiles of the same file across different repositories / paths; it will only do this for paths under base_dir. So this option is required for effective use of ccache with git worktrees (described below).</p>
<p>You <em>must not</em> set base_dir to "/", or anywhere that contains system headers (according to the ccache docs).</p>
<h3 id="disable-features-when-generating-the-build-system"><a class="header" href="#disable-features-when-generating-the-build-system">Disable features when generating the build system</a></h3>
<p>During the generation of the build system only essential build options are enabled by default to save on compilation time.</p>
<p>Run <code>cmake -B build -LH</code> to see the full list of available options. GUI tools, such as <code>ccmake</code> and <code>cmake-gui</code>, can be also helpful.</p>
<p>If you do need the wallet enabled (<code>-DENABLE_WALLET=ON</code>), it is common for devs to use your system bdb version for the wallet, so you don't have to find a copy of bdb 4.8. Wallets from such a build will be incompatible with any release binary (and vice versa), so use with caution on mainnet.</p>
<h3 id="make-use-of-your-threads-with--j"><a class="header" href="#make-use-of-your-threads-with--j">Make use of your threads with <code>-j</code></a></h3>
<p>If you have multiple threads on your machine, you can utilize all of them with:</p>
<pre><code class="language-sh">cmake --build build -j "$(($(nproc)+1))"
</code></pre>
<h3 id="only-build-what-you-need"><a class="header" href="#only-build-what-you-need">Only build what you need</a></h3>
<p>When rebuilding during development, note that running <code>cmake --build build</code>, without giving a target, will do a lot of work you probably don't need. It will build the GUI (if you've enabled it) and all the tests (which take much longer to build than the app does).</p>
<p>Obviously, it is important to build and run the tests at appropriate times -- but when you just want a quick compile to check your work, consider picking one or a set of build targets relevant to what you're working on, e.g.:</p>
<pre><code class="language-sh">cmake --build build --target bitcoind bitcoin-cli
cmake --build build --target bitcoin-qt
cmake --build build --target bench_bitcoin
</code></pre>
<p>(You can and should combine this with <code>-j</code>, as above, for a parallel build.)</p>
<h3 id="compile-on-multiple-machines"><a class="header" href="#compile-on-multiple-machines">Compile on multiple machines</a></h3>
<p>If you have more than one computer at your disposal, you can use <a href="https://www.distcc.org">distcc</a> to speed up compilation. This is easiest when all computers run the same operating system and compiler version.</p>
<h3 id="multiple-working-directories-with-git-worktrees"><a class="header" href="#multiple-working-directories-with-git-worktrees">Multiple working directories with <code>git worktrees</code></a></h3>
<p>If you work with multiple branches or multiple copies of the repository, you should try <code>git worktrees</code>.</p>
<p>To create a new branch that lives under a new working directory without disrupting your current working directory (useful for creating pull requests):</p>
<pre><code class="language-sh">git worktree add -b my-shiny-new-branch ../living-at-my-new-working-directory based-on-my-crufty-old-commit-ish
</code></pre>
<p>To simply check out a commit-ish under a new working directory without disrupting your current working directory (useful for reviewing pull requests):</p>
<pre><code class="language-sh">git worktree add --checkout ../where-my-checkout-commit-ish-will-live my-checkout-commit-ish
</code></pre>
<h3 id="interactive-dummy-rebases-for-fixups-and-execs-with-git-merge-base"><a class="header" href="#interactive-dummy-rebases-for-fixups-and-execs-with-git-merge-base">Interactive "dummy rebases" for fixups and execs with <code>git merge-base</code></a></h3>
<p>When rebasing, we often want to do a "dummy rebase," whereby we are not rebasing over an updated master but rather over the last common commit with master. This might be useful for rearranging commits, <code>rebase --autosquash</code>ing, or <code>rebase --exec</code>ing without introducing conflicts that arise from an updated master. In these situations, we can use <code>git merge-base</code> to identify the last common commit with master, and rebase off of that.</p>
<p>To squash in <code>git commit --fixup</code> commits without rebasing over an updated master, we can do the following:</p>
<pre><code class="language-sh">git rebase -i --autosquash "$(git merge-base master HEAD)"
</code></pre>
<p>To execute <code>cmake --build build &amp;&amp; ctest --test-dir build</code> on every commit since last diverged from master, but without rebasing over an updated master, we can do the following:</p>
<pre><code class="language-sh">git rebase -i --exec "cmake --build build &amp;&amp; ctest --test-dir build" "$(git merge-base master HEAD)"
</code></pre>
<hr />
<p>This synergizes well with <a href="doc/productivity.html#cache-compilations-with-ccache"><code>ccache</code></a> as objects resulting from unchanged code will most likely hit the cache and won't need to be recompiled.</p>
<p>You can also set up <a href="doc/productivity.html#reference-prs-easily-with-refspecs">upstream refspecs</a> to refer to pull requests easier in the above <code>git worktree</code> commands.</p>
<h2 id="writing-code"><a class="header" href="#writing-code">Writing code</a></h2>
<h3 id="format-cc-diffs-with-clang-format-diffpy"><a class="header" href="#format-cc-diffs-with-clang-format-diffpy">Format C/C++ diffs with <code>clang-format-diff.py</code></a></h3>
<p>See <a href="doc//contrib/devtools/README.html#clang-format-diff.py">contrib/devtools/README.md</a>.</p>
<h3 id="format-python-diffs-with-yapf-diffpy"><a class="header" href="#format-python-diffs-with-yapf-diffpy">Format Python diffs with <code>yapf-diff.py</code></a></h3>
<p>Usage is exactly the same as <a href="doc/productivity.html#format-cc-diffs-with-clang-format-diffpy"><code>clang-format-diff.py</code></a>. You can get it <a href="https://github.com/MarcoFalke/yapf-diff">here</a>.</p>
<h2 id="rebasingmerging-code"><a class="header" href="#rebasingmerging-code">Rebasing/Merging code</a></h2>
<h3 id="more-conflict-context-with-mergeconflictstyle-diff3"><a class="header" href="#more-conflict-context-with-mergeconflictstyle-diff3">More conflict context with <code>merge.conflictstyle diff3</code></a></h3>
<p>For resolving merge/rebase conflicts, it can be useful to enable diff3 style using <code>git config merge.conflictstyle diff3</code>. Instead of</p>
<pre><code class="language-diff">&lt;&lt;&lt;
yours
===
theirs
&gt;&gt;&gt;
</code></pre>
<p>you will see</p>
<pre><code class="language-diff">&lt;&lt;&lt;
yours
|||
original
===
theirs
&gt;&gt;&gt;
</code></pre>
<p>This may make it much clearer what caused the conflict. In this style, you can often just look at what changed between <em>original</em> and <em>theirs</em>, and mechanically apply that to <em>yours</em> (or the other way around).</p>
<h2 id="reviewing-code"><a class="header" href="#reviewing-code">Reviewing code</a></h2>
<h3 id="reduce-mental-load-with-git-diff-options"><a class="header" href="#reduce-mental-load-with-git-diff-options">Reduce mental load with <code>git diff</code> options</a></h3>
<p>When reviewing patches which change indentation in C++ files, use <code>git diff -w</code> and <code>git show -w</code>. This makes the diff algorithm ignore whitespace changes. This feature is also available on github.com, by adding <code>?w=1</code> at the end of any URL which shows a diff.</p>
<p>When reviewing patches that change symbol names in many places, use <code>git diff --word-diff</code>. This will instead of showing the patch as deleted/added <em>lines</em>, show deleted/added <em>words</em>.</p>
<p>When reviewing patches that move code around, try using <code>git diff --patience commit~:old/file.cpp commit:new/file/name.cpp</code>, and ignoring everything except the moved body of code which should show up as neither <code>+</code> or <code>-</code> lines. In case it was not a pure move, this may even work when combined with the <code>-w</code> or <code>--word-diff</code> options described above. <code>--color-moved=dimmed-zebra</code> will also dim the coloring of moved hunks in the diff on compatible terminals.</p>
<h3 id="reference-prs-easily-with-refspecs"><a class="header" href="#reference-prs-easily-with-refspecs">Reference PRs easily with <code>refspec</code>s</a></h3>
<p>When looking at other's pull requests, it may make sense to add the following section to your <code>.git/config</code> file:</p>
<pre><code>[remote "upstream-pull"]
        fetch = +refs/pull/*/head:refs/remotes/upstream-pull/*
        url = git@github.com:bitcoin/bitcoin.git
</code></pre>
<p>This will add an <code>upstream-pull</code> remote to your git repository, which can be fetched using <code>git fetch --all</code> or <code>git fetch upstream-pull</code>. It will download and store on disk quite a lot of data (all PRs, including merged and closed ones). Afterwards, you can use <code>upstream-pull/NUMBER/head</code> in arguments to <code>git show</code>, <code>git checkout</code> and anywhere a commit id would be acceptable to see the changes from pull request NUMBER.</p>
<h3 id="diff-the-diffs-with-git-range-diff"><a class="header" href="#diff-the-diffs-with-git-range-diff">Diff the diffs with <code>git range-diff</code></a></h3>
<p>It is very common for contributors to rebase their pull requests, or make changes to commits (perhaps in response to review) that are not at the head of their branch. This poses a problem for reviewers as when the contributor force pushes, the reviewer is no longer sure that his previous reviews of commits are still valid (as the commit hashes can now be different even though the diff is semantically the same). <a href="https://git-scm.com/docs/git-range-diff">git range-diff</a> (Git &gt;= 2.19) can help solve this problem by diffing the diffs.</p>
<p>For example, to identify the differences between your previously reviewed diffs P1-5, and the new diffs P1-2,N3-4 as illustrated below:</p>
<pre><code>       P1--P2--P3--P4--P5   &lt;-- previously-reviewed-head
      /
...--m   &lt;-- master
      \
       P1--P2--N3--N4--N5   &lt;-- new-head (with P3 slightly modified)
</code></pre>
<p>You can do:</p>
<pre><code class="language-sh">git range-diff master previously-reviewed-head new-head
</code></pre>
<p>Note that <code>git range-diff</code> also work for rebases:</p>
<pre><code>       P1--P2--P3--P4--P5   &lt;-- previously-reviewed-head
      /
...--m--m1--m2--m3   &lt;-- master
                  \
                   P1--P2--N3--N4  &lt;-- new-head (with P3 modified, P4 &amp; P5 squashed)

PREV=P5 N=4 &amp;&amp; git range-diff `git merge-base --all HEAD $PREV`...$PREV HEAD~$N...HEAD
</code></pre>
<p>Where <code>P5</code> is the commit you last reviewed and <code>4</code> is the number of commits in the new version.</p>
<hr />
<p><code>git range-diff</code> also accepts normal <code>git diff</code> options, see <a href="doc/productivity.html#reduce-mental-load-with-git-diff-options">Reduce mental load with <code>git diff</code> options</a> for useful <code>git diff</code> options.</p>
<p>You can also set up <a href="doc/productivity.html#reference-prs-easily-with-refspecs">upstream refspecs</a> to refer to pull requests easier in the above <code>git range-diff</code> commands.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="psbt-howto-for-bitcoin-core"><a class="header" href="#psbt-howto-for-bitcoin-core">PSBT Howto for Bitcoin Core</a></h1>
<p>Since Bitcoin Core 0.17, an RPC interface exists for Partially Signed Bitcoin
Transactions (PSBTs, as specified in
<a href="https://github.com/bitcoin/bips/blob/master/bip-0174.mediawiki">BIP 174</a>).</p>
<p>This document describes the overall workflow for producing signed transactions
through the use of PSBT, and the specific RPC commands used in typical
scenarios.</p>
<h2 id="psbt-in-general"><a class="header" href="#psbt-in-general">PSBT in general</a></h2>
<p>PSBT is an interchange format for Bitcoin transactions that are not fully signed
yet, together with relevant metadata to help entities work towards signing it.
It is intended to simplify workflows where multiple parties need to cooperate to
produce a transaction. Examples include hardware wallets, multisig setups, and
<a href="https://bitcointalk.org/?topic=279249">CoinJoin</a> transactions.</p>
<h3 id="overall-workflow"><a class="header" href="#overall-workflow">Overall workflow</a></h3>
<p>Overall, the construction of a fully signed Bitcoin transaction goes through the
following steps:</p>
<ul>
<li>A <strong>Creator</strong> proposes a particular transaction to be created. They construct
a PSBT that contains certain inputs and outputs, but no additional metadata.</li>
<li>For each input, an <strong>Updater</strong> adds information about the UTXOs being spent by
the transaction to the PSBT. They also add information about the scripts and
public keys involved in each of the inputs (and possibly outputs) of the PSBT.</li>
<li><strong>Signers</strong> inspect the transaction and its metadata to decide whether they
agree with the transaction. They can use amount information from the UTXOs
to assess the values and fees involved. If they agree, they produce a
partial signature for the inputs for which they have relevant key(s).</li>
<li>A <strong>Finalizer</strong> is run for each input to convert the partial signatures and
possibly script information into a final <code>scriptSig</code> and/or <code>scriptWitness</code>.</li>
<li>An <strong>Extractor</strong> produces a valid Bitcoin transaction (in network format)
from a PSBT for which all inputs are finalized.</li>
</ul>
<p>Generally, each of the above (excluding Creator and Extractor) will simply
add more and more data to a particular PSBT, until all inputs are fully signed.
In a naive workflow, they all have to operate sequentially, passing the PSBT
from one to the next, until the Extractor can convert it to a real transaction.
In order to permit parallel operation, <strong>Combiners</strong> can be employed which merge
metadata from different PSBTs for the same unsigned transaction.</p>
<p>The names above in bold are the names of the roles defined in BIP174. They're
useful in understanding the underlying steps, but in practice, software and
hardware implementations will typically implement multiple roles simultaneously.</p>
<h2 id="psbt-in-bitcoin-core"><a class="header" href="#psbt-in-bitcoin-core">PSBT in Bitcoin Core</a></h2>
<h3 id="rpcs"><a class="header" href="#rpcs">RPCs</a></h3>
<ul>
<li><strong><code>converttopsbt</code> (Creator)</strong> is a utility RPC that converts an
unsigned raw transaction to PSBT format. It ignores existing signatures.</li>
<li><strong><code>createpsbt</code> (Creator)</strong> is a utility RPC that takes a list of inputs and
outputs and converts them to a PSBT with no additional information. It is
equivalent to calling <code>createrawtransaction</code> followed by <code>converttopsbt</code>.</li>
<li><strong><code>walletcreatefundedpsbt</code> (Creator, Updater)</strong> is a wallet RPC that creates a
PSBT with the specified inputs and outputs, adds additional inputs and change
to it to balance it out, and adds relevant metadata. In particular, for inputs
that the wallet knows about (counting towards its normal or watch-only
balance), UTXO information will be added. For outputs and inputs with UTXO
information present, key and script information will be added which the wallet
knows about. It is equivalent to running <code>createrawtransaction</code>, followed by
<code>fundrawtransaction</code>, and <code>converttopsbt</code>.</li>
<li><strong><code>walletprocesspsbt</code> (Updater, Signer, Finalizer)</strong> is a wallet RPC that takes as
input a PSBT, adds UTXO, key, and script data to inputs and outputs that miss
it, and optionally signs inputs. Where possible it also finalizes the partial
signatures.</li>
<li><strong><code>descriptorprocesspsbt</code> (Updater, Signer, Finalizer)</strong> is a node RPC that takes
as input a PSBT and a list of descriptors. It updates SegWit inputs with
information available from the UTXO set and the mempool and signs the inputs using
the provided descriptors. Where possible it also finalizes the partial signatures.</li>
<li><strong><code>utxoupdatepsbt</code> (Updater)</strong> is a node RPC that takes a PSBT and updates it
to include information available from the UTXO set (works only for SegWit
inputs).</li>
<li><strong><code>finalizepsbt</code> (Finalizer, Extractor)</strong> is a utility RPC that finalizes any
partial signatures, and if all inputs are finalized, converts the result to a
fully signed transaction which can be broadcast with <code>sendrawtransaction</code>.</li>
<li><strong><code>combinepsbt</code> (Combiner)</strong> is a utility RPC that implements a Combiner. It
can be used at any point in the workflow to merge information added to
different versions of the same PSBT. In particular it is useful to combine the
output of multiple Updaters or Signers.</li>
<li><strong><code>joinpsbts</code></strong> (Creator) is a utility RPC that joins multiple PSBTs together,
concatenating the inputs and outputs. This can be used to construct CoinJoin
transactions.</li>
<li><strong><code>decodepsbt</code></strong> is a diagnostic utility RPC which will show all information in
a PSBT in human-readable form, as well as compute its eventual fee if known.</li>
<li><strong><code>analyzepsbt</code></strong> is a utility RPC that examines a PSBT and reports the
current status of its inputs, the next step in the workflow if known, and if
possible, computes the fee of the resulting transaction and estimates the
final weight and feerate.</li>
</ul>
<h3 id="workflows"><a class="header" href="#workflows">Workflows</a></h3>
<h4 id="multisig-with-multiple-bitcoin-core-instances"><a class="header" href="#multisig-with-multiple-bitcoin-core-instances">Multisig with multiple Bitcoin Core instances</a></h4>
<p>For a quick start see <a href="doc/./descriptors.html#basic-multisig-example">Basic M-of-N multisig example using descriptor wallets and PSBTs</a>.
If you are using legacy wallets feel free to continue with the example provided here.</p>
<p>Alice, Bob, and Carol want to create a 2-of-3 multisig address. They're all using
Bitcoin Core. We assume their wallets only contain the multisig funds. In case
they also have a personal wallet, this can be accomplished through the
multiwallet feature - possibly resulting in a need to add <code>-rpcwallet=name</code> to
the command line in case <code>bitcoin-cli</code> is used.</p>
<p>Setup:</p>
<ul>
<li>All three call <code>getnewaddress</code> to create a new address; call these addresses
<em>Aalice</em>, <em>Abob</em>, and <em>Acarol</em>.</li>
<li>All three call <code>getaddressinfo "X"</code>, with <em>X</em> their respective address, and
remember the corresponding public keys. Call these public keys <em>Kalice</em>,
<em>Kbob</em>, and <em>Kcarol</em>.</li>
<li>All three now run <code>addmultisigaddress 2 ["Kalice","Kbob","Kcarol"]</code> to teach
their wallet about the multisig script. Call the address produced by this
command <em>Amulti</em>. They may be required to explicitly specify the same
addresstype option each, to avoid constructing different versions due to
differences in configuration.</li>
<li>They also run <code>importaddress "Amulti" "" false</code> to make their wallets treat
payments to <em>Amulti</em> as contributing to the watch-only balance.</li>
<li>Others can verify the produced address by running
<code>createmultisig 2 ["Kalice","Kbob","Kcarol"]</code>, and expecting <em>Amulti</em> as
output. Again, it may be necessary to explicitly specify the addresstype
in order to get a result that matches. This command won't enable them to
initiate transactions later, however.</li>
<li>They can now give out <em>Amulti</em> as address others can pay to.</li>
</ul>
<p>Later, when <em>V</em> BTC has been received on <em>Amulti</em>, and Bob and Carol want to
move the coins in their entirety to address <em>Asend</em>, with no change. Alice
does not need to be involved.</p>
<ul>
<li>One of them - let's assume Carol here - initiates the creation. She runs
<code>walletcreatefundedpsbt [] {"Asend":V} 0 {"subtractFeeFromOutputs":[0], "includeWatching":true}</code>.
We call the resulting PSBT <em>P</em>. <em>P</em> does not contain any signatures.</li>
<li>Carol needs to sign the transaction herself. In order to do so, she runs
<code>walletprocesspsbt "P"</code>, and gives the resulting PSBT <em>P2</em> to Bob.</li>
<li>Bob inspects the PSBT using <code>decodepsbt "P2"</code> to determine if the transaction
has indeed just the expected input, and an output to <em>Asend</em>, and the fee is
reasonable. If he agrees, he calls <code>walletprocesspsbt "P2"</code> to sign. The
resulting PSBT <em>P3</em> contains both Carol's and Bob's signature.</li>
<li>Now anyone can call <code>finalizepsbt "P3"</code> to extract a fully signed transaction
<em>T</em>.</li>
<li>Finally anyone can broadcast the transaction using <code>sendrawtransaction "T"</code>.</li>
</ul>
<p>In case there are more signers, it may be advantageous to let them all sign in
parallel, rather than passing the PSBT from one signer to the next one. In the
above example this would translate to Carol handing a copy of <em>P</em> to each signer
separately. They can then all invoke <code>walletprocesspsbt "P"</code>, and end up with
their individually-signed PSBT structures. They then all send those back to
Carol (or anyone) who can combine them using <code>combinepsbt</code>. The last two steps
(<code>finalizepsbt</code> and <code>sendrawtransaction</code>) remain unchanged.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="reduce-memory"><a class="header" href="#reduce-memory">Reduce Memory</a></h1>
<p>There are a few parameters that can be dialed down to reduce the memory usage of <code>bitcoind</code>. This can be useful on embedded systems or small VPSes.</p>
<h2 id="in-memory-caches"><a class="header" href="#in-memory-caches">In-memory caches</a></h2>
<p>The size of some in-memory caches can be reduced. As caches trade off memory usage for performance, reducing these will usually have a negative effect on performance.</p>
<ul>
<li><code>-dbcache=&lt;n&gt;</code> - the UTXO database cache size, this defaults to <code>450</code>. The unit is MiB (1024).
<ul>
<li>The minimum value for <code>-dbcache</code> is 4.</li>
<li>A lower <code>-dbcache</code> makes initial sync time much longer. After the initial sync, the effect is less pronounced for most use-cases, unless fast validation of blocks is important, such as for mining.</li>
</ul>
</li>
</ul>
<h2 id="memory-pool-1"><a class="header" href="#memory-pool-1">Memory pool</a></h2>
<ul>
<li>
<p>In Bitcoin Core there is a memory pool limiter which can be configured with <code>-maxmempool=&lt;n&gt;</code>, where <code>&lt;n&gt;</code> is the size in MB (1000). The default value is <code>300</code>.</p>
<ul>
<li>The minimum value for <code>-maxmempool</code> is 5.</li>
<li>A lower maximum mempool size means that transactions will be evicted sooner. This will affect any uses of <code>bitcoind</code> that process unconfirmed transactions.</li>
</ul>
</li>
<li>
<p>Since <code>0.14.0</code>, unused memory allocated to the mempool (default: 300MB) is shared with the UTXO cache, so when trying to reduce memory usage you should limit the mempool, with the <code>-maxmempool</code> command line argument.</p>
</li>
<li>
<p>To disable most of the mempool functionality there is the <code>-blocksonly</code> option. This will reduce the default memory usage to 5MB and make the client opt out of receiving (and thus relaying) transactions, except from peers who have the <code>relay</code> permission set (e.g. whitelisted peers), and as part of blocks.</p>
<ul>
<li>Do not use this when using the client to broadcast transactions as any transaction sent will stick out like a sore thumb, affecting privacy. When used with the wallet it should be combined with <code>-walletbroadcast=0</code> and <code>-spendzeroconfchange=0</code>. Another mechanism for broadcasting outgoing transactions (if any) should be used.</li>
</ul>
</li>
</ul>
<h2 id="number-of-peers"><a class="header" href="#number-of-peers">Number of peers</a></h2>
<ul>
<li>
<p><code>-maxconnections=&lt;n&gt;</code> - the maximum number of connections, which defaults to 125. Each active connection takes up some
memory. This option applies only if inbound connections are enabled; otherwise, the number of connections will not
be more than 11. Of the 11 outbound peers, there can be 8 full-relay connections, 2 block-relay-only ones,
and occasionally 1 short-lived feeler or extra outbound block-relay-only connection.</p>
</li>
<li>
<p>These limits do not apply to connections added manually with the <code>-addnode</code> configuration option or
the <code>addnode</code> RPC, which have a separate limit of 8 connections.</p>
</li>
</ul>
<h2 id="thread-configuration"><a class="header" href="#thread-configuration">Thread configuration</a></h2>
<p>For each thread a thread stack needs to be allocated. By default on Linux,
threads take up 8MiB for the thread stack on a 64-bit system, and 4MiB in a
32-bit system.</p>
<ul>
<li><code>-par=&lt;n&gt;</code> - the number of script verification threads, defaults to the number of cores in the system minus one.</li>
<li><code>-rpcthreads=&lt;n&gt;</code> - the number of threads used for processing RPC requests, defaults to <code>4</code>.</li>
</ul>
<h2 id="linux-specific"><a class="header" href="#linux-specific">Linux specific</a></h2>
<p>By default, glibc's implementation of <code>malloc</code> may use more than one arena. This is known to cause excessive memory usage in some scenarios. To avoid this, make a script that sets <code>MALLOC_ARENA_MAX</code> before starting bitcoind:</p>
<pre><code class="language-bash">#!/usr/bin/env bash
export MALLOC_ARENA_MAX=1
bitcoind
</code></pre>
<p>The behavior was introduced to increase CPU locality of allocated memory and performance with concurrent allocation, so this setting could in theory reduce performance. However, in Bitcoin Core very little parallel allocation happens, so the impact is expected to be small or absent.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="reduce-traffic"><a class="header" href="#reduce-traffic">Reduce Traffic</a></h1>
<p>Some node operators need to deal with bandwidth caps imposed by their ISPs.</p>
<p>By default, Bitcoin Core allows up to 125 connections to different peers, 11 of
which are outbound. You can therefore, have at most 114 inbound connections.
Of the 11 outbound peers, there can be 8 full-relay connections, 2
block-relay-only ones and occasionally 1 short-lived feeler or an extra block-relay-only connection.</p>
<p>The default settings can result in relatively significant traffic consumption.</p>
<p>Ways to reduce traffic:</p>
<h2 id="1-use--maxuploadtargetmib-per-day"><a class="header" href="#1-use--maxuploadtargetmib-per-day">1. Use <code>-maxuploadtarget=&lt;MiB per day&gt;</code></a></h2>
<p>A major component of the traffic is caused by serving historic blocks to other nodes
during the initial blocks download phase (syncing up a new node).
This option can be specified in MiB per day and is turned off by default.
This is <em>not</em> a hard limit; only a threshold to minimize the outbound
traffic. When the limit is about to be reached, the uploaded data is cut by no
longer serving historic blocks (blocks older than one week).
Keep in mind that new nodes require other nodes that are willing to serve
historic blocks.</p>
<p>Peers with the <code>download</code> permission will never be disconnected, although their traffic counts for
calculating the target.</p>
<h2 id="2-disable-listening--listen0"><a class="header" href="#2-disable-listening--listen0">2. Disable "listening" (<code>-listen=0</code>)</a></h2>
<p>Disabling listening will result in fewer nodes connected (remember the maximum of 11
outbound peers). Fewer nodes will result in less traffic usage as you are relaying
blocks and transactions to fewer nodes.</p>
<h2 id="3-reduce-maximum-connections--maxconnectionsnum"><a class="header" href="#3-reduce-maximum-connections--maxconnectionsnum">3. Reduce maximum connections (<code>-maxconnections=&lt;num&gt;</code>)</a></h2>
<p>Reducing the maximum connected nodes to a minimum could be desirable if traffic
limits are tiny. Keep in mind that bitcoin's trustless model works best if you are
connected to a handful of nodes.</p>
<h2 id="4-turn-off-transaction-relay--blocksonly"><a class="header" href="#4-turn-off-transaction-relay--blocksonly">4. Turn off transaction relay (<code>-blocksonly</code>)</a></h2>
<p>Forwarding transactions to peers increases the P2P traffic. To only sync blocks
with other peers, you can disable transaction relay.</p>
<p>Be reminded of the effects of this setting.</p>
<ul>
<li>Fee estimation will no longer work.</li>
<li>It sets the flag "-walletbroadcast" to be "0", only if it is currently unset.
Doing so disables the automatic broadcasting of transactions from wallet. Not
relaying other's transactions could hurt your privacy if used while a wallet
is loaded or if you use the node to broadcast transactions.</li>
<li>If a peer has the forcerelay permission, we will still receive and relay
their transactions.</li>
<li>It makes block propagation slower because compact block relay can only be
used when transaction relay is enabled.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h2 id="updated-settings"><a class="header" href="#updated-settings">Updated settings</a></h2>
<ul>
<li>The maximum allowed value for the <code>-dbcache</code> configuration option has been
dropped due to recent UTXO set growth. Note that before this change, large <code>-dbcache</code>
values were automatically reduced to 16 GiB (1 GiB on 32 bit systems). (#28358)</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h2 id="p2p-and-network-changes"><a class="header" href="#p2p-and-network-changes">P2P and network changes</a></h2>
<p>Ephemeral dust is a new concept that allows a single
dust output in a transaction, provided the transaction
is zero fee. In order to spend any unconfirmed outputs
from this transaction, the spender must also spend
this dust in addition to any other outputs.</p>
<p>In other words, this type of transaction
should be created in a transaction package where
the dust is both created and spent simultaneously.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="full-replace-by-fee"><a class="header" href="#full-replace-by-fee">Full Replace-By-Fee</a></h1>
<p>Starting with v28.0, the <code>mempoolfullrbf</code> startup option was set to
default to <code>1</code>. With widespread adoption of this policy, users no longer
benefit from disabling it, so the option has been removed, making full
replace-by-fee the standard behavior. (#30592)</p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="p2p-and-network-changes-1"><a class="header" href="#p2p-and-network-changes-1">P2P and network changes</a></h2>
<p>Support for UPnP was dropped. If you want to open a port automatically, consider using the <code>-natpmp</code>
option instead, which uses PCP or NAT-PMP depending on router support.</p>
<h2 id="updated-settings-1"><a class="header" href="#updated-settings-1">Updated settings</a></h2>
<ul>
<li>Setting <code>-upnp</code> will now return an error. Consider using <code>-natpmp</code> instead.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h2 id="test"><a class="header" href="#test">Test</a></h2>
<p>The BIP94 timewarp attack mitigation (designed for testnet4) is no longer active on the regtest network. (#31156)</p>
<div style="break-before: page; page-break-before: always;"></div><p><em>The release notes draft is a temporary file that can be added to by anyone. See
<a href="doc//doc/developer-notes.html#release-notes">/doc/developer-notes.md#release-notes</a>
for the process.</em></p>
<h1 id="version-release-notes-draft"><a class="header" href="#version-release-notes-draft"><em>version</em> Release Notes Draft</a></h1>
<p>Bitcoin Core version <em>version</em> is now available from:</p>
<p><a href="https://bitcoincore.org/bin/bitcoin-core-*version*/">https://bitcoincore.org/bin/bitcoin-core-*version*/</a></p>
<p>This release includes new features, various bug fixes and performance
improvements, as well as updated translations.</p>
<p>Please report bugs using the issue tracker at GitHub:</p>
<p><a href="https://github.com/bitcoin/bitcoin/issues">https://github.com/bitcoin/bitcoin/issues</a></p>
<p>To receive security and update notifications, please subscribe to:</p>
<p><a href="https://bitcoincore.org/en/list/announcements/join/">https://bitcoincore.org/en/list/announcements/join/</a></p>
<h1 id="how-to-upgrade"><a class="header" href="#how-to-upgrade">How to Upgrade</a></h1>
<p>If you are running an older version, shut it down. Wait until it has completely
shut down (which might take a few minutes in some cases), then run the
installer (on Windows) or just copy over <code>/Applications/Bitcoin-Qt</code> (on macOS)
or <code>bitcoind</code>/<code>bitcoin-qt</code> (on Linux).</p>
<p>Upgrading directly from a version of Bitcoin Core that has reached its EOL is
possible, but it might take some time if the data directory needs to be migrated. Old
wallet versions of Bitcoin Core are generally supported.</p>
<p>Running Bitcoin Core binaries on macOS requires self signing.</p>
<pre><code>cd /path/to/bitcoin-core/bin
xattr -d com.apple.quarantine bitcoin-cli bitcoin-qt bitcoin-tx bitcoin-util bitcoin-wallet bitcoind test_bitcoin
codesign -s - bitcoin-cli bitcoin-qt bitcoin-tx bitcoin-util bitcoin-wallet bitcoind test_bitcoin
</code></pre>
<h1 id="compatibility-1"><a class="header" href="#compatibility-1">Compatibility</a></h1>
<p>Bitcoin Core is supported and extensively tested on operating systems
using the Linux Kernel 3.17+, macOS 13.0+, and Windows 7 and newer. Bitcoin
Core should also work on most other Unix-like systems but is not as
frequently tested on them. It is not recommended to use Bitcoin Core on
unsupported systems.</p>
<h1 id="notable-changes"><a class="header" href="#notable-changes">Notable changes</a></h1>
<h2 id="p2p-and-network-changes-2"><a class="header" href="#p2p-and-network-changes-2">P2P and network changes</a></h2>
<h2 id="updated-rpcs"><a class="header" href="#updated-rpcs">Updated RPCs</a></h2>
<p>Changes to wallet related RPCs can be found in the Wallet section below.</p>
<h2 id="new-rpcs"><a class="header" href="#new-rpcs">New RPCs</a></h2>
<h2 id="build-system"><a class="header" href="#build-system">Build System</a></h2>
<h2 id="updated-settings-2"><a class="header" href="#updated-settings-2">Updated settings</a></h2>
<p>Changes to GUI or wallet related settings can be found in the GUI or Wallet section below.</p>
<h2 id="new-settings"><a class="header" href="#new-settings">New settings</a></h2>
<h2 id="tools-and-utilities"><a class="header" href="#tools-and-utilities">Tools and Utilities</a></h2>
<h2 id="wallet-3"><a class="header" href="#wallet-3">Wallet</a></h2>
<h2 id="gui-changes"><a class="header" href="#gui-changes">GUI changes</a></h2>
<h1 id="low-level-changes"><a class="header" href="#low-level-changes">Low-level changes</a></h1>
<h2 id="rpc"><a class="header" href="#rpc">RPC</a></h2>
<h2 id="tests"><a class="header" href="#tests">Tests</a></h2>
<h1 id="version-change-log"><a class="header" href="#version-change-log"><em>version</em> change log</a></h1>
<h1 id="credits"><a class="header" href="#credits">Credits</a></h1>
<p>Thanks to everyone who directly contributed to this release:</p>
<p>As well as to everyone that helped with translations on
<a href="https://www.transifex.com/bitcoin/bitcoin/">Transifex</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="release-process"><a class="header" href="#release-process">Release Process</a></h1>
<h2 id="branch-updates"><a class="header" href="#branch-updates">Branch updates</a></h2>
<h3 id="before-every-release-candidate"><a class="header" href="#before-every-release-candidate">Before every release candidate</a></h3>
<ul>
<li>Update release candidate version in <code>CMakeLists.txt</code> (<code>CLIENT_VERSION_RC</code>).</li>
<li>Update manpages (after rebuilding the binaries), see <a href="doc//contrib/devtools/README.html#gen-manpagespy">gen-manpages.py</a>.</li>
<li>Update bitcoin.conf and commit changes if they exist, see <a href="doc//contrib/devtools/README.html#gen-bitcoin-confsh">gen-bitcoin-conf.sh</a>.</li>
</ul>
<h3 id="before-every-major-and-minor-release"><a class="header" href="#before-every-major-and-minor-release">Before every major and minor release</a></h3>
<ul>
<li>Update <a href="doc/bips.html">bips.md</a> to account for changes since the last release.</li>
<li>Update version in <code>CMakeLists.txt</code> (don't forget to set <code>CLIENT_VERSION_RC</code> to <code>0</code>).</li>
<li>Update manpages (see previous section)</li>
<li>Write release notes (see "Write the release notes" below) in doc/release-notes.md. If necessary,
archive the previous release notes as doc/release-notes/release-notes-${VERSION}.md.</li>
</ul>
<h3 id="before-every-major-release"><a class="header" href="#before-every-major-release">Before every major release</a></h3>
<ul>
<li>On both the master branch and the new release branch:
<ul>
<li>update <code>CLIENT_VERSION_MAJOR</code> in <a href="doc/../CMakeLists.txt"><code>CMakeLists.txt</code></a></li>
</ul>
</li>
<li>On the new release branch in <a href="doc/../CMakeLists.txt"><code>CMakeLists.txt</code></a>(see <a href="https://github.com/bitcoin/bitcoin/commit/742f7dd">this commit</a>):
<ul>
<li>set <code>CLIENT_VERSION_MINOR</code> to <code>0</code></li>
<li>set <code>CLIENT_VERSION_BUILD</code> to <code>0</code></li>
<li>set <code>CLIENT_VERSION_IS_RELEASE</code> to <code>true</code></li>
</ul>
</li>
</ul>
<h4 id="before-branch-off"><a class="header" href="#before-branch-off">Before branch-off</a></h4>
<ul>
<li>Update translations see <a href="doc//doc/translation_process.html#synchronising-translations">translation_process.md</a>.</li>
<li>Update hardcoded <a href="doc//contrib/seeds/README.html">seeds</a>, see <a href="https://github.com/bitcoin/bitcoin/pull/27488">this pull request</a> for an example.</li>
<li>Update the following variables in <a href="doc//src/kernel/chainparams.cpp"><code>src/kernel/chainparams.cpp</code></a> for mainnet, testnet, and signet:
<ul>
<li><code>m_assumed_blockchain_size</code> and <code>m_assumed_chain_state_size</code> with the current size plus some overhead (see
<a href="doc/release-process.html#how-to-calculate-assumed-blockchain-and-chain-state-size">this</a> for information on how to calculate them).</li>
<li>The following updates should be reviewed with <code>reindex-chainstate</code> and <code>assumevalid=0</code> to catch any defect
that causes rejection of blocks in the past history.</li>
<li><code>chainTxData</code> with statistics about the transaction count and rate. Use the output of the <code>getchaintxstats</code> RPC with an
<code>nBlocks</code> of 4096 (28 days) and a <code>bestblockhash</code> of RPC <code>getbestblockhash</code>; see
<a href="https://github.com/bitcoin/bitcoin/pull/28591">this pull request</a> for an example. Reviewers can verify the results by running
<code>getchaintxstats &lt;window_block_count&gt; &lt;window_final_block_hash&gt;</code> with the <code>window_block_count</code> and <code>window_final_block_hash</code> from your output.</li>
<li><code>defaultAssumeValid</code> with the output of RPC <code>getblockhash</code> using the <code>height</code> of <code>window_final_block_height</code> above
(and update the block height comment with that height), taking into account the following:
<ul>
<li>On mainnet, the selected value must not be orphaned, so it may be useful to set the height two blocks back from the tip.</li>
<li>Testnet should be set with a height some tens of thousands back from the tip, due to reorgs there.</li>
</ul>
</li>
<li><code>nMinimumChainWork</code> with the "chainwork" value of RPC <code>getblockheader</code> using the same height as that selected for the previous step.</li>
</ul>
</li>
<li>Consider updating the headers synchronization tuning parameters to account for the chainparams updates.
The optimal values change very slowly, so this isn't strictly necessary every release, but doing so doesn't hurt.
<ul>
<li>Update configuration variables in <a href="doc//contrib/devtools/headerssync-params.py"><code>contrib/devtools/headerssync-params.py</code></a>:
<ul>
<li>Set <code>TIME</code> to the software's expected supported lifetime -- after this time, its ability to defend against a high bandwidth timewarp attacker will begin to degrade.</li>
<li>Set <code>MINCHAINWORK_HEADERS</code> to the height used for the <code>nMinimumChainWork</code> calculation above.</li>
<li>Check that the other variables still look reasonable.</li>
</ul>
</li>
<li>Run the script. It works fine in CPython, but PyPy is much faster (seconds instead of minutes): <code>pypy3 contrib/devtools/headerssync-params.py</code>.</li>
<li>Paste the output defining <code>HEADER_COMMITMENT_PERIOD</code> and <code>REDOWNLOAD_BUFFER_SIZE</code> into the top of <a href="doc//src/headerssync.cpp"><code>src/headerssync.cpp</code></a>.</li>
</ul>
</li>
</ul>
<ul>
<li>Clear the release notes and move them to the wiki (see "Write the release notes" below).</li>
<li>Translations on Transifex:
<ul>
<li>Pull translations from Transifex into the master branch.</li>
<li>Create <a href="https://www.transifex.com/bitcoin/bitcoin/content/">a new resource</a> named after the major version with the slug <code>qt-translation-&lt;RRR&gt;x</code>, where <code>RRR</code> is the major branch number padded with zeros. Use <code>src/qt/locale/bitcoin_en.xlf</code> to create it.</li>
<li>In the project workflow settings, ensure that <a href="https://help.transifex.com/en/articles/6224817-setting-up-translation-memory-fill-up">Translation Memory Fill-up</a> is enabled and that <a href="https://help.transifex.com/en/articles/6224753-translation-memory-with-context">Translation Memory Context Matching</a> is disabled.</li>
<li>Update the Transifex slug in <a href="doc//.tx/config"><code>.tx/config</code></a> to the slug of the resource created in the first step. This identifies which resource the translations will be synchronized from.</li>
<li>Make an announcement that translators can start translating for the new version. You can use one of the <a href="https://www.transifex.com/bitcoin/communication/">previous announcements</a> as a template.</li>
<li>Change the auto-update URL for the resource to <code>master</code>, e.g. <code>https://raw.githubusercontent.com/bitcoin/bitcoin/master/src/qt/locale/bitcoin_en.xlf</code>. (Do this only after the previous steps, to prevent an auto-update from interfering.)</li>
</ul>
</li>
</ul>
<h4 id="after-branch-off-on-the-major-release-branch"><a class="header" href="#after-branch-off-on-the-major-release-branch">After branch-off (on the major release branch)</a></h4>
<ul>
<li>Update the versions.</li>
<li>Create the draft, named "<em>version</em> Release Notes Draft", as a <a href="https://github.com/bitcoin-core/bitcoin-devwiki/wiki/_new">collaborative wiki</a>.</li>
<li>Clear the release notes: <code>cp doc/release-notes-empty-template.md doc/release-notes.md</code></li>
<li>Create a pinned meta-issue for testing the release candidate (see <a href="https://github.com/bitcoin/bitcoin/issues/27621">this issue</a> for an example) and provide a link to it in the release announcements where useful.</li>
<li>Translations on Transifex
<ul>
<li>Change the auto-update URL for the new major version's resource away from <code>master</code> and to the branch, e.g. <code>https://raw.githubusercontent.com/bitcoin/bitcoin/&lt;branch&gt;/src/qt/locale/bitcoin_en.xlf</code>. Do not forget this or it will keep tracking the translations on master instead, drifting away from the specific major release.</li>
</ul>
</li>
<li>Prune inputs from the qa-assets repo (See <a href="https://github.com/bitcoin-core/qa-assets#pruning-inputs">pruning
inputs</a>).</li>
</ul>
<h4 id="before-final-release"><a class="header" href="#before-final-release">Before final release</a></h4>
<ul>
<li>Merge the release notes from <a href="https://github.com/bitcoin-core/bitcoin-devwiki/wiki/">the wiki</a> into the branch.</li>
<li>Ensure the "Needs release note" label is removed from all relevant pull
requests and issues:
https://github.com/bitcoin/bitcoin/issues?q=label%3A%22Needs+release+note%22</li>
</ul>
<h4 id="tagging-a-release-candidate"><a class="header" href="#tagging-a-release-candidate">Tagging a release (candidate)</a></h4>
<p>To tag the version (or release candidate) in git, use the <code>make-tag.py</code> script from <a href="https://github.com/bitcoin-core/bitcoin-maintainer-tools">bitcoin-maintainer-tools</a>. From the root of the repository run:</p>
<pre><code>../bitcoin-maintainer-tools/make-tag.py v(new version, e.g. 25.0)
</code></pre>
<p>This will perform a few last-minute consistency checks in the build system files, and if they pass, create a signed tag.</p>
<h2 id="building-3"><a class="header" href="#building-3">Building</a></h2>
<h3 id="first-time--new-builders"><a class="header" href="#first-time--new-builders">First time / New builders</a></h3>
<p>Install Guix using one of the installation methods detailed in
<a href="doc//contrib/guix/INSTALL.html">contrib/guix/INSTALL.md</a>.</p>
<p>Check out the source code in the following directory hierarchy.</p>
<pre><code>cd /path/to/your/toplevel/build
git clone https://github.com/bitcoin-core/guix.sigs.git
git clone https://github.com/bitcoin-core/bitcoin-detached-sigs.git
git clone https://github.com/bitcoin/bitcoin.git
</code></pre>
<h3 id="write-the-release-notes"><a class="header" href="#write-the-release-notes">Write the release notes</a></h3>
<p>Open a draft of the release notes for collaborative editing at https://github.com/bitcoin-core/bitcoin-devwiki/wiki.</p>
<p>For the period during which the notes are being edited on the wiki, the version on the branch should be wiped and replaced with a link to the wiki which should be used for all announcements until <code>-final</code>.</p>
<p>Generate list of authors:</p>
<pre><code>git log --format='- %aN' v(current version, e.g. 25.0)..v(new version, e.g. 25.1) | grep -v 'merge-script' | sort -fiu
</code></pre>
<h3 id="setup-and-perform-guix-builds"><a class="header" href="#setup-and-perform-guix-builds">Setup and perform Guix builds</a></h3>
<p>Checkout the Bitcoin Core version you'd like to build:</p>
<pre><code class="language-sh">pushd ./bitcoin
SIGNER='(your builder key, ie bluematt, sipa, etc)'
VERSION='(new version without v-prefix, e.g. 25.0)'
git fetch origin "v${VERSION}"
git checkout "v${VERSION}"
popd
</code></pre>
<p>Ensure your guix.sigs are up-to-date if you wish to <code>guix-verify</code> your builds
against other <code>guix-attest</code> signatures.</p>
<pre><code class="language-sh">git -C ./guix.sigs pull
</code></pre>
<h3 id="create-the-macos-sdk-tarball-first-time-or-when-sdk-version-changes"><a class="header" href="#create-the-macos-sdk-tarball-first-time-or-when-sdk-version-changes">Create the macOS SDK tarball (first time, or when SDK version changes)</a></h3>
<p>Create the macOS SDK tarball, see the <a href="doc//contrib/macdeploy/README.html#deterministic-macos-app-notes">macdeploy
instructions</a> for
details.</p>
<h3 id="build-and-attest-to-build-outputs"><a class="header" href="#build-and-attest-to-build-outputs">Build and attest to build outputs</a></h3>
<p>Follow the relevant Guix README.md sections:</p>
<ul>
<li><a href="doc//contrib/guix/README.html#building">Building</a></li>
<li><a href="doc//contrib/guix/README.html#attesting-to-build-outputs">Attesting to build outputs</a></li>
</ul>
<h3 id="verify-other-builders-signatures-to-your-own-optional"><a class="header" href="#verify-other-builders-signatures-to-your-own-optional">Verify other builders' signatures to your own (optional)</a></h3>
<ul>
<li><a href="doc//contrib/guix/README.html#verifying-build-output-attestations">Verifying build output attestations</a></li>
</ul>
<h3 id="commit-your-non-codesigned-signature-to-guixsigs"><a class="header" href="#commit-your-non-codesigned-signature-to-guixsigs">Commit your non codesigned signature to guix.sigs</a></h3>
<pre><code class="language-sh">pushd ./guix.sigs
git add "${VERSION}/${SIGNER}"/noncodesigned.SHA256SUMS{,.asc}
git commit -m "Add attestations by ${SIGNER} for ${VERSION} non-codesigned"
popd
</code></pre>
<p>Then open a Pull Request to the <a href="https://github.com/bitcoin-core/guix.sigs">guix.sigs repository</a>.</p>
<h2 id="codesigning"><a class="header" href="#codesigning">Codesigning</a></h2>
<h3 id="macos-codesigner-only-create-detached-macos-signatures-assuming-signapple-is-installed-and-up-to-date-with-master-branch"><a class="header" href="#macos-codesigner-only-create-detached-macos-signatures-assuming-signapple-is-installed-and-up-to-date-with-master-branch">macOS codesigner only: Create detached macOS signatures (assuming <a href="https://github.com/achow101/signapple/">signapple</a> is installed and up to date with master branch)</a></h3>
<p>In the <code>guix-build-${VERSION}/output/x86_64-apple-darwin</code> and <code>guix-build-${VERSION}/output/arm64-apple-darwin</code> directories:</p>
<pre><code>tar xf bitcoin-osx-unsigned.tar.gz
./detached-sig-create.sh /path/to/codesign.p12
Enter the keychain password and authorize the signature
signature-osx.tar.gz will be created
</code></pre>
<h3 id="windows-codesigner-only-create-detached-windows-signatures"><a class="header" href="#windows-codesigner-only-create-detached-windows-signatures">Windows codesigner only: Create detached Windows signatures</a></h3>
<p>In the <code>guix-build-${VERSION}/output/x86_64-w64-mingw32</code> directory:</p>
<pre><code>tar xf bitcoin-win-unsigned.tar.gz
./detached-sig-create.sh -key /path/to/codesign.key
Enter the passphrase for the key when prompted
signature-win.tar.gz will be created
</code></pre>
<h3 id="windows-and-macos-codesigners-only-test-code-signatures"><a class="header" href="#windows-and-macos-codesigners-only-test-code-signatures">Windows and macOS codesigners only: test code signatures</a></h3>
<p>It is advised to test that the code signature attaches properly prior to tagging by performing the <code>guix-codesign</code> step.
However if this is done, once the release has been tagged in the bitcoin-detached-sigs repo, the <code>guix-codesign</code> step must be performed again in order for the guix attestation to be valid when compared against the attestations of non-codesigner builds. The directories created by <code>guix-codesign</code> will need to be cleared prior to running <code>guix-codesign</code> again.</p>
<h3 id="windows-and-macos-codesigners-only-commit-the-detached-codesign-payloads"><a class="header" href="#windows-and-macos-codesigners-only-commit-the-detached-codesign-payloads">Windows and macOS codesigners only: Commit the detached codesign payloads</a></h3>
<pre><code class="language-sh">pushd ./bitcoin-detached-sigs
# checkout or create the appropriate branch for this release series
git checkout --orphan &lt;branch&gt;
# if you are the macOS codesigner
rm -rf osx
tar xf signature-osx.tar.gz
# if you are the windows codesigner
rm -rf win
tar xf signature-win.tar.gz
git add -A
git commit -m "&lt;version&gt;: {osx,win} signature for {rc,final}"
git tag -s "v${VERSION}" HEAD
git push the current branch and new tag
popd
</code></pre>
<h3 id="non-codesigners-wait-for-windows-and-macos-detached-signatures"><a class="header" href="#non-codesigners-wait-for-windows-and-macos-detached-signatures">Non-codesigners: wait for Windows and macOS detached signatures</a></h3>
<ul>
<li>Once the Windows and macOS builds each have 3 matching signatures, they will be signed with their respective release keys.</li>
<li>Detached signatures will then be committed to the <a href="https://github.com/bitcoin-core/bitcoin-detached-sigs">bitcoin-detached-sigs</a> repository, which can be combined with the unsigned apps to create signed binaries.</li>
</ul>
<h3 id="create-the-codesigned-build-outputs"><a class="header" href="#create-the-codesigned-build-outputs">Create the codesigned build outputs</a></h3>
<ul>
<li><a href="doc//contrib/guix/README.html#codesigning-build-outputs">Codesigning build outputs</a></li>
</ul>
<h3 id="verify-other-builders-signatures-to-your-own-optional-1"><a class="header" href="#verify-other-builders-signatures-to-your-own-optional-1">Verify other builders' signatures to your own (optional)</a></h3>
<ul>
<li><a href="doc//contrib/guix/README.html#verifying-build-output-attestations">Verifying build output attestations</a></li>
</ul>
<h3 id="commit-your-codesigned-signature-to-guixsigs-for-the-signed-macoswindows-binaries"><a class="header" href="#commit-your-codesigned-signature-to-guixsigs-for-the-signed-macoswindows-binaries">Commit your codesigned signature to guix.sigs (for the signed macOS/Windows binaries)</a></h3>
<pre><code class="language-sh">pushd ./guix.sigs
git add "${VERSION}/${SIGNER}"/all.SHA256SUMS{,.asc}
git commit -m "Add attestations by ${SIGNER} for ${VERSION} codesigned"
popd
</code></pre>
<p>Then open a Pull Request to the <a href="https://github.com/bitcoin-core/guix.sigs">guix.sigs repository</a>.</p>
<h2 id="after-6-or-more-people-have-guix-built-and-their-results-match"><a class="header" href="#after-6-or-more-people-have-guix-built-and-their-results-match">After 6 or more people have guix-built and their results match</a></h2>
<p>After verifying signatures, combine the <code>all.SHA256SUMS.asc</code> file from all signers into <code>SHA256SUMS.asc</code>:</p>
<pre><code class="language-bash">cat "$VERSION"/*/all.SHA256SUMS.asc &gt; SHA256SUMS.asc
</code></pre>
<ul>
<li>
<p>Upload to the bitcoincore.org server:</p>
<ol>
<li>
<p>The contents of each <code>./bitcoin/guix-build-${VERSION}/output/${HOST}/</code> directory.</p>
<p>Guix will output all of the results into host subdirectories, but the SHA256SUMS
file does not include these subdirectories. In order for downloads via torrent
to verify without directory structure modification, all of the uploaded files
need to be in the same directory as the SHA256SUMS file.</p>
<p>Wait until all of these files have finished uploading before uploading the SHA256SUMS(.asc) files.</p>
</li>
<li>
<p>The <code>SHA256SUMS</code> file</p>
</li>
<li>
<p>The <code>SHA256SUMS.asc</code> combined signature file you just created.</p>
</li>
</ol>
</li>
<li>
<p>After uploading release candidate binaries, notify the bitcoin-core-dev mailing list and
bitcoin-dev group that a release candidate is available for testing. Include a link to the release
notes draft.</p>
</li>
<li>
<p>The server will automatically create an OpenTimestamps file and torrent of the directory.</p>
</li>
<li>
<p>Optionally help seed this torrent. To get the <code>magnet:</code> URI use:</p>
<pre><code class="language-sh">transmission-show -m &lt;torrent file&gt;
</code></pre>
<p>Insert the magnet URI into the announcement sent to mailing lists. This permits
people without access to <code>bitcoincore.org</code> to download the binary distribution.
Also put it into the <code>optional_magnetlink:</code> slot in the YAML file for
bitcoincore.org.</p>
</li>
<li>
<p>Archive the release notes for the new version to <code>doc/release-notes/release-notes-${VERSION}.md</code>
(branch <code>master</code> and branch of the release).</p>
</li>
<li>
<p>Update the bitcoincore.org website</p>
<ul>
<li>
<p>blog post</p>
</li>
<li>
<p>maintained versions <a href="https://github.com/bitcoin-core/bitcoincore.org/commits/master/_includes/posts/maintenance-table.md">table</a></p>
</li>
<li>
<p>RPC documentation update</p>
<ul>
<li>See https://github.com/bitcoin-core/bitcoincore.org/blob/master/contrib/doc-gen/</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Update repositories</p>
<ul>
<li>
<p>Delete post-EOL <a href="https://github.com/bitcoin/bitcoin/branches/all">release branches</a> and create a tag <code>v${branch_name}-final</code>.</p>
</li>
<li>
<p>Delete <a href="https://github.com/bitcoin/bitcoin/labels?q=backport">"Needs backport" labels</a> for non-existing branches.</p>
</li>
<li>
<p>Update packaging repo</p>
<ul>
<li>
<p>Push the flatpak to flathub, e.g. https://github.com/flathub/org.bitcoincore.bitcoin-qt/pull/2</p>
</li>
<li>
<p>Push the snap, see https://github.com/bitcoin-core/packaging/blob/main/snap/local/build.md</p>
</li>
</ul>
</li>
<li>
<p>Create a <a href="https://github.com/bitcoin/bitcoin/releases/new">new GitHub release</a> with a link to the archived release notes</p>
</li>
</ul>
</li>
<li>
<p>Announce the release:</p>
<ul>
<li>
<p>bitcoin-dev and bitcoin-core-dev mailing list</p>
</li>
<li>
<p>Bitcoin Core announcements list https://bitcoincore.org/en/list/announcements/join/</p>
</li>
<li>
<p>Bitcoin Core Twitter https://twitter.com/bitcoincoreorg</p>
</li>
<li>
<p>Celebrate</p>
</li>
</ul>
</li>
</ul>
<h3 id="additional-information"><a class="header" href="#additional-information">Additional information</a></h3>
<h4 id="how-to-calculate-m_assumed_blockchain_size-and-m_assumed_chain_state_size"><a class="header" href="#how-to-calculate-m_assumed_blockchain_size-and-m_assumed_chain_state_size"><a name="how-to-calculate-assumed-blockchain-and-chain-state-size"></a>How to calculate <code>m_assumed_blockchain_size</code> and <code>m_assumed_chain_state_size</code></a></h4>
<p>Both variables are used as a guideline for how much space the user needs on their drive in total, not just strictly for the blockchain.
Note that all values should be taken from a <strong>fully synced</strong> node and have an overhead of 5-10% added on top of its base value.</p>
<p>To calculate <code>m_assumed_blockchain_size</code>, take the size in GiB of these directories:</p>
<ul>
<li>For <code>mainnet</code> -&gt; the data directory, excluding the <code>/testnet3</code>, <code>/testnet4</code>, <code>/signet</code>, and <code>/regtest</code> directories and any overly large files, e.g. a huge <code>debug.log</code></li>
<li>For <code>testnet</code> -&gt; <code>/testnet3</code></li>
<li>For <code>testnet4</code> -&gt; <code>/testnet4</code></li>
<li>For <code>signet</code> -&gt; <code>/signet</code></li>
</ul>
<p>To calculate <code>m_assumed_chain_state_size</code>, take the size in GiB of these directories:</p>
<ul>
<li>For <code>mainnet</code> -&gt; <code>/chainstate</code></li>
<li>For <code>testnet</code> -&gt; <code>/testnet3/chainstate</code></li>
<li>For <code>testnet4</code> -&gt; <code>/testnet4/chainstate</code></li>
<li>For <code>signet</code> -&gt; <code>/signet/chainstate</code></li>
</ul>
<p>Notes:</p>
<ul>
<li>When taking the size for <code>m_assumed_blockchain_size</code>, there's no need to exclude the <code>/chainstate</code> directory since it's a guideline value and an overhead will be added anyway.</li>
<li>The expected overhead for growth may change over time. Consider whether the percentage needs to be changed in response; if so, update it here in this section.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="tor-support-in-bitcoin"><a class="header" href="#tor-support-in-bitcoin">TOR SUPPORT IN BITCOIN</a></h1>
<p>It is possible to run Bitcoin Core as a Tor onion service, and connect to such services.</p>
<p>The following directions assume you have a Tor proxy running on port 9050. Many distributions default to having a SOCKS proxy listening on port 9050, but others may not. In particular, the Tor Browser Bundle defaults to listening on port 9150.</p>
<h2 id="compatibility-2"><a class="header" href="#compatibility-2">Compatibility</a></h2>
<ul>
<li>
<p>Starting with version 22.0, Bitcoin Core only supports Tor version 3 hidden
services (Tor v3). Tor v2 addresses are ignored by Bitcoin Core and neither
relayed nor stored.</p>
</li>
<li>
<p>Tor removed v2 support beginning with version 0.4.6.</p>
</li>
</ul>
<h2 id="how-to-see-information-about-your-tor-configuration-via-bitcoin-core"><a class="header" href="#how-to-see-information-about-your-tor-configuration-via-bitcoin-core">How to see information about your Tor configuration via Bitcoin Core</a></h2>
<p>There are several ways to see your local onion address in Bitcoin Core:</p>
<ul>
<li>in the "Local addresses" output of CLI <code>-netinfo</code></li>
<li>in the "localaddresses" output of RPC <code>getnetworkinfo</code></li>
<li>in the debug log (grep for "AddLocal"; the Tor address ends in <code>.onion</code>)</li>
</ul>
<p>You may set the <code>-debug=tor</code> config logging option to have additional
information in the debug log about your Tor configuration.</p>
<p>CLI <code>-addrinfo</code> returns the number of addresses known to your node per
network. This can be useful to see how many onion peers your node knows,
e.g. for <code>-onlynet=onion</code>.</p>
<p>You can use the <code>getnodeaddresses</code> RPC to fetch a number of onion peers known to your node; run <code>bitcoin-cli help getnodeaddresses</code> for details.</p>
<h2 id="1-run-bitcoin-core-behind-a-tor-proxy"><a class="header" href="#1-run-bitcoin-core-behind-a-tor-proxy">1. Run Bitcoin Core behind a Tor proxy</a></h2>
<p>The first step is running Bitcoin Core behind a Tor proxy. This will already anonymize all
outgoing connections, but more is possible.</p>
<pre><code>-proxy=ip:port  Set the proxy server. If SOCKS5 is selected (default), this proxy
                server will be used to try to reach .onion addresses as well.
                You need to use -noonion or -onion=0 to explicitly disable
                outbound access to onion services.

-onion=ip:port  Set the proxy server to use for Tor onion services. You do not
                need to set this if it's the same as -proxy. You can use -onion=0
                to explicitly disable access to onion services.
                ------------------------------------------------------------------
                Note: Only the -proxy option sets the proxy for DNS requests;
                with -onion they will not route over Tor, so use -proxy if you
                have privacy concerns.
                ------------------------------------------------------------------

-listen         When using -proxy, listening is disabled by default. If you want
                to manually configure an onion service (see section 3), you'll
                need to enable it explicitly.

-connect=X      When behind a Tor proxy, you can specify .onion addresses instead
-addnode=X      of IP addresses or hostnames in these parameters. It requires
-seednode=X     SOCKS5. In Tor mode, such addresses can also be exchanged with
                other P2P nodes.

-onlynet=onion  Make automatic outbound connections only to .onion addresses.
                Inbound and manual connections are not affected by this option.
                It can be specified multiple times to allow multiple networks,
                e.g. onlynet=onion, onlynet=i2p, onlynet=cjdns.
</code></pre>
<p>In a typical situation, this suffices to run behind a Tor proxy:</p>
<pre><code>./bitcoind -proxy=127.0.0.1:9050
</code></pre>
<h2 id="2-automatically-create-a-bitcoin-core-onion-service"><a class="header" href="#2-automatically-create-a-bitcoin-core-onion-service">2. Automatically create a Bitcoin Core onion service</a></h2>
<p>Bitcoin Core makes use of Tor's control socket API to create and destroy
ephemeral onion services programmatically. This means that if Tor is running and
proper authentication has been configured, Bitcoin Core automatically creates an
onion service to listen on. The goal is to increase the number of available
onion nodes.</p>
<p>This feature is enabled by default if Bitcoin Core is listening (<code>-listen</code>) and
it requires a Tor connection to work. It can be explicitly disabled with
<code>-listenonion=0</code>. If it is not disabled, it can be configured using the
<code>-torcontrol</code> and <code>-torpassword</code> settings.</p>
<p>To see verbose Tor information in the bitcoind debug log, pass <code>-debug=tor</code>.</p>
<h3 id="control-port"><a class="header" href="#control-port">Control Port</a></h3>
<p>You may need to set up the Tor Control Port. On Linux distributions there may be
some or all of the following settings in <code>/etc/tor/torrc</code>, generally commented
out by default (if not, add them):</p>
<pre><code>ControlPort 9051
CookieAuthentication 1
CookieAuthFileGroupReadable 1
DataDirectoryGroupReadable 1
</code></pre>
<p>Add or uncomment those, save, and restart Tor (usually <code>systemctl restart tor</code>
or <code>sudo systemctl restart tor</code> on most systemd-based systems, including recent
Debian and Ubuntu, or just restart the computer).</p>
<h3 id="authentication"><a class="header" href="#authentication">Authentication</a></h3>
<p>Connecting to Tor's control socket API requires one of two authentication
methods to be configured: cookie authentication or bitcoind's <code>-torpassword</code>
configuration option.</p>
<h4 id="cookie-authentication"><a class="header" href="#cookie-authentication">Cookie authentication</a></h4>
<p>For cookie authentication, the user running bitcoind must have read access to
the <code>CookieAuthFile</code> specified in the Tor configuration. In some cases this is
preconfigured and the creation of an onion service is automatic. Don't forget to
use the <code>-debug=tor</code> bitcoind configuration option to enable Tor debug logging.</p>
<p>If a permissions problem is seen in the debug log, e.g. <code>tor: Authentication cookie /run/tor/control.authcookie could not be opened (check permissions)</code>, it
can be resolved by adding both the user running Tor and the user running
bitcoind to the same Tor group and setting permissions appropriately.</p>
<p>On Debian-derived systems, the Tor group will likely be <code>debian-tor</code> and one way
to verify could be to list the groups and grep for a "tor" group name:</p>
<pre><code>getent group | cut -d: -f1 | grep -i tor
</code></pre>
<p>You can also check the group of the cookie file. On most Linux systems, the Tor
auth cookie will usually be <code>/run/tor/control.authcookie</code>:</p>
<pre><code>TORGROUP=$(stat -c '%G' /run/tor/control.authcookie)
</code></pre>
<p>Once you have determined the <code>${TORGROUP}</code> and selected the <code>${USER}</code> that will
run bitcoind, run this as root:</p>
<pre><code>usermod -a -G ${TORGROUP} ${USER}
</code></pre>
<p>Then restart the computer (or log out) and log in as the <code>${USER}</code> that will run
bitcoind.</p>
<h4 id="torpassword-authentication"><a class="header" href="#torpassword-authentication"><code>torpassword</code> authentication</a></h4>
<p>For the <code>-torpassword=password</code> option, the password is the clear text form that
was used when generating the hashed password for the <code>HashedControlPassword</code>
option in the Tor configuration file.</p>
<p>The hashed password can be obtained with the command <code>tor --hash-password password</code> (refer to the <a href="https://2019.www.torproject.org/docs/tor-manual.html.en">Tor Dev
Manual</a> for more
details).</p>
<h2 id="3-manually-create-a-bitcoin-core-onion-service"><a class="header" href="#3-manually-create-a-bitcoin-core-onion-service">3. Manually create a Bitcoin Core onion service</a></h2>
<p>You can also manually configure your node to be reachable from the Tor network.
Add these lines to your <code>/etc/tor/torrc</code> (or equivalent config file):</p>
<pre><code>HiddenServiceDir /var/lib/tor/bitcoin-service/
HiddenServicePort 8333 127.0.0.1:8334
</code></pre>
<p>The directory can be different of course, but virtual port numbers should be equal to
your bitcoind's P2P listen port (8333 by default), and target addresses and ports
should be equal to binding address and port for inbound Tor connections (127.0.0.1:8334 by default).</p>
<pre><code>-externalip=X   You can tell bitcoin about its publicly reachable addresses using
                this option, and this can be an onion address. Given the above
                configuration, you can find your onion address in
                /var/lib/tor/bitcoin-service/hostname. For connections
                coming from unroutable addresses (such as 127.0.0.1, where the
                Tor proxy typically runs), onion addresses are given
                preference for your node to advertise itself with.

                You can set multiple local addresses with -externalip. The
                one that will be rumoured to a particular peer is the most
                compatible one and also using heuristics, e.g. the address
                with the most incoming connections, etc.

-listen         You'll need to enable listening for incoming connections, as this
                is off by default behind a proxy.

-discover       When -externalip is specified, no attempt is made to discover local
                IPv4 or IPv6 addresses. If you want to run a dual stack, reachable
                from both Tor and IPv4 (or IPv6), you'll need to either pass your
                other addresses using -externalip, or explicitly enable -discover.
                Note that both addresses of a dual-stack system may be easily
                linkable using traffic analysis.
</code></pre>
<p>In a typical situation, where you're only reachable via Tor, this should suffice:</p>
<pre><code>./bitcoind -proxy=127.0.0.1:9050 -externalip=7zvj7a2imdgkdbg4f2dryd5rgtrn7upivr5eeij4cicjh65pooxeshid.onion -listen
</code></pre>
<p>(obviously, replace the .onion address with your own). It should be noted that you still
listen on all devices and another node could establish a clearnet connection, when knowing
your address. To mitigate this, additionally bind the address of your Tor proxy:</p>
<pre><code>./bitcoind ... -bind=127.0.0.1:8334=onion
</code></pre>
<p>If you don't care too much about hiding your node, and want to be reachable on IPv4
as well, use <code>discover</code> instead:</p>
<pre><code>./bitcoind ... -discover
</code></pre>
<p>and open port 8333 on your firewall (or use port mapping, i.e., <code>-natpmp</code>).</p>
<p>If you only want to use Tor to reach .onion addresses, but not use it as a proxy
for normal IPv4/IPv6 communication, use:</p>
<pre><code>./bitcoind -onion=127.0.0.1:9050 -externalip=7zvj7a2imdgkdbg4f2dryd5rgtrn7upivr5eeij4cicjh65pooxeshid.onion -discover
</code></pre>
<h2 id="4-privacy-recommendations"><a class="header" href="#4-privacy-recommendations">4. Privacy recommendations</a></h2>
<ul>
<li>Do not add anything but Bitcoin Core ports to the onion service created in section 3.
If you run a web service too, create a new onion service for that.
Otherwise it is trivial to link them, which may reduce privacy. Onion
services created automatically (as in section 2) always have only one port
open.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="user-space-statically-defined-tracing-usdt-for-bitcoin-core"><a class="header" href="#user-space-statically-defined-tracing-usdt-for-bitcoin-core">User-space, Statically Defined Tracing (USDT) for Bitcoin Core</a></h1>
<p>Bitcoin Core includes statically defined tracepoints to allow for more
observability during development, debugging, code review, and production usage.
These tracepoints make it possible to keep track of custom statistics and
enable detailed monitoring of otherwise hidden internals. They have
little to no performance impact when unused.</p>
<pre><code>eBPF and USDT Overview
======================

                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ tracing script   â”‚            â”‚ bitcoind     â”‚
                â”‚==================â”‚      2.    â”‚==============â”‚
                â”‚  eBPF  â”‚ tracing â”‚      hooks â”‚              â”‚
                â”‚  code  â”‚ logic   â”‚      intoâ”Œâ”€â”¤â–ºtracepoint 1â”€â”¼â”€â”€â”€â” 3.
                â””â”€â”€â”€â”€â”¬â”€â”€â”€â”´â”€â”€â–²â”€â”€â”€â”€â”€â”€â”˜          â”œâ”€â”¤â–ºtracepoint 2 â”‚   â”‚ pass args
            1.       â”‚      â”‚ 4.              â”‚ â”‚ ...          â”‚   â”‚ to eBPF
    User    compiles â”‚      â”‚ pass data to    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ program
    Space    &amp; loads â”‚      â”‚ tracing script  â”‚                    â”‚
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€
    Kernel           â”‚      â”‚                 â”‚                    â”‚
    Space       â”Œâ”€â”€â”¬â”€â–¼â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
                â”‚  â”‚  eBPF program                         â”‚â—„â”€â”€â”€â”€â”€â”€â”˜
                â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                â”‚ eBPF kernel Virtual Machine (sandboxed)  â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. The tracing script compiles the eBPF code and loads the eBPF program into a kernel VM
2. The eBPF program hooks into one or more tracepoints
3. When the tracepoint is called, the arguments are passed to the eBPF program
4. The eBPF program processes the arguments and returns data to the tracing script
</code></pre>
<p>The Linux kernel can hook into the tracepoints during runtime and pass data to
sandboxed <a href="https://ebpf.io/">eBPF</a> programs running in the kernel. These eBPF programs can, for
example, collect statistics or pass data back to user-space scripts for further
processing.</p>
<p>The two main eBPF front-ends with support for USDT are <a href="https://github.com/iovisor/bpftrace">bpftrace</a> and
<a href="https://github.com/iovisor/bcc">BPF Compiler Collection (BCC)</a>. BCC is used for complex tools and daemons and
<code>bpftrace</code> is preferred for one-liners and shorter scripts. Examples for both can
be found in <a href="doc/../contrib/tracing/">contrib/tracing</a>.</p>
<h2 id="tracepoint-documentation"><a class="header" href="#tracepoint-documentation">Tracepoint documentation</a></h2>
<p>The currently available tracepoints are listed here.</p>
<h3 id="context-net"><a class="header" href="#context-net">Context <code>net</code></a></h3>
<h4 id="tracepoint-netinbound_message"><a class="header" href="#tracepoint-netinbound_message">Tracepoint <code>net:inbound_message</code></a></h4>
<p>Is called when a message is received from a peer over the P2P network. Passes
information about our peer, the connection and the message as arguments.</p>
<p>Arguments passed:</p>
<ol>
<li>Peer ID as <code>int64</code></li>
<li>Peer Address and Port (IPv4, IPv6, Tor v3, I2P, ...) as <code>pointer to C-style String</code> (max. length 68 characters)</li>
<li>Connection Type (inbound, feeler, outbound-full-relay, ...) as <code>pointer to C-style String</code> (max. length 20 characters)</li>
<li>Message Type (inv, ping, getdata, addrv2, ...) as <code>pointer to C-style String</code> (max. length 20 characters)</li>
<li>Message Size in bytes as <code>uint64</code></li>
<li>Message Bytes as <code>pointer to unsigned chars</code> (i.e. bytes)</li>
</ol>
<p>Note: The message is passed to the tracepoint in full, however, due to space
limitations in the eBPF kernel VM it might not be possible to pass the message
to user-space in full. Messages longer than a 32kb might be cut off. This can
be detected in tracing scripts by comparing the message size to the length of
the passed message.</p>
<h4 id="tracepoint-netoutbound_message"><a class="header" href="#tracepoint-netoutbound_message">Tracepoint <code>net:outbound_message</code></a></h4>
<p>Is called when a message is sent to a peer over the P2P network. Passes
information about our peer, the connection and the message as arguments.</p>
<p>Arguments passed:</p>
<ol>
<li>Peer ID as <code>int64</code></li>
<li>Peer Address and Port (IPv4, IPv6, Tor v3, I2P, ...) as <code>pointer to C-style String</code> (max. length 68 characters)</li>
<li>Connection Type (inbound, feeler, outbound-full-relay, ...) as <code>pointer to C-style String</code> (max. length 20 characters)</li>
<li>Message Type (inv, ping, getdata, addrv2, ...) as <code>pointer to C-style String</code> (max. length 20 characters)</li>
<li>Message Size in bytes as <code>uint64</code></li>
<li>Message Bytes as <code>pointer to unsigned chars</code> (i.e. bytes)</li>
</ol>
<p>Note: The message is passed to the tracepoint in full, however, due to space
limitations in the eBPF kernel VM it might not be possible to pass the message
to user-space in full. Messages longer than a 32kb might be cut off. This can
be detected in tracing scripts by comparing the message size to the length of
the passed message.</p>
<h3 id="context-validation"><a class="header" href="#context-validation">Context <code>validation</code></a></h3>
<h4 id="tracepoint-validationblock_connected"><a class="header" href="#tracepoint-validationblock_connected">Tracepoint <code>validation:block_connected</code></a></h4>
<p>Is called <em>after</em> a block is connected to the chain. Can, for example, be used
to benchmark block connections together with <code>-reindex</code>.</p>
<p>Arguments passed:</p>
<ol>
<li>Block Header Hash as <code>pointer to unsigned chars</code> (i.e. 32 bytes in little-endian)</li>
<li>Block Height as <code>int32</code></li>
<li>Transactions in the Block as <code>uint64</code></li>
<li>Inputs spend in the Block as <code>int32</code></li>
<li>SigOps in the Block (excluding coinbase SigOps) <code>uint64</code></li>
<li>Time it took to connect the Block in nanoseconds (ns) as <code>uint64</code></li>
</ol>
<h3 id="context-utxocache"><a class="header" href="#context-utxocache">Context <code>utxocache</code></a></h3>
<p>The following tracepoints cover the in-memory UTXO cache. UTXOs are, for example,
added to and removed (spent) from the cache when we connect a new block.
<strong>Note</strong>: Bitcoin Core uses temporary clones of the <em>main</em> UTXO cache
(<code>chainstate.CoinsTip()</code>). For example, the RPCs <code>generateblock</code> and
<code>getblocktemplate</code> call <code>TestBlockValidity()</code>, which applies the UTXO set
changes to a temporary cache. Similarly, mempool consistency checks, which are
frequent on regtest, also apply the UTXO set changes to a temporary cache.
Changes to the <em>main</em> UTXO cache and to temporary caches trigger the tracepoints.
We can't tell if a temporary cache or the <em>main</em> cache was changed.</p>
<h4 id="tracepoint-utxocacheflush"><a class="header" href="#tracepoint-utxocacheflush">Tracepoint <code>utxocache:flush</code></a></h4>
<p>Is called <em>after</em> the in-memory UTXO cache is flushed.</p>
<p>Arguments passed:</p>
<ol>
<li>Time it took to flush the cache microseconds as <code>int64</code></li>
<li>Flush state mode as <code>uint32</code>. It's an enumerator class with values <code>0</code>
(<code>NONE</code>), <code>1</code> (<code>IF_NEEDED</code>), <code>2</code> (<code>PERIODIC</code>), <code>3</code> (<code>ALWAYS</code>)</li>
<li>Cache size (number of coins) before the flush as <code>uint64</code></li>
<li>Cache memory usage in bytes as <code>uint64</code></li>
<li>If pruning caused the flush as <code>bool</code></li>
</ol>
<h4 id="tracepoint-utxocacheadd"><a class="header" href="#tracepoint-utxocacheadd">Tracepoint <code>utxocache:add</code></a></h4>
<p>Is called when a coin is added to a UTXO cache. This can be a temporary UTXO cache too.</p>
<p>Arguments passed:</p>
<ol>
<li>Transaction ID (hash) as <code>pointer to unsigned chars</code> (i.e. 32 bytes in little-endian)</li>
<li>Output index as <code>uint32</code></li>
<li>Block height the coin was added to the UTXO-set as  <code>uint32</code></li>
<li>Value of the coin as <code>int64</code></li>
<li>If the coin is a coinbase as <code>bool</code></li>
</ol>
<h4 id="tracepoint-utxocachespent"><a class="header" href="#tracepoint-utxocachespent">Tracepoint <code>utxocache:spent</code></a></h4>
<p>Is called when a coin is spent from a UTXO cache. This can be a temporary UTXO cache too.</p>
<p>Arguments passed:</p>
<ol>
<li>Transaction ID (hash) as <code>pointer to unsigned chars</code> (i.e. 32 bytes in little-endian)</li>
<li>Output index as <code>uint32</code></li>
<li>Block height the coin was spent, as <code>uint32</code></li>
<li>Value of the coin as <code>int64</code></li>
<li>If the coin is a coinbase as <code>bool</code></li>
</ol>
<h4 id="tracepoint-utxocacheuncache"><a class="header" href="#tracepoint-utxocacheuncache">Tracepoint <code>utxocache:uncache</code></a></h4>
<p>Is called when a coin is purposefully unloaded from a UTXO cache. This
happens, for example, when we load an UTXO into a cache when trying to accept
a transaction that turns out to be invalid. The loaded UTXO is uncached to avoid
filling our UTXO cache up with irrelevant UTXOs.</p>
<p>Arguments passed:</p>
<ol>
<li>Transaction ID (hash) as <code>pointer to unsigned chars</code> (i.e. 32 bytes in little-endian)</li>
<li>Output index as <code>uint32</code></li>
<li>Block height the coin was uncached, as <code>uint32</code></li>
<li>Value of the coin as <code>int64</code></li>
<li>If the coin is a coinbase as <code>bool</code></li>
</ol>
<h3 id="context-coin_selection"><a class="header" href="#context-coin_selection">Context <code>coin_selection</code></a></h3>
<h4 id="tracepoint-coin_selectionselected_coins"><a class="header" href="#tracepoint-coin_selectionselected_coins">Tracepoint <code>coin_selection:selected_coins</code></a></h4>
<p>Is called when <code>SelectCoins</code> completes.</p>
<p>Arguments passed:</p>
<ol>
<li>Wallet name as <code>pointer to C-style string</code></li>
<li>Coin selection algorithm name as <code>pointer to C-style string</code></li>
<li>Selection target value as <code>int64</code></li>
<li>Calculated waste metric of the solution as <code>int64</code></li>
<li>Total value of the selected inputs as <code>int64</code></li>
</ol>
<h4 id="tracepoint-coin_selectionnormal_create_tx_internal"><a class="header" href="#tracepoint-coin_selectionnormal_create_tx_internal">Tracepoint <code>coin_selection:normal_create_tx_internal</code></a></h4>
<p>Is called when the first <code>CreateTransactionInternal</code> completes.</p>
<p>Arguments passed:</p>
<ol>
<li>Wallet name as <code>pointer to C-style string</code></li>
<li>Whether <code>CreateTransactionInternal</code> succeeded as <code>bool</code></li>
<li>The expected transaction fee as an <code>int64</code></li>
<li>The position of the change output as an <code>int32</code></li>
</ol>
<h4 id="tracepoint-coin_selectionattempting_aps_create_tx"><a class="header" href="#tracepoint-coin_selectionattempting_aps_create_tx">Tracepoint <code>coin_selection:attempting_aps_create_tx</code></a></h4>
<p>Is called when <code>CreateTransactionInternal</code> is called the second time for the optimistic
Avoid Partial Spends selection attempt. This is used to determine whether the next
tracepoints called are for the Avoid Partial Spends solution, or a different transaction.</p>
<p>Arguments passed:</p>
<ol>
<li>Wallet name as <code>pointer to C-style string</code></li>
</ol>
<h4 id="tracepoint-coin_selectionaps_create_tx_internal"><a class="header" href="#tracepoint-coin_selectionaps_create_tx_internal">Tracepoint <code>coin_selection:aps_create_tx_internal</code></a></h4>
<p>Is called when the second <code>CreateTransactionInternal</code> with Avoid Partial Spends enabled completes.</p>
<p>Arguments passed:</p>
<ol>
<li>Wallet name as <code>pointer to C-style string</code></li>
<li>Whether the Avoid Partial Spends solution will be used as <code>bool</code></li>
<li>Whether <code>CreateTransactionInternal</code> succeeded as<code> bool</code></li>
<li>The expected transaction fee as an <code>int64</code></li>
<li>The position of the change output as an <code>int32</code></li>
</ol>
<h3 id="context-mempool"><a class="header" href="#context-mempool">Context <code>mempool</code></a></h3>
<h4 id="tracepoint-mempooladded"><a class="header" href="#tracepoint-mempooladded">Tracepoint <code>mempool:added</code></a></h4>
<p>Is called when a transaction is added to the node's mempool. Passes information
about the transaction.</p>
<p>Arguments passed:</p>
<ol>
<li>Transaction ID (hash) as <code>pointer to unsigned chars</code> (i.e. 32 bytes in little-endian)</li>
<li>Transaction virtual size as <code>int32</code></li>
<li>Transaction fee as <code>int64</code></li>
</ol>
<h4 id="tracepoint-mempoolremoved"><a class="header" href="#tracepoint-mempoolremoved">Tracepoint <code>mempool:removed</code></a></h4>
<p>Is called when a transaction is removed from the node's mempool. Passes information
about the transaction.</p>
<p>Arguments passed:</p>
<ol>
<li>Transaction ID (hash) as <code>pointer to unsigned chars</code> (i.e. 32 bytes in little-endian)</li>
<li>Removal reason as <code>pointer to C-style String</code> (max. length 9 characters)</li>
<li>Transaction virtual size as <code>int32</code></li>
<li>Transaction fee as <code>int64</code></li>
<li>Transaction mempool entry time (epoch) as <code>uint64</code></li>
</ol>
<h4 id="tracepoint-mempoolreplaced"><a class="header" href="#tracepoint-mempoolreplaced">Tracepoint <code>mempool:replaced</code></a></h4>
<p>Is called when a transaction in the node's mempool is getting replaced by another.
Passes information about the replaced and replacement transactions.</p>
<p>Arguments passed:</p>
<ol>
<li>Replaced transaction ID (hash) as <code>pointer to unsigned chars</code> (i.e. 32 bytes in little-endian)</li>
<li>Replaced transaction virtual size as <code>int32</code></li>
<li>Replaced transaction fee as <code>int64</code></li>
<li>Replaced transaction mempool entry time (epoch) as <code>uint64</code></li>
<li>Replacement transaction ID (hash) as <code>pointer to unsigned chars</code> (i.e. 32 bytes in little-endian)</li>
<li>Replacement transaction virtual size as <code>int32</code></li>
<li>Replacement transaction fee as <code>int64</code></li>
</ol>
<p>Note: In cases where a single replacement transaction replaces multiple
existing transactions in the mempool, the tracepoint is called once for each
replaced transaction, with data of the replacement transaction being the same
in each call.</p>
<h4 id="tracepoint-mempoolrejected"><a class="header" href="#tracepoint-mempoolrejected">Tracepoint <code>mempool:rejected</code></a></h4>
<p>Is called when a transaction is not permitted to enter the mempool. Passes
information about the rejected transaction.</p>
<p>Arguments passed:</p>
<ol>
<li>Transaction ID (hash) as <code>pointer to unsigned chars</code> (i.e. 32 bytes in little-endian)</li>
<li>Reject reason as <code>pointer to C-style String</code> (max. length 118 characters)</li>
</ol>
<h2 id="adding-tracepoints-to-bitcoin-core"><a class="header" href="#adding-tracepoints-to-bitcoin-core">Adding tracepoints to Bitcoin Core</a></h2>
<p>Use the <code>TRACEPOINT</code> macro to add a new tracepoint. If not yet included, include
<code>util/trace.h</code> (defines the tracepoint macros) with <code>#include &lt;util/trace.h&gt;</code>.
Each tracepoint needs a <code>context</code> and an <code>event</code>. Please use <code>snake_case</code> and
try to make sure that the tracepoint names make sense even without detailed
knowledge of the implementation details. You can pass zero to twelve arguments
to the tracepoint. Each tracepoint also needs a global semaphore. The semaphore
gates the tracepoint arguments from being processed if we are not attached to
the tracepoint. Add a <code>TRACEPOINT_SEMAPHORE(context, event)</code> with the <code>context</code>
and <code>event</code> of your tracepoint in the top-level namespace at the beginning of
the file. Do not forget to update the tracepoint list in this document.</p>
<p>For example, the <code>net:outbound_message</code> tracepoint in <code>src/net.cpp</code> with six
arguments.</p>
<pre><code class="language-C++">// src/net.cpp
TRACEPOINT_SEMAPHORE(net, outbound_message);
â€¦
void CConnman::PushMessage(â€¦) {
  â€¦
  TRACEPOINT(net, outbound_message,
      pnode-&gt;GetId(),
      pnode-&gt;m_addr_name.c_str(),
      pnode-&gt;ConnectionTypeAsString().c_str(),
      sanitizedType.c_str(),
      msg.data.size(),
      msg.data.data()
  );
  â€¦
}
</code></pre>
<p>If needed, an extra <code>if (TRACEPOINT_ACTIVE(context, event)) {...}</code> check can be
used to prepare somewhat expensive arguments right before the tracepoint. While
the tracepoint arguments are only prepared when we attach something to the
tracepoint, an argument preparation should never hang the process. Hashing and
serialization of data structures is probably fine, a <code>sleep(10s)</code> not.</p>
<pre><code class="language-C++">// An example tracepoint with an expensive argument.

TRACEPOINT_SEMAPHORE(example, gated_expensive_argument);
â€¦
if (TRACEPOINT_ACTIVE(example, gated_expensive_argument)) {
    expensive_argument = expensive_calulation();
    TRACEPOINT(example, gated_expensive_argument, expensive_argument);
}
</code></pre>
<h3 id="guidelines-and-best-practices"><a class="header" href="#guidelines-and-best-practices">Guidelines and best practices</a></h3>
<h4 id="clear-motivation-and-use-case"><a class="header" href="#clear-motivation-and-use-case">Clear motivation and use case</a></h4>
<p>Tracepoints need a clear motivation and use case. The motivation should
outweigh the impact on, for example, code readability. There is no point in
adding tracepoints that don't end up being used.</p>
<h4 id="provide-an-example"><a class="header" href="#provide-an-example">Provide an example</a></h4>
<p>When adding a new tracepoint, provide an example. Examples can show the use case
and help reviewers testing that the tracepoint works as intended. The examples
can be kept simple but should give others a starting point when working with
the tracepoint. See existing examples in <a href="doc/../contrib/tracing/">contrib/tracing/</a>.</p>
<h4 id="semi-stable-api"><a class="header" href="#semi-stable-api">Semi-stable API</a></h4>
<p>Tracepoints should have a semi-stable API. Users should be able to rely on the
tracepoints for scripting. This means tracepoints need to be documented, and the
argument order ideally should not change. If there is an important reason to
change argument order, make sure to document the change and update the examples
using the tracepoint.</p>
<h4 id="ebpf-virtual-machine-limits"><a class="header" href="#ebpf-virtual-machine-limits">eBPF Virtual Machine limits</a></h4>
<p>Keep the eBPF Virtual Machine limits in mind. eBPF programs receiving data from
the tracepoints run in a sandboxed Linux kernel VM. This VM has a limited stack
size of 512 bytes. Check if it makes sense to pass larger amounts of data, for
example, with a tracing script that can handle the passed data.</p>
<h4 id="bpftrace-argument-limit"><a class="header" href="#bpftrace-argument-limit"><code>bpftrace</code> argument limit</a></h4>
<p>While tracepoints can have up to 12 arguments, bpftrace scripts currently only
support reading from the first six arguments (<code>arg0</code> till <code>arg5</code>) on <code>x86_64</code>.
bpftrace currently lacks real support for handling and printing binary data,
like block header hashes and txids. When a tracepoint passes more than six
arguments, then string and integer arguments should preferably be placed in the
first six argument fields. Binary data can be placed in later arguments. The BCC
supports reading from all 12 arguments.</p>
<h4 id="strings-as-c-style-string"><a class="header" href="#strings-as-c-style-string">Strings as C-style String</a></h4>
<p>Generally, strings should be passed into the <code>TRACEPOINT</code> macros as pointers to
C-style strings (a null-terminated sequence of characters). For C++
<code>std::strings</code>, <a href="https://www.cplusplus.com/reference/string/string/c_str/"><code>c_str()</code></a>  can be used. It's recommended to document the
maximum expected string size if known.</p>
<h2 id="listing-available-tracepoints"><a class="header" href="#listing-available-tracepoints">Listing available tracepoints</a></h2>
<p>Multiple tools can list the available tracepoints in a <code>bitcoind</code> binary with
USDT support.</p>
<h3 id="gdb---gnu-project-debugger"><a class="header" href="#gdb---gnu-project-debugger">GDB - GNU Project Debugger</a></h3>
<p>To list probes in Bitcoin Core, use <code>info probes</code> in <code>gdb</code>:</p>
<pre><code>$ gdb ./build/src/bitcoind
â€¦
(gdb) info probes
Type Provider   Name             Where              Semaphore Object
stap net        inbound_message  0x000000000014419e 0x0000000000d29bd2 /build/src/bitcoind
stap net        outbound_message 0x0000000000107c05 0x0000000000d29bd0 /build/src/bitcoind
stap validation block_connected  0x00000000002fb10c 0x0000000000d29bd8 /build/src/bitcoind
â€¦
</code></pre>
<h3 id="with-readelf"><a class="header" href="#with-readelf">With <code>readelf</code></a></h3>
<p>The <code>readelf</code> tool can be used to display the USDT tracepoints in Bitcoin Core.
Look for the notes with the description <code>NT_STAPSDT</code>.</p>
<pre><code>$ readelf -n ./build/src/bitcoind | grep NT_STAPSDT -A 4 -B 2
Displaying notes found in: .note.stapsdt
  Owner                 Data size	Description
  stapsdt              0x0000005d	NT_STAPSDT (SystemTap probe descriptors)
    Provider: net
    Name: outbound_message
    Location: 0x0000000000107c05, Base: 0x0000000000579c90, Semaphore: 0x0000000000d29bd0
    Arguments: -8@%r12 8@%rbx 8@%rdi 8@192(%rsp) 8@%rax 8@%rdx
â€¦
</code></pre>
<h3 id="with-tplist"><a class="header" href="#with-tplist">With <code>tplist</code></a></h3>
<p>The <code>tplist</code> tool is provided by BCC (see <a href="https://github.com/iovisor/bcc/blob/master/INSTALL.md">Installing BCC</a>). It displays kernel
tracepoints or USDT probes and their formats (for more information, see the
<a href="https://github.com/iovisor/bcc/blob/master/tools/tplist_example.txt"><code>tplist</code> usage demonstration</a>). There are slight binary naming differences
between distributions. For example, on
<a href="https://github.com/iovisor/bcc/blob/master/INSTALL.md#ubuntu---binary">Ubuntu the binary is called <code>tplist-bpfcc</code></a>.</p>
<pre><code>$ tplist -l ./build/src/bitcoind -v
b'net':b'outbound_message' [sema 0xd29bd0]
  1 location(s)
  6 argument(s)
â€¦
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="translations-1"><a class="header" href="#translations-1">Translations</a></h1>
<p>The Bitcoin-Core project has been designed to support multiple localisations. This makes adding new phrases, and completely new languages easily achievable. For managing all application translations, Bitcoin-Core makes use of the Transifex online translation management tool.</p>
<h3 id="helping-to-translate-using-transifex"><a class="header" href="#helping-to-translate-using-transifex">Helping to translate (using Transifex)</a></h3>
<p>Transifex is setup to monitor the GitHub repo for updates, and when code containing new translations is found, Transifex will process any changes. It may take several hours after a pull-request has been merged, to appear in the Transifex web interface.</p>
<p>Multiple language support is critical in assisting Bitcoinâ€™s global adoption, and growth. One of Bitcoinâ€™s greatest strengths is cross-border money transfers, any help making that easier is greatly appreciated.</p>
<p>See the <a href="https://www.transifex.com/bitcoin/bitcoin/">Transifex Bitcoin project</a> to assist in translations. You should also join the translation mailing list for announcements - see details below.</p>
<h3 id="writing-code-with-translations"><a class="header" href="#writing-code-with-translations">Writing code with translations</a></h3>
<p>We use automated scripts to help extract translations in both Qt, and non-Qt source files. It is rarely necessary to manually edit the files in <code>src/qt/locale/</code>. The translation source files must adhere to the following format:
<code>bitcoin_xx_YY.ts or bitcoin_xx.ts</code></p>
<p><code>src/qt/locale/bitcoin_en.ts</code> is treated in a special way. It is used as the source for all other translations. Whenever a string in the source code is changed, this file must be updated to reflect those changes. A custom script is used to extract strings from the non-Qt parts. This script makes use of <code>gettext</code>, so make sure that utility is installed (ie, <code>apt-get install gettext</code> on Ubuntu/Debian). Once this has been updated, <code>lupdate</code> (included in the Qt SDK) is used to update <code>bitcoin_en.ts</code>.</p>
<p>To automatically regenerate the <code>bitcoin_en.ts</code> file, run the following commands:</p>
<pre><code class="language-sh">cmake -B build --preset dev-mode -DWITH_BDB=ON -DBUILD_GUI=ON
cmake --build build --target translate
</code></pre>
<p><strong>Example Qt translation</strong></p>
<pre><code class="language-cpp">QToolBar *toolbar = addToolBar(tr("Tabs toolbar"));
</code></pre>
<h3 id="creating-a-pull-request"><a class="header" href="#creating-a-pull-request">Creating a pull-request</a></h3>
<p>For general PRs, you shouldnâ€™t include any updates to the translation source files. They will be updated periodically, primarily around pre-releases, allowing time for any new phrases to be translated before public releases. This is also important in avoiding translation related merge conflicts.</p>
<p>When an updated source file is merged into the GitHub repo, Transifex will automatically detect it (although it can take several hours). Once processed, the new strings will show up as "Remaining" in the Transifex web interface and are ready for translators.</p>
<p>To create the pull-request, use the following commands:</p>
<pre><code>git add src/qt/bitcoinstrings.cpp src/qt/locale/bitcoin_en.ts
git commit
</code></pre>
<h3 id="creating-a-transifex-account"><a class="header" href="#creating-a-transifex-account">Creating a Transifex account</a></h3>
<p>Visit the <a href="https://www.transifex.com/signup/">Transifex Signup</a> page to create an account. Take note of your username and password, as they will be required to configure the command-line tool.</p>
<p>You can find the Bitcoin translation project at <a href="https://www.transifex.com/bitcoin/bitcoin/">https://www.transifex.com/bitcoin/bitcoin/</a>.</p>
<h3 id="installing-the-transifex-client-command-line-tool"><a class="header" href="#installing-the-transifex-client-command-line-tool">Installing the Transifex client command-line tool</a></h3>
<p>The client is used to fetch updated translations. Please check installation instructions and any other details at https://developers.transifex.com/docs/cli.</p>
<p>The Transifex Bitcoin project config file is included as part of the repo. It can be found at <code>.tx/config</code>, however you shouldnâ€™t need to change anything.</p>
<h3 id="synchronising-translations"><a class="header" href="#synchronising-translations">Synchronising translations</a></h3>
<p>To assist in updating translations, a helper script is available in the <a href="https://github.com/bitcoin-core/bitcoin-maintainer-tools">maintainer-tools repo</a>. To use it and commit the result, simply do:</p>
<pre><code>python3 ../bitcoin-maintainer-tools/update-translations.py
git commit -a
</code></pre>
<p><strong>Do not directly download translations</strong> one by one from the Transifex website, as we do a few post-processing steps before committing the translations.</p>
<h3 id="handling-plurals-in-source-files"><a class="header" href="#handling-plurals-in-source-files">Handling Plurals (in source files)</a></h3>
<p>When new plurals are added to the source file, it's important to do the following steps:</p>
<ol>
<li>Open <code>bitcoin_en.ts</code> in Qt Linguist (included in the Qt SDK)</li>
<li>Search for <code>%n</code>, which will take you to the parts in the translation that use plurals</li>
<li>Look for empty <code>English Translation (Singular)</code> and <code>English Translation (Plural)</code> fields</li>
<li>Add the appropriate strings for the singular and plural form of the base string</li>
<li>Mark the item as done (via the green arrow symbol in the toolbar)</li>
<li>Repeat from step 2, until all singular and plural forms are in the source file</li>
<li>Save the source file</li>
</ol>
<h3 id="translating-a-new-language"><a class="header" href="#translating-a-new-language">Translating a new language</a></h3>
<p>To create a new language template, you will need to edit the languages manifest file <code>src/qt/bitcoin_locale.qrc</code> and add a new entry. Below is an example of the English language entry.</p>
<pre><code class="language-xml">&lt;qresource prefix="/translations"&gt;
    &lt;file alias="en"&gt;locale/bitcoin_en.qm&lt;/file&gt;
    ...
&lt;/qresource&gt;
</code></pre>
<p><strong>Note:</strong> that the language translation file <strong>must end in <code>.qm</code></strong> (the compiled extension), and not <code>.ts</code>.</p>
<h3 id="questions-and-general-assistance"><a class="header" href="#questions-and-general-assistance">Questions and general assistance</a></h3>
<p>If you are a translator, you should also subscribe to the mailing list, https://groups.google.com/forum/#!forum/bitcoin-translators. Announcements will be posted during application pre-releases to notify translators to check for updates.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="translation-strings-policy"><a class="header" href="#translation-strings-policy">Translation Strings Policy</a></h1>
<p>This document provides guidelines for internationalization of the Bitcoin Core software.</p>
<h2 id="how-to-translate"><a class="header" href="#how-to-translate">How to translate?</a></h2>
<p>To mark a message as translatable</p>
<ul>
<li>
<p>In GUI source code (under <code>src/qt</code>): use <code>tr("...")</code></p>
</li>
<li>
<p>In non-GUI source code (under <code>src</code>): use <code>_("...")</code></p>
</li>
</ul>
<p>No internationalization is used for e.g. developer scripts outside <code>src</code>.</p>
<h2 id="strings-to-be-translated"><a class="header" href="#strings-to-be-translated">Strings to be translated</a></h2>
<p>On a high level, these strings are to be translated:</p>
<ul>
<li>GUI strings, anything that appears in a dialog or window</li>
</ul>
<h3 id="gui-strings"><a class="header" href="#gui-strings">GUI strings</a></h3>
<p>Do not translate technical or extremely rare errors.
Anything else that appears to the user in the GUI is to be translated. This includes labels, menu items, button texts, tooltips and window titles.
This includes messages passed to the GUI through the UI interface through <code>InitMessage</code>, <code>ThreadSafeMessageBox</code> or <code>ShowProgress</code>.</p>
<h2 id="general-recommendations"><a class="header" href="#general-recommendations">General recommendations</a></h2>
<h3 id="avoid-unnecessary-translation-strings"><a class="header" href="#avoid-unnecessary-translation-strings">Avoid unnecessary translation strings</a></h3>
<p>Try not to burden translators with translating messages that are e.g. slight variations of other messages.
In the GUI, avoid the use of text where an icon or symbol will do.
Make sure that placeholder texts in forms do not end up in the list of strings to be translated (use <code>&lt;string notr="true"&gt;</code>).</p>
<h3 id="make-translated-strings-understandable"><a class="header" href="#make-translated-strings-understandable">Make translated strings understandable</a></h3>
<p>Try to write translation strings in an understandable way, for both the user and the translator. Avoid overly technical or detailed messages.</p>
<h3 id="do-not-translate-internal-errors"><a class="header" href="#do-not-translate-internal-errors">Do not translate internal errors</a></h3>
<p>Do not translate internal errors, log messages, or messages that appear on the RPC interface. If an error is to be shown to the user,
use a translatable generic message, then log the detailed message to the log. E.g., "A fatal internal error occurred, see debug.log for details".
This helps troubleshooting; if the error is the same for everyone, the likelihood is increased that it can be found using a search engine.</p>
<h3 id="avoid-fragments"><a class="header" href="#avoid-fragments">Avoid fragments</a></h3>
<p>Avoid dividing up a message into fragments. Translators see every string separately, so they may misunderstand the context if the messages are not self-contained.</p>
<h3 id="avoid-html-in-translation-strings"><a class="header" href="#avoid-html-in-translation-strings">Avoid HTML in translation strings</a></h3>
<p>There have been difficulties with the use of HTML in translation strings; translators should not be able to accidentally affect the formatting of messages.
This may sometimes be at conflict with the recommendation in the previous section.</p>
<h3 id="plurals"><a class="header" href="#plurals">Plurals</a></h3>
<p>Plurals can be complex in some languages. A quote from the gettext documentation:</p>
<pre><code>In Polish we use e.g. plik (file) this way:
1 plik,
2,3,4 pliki,
5-21 pliko'w,
22-24 pliki,
25-31 pliko'w
and so on
</code></pre>
<p>In Qt code, use tr's third argument for optional plurality. For example:</p>
<pre><code>tr("%n hour(s)","",secs/HOUR_IN_SECONDS);
tr("%n day(s)","",secs/DAY_IN_SECONDS);
tr("%n week(s)","",secs/WEEK_IN_SECONDS);
</code></pre>
<p>This adds <code>&lt;numerusform&gt;</code>s to the respective <code>.ts</code> file, which can be translated separately depending on the language. In English, this is simply:</p>
<pre><code>&lt;message numerus="yes"&gt;
    &lt;source&gt;%n active connection(s) to Bitcoin network&lt;/source&gt;
    &lt;translation&gt;
        &lt;numerusform&gt;%n active connection to Bitcoin network&lt;/numerusform&gt;
        &lt;numerusform&gt;%n active connections to Bitcoin network&lt;/numerusform&gt;
    &lt;/translation&gt;
&lt;/message&gt;
</code></pre>
<p>Where possible, try to avoid embedding numbers into the flow of the string at all. E.g.,</p>
<pre><code>WARNING: check your network connection, %d blocks received in the last %d hours (%d expected)
</code></pre>
<p>versus</p>
<pre><code>WARNING: check your network connection, less blocks (%d) were received in the last %n hours than expected (%d).
</code></pre>
<p>The second example reduces the number of pluralized words that translators have to handle from three to one, at no cost to comprehensibility of the sentence.</p>
<h3 id="string-freezes"><a class="header" href="#string-freezes">String freezes</a></h3>
<p>During a string freeze (often before a major release), no translation strings are to be added, modified or removed.</p>
<p>This can be checked by building the <code>translate</code> target with <code>cmake</code> (<a href="doc/translation_process.html">instructions</a>), then verifying that <code>bitcoin_en.ts</code> remains unchanged.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="block-and-transaction-broadcasting-with-zeromq"><a class="header" href="#block-and-transaction-broadcasting-with-zeromq">Block and Transaction Broadcasting with ZeroMQ</a></h1>
<p><a href="https://zeromq.org/">ZeroMQ</a> is a lightweight wrapper around TCP
connections, inter-process communication, and shared-memory,
providing various message-oriented semantics such as publish/subscribe,
request/reply, and push/pull.</p>
<p>The Bitcoin Core daemon can be configured to act as a trusted "border
router", implementing the bitcoin wire protocol and relay, making
consensus decisions, maintaining the local blockchain database,
broadcasting locally generated transactions into the network, and
providing a queryable RPC interface to interact on a polled basis for
requesting blockchain related data. However, there exists only a
limited service to notify external software of events like the arrival
of new blocks or transactions.</p>
<p>The ZeroMQ facility implements a notification interface through a set
of specific notifiers. Currently there are notifiers that publish
blocks and transactions. This read-only facility requires only the
connection of a corresponding ZeroMQ subscriber port in receiving
software; it is not authenticated nor is there any two-way protocol
involvement. Therefore, subscribers should validate the received data
since it may be out of date, incomplete or even invalid.</p>
<p>ZeroMQ sockets are self-connecting and self-healing; that is,
connections made between two endpoints will be automatically restored
after an outage, and either end may be freely started or stopped in
any order.</p>
<p>Because ZeroMQ is message oriented, subscribers receive transactions
and blocks all-at-once and do not need to implement any sort of
buffering or reassembly.</p>
<h2 id="prerequisites"><a class="header" href="#prerequisites">Prerequisites</a></h2>
<p>The ZeroMQ feature in Bitcoin Core requires the ZeroMQ API &gt;= 4.0.0
<a href="https://github.com/zeromq/libzmq/releases">libzmq</a>.
For version information, see <a href="doc/dependencies.html">dependencies.md</a>.
Typically, it is packaged by distributions as something like
<em>libzmq3-dev</em>. The C++ wrapper for ZeroMQ is <em>not</em> needed.</p>
<p>In order to run the example Python client scripts in the <code>contrib/zmq/</code>
directory, one must also install <a href="https://github.com/zeromq/pyzmq">PyZMQ</a>
(generally with <code>pip install pyzmq</code>), though this is not necessary for daemon
operation.</p>
<h2 id="enabling"><a class="header" href="#enabling">Enabling</a></h2>
<p>By default, the ZeroMQ feature is not automatically compiled.
To enable, use <code>-DWITH_ZMQ=ON</code> when configuring the build system:</p>
<pre><code>$ cmake -B build -DWITH_ZMQ=ON
</code></pre>
<p>To actually enable operation, one must set the appropriate options on
the command line or in the configuration file.</p>
<h2 id="usage-5"><a class="header" href="#usage-5">Usage</a></h2>
<p>Currently, the following notifications are supported:</p>
<pre><code>-zmqpubhashtx=address
-zmqpubhashblock=address
-zmqpubrawblock=address
-zmqpubrawtx=address
-zmqpubsequence=address
</code></pre>
<p>The socket type is PUB and the address must be a valid ZeroMQ socket
address. The same address can be used in more than one notification.
The same notification can be specified more than once.</p>
<p>The option to set the PUB socket's outbound message high water mark
(SNDHWM) may be set individually for each notification:</p>
<pre><code>-zmqpubhashtxhwm=n
-zmqpubhashblockhwm=n
-zmqpubrawblockhwm=n
-zmqpubrawtxhwm=n
-zmqpubsequencehwm=n
</code></pre>
<p>The high water mark value must be an integer greater than or equal to 0.</p>
<p>For instance:</p>
<pre><code>$ bitcoind -zmqpubhashtx=tcp://127.0.0.1:28332 \
           -zmqpubhashtx=tcp://192.168.1.2:28332 \
           -zmqpubhashblock="tcp://[::1]:28333" \
           -zmqpubrawtx=ipc:///tmp/bitcoind.tx.raw \
           -zmqpubhashtxhwm=10000
</code></pre>
<p>Each PUB notification has a topic and body, where the header
corresponds to the notification type. For instance, for the
notification <code>-zmqpubhashtx</code> the topic is <code>hashtx</code> (no null
terminator). These options can also be provided in bitcoin.conf.</p>
<p>The topics are:</p>
<p><code>sequence</code>: the body is structured as the following based on the type of message:</p>
<pre><code>&lt;32-byte hash&gt;C :                 Blockhash connected
&lt;32-byte hash&gt;D :                 Blockhash disconnected
&lt;32-byte hash&gt;R&lt;8-byte LE uint&gt; : Transactionhash removed from mempool for non-block inclusion reason
&lt;32-byte hash&gt;A&lt;8-byte LE uint&gt; : Transactionhash added mempool
</code></pre>
<p>Where the 8-byte uints correspond to the mempool sequence number.</p>
<p><code>rawtx</code>: Notifies about all transactions, both when they are added to mempool or when a new block arrives. This means a transaction could be published multiple times. First, when it enters the mempool and then again in each block that includes it. The messages are ZMQ multipart messages with three parts. The first part is the topic (<code>rawtx</code>), the second part is the serialized transaction, and the last part is a sequence number (representing the message count to detect lost messages).</p>
<pre><code>| rawtx | &lt;serialized transaction&gt; | &lt;uint32 sequence number in Little Endian&gt;
</code></pre>
<p><code>hashtx</code>: Notifies about all transactions, both when they are added to mempool or when a new block arrives. This means a transaction could be published multiple times. First, when it enters the mempool and then again in each block that includes it. The messages are ZMQ multipart messages with three parts. The first part is the topic (<code>hashtx</code>), the second part is the 32-byte transaction hash, and the last part is a sequence number (representing the message count to detect lost messages).</p>
<pre><code>| hashtx | &lt;32-byte transaction hash in Little Endian&gt; | &lt;uint32 sequence number in Little Endian&gt;
</code></pre>
<p><code>rawblock</code>: Notifies when the chain tip is updated. When assumeutxo is in use, this notification will not be issued for historical blocks connected to the background validation chainstate. Messages are ZMQ multipart messages with three parts. The first part is the topic (<code>rawblock</code>), the second part is the serialized block, and the last part is a sequence number (representing the message count to detect lost messages).</p>
<pre><code>| rawblock | &lt;serialized block&gt; | &lt;uint32 sequence number in Little Endian&gt;
</code></pre>
<p><code>hashblock</code>: Notifies when the chain tip is updated. When assumeutxo is in use, this notification will not be issued for historical blocks connected to the background validation chainstate. Messages are ZMQ multipart messages with three parts. The first part is the topic (<code>hashblock</code>), the second part is the 32-byte block hash, and the last part is a sequence number (representing the message count to detect lost messages).</p>
<pre><code>| hashblock | &lt;32-byte block hash in Little Endian&gt; | &lt;uint32 sequence number in Little Endian&gt;
</code></pre>
<p><strong><em>NOTE:</em></strong>  Note that the 32-byte hashes are in Little Endian and not in the Big Endian format that the RPC interface and block explorers use to display transaction and block hashes.</p>
<p>ZeroMQ endpoint specifiers for TCP (and others) are documented in the
<a href="http://api.zeromq.org/4-0:_start">ZeroMQ API</a>.</p>
<p>Client side, then, the ZeroMQ subscriber socket must have the
ZMQ_SUBSCRIBE option set to one or either of these prefixes (for
instance, just <code>hash</code>); without doing so will result in no messages
arriving. Please see <a href="doc//contrib/zmq/zmq_sub.py"><code>contrib/zmq/zmq_sub.py</code></a> for a working example.</p>
<p>The ZMQ_PUB socket's ZMQ_TCP_KEEPALIVE option is enabled. This means that
the underlying SO_KEEPALIVE option is enabled when using a TCP transport.
The effective TCP keepalive values are managed through the underlying
operating system configuration and must be configured prior to connection establishment.</p>
<p>For example, when running on GNU/Linux, one might use the following
to lower the keepalive setting to 10 minutes:</p>
<p>sudo sysctl -w net.ipv4.tcp_keepalive_time=600</p>
<p>Setting the keepalive values appropriately for your operating environment may
improve connectivity in situations where long-lived connections are silently
dropped by network middle boxes.</p>
<p>Also, the socket's ZMQ_IPV6 option is enabled to accept connections from IPv6
hosts as well. If needed, this option has to be set on the client side too.</p>
<h2 id="remarks"><a class="header" href="#remarks">Remarks</a></h2>
<p>From the perspective of bitcoind, the ZeroMQ socket is write-only; PUB
sockets don't even have a read function. Thus, there is no state
introduced into bitcoind directly. Furthermore, no information is
broadcast that wasn't already received from the public P2P network.</p>
<p>No authentication or authorization is done on connecting clients; it
is assumed that the ZeroMQ port is exposed only to trusted entities,
using other means such as firewalling.</p>
<p>Note that for <code>*block</code> topics, when the block chain tip changes,
a reorganisation may occur and just the tip will be notified.
It is up to the subscriber to retrieve the chain from the last known
block to the new tip. Also note that no notification will occur if the tip
was in the active chain, as would be the case after calling the <code>invalidateblock</code> RPC.
In contrast, the <code>sequence</code> topic publishes all block connections and
disconnections.</p>
<p>There are several possibilities that ZMQ notification can get lost
during transmission depending on the communication type you are
using. Bitcoind appends an up-counting sequence number to each
notification which allows listeners to detect lost notifications.</p>
<p>The <code>sequence</code> topic refers specifically to the mempool sequence
number, which is also published along with all mempool events. This
is a different sequence value than in ZMQ itself in order to allow a total
ordering of mempool events to be constructed.</p>
<div style="break-before: page; page-break-before: always;"></div><p>This Page Intentionally Left Blank</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="assumeutxo-design"><a class="header" href="#assumeutxo-design">Assumeutxo Design</a></h1>
<p>For notes on the usage of Assumeutxo, please refer to <a href="doc/design//doc/assumeutxo.html">the usage doc</a>.</p>
<h2 id="general-background"><a class="header" href="#general-background">General background</a></h2>
<ul>
<li><a href="https://github.com/jamesob/assumeutxo-docs/tree/2019-04-proposal/proposal">assumeutxo proposal</a></li>
<li><a href="https://github.com/bitcoin/bitcoin/issues/15605">Github issue</a></li>
<li><a href="https://github.com/bitcoin/bitcoin/pull/15606">draft PR</a></li>
</ul>
<h2 id="design-notes"><a class="header" href="#design-notes">Design notes</a></h2>
<ul>
<li>
<p>The concept of UTXO snapshots is treated as an implementation detail that lives
behind the ChainstateManager interface. The external presentation of the changes
required to facilitate the use of UTXO snapshots is the understanding that there are
now certain regions of the chain that can be temporarily assumed to be valid.
In certain cases, e.g. wallet rescanning, this is very similar to dealing with
a pruned chain.</p>
<p>Logic outside ChainstateManager should try not to know about snapshots, instead
preferring to work in terms of more general states like assumed-valid.</p>
</li>
</ul>
<h2 id="chainstate-phases"><a class="header" href="#chainstate-phases">Chainstate phases</a></h2>
<p>Chainstate within the system goes through a number of phases when UTXO snapshots are
used, as managed by <code>ChainstateManager</code>. At various points there can be multiple
<code>Chainstate</code> objects in existence to facilitate both maintaining the network tip and
performing historical validation of the assumed-valid chain.</p>
<p>It is worth noting that though there are multiple separate chainstates, those
chainstates share use of a common block index (i.e. they hold the same <code>BlockManager</code>
reference).</p>
<p>The subheadings below outline the phases and the corresponding changes to chainstate
data.</p>
<h3 id="normal-operation-via-initial-block-download"><a class="header" href="#normal-operation-via-initial-block-download">"Normal" operation via initial block download</a></h3>
<p><code>ChainstateManager</code> manages a single Chainstate object, for which
<code>m_from_snapshot_blockhash</code> is <code>std::nullopt</code>. This chainstate is (maybe obviously)
considered active. This is the "traditional" mode of operation for bitcoind.</p>
<div class="table-wrapper"><table><thead><tr><th></th><th></th></tr></thead><tbody>
<tr><td>number of chainstates</td><td>1</td></tr>
<tr><td>active chainstate</td><td>ibd</td></tr>
</tbody></table>
</div>
<h3 id="user-loads-a-utxo-snapshot-via-loadtxoutset-rpc"><a class="header" href="#user-loads-a-utxo-snapshot-via-loadtxoutset-rpc">User loads a UTXO snapshot via <code>loadtxoutset</code> RPC</a></h3>
<p><code>ChainstateManager</code> initializes a new chainstate (see <code>ActivateSnapshot()</code>) to load the
snapshot contents into. During snapshot load and validation (see
<code>PopulateAndValidateSnapshot()</code>), the new chainstate is not considered active and the
original chainstate remains in use as active.</p>
<div class="table-wrapper"><table><thead><tr><th></th><th></th></tr></thead><tbody>
<tr><td>number of chainstates</td><td>2</td></tr>
<tr><td>active chainstate</td><td>ibd</td></tr>
</tbody></table>
</div>
<p>Once the snapshot chainstate is loaded and validated, it is promoted to active
chainstate and a sync to tip begins. A new chainstate directory is created in the
datadir for the snapshot chainstate called <code>chainstate_snapshot</code>.</p>
<p>When this directory is present in the datadir, the snapshot chainstate will be detected
and loaded as active on node startup (via <code>DetectSnapshotChainstate()</code>).</p>
<p>A special file is created within that directory, <code>base_blockhash</code>, which contains the
serialized <code>uint256</code> of the base block of the snapshot. This is used to reinitialize
the snapshot chainstate on subsequent inits. Otherwise, the directory is a normal
leveldb database.</p>
<div class="table-wrapper"><table><thead><tr><th></th><th></th></tr></thead><tbody>
<tr><td>number of chainstates</td><td>2</td></tr>
<tr><td>active chainstate</td><td>snapshot</td></tr>
</tbody></table>
</div>
<p>The snapshot begins to sync to tip from its base block, technically in parallel with
the original chainstate, but it is given priority during block download and is
allocated most of the cache (see <code>MaybeRebalanceCaches()</code> and usages) as our chief
goal is getting to network tip.</p>
<p><strong>Failure consideration:</strong> if shutdown happens at any point during this phase, both
chainstates will be detected during the next init and the process will resume.</p>
<h3 id="snapshot-chainstate-hits-network-tip"><a class="header" href="#snapshot-chainstate-hits-network-tip">Snapshot chainstate hits network tip</a></h3>
<p>Once the snapshot chainstate leaves IBD, caches are rebalanced
(via <code>MaybeRebalanceCaches()</code> in <code>ActivateBestChain()</code>) and more cache is given
to the background chainstate, which is responsible for doing full validation of the
assumed-valid parts of the chain.</p>
<p><strong>Note:</strong> at this point, ValidationInterface callbacks will be coming in from both
chainstates. Considerations here must be made for indexing, which may no longer be happening
sequentially.</p>
<h3 id="background-chainstate-hits-snapshot-base-block"><a class="header" href="#background-chainstate-hits-snapshot-base-block">Background chainstate hits snapshot base block</a></h3>
<p>Once the tip of the background chainstate hits the base block of the snapshot
chainstate, we stop use of the background chainstate by setting <code>m_disabled</code>, in
<code>MaybeCompleteSnapshotValidation()</code>, which is checked in <code>ActivateBestChain()</code>). We hash the
background chainstate's UTXO set contents and ensure it matches the compiled value in
<code>CMainParams::m_assumeutxo_data</code>.</p>
<div class="table-wrapper"><table><thead><tr><th></th><th></th></tr></thead><tbody>
<tr><td>number of chainstates</td><td>2 (ibd has <code>m_disabled=true</code>)</td></tr>
<tr><td>active chainstate</td><td>snapshot</td></tr>
</tbody></table>
</div>
<p>The background chainstate data lingers on disk until the program is restarted.</p>
<h3 id="bitcoind-restarts-sometime-after-snapshot-validation-has-completed"><a class="header" href="#bitcoind-restarts-sometime-after-snapshot-validation-has-completed">Bitcoind restarts sometime after snapshot validation has completed</a></h3>
<p>After a shutdown and subsequent restart, <code>LoadChainstate()</code> cleans up the background
chainstate with <code>ValidatedSnapshotCleanup()</code>, which renames the <code>chainstate_snapshot</code>
datadir as <code>chainstate</code> and removes the now unnecessary background chainstate data.</p>
<div class="table-wrapper"><table><thead><tr><th></th><th></th></tr></thead><tbody>
<tr><td>number of chainstates</td><td>1</td></tr>
<tr><td>active chainstate</td><td>ibd (was snapshot, but is now fully validated)</td></tr>
</tbody></table>
</div>
<p>What began as the snapshot chainstate is now indistinguishable from a chainstate that
has been built from the traditional IBD process, and will be initialized as such.</p>
<p>A file will be left in <code>chainstate/base_blockhash</code>, which indicates that the
chainstate, even though now fully validated, was originally started from a snapshot
with the corresponding base blockhash.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="libraries"><a class="header" href="#libraries">Libraries</a></h1>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Description</th></tr></thead><tbody>
<tr><td><em>libbitcoin_cli</em></td><td>RPC client functionality used by <em>bitcoin-cli</em> executable</td></tr>
<tr><td><em>libbitcoin_common</em></td><td>Home for common functionality shared by different executables and libraries. Similar to <em>libbitcoin_util</em>, but higher-level (see <a href="doc/design/libraries.html#dependencies">Dependencies</a>).</td></tr>
<tr><td><em>libbitcoin_consensus</em></td><td>Consensus functionality used by <em>libbitcoin_node</em> and <em>libbitcoin_wallet</em>.</td></tr>
<tr><td><em>libbitcoin_crypto</em></td><td>Hardware-optimized functions for data encryption, hashing, message authentication, and key derivation.</td></tr>
<tr><td><em>libbitcoin_kernel</em></td><td>Consensus engine and support library used for validation by <em>libbitcoin_node</em>.</td></tr>
<tr><td><em>libbitcoinqt</em></td><td>GUI functionality used by <em>bitcoin-qt</em> and <em>bitcoin-gui</em> executables.</td></tr>
<tr><td><em>libbitcoin_ipc</em></td><td>IPC functionality used by <em>bitcoin-node</em>, <em>bitcoin-wallet</em>, <em>bitcoin-gui</em> executables to communicate when <a href="doc/design/multiprocess.html"><code>-DWITH_MULTIPROCESS=ON</code></a> is used.</td></tr>
<tr><td><em>libbitcoin_node</em></td><td>P2P and RPC server functionality used by <em>bitcoind</em> and <em>bitcoin-qt</em> executables.</td></tr>
<tr><td><em>libbitcoin_util</em></td><td>Home for common functionality shared by different executables and libraries. Similar to <em>libbitcoin_common</em>, but lower-level (see <a href="doc/design/libraries.html#dependencies">Dependencies</a>).</td></tr>
<tr><td><em>libbitcoin_wallet</em></td><td>Wallet functionality used by <em>bitcoind</em> and <em>bitcoin-wallet</em> executables.</td></tr>
<tr><td><em>libbitcoin_wallet_tool</em></td><td>Lower-level wallet functionality used by <em>bitcoin-wallet</em> executable.</td></tr>
<tr><td><em>libbitcoin_zmq</em></td><td><a href="doc/design/../zmq.html">ZeroMQ</a> functionality used by <em>bitcoind</em> and <em>bitcoin-qt</em> executables.</td></tr>
</tbody></table>
</div>
<h2 id="conventions"><a class="header" href="#conventions">Conventions</a></h2>
<ul>
<li>
<p>Most libraries are internal libraries and have APIs which are completely unstable! There are few or no restrictions on backwards compatibility or rules about external dependencies. An exception is <em>libbitcoin_kernel</em>, which, at some future point, will have a documented external interface.</p>
</li>
<li>
<p>Generally each library should have a corresponding source directory and namespace. Source code organization is a work in progress, so it is true that some namespaces are applied inconsistently, and if you look at <a href="doc/design/../../src/CMakeLists.txt"><code>add_library(bitcoin_* ...)</code></a> lists you can see that many libraries pull in files from outside their source directory. But when working with libraries, it is good to follow a consistent pattern like:</p>
<ul>
<li><em>libbitcoin_node</em> code lives in <code>src/node/</code> in the <code>node::</code> namespace</li>
<li><em>libbitcoin_wallet</em> code lives in <code>src/wallet/</code> in the <code>wallet::</code> namespace</li>
<li><em>libbitcoin_ipc</em> code lives in <code>src/ipc/</code> in the <code>ipc::</code> namespace</li>
<li><em>libbitcoin_util</em> code lives in <code>src/util/</code> in the <code>util::</code> namespace</li>
<li><em>libbitcoin_consensus</em> code lives in <code>src/consensus/</code> in the <code>Consensus::</code> namespace</li>
</ul>
</li>
</ul>
<h2 id="dependencies-2"><a class="header" href="#dependencies-2">Dependencies</a></h2>
<ul>
<li>Libraries should minimize what other libraries they depend on, and only reference symbols following the arrows shown in the dependency graph below:</li>
</ul>
<table><tr><td>
<pre><code class="language-mermaid">
%%{ init : { "flowchart" : { "curve" : "basis" }}}%%

graph TD;

bitcoin-cli[bitcoin-cli]--&gt;libbitcoin_cli;

bitcoind[bitcoind]--&gt;libbitcoin_node;
bitcoind[bitcoind]--&gt;libbitcoin_wallet;

bitcoin-qt[bitcoin-qt]--&gt;libbitcoin_node;
bitcoin-qt[bitcoin-qt]--&gt;libbitcoinqt;
bitcoin-qt[bitcoin-qt]--&gt;libbitcoin_wallet;

bitcoin-wallet[bitcoin-wallet]--&gt;libbitcoin_wallet;
bitcoin-wallet[bitcoin-wallet]--&gt;libbitcoin_wallet_tool;

libbitcoin_cli--&gt;libbitcoin_util;
libbitcoin_cli--&gt;libbitcoin_common;

libbitcoin_consensus--&gt;libbitcoin_crypto;

libbitcoin_common--&gt;libbitcoin_consensus;
libbitcoin_common--&gt;libbitcoin_crypto;
libbitcoin_common--&gt;libbitcoin_util;

libbitcoin_kernel--&gt;libbitcoin_consensus;
libbitcoin_kernel--&gt;libbitcoin_crypto;
libbitcoin_kernel--&gt;libbitcoin_util;

libbitcoin_node--&gt;libbitcoin_consensus;
libbitcoin_node--&gt;libbitcoin_crypto;
libbitcoin_node--&gt;libbitcoin_kernel;
libbitcoin_node--&gt;libbitcoin_common;
libbitcoin_node--&gt;libbitcoin_util;

libbitcoinqt--&gt;libbitcoin_common;
libbitcoinqt--&gt;libbitcoin_util;

libbitcoin_util--&gt;libbitcoin_crypto;

libbitcoin_wallet--&gt;libbitcoin_common;
libbitcoin_wallet--&gt;libbitcoin_crypto;
libbitcoin_wallet--&gt;libbitcoin_util;

libbitcoin_wallet_tool--&gt;libbitcoin_wallet;
libbitcoin_wallet_tool--&gt;libbitcoin_util;

classDef bold stroke-width:2px, font-weight:bold, font-size: smaller;
class bitcoin-qt,bitcoind,bitcoin-cli,bitcoin-wallet bold
</code></pre>
</td></tr><tr><td>
<p><strong>Dependency graph</strong>. Arrows show linker symbol dependencies. <em>Crypto</em> lib depends on nothing. <em>Util</em> lib is depended on by everything. <em>Kernel</em> lib depends only on consensus, crypto, and util.</p>
</td></tr></table>
<ul>
<li>
<p>The graph shows what <em>linker symbols</em> (functions and variables) from each library other libraries can call and reference directly, but it is not a call graph. For example, there is no arrow connecting <em>libbitcoin_wallet</em> and <em>libbitcoin_node</em> libraries, because these libraries are intended to be modular and not depend on each other's internal implementation details. But wallet code is still able to call node code indirectly through the <code>interfaces::Chain</code> abstract class in <a href="doc/design/../../src/interfaces/chain.h"><code>interfaces/chain.h</code></a> and node code calls wallet code through the <code>interfaces::ChainClient</code> and <code>interfaces::Chain::Notifications</code> abstract classes in the same file. In general, defining abstract classes in <a href="doc/design/../../src/interfaces/"><code>src/interfaces/</code></a> can be a convenient way of avoiding unwanted direct dependencies or circular dependencies between libraries.</p>
</li>
<li>
<p><em>libbitcoin_crypto</em> should be a standalone dependency that any library can depend on, and it should not depend on any other libraries itself.</p>
</li>
<li>
<p><em>libbitcoin_consensus</em> should only depend on <em>libbitcoin_crypto</em>, and all other libraries besides <em>libbitcoin_crypto</em> should be allowed to depend on it.</p>
</li>
<li>
<p><em>libbitcoin_util</em> should be a standalone dependency that any library can depend on, and it should not depend on other libraries except <em>libbitcoin_crypto</em>. It provides basic utilities that fill in gaps in the C++ standard library and provide lightweight abstractions over platform-specific features. Since the util library is distributed with the kernel and is usable by kernel applications, it shouldn't contain functions that external code shouldn't call, like higher level code targeted at the node or wallet. (<em>libbitcoin_common</em> is a better place for higher level code, or code that is meant to be used by internal applications only.)</p>
</li>
<li>
<p><em>libbitcoin_common</em> is a home for miscellaneous shared code used by different Bitcoin Core applications. It should not depend on anything other than <em>libbitcoin_util</em>, <em>libbitcoin_consensus</em>, and <em>libbitcoin_crypto</em>.</p>
</li>
<li>
<p><em>libbitcoin_kernel</em> should only depend on <em>libbitcoin_util</em>, <em>libbitcoin_consensus</em>, and <em>libbitcoin_crypto</em>.</p>
</li>
<li>
<p>The only thing that should depend on <em>libbitcoin_kernel</em> internally should be <em>libbitcoin_node</em>. GUI and wallet libraries <em>libbitcoinqt</em> and <em>libbitcoin_wallet</em> in particular should not depend on <em>libbitcoin_kernel</em> and the unneeded functionality it would pull in, like block validation. To the extent that GUI and wallet code need scripting and signing functionality, they should be get able it from <em>libbitcoin_consensus</em>, <em>libbitcoin_common</em>, <em>libbitcoin_crypto</em>, and <em>libbitcoin_util</em>, instead of <em>libbitcoin_kernel</em>.</p>
</li>
<li>
<p>GUI, node, and wallet code internal implementations should all be independent of each other, and the <em>libbitcoinqt</em>, <em>libbitcoin_node</em>, <em>libbitcoin_wallet</em> libraries should never reference each other's symbols. They should only call each other through <a href="doc/design/../../src/interfaces/"><code>src/interfaces/</code></a> abstract interfaces.</p>
</li>
</ul>
<h2 id="work-in-progress"><a class="header" href="#work-in-progress">Work in progress</a></h2>
<ul>
<li>Validation code is moving from <em>libbitcoin_node</em> to <em>libbitcoin_kernel</em> as part of <a href="https://github.com/bitcoin/bitcoin/issues/27587">The libbitcoinkernel Project #27587</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="multiprocess-bitcoin-design-document"><a class="header" href="#multiprocess-bitcoin-design-document">Multiprocess Bitcoin Design Document</a></h1>
<p>Guide to the design and architecture of the Bitcoin Core multiprocess feature</p>
<p><em>This document describes the design of the multiprocess feature. For usage information, see the top-level <a href="doc/design/../multiprocess.html">multiprocess.md</a> file.</em></p>
<h2 id="table-of-contents-1"><a class="header" href="#table-of-contents-1">Table of contents</a></h2>
<ul>
<li><a href="doc/design/multiprocess.html#introduction">Introduction</a></li>
<li><a href="doc/design/multiprocess.html#current-architecture">Current Architecture</a></li>
<li><a href="doc/design/multiprocess.html#proposed-architecture">Proposed Architecture</a></li>
<li><a href="doc/design/multiprocess.html#component-overview-navigating-the-ipc-framework">Component Overview: Navigating the IPC Framework</a></li>
<li><a href="doc/design/multiprocess.html#design-considerations">Design Considerations</a>
<ul>
<li><a href="doc/design/multiprocess.html#selection-of-capn-proto">Selection of Capâ€™n Proto</a></li>
<li><a href="doc/design/multiprocess.html#hiding-ipc">Hiding IPC</a></li>
<li><a href="doc/design/multiprocess.html#interface-definition-maintenance">Interface Definition Maintenance</a></li>
<li><a href="doc/design/multiprocess.html#interface-stability">Interface Stability</a></li>
</ul>
</li>
<li><a href="doc/design/multiprocess.html#security-considerations">Security Considerations</a></li>
<li><a href="doc/design/multiprocess.html#example-use-cases-and-flows">Example Use Cases and Flows</a>
<ul>
<li><a href="doc/design/multiprocess.html#retrieving-a-block-hash">Retrieving a Block Hash</a></li>
</ul>
</li>
<li><a href="doc/design/multiprocess.html#future-enhancements">Future Enhancements</a></li>
<li><a href="doc/design/multiprocess.html#conclusion">Conclusion</a></li>
<li><a href="doc/design/multiprocess.html#appendices">Appendices</a>
<ul>
<li><a href="doc/design/multiprocess.html#glossary-of-terms">Glossary of Terms</a></li>
<li><a href="doc/design/multiprocess.html#references">References</a></li>
</ul>
</li>
<li><a href="doc/design/multiprocess.html#acknowledgements">Acknowledgements</a></li>
</ul>
<h2 id="introduction"><a class="header" href="#introduction">Introduction</a></h2>
<p>The Bitcoin Core software has historically employed a monolithic architecture. The existing design has integrated functionality like P2P network operations, wallet management, and a GUI into a single executable. While effective, it has limitations in flexibility, security, and scalability. This project introduces changes that transition Bitcoin Core to a more modular architecture. It aims to enhance security, improve usability, and facilitate maintenance and development of the software in the long run.</p>
<h2 id="current-architecture"><a class="header" href="#current-architecture">Current Architecture</a></h2>
<p>The current system features two primary executables: <code>bitcoind</code> and <code>bitcoin-qt</code>. <code>bitcoind</code> combines a Bitcoin P2P node with an integrated JSON-RPC server, wallet, and indexes. <code>bitcoin-qt</code> extends this by incorporating a Qt-based GUI. This monolithic structure, although robust, presents challenges such as limited operational flexibility and increased security risks due to the tight integration of components.</p>
<h2 id="proposed-architecture"><a class="header" href="#proposed-architecture">Proposed Architecture</a></h2>
<p>The new architecture divides the existing code into three specialized executables:</p>
<ul>
<li><code>bitcoin-node</code>: Manages the P2P node, indexes, and JSON-RPC server.</li>
<li><code>bitcoin-wallet</code>: Handles all wallet functionality.</li>
<li><code>bitcoin-gui</code>: Provides a standalone Qt-based GUI.</li>
</ul>
<p>This modular approach is designed to enhance security through component isolation and improve usability by allowing independent operation of each module. This allows for new use-cases, such as running the node on a dedicated machine and operating wallets and GUIs on separate machines with the flexibility to start and stop them as needed.</p>
<p>This subdivision could be extended in the future. For example, indexes could be removed from the <code>bitcoin-node</code> executable and run in separate executables. And JSON-RPC servers could be added to wallet and index executables, so they can listen and respond to RPC requests on their own ports, without needing to forward RPC requests through <code>bitcoin-node</code>.</p>
<table><tr><td>
<pre><code class="language-mermaid">flowchart LR
    node[bitcoin-node] -- listens on --&gt; socket["&amp;lt;datadir&amp;gt;/node.sock"]
    wallet[bitcoin-wallet] -- connects to --&gt; socket
    gui[bitcoin-gui] -- connects to --&gt; socket
</code></pre>
</td></tr><tr><td>
Processes and socket connection.
</td></tr></table>
<h2 id="component-overview-navigating-the-ipc-framework"><a class="header" href="#component-overview-navigating-the-ipc-framework">Component Overview: Navigating the IPC Framework</a></h2>
<p>This section describes the major components of the Inter-Process Communication (IPC) framework covering the relevant source files, generated files, tools, and libraries.</p>
<h3 id="abstract-c-classes-in-srcinterfaces"><a class="header" href="#abstract-c-classes-in-srcinterfaces">Abstract C++ Classes in <a href="doc/design/../../src/interfaces/"><code>src/interfaces/</code></a></a></h3>
<ul>
<li>The foundation of the IPC implementation lies in the abstract C++ classes within the <a href="doc/design/../../src/interfaces/"><code>src/interfaces/</code></a> directory. These classes define pure virtual methods that code in <a href="doc/design/../../src/node/"><code>src/node/</code></a>, <a href="doc/design/../../src/wallet/"><code>src/wallet/</code></a>, and <a href="doc/design/../../src/qt/"><code>src/qt/</code></a> directories call to interact with each other.</li>
<li>Each abstract class in this directory represents a distinct interface that the different modules (node, wallet, GUI) implement and use for cross-process communication.</li>
<li>The classes are written following conventions described in <a href="doc/design/../developer-notes.html#internal-interface-guidelines">Internal Interface
Guidelines</a> to ensure
compatibility with Cap'n Proto.</li>
</ul>
<h3 id="capn-proto-files-in-srcipccapnp"><a class="header" href="#capn-proto-files-in-srcipccapnp">Capâ€™n Proto Files in <a href="doc/design/../../src/ipc/capnp/"><code>src/ipc/capnp/</code></a></a></h3>
<ul>
<li>Corresponding to each abstract class, there are <code>.capnp</code> files within the <a href="doc/design/../../src/ipc/capnp/"><code>src/ipc/capnp/</code></a> directory. These files are used as input to the <code>mpgen</code> tool (described below) to generate C++ code.</li>
<li>These Capâ€™n Proto files (<a href="https://capnproto.org/rpc.html">learn more about Cap'n Proto RPC</a>) define the structure and format of messages that are exchanged over IPC. They serve as blueprints for generating C++ code that bridges the gap between high-level C++ interfaces and low-level socket communication.</li>
</ul>
<h3 id="the-mpgen-code-generation-tool"><a class="header" href="#the-mpgen-code-generation-tool">The <code>mpgen</code> Code Generation Tool</a></h3>
<ul>
<li>A central component of the IPC framework is the <code>mpgen</code> tool which is part the <a href="https://github.com/chaincodelabs/libmultiprocess"><code>libmultiprocess</code> project</a>. This tool takes the <code>.capnp</code> files as input and generates C++ code.</li>
<li>The generated code handles IPC communication, translating interface calls into socket reads and writes.</li>
</ul>
<h3 id="c-client-subclasses-in-generated-code"><a class="header" href="#c-client-subclasses-in-generated-code">C++ Client Subclasses in Generated Code</a></h3>
<ul>
<li>In the generated code, we have C++ client subclasses that inherit from the abstract classes in <a href="doc/design/../../src/interfaces/"><code>src/interfaces/</code></a>. These subclasses are the workhorses of the IPC mechanism.</li>
<li>They implement all the methods of the interface, marshalling arguments into a structured format, sending them as requests to the IPC server via a UNIX socket, and handling the responses.</li>
<li>These subclasses effectively mask the complexity of IPC, presenting a familiar C++ interface to developers.</li>
<li>Internally, the client subclasses generated by the <code>mpgen</code> tool wrap <a href="https://capnproto.org/cxxrpc.html#clients">client classes generated by Cap'n Proto</a>, and use them to send IPC requests. The Cap'n Proto client classes are low-level, with non-blocking methods that use asynchronous I/O and pass request and response objects, while mpgen client subclasses provide normal C++ methods that block while executing and convert between request/response objects and arguments/return values.</li>
</ul>
<h3 id="c-server-classes-in-generated-code"><a class="header" href="#c-server-classes-in-generated-code">C++ Server Classes in Generated Code</a></h3>
<ul>
<li>On the server side, corresponding generated C++ classes receive IPC requests. These server classes are responsible for unmarshalling method arguments, invoking the corresponding methods in the local <a href="doc/design/../../src/interfaces/"><code>src/interfaces/</code></a> objects, and creating the IPC response.</li>
<li>The server classes ensure that return values (including output argument values and thrown exceptions) are marshalled and sent back to the client, completing the communication cycle.</li>
<li>Internally, the server subclasses generated by the <code>mpgen</code> tool inherit from <a href="https://capnproto.org/cxxrpc.html#servers">server classes generated by Cap'n Proto</a>, and use them to process IPC requests.</li>
</ul>
<h3 id="the-libmultiprocess-runtime-library"><a class="header" href="#the-libmultiprocess-runtime-library">The <code>libmultiprocess</code> Runtime Library</a></h3>
<ul>
<li><strong>Core Functionality</strong>: The <code>libmultiprocess</code> runtime library's primary function is to instantiate the generated client and server classes as needed.</li>
<li><strong>Bootstrapping IPC Connections</strong>: It provides functions for starting new IPC connections, specifically binding generated client and server classes for an initial <code>interfaces::Init</code> interface (defined in <a href="doc/design/../../src/interfaces/init.h"><code>src/interfaces/init.h</code></a>) to a UNIX socket. This initial interface has methods returning other interfaces that different Bitcoin Core modules use to communicate after the bootstrapping phase.</li>
<li><strong>Asynchronous I/O and Thread Management</strong>: The library is also responsible for managing I/O and threading. Particularly, it ensures that IPC requests never block each other and that new threads on either side of a connection can always make client calls. It also manages worker threads on the server side of calls, ensuring that calls from the same client thread always execute on the same server thread (to avoid locking issues and support nested callbacks).</li>
</ul>
<h3 id="type-hooks-in-srcipccapnp-typesh"><a class="header" href="#type-hooks-in-srcipccapnp-typesh">Type Hooks in <a href="doc/design/../../src/ipc/capnp/"><code>src/ipc/capnp/*-types.h</code></a></a></h3>
<ul>
<li><strong>Custom Type Conversions</strong>: In <a href="doc/design/../../src/ipc/capnp/"><code>src/ipc/capnp/*-types.h</code></a>, function overloads of <code>libmultiprocess</code> C++ functions, <code>mp::CustomReadField</code>, <code>mp::CustomBuildField</code>, <code>mp::CustomReadMessage</code> and <code>mp::CustomBuildMessage</code>, are defined. These overloads are used for customizing the conversion of specific C++ types to and from Capâ€™n Proto types.</li>
<li><strong>Handling Special Cases</strong>: The <code>mpgen</code> tool and <code>libmultiprocess</code> library can convert most C++ types to and from Capâ€™n Proto types automatically, including interface types, primitive C++ types, standard C++ types like <code>std::vector</code>, <code>std::set</code>, <code>std::map</code>, <code>std::tuple</code>, and <code>std::function</code>, as well as simple C++ structs that consist of aforementioned types and whose fields correspond 1:1 with Capâ€™n Proto struct fields. For other types, <code>*-types.h</code> files provide custom code to convert between C++ and Capâ€™n Proto data representations.</li>
</ul>
<h3 id="protocol-agnostic-ipc-code-in-srcipc"><a class="header" href="#protocol-agnostic-ipc-code-in-srcipc">Protocol-Agnostic IPC Code in <a href="doc/design/../../src/ipc/"><code>src/ipc/</code></a></a></h3>
<ul>
<li><strong>Broad Applicability</strong>: Unlike the Capâ€™n Proto-specific code in <a href="doc/design/../../src/ipc/capnp/"><code>src/ipc/capnp/</code></a>, the code in the <a href="doc/design/../../src/ipc/"><code>src/ipc/</code></a> directory is protocol-agnostic. This enables potential support for other protocols, such as gRPC or a custom protocol in the future.</li>
<li><strong>Process Management and Socket Operations</strong>: The main purpose of this component is to provide functions for spawning new processes and creating and connecting to UNIX sockets.</li>
<li><strong>ipc::Exception Class</strong>: This code also defines an <code>ipc::Exception</code> class which is thrown from the generated C++ client class methods when there is an unexpected IPC error, such as a disconnection.</li>
</ul>
<table><tr><td>
<pre><code class="language-mermaid">flowchart TD
    capnpFile[ipc/capnp/chain.capnp] --&gt;|Input to| mpgenTool([mpgen Tool])
    mpgenTool --&gt;|Generates| proxyTypesH[ipc/capnp/chain.capnp.proxy-types.h]
    mpgenTool --&gt; proxyClientCpp[ipc/capnp/chain.capnp.proxy-client.c++]
    mpgenTool --&gt; proxyServerCpp[ipc/capnp/chain.capnp.proxy-server.c++]
    proxyTypesH -.-&gt;|Includes| interfaces/chain.h
    proxyClientCpp -.-&gt; interfaces/chain.h
    proxyServerCpp -.-&gt; interfaces/chain.h
</code></pre>
</td></tr><tr><td>
Diagram showing generated source files and includes.
</td></tr></table>
<h2 id="design-considerations"><a class="header" href="#design-considerations">Design Considerations</a></h2>
<h3 id="selection-of-capn-proto"><a class="header" href="#selection-of-capn-proto">Selection of Capâ€™n Proto</a></h3>
<p>The choice to use <a href="https://capnproto.org/">Capâ€™n Proto</a> for IPC was primarily influenced by its support for passing object references and managing object lifetimes, which would have to be implemented manually with a framework that only supported plain requests and responses like <a href="https://grpc.io/">gRPC</a>. The support is especially helpful for passing callback objects like <code>std::function</code> and enabling bidirectional calls between processes.</p>
<p>The choice to use an RPC framework at all instead of a custom protocol was necessitated by the size of Bitcoin Core internal interfaces which consist of around 150 methods that pass complex data structures and are called in complicated ways (in parallel, and from callbacks that can be nested and stored). Writing a custom protocol to wrap these complicated interfaces would be a lot more work, akin to writing a new RPC framework.</p>
<h3 id="hiding-ipc"><a class="header" href="#hiding-ipc">Hiding IPC</a></h3>
<p>The IPC mechanism is deliberately isolated from the rest of the codebase so less code has to be concerned with IPC.</p>
<p>Building Bitcoin Core with IPC support is optional, and node, wallet, and GUI code can be compiled to either run in the same process or separate processes. The build system also ensures Capâ€™n Proto library headers can only be used within the <a href="doc/design/../../src/ipc/capnp/"><code>src/ipc/capnp/</code></a> directory, not in other parts of the codebase.</p>
<p>The libmultiprocess runtime is designed to place as few constraints as possible on IPC interfaces and to make IPC calls act like normal function calls. Method arguments, return values, and exceptions are automatically serialized and sent between processes. Object references and <code>std::function</code> arguments are tracked to allow invoked code to call back into invoking code at any time. And there is a 1:1 threading model where every client thread has a corresponding server thread responsible for executing incoming calls from that thread (there can be multiple calls from the same thread due to callbacks) without blocking, and holding the same thread-local variables and locks so behavior is the same whether IPC is used or not.</p>
<h3 id="interface-definition-maintenance"><a class="header" href="#interface-definition-maintenance">Interface Definition Maintenance</a></h3>
<p>The choice to maintain interface definitions and C++ type mappings as <code>.capnp</code> files in the <a href="doc/design/../../src/ipc/capnp/"><code>src/ipc/capnp/</code></a> was mostly done for convenience, and probably something that could be improved in the future.</p>
<p>In the current design, class names, method names, and parameter names are duplicated between C++ interfaces in <a href="doc/design/../../src/interfaces/"><code>src/interfaces/</code></a> and Capâ€™n Proto files in <a href="doc/design/../../src/ipc/capnp/"><code>src/ipc/capnp/</code></a>. While this keeps C++ interface headers simple and free of references to IPC, it is a maintenance burden because it means inconsistencies between C++ declarations and Capâ€™n Proto declarations will result in compile errors. (Static type checking ensures these are not runtime errors.)</p>
<p>An alternate approach could use custom <a href="https://en.cppreference.com/w/cpp/language/attributes">C++ Attributes</a> embedded in interface declarations to automatically generate <code>.capnp</code> files from C++ headers. This has not been pursued because parsing C++ headers is more complicated than parsing Capâ€™n Proto interface definitions, especially portably on multiple platforms.</p>
<p>In the meantime, the developer guide <a href="doc/design/../developer-notes.html#internal-interface-guidelines">Internal interface guidelines</a> can provide guidance on keeping interfaces consistent and functional and avoiding compile errors.</p>
<h3 id="interface-stability"><a class="header" href="#interface-stability">Interface Stability</a></h3>
<p>The currently defined IPC interfaces are unstable, and can change freely with no backwards compatibility. The decision to allow this stems from the recognition that our current interfaces are still evolving and not yet ideal for external use. As these interfaces mature and become more refined, there may be an opportunity to declare them stable and use Capâ€™n Proto's support for protocol evolution (<a href="https://capnproto.org/language.html#evolving-your-protocol">Cap'n Proto - Evolving Your Protocol</a>) to allow them to be extended while remaining backwards compatible. This could allow different versions of node, GUI, and wallet binaries to interoperate, and potentially open doors for external tools to utilize these interfaces, such as creating custom indexes through a stable indexing interface. However, for now, the priority is to improve the interfaces internally. Given their current state and the advantages of using JSON-RPC for most common tasks, it's more practical to focus on internal development rather than external applicability.</p>
<h2 id="security-considerations"><a class="header" href="#security-considerations">Security Considerations</a></h2>
<p>The integration of <a href="https://capnproto.org/">Capâ€™n Proto</a> and <a href="https://github.com/chaincodelabs/libmultiprocess">libmultiprocess</a> into the Bitcoin Core architecture increases its potential attack surface. Capâ€™n Proto, being a complex and substantial new dependency, introduces potential sources of vulnerability, particularly through the creation of new UNIX sockets. The inclusion of libmultiprocess, while a smaller external dependency, also contributes to this risk. However, plans are underway to incorporate libmultiprocess as a git subtree, aligning it more closely with the project's well-reviewed internal libraries. While adopting these multiprocess features does introduce some risk, it's worth noting that they can be disabled, allowing builds without these new dependencies. This flexibility ensures that users can balance functionality with security considerations as needed.</p>
<h2 id="example-use-cases-and-flows"><a class="header" href="#example-use-cases-and-flows">Example Use Cases and Flows</a></h2>
<h3 id="retrieving-a-block-hash"><a class="header" href="#retrieving-a-block-hash">Retrieving a Block Hash</a></h3>
<p>Letâ€™s walk through an example where the <code>bitcoin-wallet</code> process requests the hash of a block at a specific height from the <code>bitcoin-node</code> process. This example demonstrates the practical application of the IPC mechanism, specifically the interplay between C++ method calls and Capâ€™n Proto-generated RPC calls.</p>
<table><tr><td>
<pre><code class="language-mermaid">sequenceDiagram
    box "bitcoin-wallet process"
    participant WalletCode as Wallet code
    participant ChainClient as Generated Chain client class&lt;br/&gt;ProxyClient&lt;messages::Chain&gt;
    end
    box "bitcoin-node process"
    participant ChainServer as Generated Chain server class&lt;br/&gt;ProxyServer&lt;messages::Chain&gt;
    participant LocalChain as Chain object&lt;br/&gt;node::ChainImpl
    end

    WalletCode-&gt;&gt;ChainClient: getBlockHash(height)
    ChainClient-&gt;&gt;ChainServer: Send RPC getBlockHash request
    ChainServer-&gt;&gt;LocalChain: getBlockHash(height)
    LocalChain-&gt;&gt;ChainServer: Return block hash
    ChainServer-&gt;&gt;ChainClient: Send response with block hash
    ChainClient-&gt;&gt;WalletCode: Return block hash
</code></pre>
</td></tr><tr><td>
<code>Chain::getBlockHash</code> call diagram
</td></tr></table>
<ol>
<li>
<p><strong>Initiation in bitcoin-wallet</strong></p>
<ul>
<li>The wallet process calls the <code>getBlockHash</code> method on a <code>Chain</code> object. This method is defined as a virtual method in <a href="doc/design/../../src/interfaces/chain.h"><code>src/interfaces/chain.h</code></a>.</li>
</ul>
</li>
<li>
<p><strong>Translation to Capâ€™n Proto RPC</strong></p>
<ul>
<li>The <code>Chain::getBlockHash</code> virtual method is overridden by the <code>Chain</code> <a href="doc/design/multiprocess.html#c-client-subclasses-in-generated-code">client subclass</a> to translate the method call into a Capâ€™n Proto RPC call.</li>
<li>The client subclass is automatically generated by the <code>mpgen</code> tool from the <a href="https://github.com/ryanofsky/bitcoin/blob/pr/ipc/src/ipc/capnp/chain.capnp"><code>chain.capnp</code></a> file in <a href="doc/design/../../src/ipc/capnp/"><code>src/ipc/capnp/</code></a>.</li>
</ul>
</li>
<li>
<p><strong>Request Preparation and Dispatch</strong></p>
<ul>
<li>The <code>getBlockHash</code> method of the generated <code>Chain</code> client subclass in <code>bitcoin-wallet</code> populates a Capâ€™n Proto request with the <code>height</code> parameter, sends it to <code>bitcoin-node</code> process, and waits for a response.</li>
</ul>
</li>
<li>
<p><strong>Handling in bitcoin-node</strong></p>
<ul>
<li>Upon receiving the request, the Cap'n Proto dispatching code in the <code>bitcoin-node</code> process calls the <code>getBlockHash</code> method of the <code>Chain</code> <a href="doc/design/multiprocess.html#c-server-classes-in-generated-code">server class</a>.</li>
<li>The server class is automatically generated by the <code>mpgen</code> tool from the <a href="https://github.com/ryanofsky/bitcoin/blob/pr/ipc/src/ipc/capnp/chain.capnp"><code>chain.capnp</code></a> file in <a href="doc/design/../../src/ipc/capnp/"><code>src/ipc/capnp/</code></a>.</li>
<li>The <code>getBlockHash</code> method of the generated <code>Chain</code> server subclass in <code>bitcoin-wallet</code> receives a Capâ€™n Proto request object with the <code>height</code> parameter, and calls the <code>getBlockHash</code> method on its local <code>Chain</code> object with the provided <code>height</code>.</li>
<li>When the call returns, it encapsulates the return value in a Capâ€™n Proto response, which it sends back to the <code>bitcoin-wallet</code> process.</li>
</ul>
</li>
<li>
<p><strong>Response and Return</strong></p>
<ul>
<li>The <code>getBlockHash</code> method of the generated <code>Chain</code> client subclass in <code>bitcoin-wallet</code> which sent the request now receives the response.</li>
<li>It extracts the block hash value from the response, and returns it to the original caller.</li>
</ul>
</li>
</ol>
<h2 id="future-enhancements"><a class="header" href="#future-enhancements">Future Enhancements</a></h2>
<p>Further improvements are possible such as:</p>
<ul>
<li>Separating indexes from <code>bitcoin-node</code>, and running indexing code in separate processes (see <a href="https://github.com/bitcoin/bitcoin/pull/24230">indexes: Stop using node internal types #24230</a>).</li>
<li>Enabling wallet processes to listen for JSON-RPC requests on their own ports instead of needing the node process to listen and forward requests to them.</li>
<li>Automatically generating <code>.capnp</code> files from C++ interface definitions (see <a href="doc/design/multiprocess.html#interface-definition-maintenance">Interface Definition Maintenance</a>).</li>
<li>Simplifying and stabilizing interfaces (see <a href="doc/design/multiprocess.html#interface-stability">Interface Stability</a>).</li>
<li>Adding sandbox features, restricting subprocess access to resources and data (see <a href="https://eklitzke.org/multiprocess-bitcoin">https://eklitzke.org/multiprocess-bitcoin</a>).</li>
<li>Using Cap'n Proto's support for <a href="https://capnproto.org/otherlang.html">other languages</a>, such as <a href="https://github.com/capnproto/capnproto-rust">Rust</a>, to allow code written in other languages to call Bitcoin Core C++ code, and vice versa (see <a href="https://github.com/chaincodelabs/libmultiprocess/issues/56">How to rustify libmultiprocess? #56</a>).</li>
</ul>
<h2 id="conclusion"><a class="header" href="#conclusion">Conclusion</a></h2>
<p>This modularization represents an advancement in Bitcoin Core's architecture, offering enhanced security, flexibility, and maintainability. The project invites collaboration and feedback from the community.</p>
<h2 id="appendices"><a class="header" href="#appendices">Appendices</a></h2>
<h3 id="glossary-of-terms"><a class="header" href="#glossary-of-terms">Glossary of Terms</a></h3>
<ul>
<li>
<p><strong>abstract class</strong>: A class in C++ that consists of virtual functions. In the Bitcoin Core project, they define interfaces for inter-component communication.</p>
</li>
<li>
<p><strong>asynchronous I/O</strong>: A form of input/output processing that allows a program to continue other operations while a transmission is in progress.</p>
</li>
<li>
<p><strong>Capâ€™n Proto</strong>: A high-performance data serialization and RPC library, chosen for its support for object references and bidirectional communication.</p>
</li>
<li>
<p><strong>Capâ€™n Proto interface</strong>: A set of methods defined in Capâ€™n Proto to facilitate structured communication between different software components.</p>
</li>
<li>
<p><strong>Capâ€™n Proto struct</strong>: A structured data format used in Capâ€™n Proto, similar to structs in C++, for organizing and transporting data across different processes.</p>
</li>
<li>
<p><strong>client class (in generated code)</strong>: A C++ class generated from a Capâ€™n Proto interface which inherits from a Bitcoin Core abstract class, and implements each virtual method to send IPC requests to another process. (see also <a href="doc/design/multiprocess.html#c-client-subclasses-in-generated-code">components section</a>)</p>
</li>
<li>
<p><strong>IPC (inter-process communication)</strong>: Mechanisms that enable processes to exchange requests and data.</p>
</li>
<li>
<p><strong>ipc::Exception class</strong>: A class within Bitcoin Core's protocol-agnostic IPC code that is thrown by client class methods when there is an IPC error.</p>
</li>
<li>
<p><strong>libmultiprocess</strong>: A custom library and code generation tool used for creating IPC interfaces and managing IPC connections.</p>
</li>
<li>
<p><strong>marshalling</strong>: Transforming an objectâ€™s memory representation for transmission.</p>
</li>
<li>
<p><strong>mpgen tool</strong>: A tool within the <code>libmultiprocess</code> suite that generates C++ code from Capâ€™n Proto files, facilitating IPC.</p>
</li>
<li>
<p><strong>protocol-agnostic code</strong>: Generic IPC code in <a href="doc/design/../../src/ipc/"><code>src/ipc/</code></a> that does not rely on Capâ€™n Proto and could be used with other protocols. Distinct from code in <a href="doc/design/../../src/ipc/capnp/"><code>src/ipc/capnp/</code></a> which relies on Capâ€™n Proto.</p>
</li>
<li>
<p><strong>RPC (remote procedure call)</strong>: A protocol that enables a program to request a service from another program in a different address space or network. Bitcoin Core uses <a href="https://en.wikipedia.org/wiki/JSON-RPC">JSON-RPC</a> for RPC.</p>
</li>
<li>
<p><strong>server class (in generated code)</strong>: A C++ class generated from a Capâ€™n Proto interface which handles requests sent by a <em>client class</em> in another process. The request handled by calling a local Bitcoin Core interface method, and the return values (if any) are sent back in a response. (see also: <a href="doc/design/multiprocess.html#c-server-classes-in-generated-code">components section</a>)</p>
</li>
<li>
<p><strong>unix socket</strong>: Communication endpoint which is a filesystem path, used for exchanging data between processes running on the same host.</p>
</li>
<li>
<p><strong>virtual method</strong>: A function or method whose behavior can be overridden within an inheriting class by a function with the same signature.</p>
</li>
</ul>
<h2 id="references"><a class="header" href="#references">References</a></h2>
<ul>
<li><strong>Capâ€™n Proto RPC protocol description</strong>: https://capnproto.org/rpc.html</li>
<li><strong>libmultiprocess project page</strong>: https://github.com/chaincodelabs/libmultiprocess</li>
</ul>
<h2 id="acknowledgements"><a class="header" href="#acknowledgements">Acknowledgements</a></h2>
<p>This design doc was written by @ryanofsky, who is grateful to all the reviewers who gave feedback and tested <a href="https://github.com/bitcoin/bitcoin/pull/28722">multiprocess PRs</a>, and everyone else who's helped with this project. Particular thanks to @ariard who deeply reviewed IPC code and improved the design of the IPC library and initialization process. @jnewbery who championed the early refactoring PRs and helped guide them through development and review. @sjors who has reviewed and repeatedly tested multiprocess code, reporting many issues and helping debug them. @hebasto, @fanquake, and @maflcko who made significant improvements to the build system and fixed countless build issues. @vasild and @jamesob who were brave contributors to the libmultiprocess library. And Chaincode Labs for making this work possible. Also thanks to ChatGPT, who actually wrote most of this document (not @ryanofsky).</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="transaction-relay-policy"><a class="header" href="#transaction-relay-policy">Transaction Relay Policy</a></h1>
<p><strong>Policy</strong> (Mempool or Transaction Relay Policy) is the node's set of validation rules, in addition
to consensus, enforced for unconfirmed transactions before submitting them to the mempool. These
rules are local to the node and configurable, see "Node relay options" when running <code>-help</code>.
Policy may include restrictions on the transaction itself, the transaction
in relation to the current chain tip, and the transaction in relation to the node's mempool
contents. Policy is <em>not</em> applied to transactions in blocks.</p>
<p>This documentation is not an exhaustive list of all policy rules.</p>
<ul>
<li><a href="doc/policy/mempool-limits.html">Mempool Limits</a></li>
<li><a href="doc/policy/mempool-replacements.html">Mempool Replacements</a></li>
<li><a href="doc/policy/packages.html">Packages</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="mempool-limits"><a class="header" href="#mempool-limits">Mempool Limits</a></h1>
<h2 id="definitions"><a class="header" href="#definitions">Definitions</a></h2>
<p>Given any two transactions Tx0 and Tx1 where Tx1 spends an output of Tx0,
Tx0 is a <em>parent</em> of Tx1 and Tx1 is a <em>child</em> of Tx0.</p>
<p>A transaction's <em>ancestors</em> include, recursively, its parents, the parents of its parents, etc.
A transaction's <em>descendants</em> include, recursively, its children, the children of its children, etc.</p>
<p>A mempool entry's <em>ancestor count</em> is the total number of in-mempool (unconfirmed) transactions in
its ancestor set, including itself.
A mempool entry's <em>descendant count</em> is the total number of in-mempool (unconfirmed) transactions in
its descendant set, including itself.</p>
<p>A mempool entry's <em>ancestor size</em> is the aggregated virtual size of in-mempool (unconfirmed)
transactions in its ancestor set, including itself.
A mempool entry's <em>descendant size</em> is the aggregated virtual size of in-mempool (unconfirmed)
transactions in its descendant set, including itself.</p>
<p>Transactions submitted to the mempool must not exceed the ancestor and descendant limits (aka
mempool <em>package limits</em>) set by the node (see <code>-limitancestorcount</code>, <code>-limitancestorsize</code>,
<code>-limitdescendantcount</code>, <code>-limitdescendantsize</code>).</p>
<h2 id="exemptions"><a class="header" href="#exemptions">Exemptions</a></h2>
<h3 id="cpfp-carve-out"><a class="header" href="#cpfp-carve-out">CPFP Carve Out</a></h3>
<p><strong>CPFP Carve Out</strong> if a transaction candidate for submission to the
mempool would cause some mempool entry to exceed its descendant limits, an exemption is made if all
of the following conditions are met:</p>
<ol>
<li>
<p>The candidate transaction is no more than 10,000 virtual bytes.</p>
</li>
<li>
<p>The candidate transaction has an ancestor count of 2 (itself and exactly 1 ancestor).</p>
</li>
<li>
<p>The in-mempool transaction's descendant count, including the candidate transaction, would only
exceed the limit by 1.</p>
</li>
</ol>
<p><em>Rationale</em>: this rule was introduced to prevent pinning by domination of a transaction's descendant
limits in two-party contract protocols such as LN.  Also see the <a href="https://lists.linuxfoundation.org/pipermail/bitcoin-dev/2018-November/016518.html">mailing list
post</a>.</p>
<p>This rule was introduced in <a href="https://github.com/bitcoin/bitcoin/pull/15681">PR #15681</a>.</p>
<h3 id="single-conflict-rbf-carve-out"><a class="header" href="#single-conflict-rbf-carve-out">Single-Conflict RBF Carve Out</a></h3>
<p>When a candidate transaction for submission to the mempool would replace mempool entries, it may
also decrease the descendant count of other mempool entries. Since ancestor/descendant limits are
calculated prior to removing the would-be-replaced transactions, they may be overestimated.</p>
<p>An exemption is given for a candidate transaction that would replace mempool transactions and meets
all of the following conditions:</p>
<ol>
<li>
<p>The candidate transaction has exactly 1 directly conflicting transaction.</p>
</li>
<li>
<p>The candidate transaction does not spend any unconfirmed inputs that are not also spent by the
directly conflicting transaction.</p>
</li>
</ol>
<p>The following discounts are given to account for the would-be-replaced transaction(s):</p>
<ol>
<li>
<p>The descendant count limit is temporarily increased by 1.</p>
</li>
<li>
<p>The descendant size limit temporarily is increased by the virtual size of the to-be-replaced
directly conflicting transaction.</p>
</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="mempool-replacements"><a class="header" href="#mempool-replacements">Mempool Replacements</a></h1>
<h2 id="current-replace-by-fee-policy"><a class="header" href="#current-replace-by-fee-policy">Current Replace-by-Fee Policy</a></h2>
<p>A transaction conflicts with an in-mempool transaction ("directly conflicting transaction") if they
spend one or more of the same inputs. A transaction may conflict with multiple in-mempool
transactions.</p>
<p>A transaction ("replacement transaction") may replace its directly conflicting transactions and
their in-mempool descendants (together, "original transactions") if, in addition to passing all
other consensus and policy rules, each of the following conditions are met:</p>
<ol>
<li>
<p>(Removed)</p>
</li>
<li>
<p>The replacement transaction only include an unconfirmed input if that input was included in
one of the directly conflicting transactions. An unconfirmed input spends an output from a
currently-unconfirmed transaction.</p>
<p><em>Rationale</em>: When RBF was originally implemented, the mempool did not keep track of
ancestor feerates yet. This rule was suggested as a temporary restriction.</p>
</li>
<li>
<p>The replacement transaction pays an absolute fee of at least the sum paid by the original
transactions.</p>
<p><em>Rationale</em>: Only requiring the replacement transaction to have a higher feerate could allow an
attacker to bypass node minimum relay feerate requirements and cause the network to repeatedly
relay slightly smaller replacement transactions without adding any more fees. Additionally, if
any of the original transactions would be included in the next block assembled by an economically
rational miner, a replacement policy allowing the replacement transaction to decrease the absolute
fees in the next block would be incentive-incompatible.</p>
</li>
<li>
<p>The additional fees (difference between absolute fee paid by the replacement transaction and the
sum paid by the original transactions) pays for the replacement transaction's bandwidth at or
above the rate set by the node's incremental relay feerate. For example, if the incremental relay
feerate is 1 satoshi/vB and the replacement transaction is 500 virtual bytes total, then the
replacement pays a fee at least 500 satoshis higher than the sum of the original transactions.</p>
<p><em>Rationale</em>: Try to prevent DoS attacks where an attacker causes the network to repeatedly relay
transactions each paying a tiny additional amount in fees, e.g. just 1 satoshi.</p>
</li>
<li>
<p>The number of original transactions does not exceed 100. More precisely, the sum of all
directly conflicting transactions' descendant counts (number of transactions inclusive of itself
and its descendants) must not exceed 100; it is possible that this overestimates the true number
of original transactions.</p>
<p><em>Rationale</em>: Try to prevent DoS attacks where an attacker is able to easily occupy and flush out
significant portions of the node's mempool using replacements with multiple directly conflicting
transactions, each with large descendant sets.</p>
</li>
<li>
<p>The replacement transaction's feerate is greater than the feerates of all directly conflicting
transactions.</p>
<p><em>Rationale</em>: This rule was originally intended to ensure that the replacement transaction is
preferable for block-inclusion, compared to what would be removed from the mempool. This rule
predates ancestor feerate-based transaction selection.</p>
</li>
</ol>
<p>This set of rules is similar but distinct from BIP125.</p>
<h2 id="history"><a class="header" href="#history">History</a></h2>
<ul>
<li>
<p>Opt-in full replace-by-fee (without inherited signaling) honoured in mempool and mining as of
<strong>v0.12.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/6871">PR 6871</a>).</p>
</li>
<li>
<p><a href="https://github.com/bitcoin/bips/blob/master/bip-0125.mediawiki">BIP125</a> defined based on
Bitcoin Core implementation.</p>
</li>
<li>
<p>The incremental relay feerate used to calculate the required additional fees is distinct from
<code>-minrelaytxfee</code> and configurable using <code>-incrementalrelayfee</code>
(<a href="https://github.com/bitcoin/bitcoin/pull/9380">PR #9380</a>).</p>
</li>
<li>
<p>RBF enabled by default in the wallet GUI as of <strong>v0.18.1</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/11605">PR
#11605</a>).</p>
</li>
<li>
<p>Full replace-by-fee enabled as a configurable mempool policy as of <strong>v24.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/25353">PR
#25353</a>).</p>
</li>
<li>
<p>Full replace-by-fee is the default policy as of <strong>v28.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/30493">PR #30493</a>).</p>
</li>
<li>
<p>Signaling for replace-by-fee is no longer required as of <a href="https://github.com/bitcoin/bitcoin/pull/30592">PR 30592</a>.</p>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="package-mempool-accept"><a class="header" href="#package-mempool-accept">Package Mempool Accept</a></h1>
<h2 id="definitions-1"><a class="header" href="#definitions-1">Definitions</a></h2>
<p>A <strong>package</strong> is an ordered list of transactions, representable by a connected Directed Acyclic
Graph (a directed edge exists between a transaction that spends the output of another transaction).</p>
<p>For every transaction <code>t</code> in a <strong>topologically sorted</strong> package, if any of its parents are present
in the package, they appear somewhere in the list before <code>t</code>.</p>
<p>A <strong>child-with-unconfirmed-parents</strong> package is a topologically sorted package that consists of
exactly one child and all of its unconfirmed parents (no other transactions may be present).
The last transaction in the package is the child, and its package can be canonically defined based
on the current state: each of its inputs must be available in the UTXO set as of the current chain
tip or some preceding transaction in the package.</p>
<h2 id="package-mempool-acceptance-rules"><a class="header" href="#package-mempool-acceptance-rules">Package Mempool Acceptance Rules</a></h2>
<p>The following rules are enforced for all packages:</p>
<ul>
<li>
<p>Packages cannot exceed <code>MAX_PACKAGE_COUNT=25</code> count and <code>MAX_PACKAGE_WEIGHT=404000</code> total weight
(#20833)</p>
<ul>
<li>
<p><em>Rationale</em>: We want package size to be as small as possible to mitigate DoS via package
validation. However, we want to make sure that the limit does not restrict ancestor
packages that would be allowed if submitted individually.</p>
</li>
<li>
<p>Note that, if these mempool limits change, package limits should be reconsidered. Users may
also configure their mempool limits differently.</p>
</li>
<li>
<p>Note that this is transaction weight, not "virtual" size as with other limits to allow
simpler context-less checks.</p>
</li>
</ul>
</li>
<li>
<p>Packages must be topologically sorted. (#20833)</p>
</li>
<li>
<p>Packages cannot have conflicting transactions, i.e. no two transactions in a package can spend
the same inputs. Packages cannot have duplicate transactions. (#20833)</p>
</li>
<li>
<p>Only limited package replacements are currently considered. (#28984)</p>
<ul>
<li>
<p>Packages are 1-parent-1-child, with no in-mempool ancestors of the package.</p>
</li>
<li>
<p>All conflicting clusters (connected components of mempool transactions) must be clusters of up to size 2.</p>
</li>
<li>
<p>No more than MAX_REPLACEMENT_CANDIDATES transactions can be replaced, analogous to
regular <a href="doc/policy/./mempool-replacements.html">replacement rule</a> 5).</p>
</li>
<li>
<p>Replacements must pay more total total fees at the incremental relay fee (analogous to
regular <a href="doc/policy/./mempool-replacements.html">replacement rules</a> 3 and 4).</p>
</li>
<li>
<p>Parent feerate must be lower than package feerate.</p>
</li>
<li>
<p>Must improve <a href="https://delvingbitcoin.org/t/mempool-incentive-compatibility/553">feerate diagram</a>. (#29242)</p>
</li>
<li>
<p><em>Rationale</em>: Basic support for package RBF can be used by wallets
by making chains of no longer than two, then directly conflicting
those chains when needed. Combined with TRUC transactions this can
result in more robust fee bumping. More general package RBF may be
enabled in the future.</p>
</li>
</ul>
</li>
<li>
<p>When packages are evaluated against ancestor/descendant limits, the union of all transactions'
descendants and ancestors is considered. (#21800)</p>
<ul>
<li><em>Rationale</em>: This is essentially a "worst case" heuristic intended for packages that are
heavily connected, i.e. some transaction in the package is the ancestor or descendant of all
the other transactions.</li>
</ul>
</li>
<li>
<p><a href="doc/policy/./mempool-limits.html#CPFP-Carve-Out">CPFP Carve Out</a> is disabled in packaged contexts. (#21800)</p>
<ul>
<li><em>Rationale</em>: This carve out cannot be accurately applied when there are multiple transactions'
ancestors and descendants being considered at the same time.</li>
</ul>
</li>
</ul>
<p>The following rules are only enforced for packages to be submitted to the mempool (not
enforced for test accepts):</p>
<ul>
<li>
<p>Packages must be child-with-unconfirmed-parents packages. This also means packages must contain at
least 2 transactions. (#22674)</p>
<ul>
<li>
<p><em>Rationale</em>: This allows for fee-bumping by CPFP. Allowing multiple parents makes it possible
to fee-bump a batch of transactions. Restricting packages to a defined topology is easier to
reason about and simplifies the validation logic greatly.</p>
</li>
<li>
<p>Warning: Batched fee-bumping may be unsafe for some use cases. Users and application developers
should take caution if utilizing multi-parent packages.</p>
</li>
</ul>
</li>
<li>
<p>Transactions in the package that have the same txid as another transaction already in the mempool
will be removed from the package prior to submission ("deduplication").</p>
<ul>
<li>
<p><em>Rationale</em>: Node operators are free to set their mempool policies however they please, nodes
may receive transactions in different orders, and malicious counterparties may try to take
advantage of policy differences to pin or delay propagation of transactions. As such, it's
possible for some package transaction(s) to already be in the mempool, and there is no need to
repeat validation for those transactions or double-count them in fees.</p>
</li>
<li>
<p><em>Rationale</em>: We want to prevent potential censorship vectors. We should not reject entire
packages because we already have one of the transactions. Also, if an attacker first broadcasts
a competing package or transaction with a mutated witness, even though the two
same-txid-different-witness transactions are conflicting and cannot replace each other, the
honest package should still be considered for acceptance.</p>
</li>
</ul>
</li>
</ul>
<h3 id="package-fees-and-feerate"><a class="header" href="#package-fees-and-feerate">Package Fees and Feerate</a></h3>
<p><em>Package Feerate</em> is the total modified fees (base fees + any fee delta from
<code>prioritisetransaction</code>) divided by the total virtual size of all transactions in the package.
If any transactions in the package are already in the mempool, they are not submitted again
("deduplicated") and are thus excluded from this calculation.</p>
<p>To meet the dynamic mempool minimum feerate, i.e., the feerate determined by the transactions
evicted when the mempool reaches capacity (not the static minimum relay feerate), the total package
feerate instead of individual feerate can be used. For example, if the mempool minimum feerate is
5sat/vB and a 1sat/vB parent transaction has a high-feerate child, it may be accepted if
submitted as a package.</p>
<p><em>Rationale</em>: This can be thought of as "CPFP within a package," solving the issue of a presigned
transaction (i.e. in which a replacement transaction with a higher fee cannot be signed) being
rejected from the mempool when transaction volume is high and the mempool minimum feerate rises.</p>
<p>Note: Package feerate cannot be used to meet the minimum relay feerate (<code>-minrelaytxfee</code>)
requirement. For example, if the mempool minimum feerate is 5sat/vB and the minimum relay feerate is
set to 5satvB, a 1sat/vB parent transaction with a high-feerate child will not be accepted, even if
submitted as a package.</p>
<p><em>Rationale</em>: Avoid situations in which the mempool contains non-bumped transactions below min relay
feerate (which we consider to have pay 0 fees and thus receiving free relay). While package
submission would ensure these transactions are bumped at the time of entry, it is not guaranteed
that the transaction will always be bumped. For example, a later transaction could replace the
fee-bumping child without still bumping the parent. These no-longer-bumped transactions should be
removed during a replacement, but we do not have a DoS-resistant way of removing them or enforcing a
limit on their quantity. Instead, prevent their entry into the mempool.</p>
<p>Implementation Note: Transactions within a package are always validated individually first, and
package validation is used for the transactions that failed. Since package feerate is only
calculated using transactions that are not in the mempool, this implementation detail affects the
outcome of package validation.</p>
<p><em>Rationale</em>: It would be incorrect to use the fees of transactions that are already in the mempool, as
we do not want a transaction's fees to be double-counted.</p>
<p><em>Rationale</em>: Packages are intended for incentive-compatible fee-bumping: transaction B is a
"legitimate" fee-bump for transaction A only if B is a descendant of A and has a <em>higher</em> feerate
than A. We want to prevent "parents pay for children" behavior; fees of parents should not help
their children, since the parents can be mined without the child.  More generally, if transaction A
is not needed in order for transaction B to be mined, A's fees cannot help B. In a
child-with-parents package, simply excluding any parent transactions that meet feerate requirements
individually is sufficient to ensure this.</p>
<p><em>Rationale</em>: We must not allow a low-feerate child to prevent its parent from being accepted; fees
of children should not negatively impact their parents, since they are not necessary for the parents
to be mined. More generally, if transaction B is not needed in order for transaction A to be mined,
B's fees cannot harm A. In a child-with-parents package, simply validating parents individually
first is sufficient to ensure this.</p>
<p><em>Rationale</em>: As a principle, we want to avoid accidentally restricting policy in order to be
backward-compatible for users and applications that rely on p2p transaction relay. Concretely,
package validation should not prevent the acceptance of a transaction that would otherwise be
policy-valid on its own. By always accepting a transaction that passes individual validation before
trying package validation, we prevent any unintentional restriction of policy.</p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="rpc-tools"><a class="header" href="#rpc-tools">RPC Tools</a></h2>
<h3 id="rpcauth"><a class="header" href="#rpcauth"><a href="share/rpcauth//share/rpcauth">RPCAuth</a></a></h3>
<pre><code>usage: rpcauth.py [-h] username [password]

Create login credentials for a JSON-RPC user

positional arguments:
  username    the username for authentication
  password    leave empty to generate a random password or specify "-" to
              prompt for password

optional arguments:
  -h, --help  show this help message and exit
  -j, --json   output data in json format
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ctaes"><a class="header" href="#ctaes">ctaes</a></h1>
<p>Simple C module for constant-time AES encryption and decryption.</p>
<p>Features:</p>
<ul>
<li>Simple, pure C code without any dependencies.</li>
<li>No tables or data-dependent branches whatsoever, but using bit sliced approach from https://eprint.iacr.org/2009/129.pdf.</li>
<li>Very small object code: slightly over 4k of executable code when compiled with -Os.</li>
<li>Slower than implementations based on precomputed tables or specialized instructions, but can do ~15 MB/s on modern CPUs.</li>
</ul>
<h2 id="performance"><a class="header" href="#performance">Performance</a></h2>
<p>Compiled with GCC 5.3.1 with -O3, on an Intel(R) Core(TM) i7-4800MQ CPU, numbers in CPU cycles:</p>
<div class="table-wrapper"><table><thead><tr><th>Algorithm</th><th style="text-align: right">Key schedule</th><th style="text-align: right">Encryption per byte</th><th style="text-align: right">Decryption per byte</th></tr></thead><tbody>
<tr><td>AES-128</td><td style="text-align: right">2.8k</td><td style="text-align: right">154</td><td style="text-align: right">161</td></tr>
<tr><td>AES-192</td><td style="text-align: right">3.1k</td><td style="text-align: right">169</td><td style="text-align: right">181</td></tr>
<tr><td>AES-256</td><td style="text-align: right">4.0k</td><td style="text-align: right">191</td><td style="text-align: right">203</td></tr>
</tbody></table>
</div>
<h2 id="build-steps"><a class="header" href="#build-steps">Build steps</a></h2>
<p>Object code:</p>
<pre><code>$ gcc -O3 ctaes.c -c -o ctaes.o
</code></pre>
<p>Tests:</p>
<pre><code>$ gcc -O3 ctaes.c test.c -o test
</code></pre>
<p>Benchmark:</p>
<pre><code>$ gcc -O3 ctaes.c bench.c -o bench
</code></pre>
<h2 id="review"><a class="header" href="#review">Review</a></h2>
<p>Results of a formal review of the code can be found in http://bitcoin.sipa.be/ctaes/review.zip</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="internal-c-interfaces"><a class="header" href="#internal-c-interfaces">Internal c++ interfaces</a></h1>
<p>The following interfaces are defined here:</p>
<ul>
<li>
<p><a href="src/interfaces/chain.h"><code>Chain</code></a> â€” used by wallet to access blockchain and mempool state. Added in <a href="https://github.com/bitcoin/bitcoin/pull/14437">#14437</a>, <a href="https://github.com/bitcoin/bitcoin/pull/14711">#14711</a>, <a href="https://github.com/bitcoin/bitcoin/pull/15288">#15288</a>, and <a href="https://github.com/bitcoin/bitcoin/pull/10973">#10973</a>.</p>
</li>
<li>
<p><a href="src/interfaces/chain.h"><code>ChainClient</code></a> â€” used by node to start &amp; stop <code>Chain</code> clients. Added in <a href="https://github.com/bitcoin/bitcoin/pull/14437">#14437</a>.</p>
</li>
<li>
<p><a href="src/interfaces/node.h"><code>Node</code></a> â€” used by GUI to start &amp; stop bitcoin node. Added in <a href="https://github.com/bitcoin/bitcoin/pull/10244">#10244</a>.</p>
</li>
<li>
<p><a href="src/interfaces/wallet.h"><code>Wallet</code></a> â€” used by GUI to access wallets. Added in <a href="https://github.com/bitcoin/bitcoin/pull/10244">#10244</a>.</p>
</li>
<li>
<p><a href="src/interfaces/handler.h"><code>Handler</code></a> â€” returned by <code>handleEvent</code> methods on interfaces above and used to manage lifetimes of event handlers.</p>
</li>
<li>
<p><a href="src/interfaces/init.h"><code>Init</code></a> â€” used by multiprocess code to access interfaces above on startup. Added in <a href="https://github.com/bitcoin/bitcoin/pull/19160">#19160</a>.</p>
</li>
<li>
<p><a href="src/interfaces/ipc.h"><code>Ipc</code></a> â€” used by multiprocess code to access <code>Init</code> interface across processes. Added in <a href="https://github.com/bitcoin/bitcoin/pull/19160">#19160</a>.</p>
</li>
</ul>
<p>The interfaces above define boundaries between major components of bitcoin code (node, wallet, and gui), making it possible for them to run in <a href="src/interfaces/../../doc/multiprocess.html">different processes</a>, and be tested, developed, and understood independently. These interfaces are not currently designed to be stable or to be used externally.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="srcnode"><a class="header" href="#srcnode">src/node/</a></h1>
<p>The <a href="src/node/./"><code>src/node/</code></a> directory contains code that needs to access node state
(state in <code>CChain</code>, <code>CBlockIndex</code>, <code>CCoinsView</code>, <code>CTxMemPool</code>, and similar
classes).</p>
<p>Code in <a href="src/node/./"><code>src/node/</code></a> is meant to be segregated from code in
<a href="src/node/../wallet/"><code>src/wallet/</code></a> and <a href="src/node/../qt/"><code>src/qt/</code></a>, to ensure wallet and GUI
code changes don't interfere with node operation, to allow wallet and GUI code
to run in separate processes, and to perhaps eventually allow wallet and GUI
code to be maintained in separate source repositories.</p>
<p>As a rule of thumb, code in one of the <a href="src/node/./"><code>src/node/</code></a>,
<a href="src/node/../wallet/"><code>src/wallet/</code></a>, or <a href="src/node/../qt/"><code>src/qt/</code></a> directories should avoid
calling code in the other directories directly, and only invoke it indirectly
through the more limited <a href="src/node/../interfaces/"><code>src/interfaces/</code></a> classes.</p>
<p>This directory is at the moment
sparsely populated. Eventually more substantial files like
<a href="src/node/../validation.cpp"><code>src/validation.cpp</code></a> and
<a href="src/node/../txmempool.cpp"><code>src/txmempool.cpp</code></a> might be moved there.</p>
<div style="break-before: page; page-break-before: always;"></div><p>This directory contains the source code for the Bitcoin Core graphical user interface (GUI). It uses the <a href="https://www1.qt.io/developers/">Qt</a> cross-platform framework.</p>
<p>The current precise version for Qt 5 is specified in <a href="src/qt//depends/packages/qt.mk">qt.mk</a>.</p>
<h2 id="compile-and-run"><a class="header" href="#compile-and-run">Compile and run</a></h2>
<p>See build instructions: <a href="src/qt//doc/build-unix.html">Unix</a>, <a href="src/qt//doc/build-osx.html">macOS</a>, <a href="src/qt//doc/build-windows-msvc.html">Windows</a>, <a href="src/qt//doc/build-freebsd.html">FreeBSD</a>, <a href="src/qt//doc/build-netbsd.html">NetBSD</a>, <a href="src/qt//doc/build-openbsd.html">OpenBSD</a></p>
<p>When following your systems build instructions, make sure to install the <code>Qt</code> dependencies.</p>
<p>To run:</p>
<pre><code class="language-sh">./build/src/qt/bitcoin-qt
</code></pre>
<h2 id="files-and-directories"><a class="header" href="#files-and-directories">Files and Directories</a></h2>
<h4 id="forms"><a class="header" href="#forms">forms/</a></h4>
<ul>
<li>A directory that contains <a href="https://doc.qt.io/qt-5.9/designer-using-a-ui-file.html">Designer UI</a> files. These files specify the characteristics of form elements in XML. Qt UI files can be edited with <a href="src/qt/index.html#using-qt-creator-as-ide">Qt Creator</a> or using any text editor.</li>
</ul>
<h4 id="locale"><a class="header" href="#locale">locale/</a></h4>
<ul>
<li>Contains translations. They are periodically updated and an effort is made to support as many languages as possible. The process of contributing translations is described in <a href="src/qt//doc/translation_process.html">doc/translation_process.md</a>.</li>
</ul>
<h4 id="res"><a class="header" href="#res">res/</a></h4>
<ul>
<li>Contains graphical resources used to enhance the UI experience.</li>
</ul>
<h4 id="test-1"><a class="header" href="#test-1">test/</a></h4>
<ul>
<li>Functional tests used to ensure proper functionality of the GUI. Significant changes to the GUI code normally require new or updated tests.</li>
</ul>
<h4 id="bitcoinguihcpp"><a class="header" href="#bitcoinguihcpp">bitcoingui.(h/cpp)</a></h4>
<ul>
<li>Represents the main window of the Bitcoin UI.</li>
</ul>
<h4 id="modelhcpp"><a class="header" href="#modelhcpp">*model.(h/cpp)</a></h4>
<ul>
<li>The model. When it has a corresponding controller, it generally inherits from  <a href="https://doc.qt.io/qt-5/qabstracttablemodel.html">QAbstractTableModel</a>. Models that are used by controllers as helpers inherit from other Qt classes like <a href="https://doc.qt.io/qt-5/qvalidator.html">QValidator</a>.</li>
<li>ClientModel is used by the main application <code>bitcoingui</code> and several models like <code>peertablemodel</code>.</li>
</ul>
<h4 id="pagehcpp"><a class="header" href="#pagehcpp">*page.(h/cpp)</a></h4>
<ul>
<li>A controller. <code>:NAMEpage.cpp</code> generally includes <code>:NAMEmodel.h</code> and <code>forms/:NAME.page.ui</code> with a similar <code>:NAME</code>.</li>
</ul>
<h4 id="dialoghcpp"><a class="header" href="#dialoghcpp">*dialog.(h/cpp)</a></h4>
<ul>
<li>Various dialogs, e.g. to open a URL. Inherit from <a href="https://doc.qt.io/qt-5/qdialog.html">QDialog</a>.</li>
</ul>
<h4 id="paymentserverhcpp"><a class="header" href="#paymentserverhcpp">paymentserver.(h/cpp)</a></h4>
<ul>
<li>(Deprecated) Used to process BIP21 payment URI requests. Also handles URI-based application switching (e.g. when following a bitcoin:... link from a browser).</li>
</ul>
<h4 id="walletviewhcpp"><a class="header" href="#walletviewhcpp">walletview.(h/cpp)</a></h4>
<ul>
<li>Represents the view to a single wallet.</li>
</ul>
<h4 id="other-hcpp-files"><a class="header" href="#other-hcpp-files">Other .h/cpp files</a></h4>
<ul>
<li>UI elements like BitcoinAmountField, which inherit from QWidget.</li>
<li><code>bitcoinstrings.cpp</code>: automatically generated</li>
<li><code>bitcoinunits.(h/cpp)</code>: BTC / mBTC / etc. handling</li>
<li><code>callback.h</code></li>
<li><code>guiconstants.h</code>: UI colors, app name, etc.</li>
<li><code>guiutil.h</code>: several helper functions</li>
<li><code>macdockiconhandler.(h/mm)</code>: macOS dock icon handler</li>
<li><code>macnotificationhandler.(h/mm)</code>: display notifications in macOS</li>
</ul>
<h2 id="contribute"><a class="header" href="#contribute">Contribute</a></h2>
<p>See <a href="src/qt//CONTRIBUTING.html">CONTRIBUTING.md</a> for general guidelines.</p>
<p><strong>Note:</strong> Do not change <code>local/bitcoin_en.ts</code>. It is updated <a href="src/qt//doc/translation_process.html#writing-code-with-translations">automatically</a>.</p>
<h2 id="using-qt-creator-as-an-ide"><a class="header" href="#using-qt-creator-as-an-ide">Using Qt Creator as an IDE</a></h2>
<p><a href="https://www.qt.io/product/development-tools">Qt Creator</a> is a powerful tool which packages a UI designer tool (Qt Designer) and a C++ IDE into one application. This is especially useful if you want to change the UI layout.</p>
<h4 id="download-qt-creator"><a class="header" href="#download-qt-creator">Download Qt Creator</a></h4>
<p>On Unix and macOS, Qt Creator can be installed through your package manager. Alternatively, you can download a binary from the <a href="https://www.qt.io/download/">Qt Website</a>.</p>
<p><strong>Note:</strong> If installing from a binary grabbed from the Qt Website: During the installation process, uncheck everything except for <code>Qt Creator</code>.</p>
<h5 id="macos-3"><a class="header" href="#macos-3">macOS</a></h5>
<pre><code class="language-sh">brew install qt-creator
</code></pre>
<h5 id="ubuntu--debian-1"><a class="header" href="#ubuntu--debian-1">Ubuntu &amp; Debian</a></h5>
<pre><code class="language-sh">sudo apt-get install qtcreator
</code></pre>
<h4 id="setup-qt-creator"><a class="header" href="#setup-qt-creator">Setup Qt Creator</a></h4>
<ol>
<li>Make sure you've installed all dependencies specified in your systems build instructions</li>
<li>Follow the compile instructions for your system, adding the <code>-DCMAKE_BUILD_TYPE=Debug</code> build flag</li>
<li>Start Qt Creator. At the start page, do: <code>New</code> -&gt; <code>Import Project</code> -&gt; <code>Import Existing Project</code></li>
<li>Enter <code>bitcoin-qt</code> as the Project Name and enter the absolute path to <code>src/qt</code> as Location</li>
<li>Check over the file selection, you may need to select the <code>forms</code> directory (necessary if you intend to edit *.ui files)</li>
<li>Confirm the <code>Summary</code> page</li>
<li>In the <code>Projects</code> tab, select <code>Manage Kits...</code></li>
</ol>
<p><strong>macOS</strong></p>
<ul>
<li>Under <code>Kits</code>: select the default "Desktop" kit</li>
<li>Under <code>Compilers</code>: select <code>"Clang (x86 64bit in /usr/bin)"</code></li>
<li>Under <code>Debuggers</code>: select <code>"LLDB"</code> as debugger (you might need to set the path to your LLDB installation)</li>
</ul>
<p><strong>Ubuntu &amp; Debian</strong></p>
<p>Note: Some of these options may already be set</p>
<ul>
<li>Under <code>Kits</code>: select the default "Desktop" kit</li>
<li>Under <code>Compilers</code>: select <code>"GCC (x86 64bit in /usr/bin)"</code></li>
<li>Under <code>Debuggers</code>: select <code>"GDB"</code> as debugger</li>
</ul>
<ol start="8">
<li>While in the <code>Projects</code> tab, ensure that you have the <code>bitcoin-qt</code> executable specified under <code>Run</code></li>
</ol>
<ul>
<li>If the executable is not specified: click <code>"Choose..."</code>, navigate to <code>src/qt</code>, and select <code>bitcoin-qt</code></li>
</ul>
<ol start="9">
<li>You're all set! Start developing, building, and debugging the Bitcoin Core GUI</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="unit-tests"><a class="header" href="#unit-tests">Unit tests</a></h1>
<p>The sources in this directory are unit test cases. Boost includes a
unit testing framework, and since Bitcoin Core already uses Boost, it makes
sense to simply use this framework rather than require developers to
configure some other framework (we want as few impediments to creating
unit tests as possible).</p>
<p>The build system is set up to compile an executable called <code>test_bitcoin</code>
that runs all of the unit tests. The main source file for the test library is found in
<code>util/setup_common.cpp</code>.</p>
<p>The examples in this document assume the build directory is named
<code>build</code>. You'll need to adapt them if you named it differently.</p>
<h3 id="compilingrunning-unit-tests"><a class="header" href="#compilingrunning-unit-tests">Compiling/running unit tests</a></h3>
<p>Unit tests will be automatically compiled if dependencies were met
during the generation of the Bitcoin Core build system
and tests weren't explicitly disabled.</p>
<p>The unit tests can be run with <code>ctest --test-dir build</code>, which includes unit
tests from subtrees.</p>
<p>Run <code>test_bitcoin --list_content</code> for the full list of tests.</p>
<p>To run the unit tests manually, launch <code>build/src/test/test_bitcoin</code>. To recompile
after a test file was modified, run <code>cmake --build build</code> and then run the test again. If you
modify a non-test file, use <code>cmake --build build --target test_bitcoin</code> to recompile only what's needed
to run the unit tests.</p>
<p>To add more unit tests, add <code>BOOST_AUTO_TEST_CASE</code> functions to the existing
.cpp files in the <code>test/</code> directory or add new .cpp files that
implement new <code>BOOST_AUTO_TEST_SUITE</code> sections.</p>
<p>To run the GUI unit tests manually, launch <code>build/src/qt/test/test_bitcoin-qt</code></p>
<p>To add more GUI unit tests, add them to the <code>src/qt/test/</code> directory and
the <code>src/qt/test/test_main.cpp</code> file.</p>
<h3 id="running-individual-tests"><a class="header" href="#running-individual-tests">Running individual tests</a></h3>
<p>The <code>test_bitcoin</code> runner accepts command line arguments from the Boost
framework. To see the list of arguments that may be passed, run:</p>
<pre><code>test_bitcoin --help
</code></pre>
<p>For example, to run only the tests in the <code>getarg_tests</code> file, with full logging:</p>
<pre><code class="language-bash">build/src/test/test_bitcoin --log_level=all --run_test=getarg_tests
</code></pre>
<p>or</p>
<pre><code class="language-bash">build/src/test/test_bitcoin -l all -t getarg_tests
</code></pre>
<p>or to run only the doubledash test in <code>getarg_tests</code></p>
<pre><code class="language-bash">build/src/test/test_bitcoin --run_test=getarg_tests/doubledash
</code></pre>
<p>The <code>--log_level=</code> (or <code>-l</code>) argument controls the verbosity of the test output.</p>
<p>The <code>test_bitcoin</code> runner also accepts some of the command line arguments accepted by
<code>bitcoind</code>. Use <code>--</code> to separate these sets of arguments:</p>
<pre><code class="language-bash">build/src/test/test_bitcoin --log_level=all --run_test=getarg_tests -- -printtoconsole=1
</code></pre>
<p>The <code>-printtoconsole=1</code> after the two dashes sends debug logging, which
normally goes only to <code>debug.log</code> within the data directory, to the
standard terminal output as well.</p>
<p>Running <code>test_bitcoin</code> creates a temporary working (data) directory with a randomly
generated pathname within <code>test_common bitcoin/</code>, which in turn is within
the system's temporary directory (see
<a href="https://en.cppreference.com/w/cpp/filesystem/temp_directory_path"><code>temp_directory_path</code></a>).
This data directory looks like a simplified form of the standard <code>bitcoind</code> data
directory. Its content will vary depending on the test, but it will always
have a <code>debug.log</code> file, for example.</p>
<p>The location of the temporary data directory can be specified with the
<code>-testdatadir</code> option. This can make debugging easier. The directory
path used is the argument path appended with
<code>/test_common bitcoin/&lt;test-name&gt;/datadir</code>.
The directory path is created if necessary.
Specifying this argument also causes the data directory
not to be removed after the last test. This is useful for looking at
what the test wrote to <code>debug.log</code> after it completes, for example.
(The directory is removed at the start of the next test run,
so no leftover state is used.)</p>
<pre><code class="language-bash">$ build/src/test/test_bitcoin --run_test=getarg_tests/doubledash -- -testdatadir=/somewhere/mydatadir
Test directory (will not be deleted): "/somewhere/mydatadir/test_common bitcoin/getarg_tests/doubledash/datadir"
Running 1 test case...

*** No errors detected
$ ls -l '/somewhere/mydatadir/test_common bitcoin/getarg_tests/doubledash/datadir'
total 8
drwxrwxr-x 2 admin admin 4096 Nov 27 22:45 blocks
-rw-rw-r-- 1 admin admin 1003 Nov 27 22:45 debug.log
</code></pre>
<p>If you run an entire test suite, such as <code>--run_test=getarg_tests</code>, or all the test suites
(by not specifying <code>--run_test</code>), a separate directory
will be created for each individual test.</p>
<h3 id="adding-test-cases"><a class="header" href="#adding-test-cases">Adding test cases</a></h3>
<p>To add a new unit test file to our test suite, you need
to add the file to either <code>src/test/CMakeLists.txt</code> or
<code>src/wallet/test/CMakeLists.txt</code> for wallet-related tests. The pattern is to create
one test file for each class or source file for which you want to create
unit tests. The file naming convention is <code>&lt;source_filename&gt;_tests.cpp</code>
and such files should wrap their tests in a test suite
called <code>&lt;source_filename&gt;_tests</code>. For an example of this pattern,
see <code>uint256_tests.cpp</code>.</p>
<h3 id="logging-and-debugging-in-unit-tests"><a class="header" href="#logging-and-debugging-in-unit-tests">Logging and debugging in unit tests</a></h3>
<p><code>ctest --test-dir build</code> will write to the log file <code>build/Testing/Temporary/LastTest.log</code>. You can
additionally use the <code>--output-on-failure</code> option to display logs of the failed tests automatically
on failure. For running individual tests verbosely, refer to the section
<a href="src/test/index.html#running-individual-tests">above</a>.</p>
<p>To write to logs from unit tests you need to use specific message methods
provided by Boost. The simplest is <code>BOOST_TEST_MESSAGE</code>.</p>
<p>For debugging you can launch the <code>test_bitcoin</code> executable with <code>gdb</code> or <code>lldb</code> and
start debugging, just like you would with any other program:</p>
<pre><code class="language-bash">gdb build/src/test/test_bitcoin
</code></pre>
<h4 id="segmentation-faults"><a class="header" href="#segmentation-faults">Segmentation faults</a></h4>
<p>If you hit a segmentation fault during a test run, you can diagnose where the fault
is happening by running <code>gdb ./build/src/test/test_bitcoin</code> and then using the <code>bt</code> command
within gdb.</p>
<p>Another tool that can be used to resolve segmentation faults is
<a href="https://valgrind.org/">valgrind</a>.</p>
<p>If for whatever reason you want to produce a core dump file for this fault, you can do
that as well. By default, the boost test runner will intercept system errors and not
produce a core file. To bypass this, add <code>--catch_system_errors=no</code> to the
<code>test_bitcoin</code> arguments and ensure that your ulimits are set properly (e.g. <code>ulimit -c unlimited</code>).</p>
<p>Running the tests and hitting a segmentation fault should now produce a file called <code>core</code>
(on Linux platforms, the file name will likely depend on the contents of
<code>/proc/sys/kernel/core_pattern</code>).</p>
<p>You can then explore the core dump using</p>
<pre><code class="language-bash">gdb build/src/test/test_bitcoin core

(gdb) bt  # produce a backtrace for where a segfault occurred
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="description"><a class="header" href="#description">Description</a></h2>
<p>This directory contains data-driven tests for various aspects of Bitcoin.</p>
<h2 id="license-3"><a class="header" href="#license-3">License</a></h2>
<p>The data files in this directory are distributed under the MIT software
license, see the accompanying file COPYING or
https://www.opensource.org/licenses/mit-license.php.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="test-library"><a class="header" href="#test-library">Test library</a></h1>
<p>This contains files for the test library, which is used by the test binaries (unit tests, benchmarks, fuzzers, gui
tests).</p>
<p>Generally, the files in this folder should be well-separated modules. New code should be added to existing modules or
(when in doubt) a new module should be created.</p>
<p>The utilities in here are compiled into a library, which does not hold any state. However, the main file <code>setup_common</code>
defines the common test setup for all test binaries. The test binaries will handle the global state when they
instantiate the <code>BasicTestingSetup</code> (or one of its derived classes).</p>
<div style="break-before: page; page-break-before: always;"></div><p>This directory contains integration tests that test bitcoind and its
utilities in their entirety. It does not contain unit tests, which
can be found in <a href="test//src/test">/src/test</a>, <a href="test//src/wallet/test">/src/wallet/test</a>,
etc.</p>
<p>This directory contains the following sets of tests:</p>
<ul>
<li><a href="test//test/fuzz">fuzz</a> A runner to execute all fuzz targets from
<a href="test//src/test/fuzz">/src/test/fuzz</a>.</li>
<li><a href="test//test/functional">functional</a> which test the functionality of
bitcoind and bitcoin-qt by interacting with them through the RPC and P2P
interfaces.</li>
<li><a href="test//test/util">util</a> which tests the utilities (bitcoin-util, bitcoin-tx, ...).</li>
<li><a href="test//test/lint/">lint</a> which perform various static analysis checks.</li>
</ul>
<p>The util tests are run as part of <code>ctest</code> invocation. The fuzz tests, functional
tests and lint scripts can be run as explained in the sections below.</p>
<h1 id="running-tests-locally"><a class="header" href="#running-tests-locally">Running tests locally</a></h1>
<p>Before tests can be run locally, Bitcoin Core must be built.  See the <a href="test//doc#building">building instructions</a> for help.</p>
<p>The following examples assume that the build directory is named <code>build</code>.</p>
<h2 id="fuzz-tests"><a class="header" href="#fuzz-tests">Fuzz tests</a></h2>
<p>See <a href="test//doc/fuzzing.html">/doc/fuzzing.md</a></p>
<h3 id="functional-tests"><a class="header" href="#functional-tests">Functional tests</a></h3>
<h4 id="dependencies-and-prerequisites"><a class="header" href="#dependencies-and-prerequisites">Dependencies and prerequisites</a></h4>
<p>The ZMQ functional test requires a python ZMQ library. To install it:</p>
<ul>
<li>on Unix, run <code>sudo apt-get install python3-zmq</code></li>
<li>on mac OS, run <code>pip3 install pyzmq</code></li>
</ul>
<p>On Windows the <code>PYTHONUTF8</code> environment variable must be set to 1:</p>
<pre><code class="language-cmd">set PYTHONUTF8=1
</code></pre>
<h4 id="running-the-tests"><a class="header" href="#running-the-tests">Running the tests</a></h4>
<p>Individual tests can be run by directly calling the test script, e.g.:</p>
<pre><code>build/test/functional/feature_rbf.py
</code></pre>
<p>or can be run through the test_runner harness, eg:</p>
<pre><code>build/test/functional/test_runner.py feature_rbf.py
</code></pre>
<p>You can run any combination (incl. duplicates) of tests by calling:</p>
<pre><code>build/test/functional/test_runner.py &lt;testname1&gt; &lt;testname2&gt; &lt;testname3&gt; ...
</code></pre>
<p>Wildcard test names can be passed, if the paths are coherent and the test runner
is called from a <code>bash</code> shell or similar that does the globbing. For example,
to run all the wallet tests:</p>
<pre><code>build/test/functional/test_runner.py test/functional/wallet*
functional/test_runner.py functional/wallet*  # (called from the build/test/ directory)
test_runner.py wallet*  # (called from the build/test/functional/ directory)
</code></pre>
<p>but not</p>
<pre><code>build/test/functional/test_runner.py wallet*
</code></pre>
<p>Combinations of wildcards can be passed:</p>
<pre><code>build/test/functional/test_runner.py ./test/functional/tool* test/functional/mempool*
test_runner.py tool* mempool*
</code></pre>
<p>Run the regression test suite with:</p>
<pre><code>build/test/functional/test_runner.py
</code></pre>
<p>Run all possible tests with</p>
<pre><code>build/test/functional/test_runner.py --extended
</code></pre>
<p>In order to run backwards compatibility tests, first run:</p>
<pre><code>test/get_previous_releases.py -b
</code></pre>
<p>to download the necessary previous release binaries.</p>
<p>By default, up to 4 tests will be run in parallel by test_runner. To specify
how many jobs to run, append <code>--jobs=n</code></p>
<p>The individual tests and the test_runner harness have many command-line
options. Run <code>build/test/functional/test_runner.py -h</code> to see them all.</p>
<h4 id="speed-up-test-runs-with-a-ram-disk"><a class="header" href="#speed-up-test-runs-with-a-ram-disk">Speed up test runs with a RAM disk</a></h4>
<p>If you have available RAM on your system you can create a RAM disk to use as the <code>cache</code> and <code>tmp</code> directories for the functional tests in order to speed them up.
Speed-up amount varies on each system (and according to your RAM speed and other variables), but a 2-3x speed-up is not uncommon.</p>
<p><strong>Linux</strong></p>
<p>To create a 4 GiB RAM disk at <code>/mnt/tmp/</code>:</p>
<pre><code class="language-bash">sudo mkdir -p /mnt/tmp
sudo mount -t tmpfs -o size=4g tmpfs /mnt/tmp/
</code></pre>
<p>Configure the size of the RAM disk using the <code>size=</code> option.
The size of the RAM disk needed is relative to the number of concurrent jobs the test suite runs.
For example running the test suite with <code>--jobs=100</code> might need a 4 GiB RAM disk, but running with <code>--jobs=32</code> will only need a 2.5 GiB RAM disk.</p>
<p>To use, run the test suite specifying the RAM disk as the <code>cachedir</code> and <code>tmpdir</code>:</p>
<pre><code class="language-bash">build/test/functional/test_runner.py --cachedir=/mnt/tmp/cache --tmpdir=/mnt/tmp
</code></pre>
<p>Once finished with the tests and the disk, and to free the RAM, simply unmount the disk:</p>
<pre><code class="language-bash">sudo umount /mnt/tmp
</code></pre>
<p><strong>macOS</strong></p>
<p>To create a 4 GiB RAM disk named "ramdisk" at <code>/Volumes/ramdisk/</code>:</p>
<pre><code class="language-bash">diskutil erasevolume HFS+ ramdisk $(hdiutil attach -nomount ram://8388608)
</code></pre>
<p>Configure the RAM disk size, expressed as the number of blocks, at the end of the command
(<code>4096 MiB * 2048 blocks/MiB = 8388608 blocks</code> for 4 GiB). To run the tests using the RAM disk:</p>
<pre><code class="language-bash">build/test/functional/test_runner.py --cachedir=/Volumes/ramdisk/cache --tmpdir=/Volumes/ramdisk/tmp
</code></pre>
<p>To unmount:</p>
<pre><code class="language-bash">umount /Volumes/ramdisk
</code></pre>
<h4 id="troubleshooting-and-debugging-test-failures"><a class="header" href="#troubleshooting-and-debugging-test-failures">Troubleshooting and debugging test failures</a></h4>
<h5 id="resource-contention"><a class="header" href="#resource-contention">Resource contention</a></h5>
<p>The P2P and RPC ports used by the bitcoind nodes-under-test are chosen to make
conflicts with other processes unlikely. However, if there is another bitcoind
process running on the system (perhaps from a previous test which hasn't successfully
killed all its bitcoind nodes), then there may be a port conflict which will
cause the test to fail. It is recommended that you run the tests on a system
where no other bitcoind processes are running.</p>
<p>On linux, the test framework will warn if there is another
bitcoind process running when the tests are started.</p>
<p>If there are zombie bitcoind processes after test failure, you can kill them
by running the following commands. <strong>Note that these commands will kill all
bitcoind processes running on the system, so should not be used if any non-test
bitcoind processes are being run.</strong></p>
<pre><code class="language-bash">killall bitcoind
</code></pre>
<p>or</p>
<pre><code class="language-bash">pkill -9 bitcoind
</code></pre>
<h5 id="data-directory-cache"><a class="header" href="#data-directory-cache">Data directory cache</a></h5>
<p>A pre-mined blockchain with 200 blocks is generated the first time a
functional test is run and is stored in build/test/cache. This speeds up
test startup times since new blockchains don't need to be generated for
each test. However, the cache may get into a bad state, in which case
tests will fail. If this happens, remove the cache directory (and make
sure bitcoind processes are stopped as above):</p>
<pre><code class="language-bash">rm -rf build/test/cache
killall bitcoind
</code></pre>
<h5 id="test-logging"><a class="header" href="#test-logging">Test logging</a></h5>
<p>The tests contain logging at five different levels (DEBUG, INFO, WARNING, ERROR
and CRITICAL). From within your functional tests you can log to these different
levels using the logger included in the test_framework, e.g.
<code>self.log.debug(object)</code>. By default:</p>
<ul>
<li>when run through the test_runner harness, <em>all</em> logs are written to
<code>test_framework.log</code> and no logs are output to the console.</li>
<li>when run directly, <em>all</em> logs are written to <code>test_framework.log</code> and INFO
level and above are output to the console.</li>
<li>when run by <a href="test//ci/README.html">our CI (Continuous Integration)</a>, no logs are output to the console. However, if a test
fails, the <code>test_framework.log</code> and bitcoind <code>debug.log</code>s will all be dumped
to the console to help troubleshooting.</li>
</ul>
<p>These log files can be located under the test data directory (which is always
printed in the first line of test output):</p>
<ul>
<li><code>&lt;test data directory&gt;/test_framework.log</code></li>
<li><code>&lt;test data directory&gt;/node&lt;node number&gt;/regtest/debug.log</code>.</li>
</ul>
<p>The node number identifies the relevant test node, starting from <code>node0</code>, which
corresponds to its position in the nodes list of the specific test,
e.g. <code>self.nodes[0]</code>.</p>
<p>To change the level of logs output to the console, use the <code>-l</code> command line
argument.</p>
<p><code>test_framework.log</code> and bitcoind <code>debug.log</code>s can be combined into a single
aggregate log by running the <code>combine_logs.py</code> script. The output can be plain
text, colorized text or html. For example:</p>
<pre><code>build/test/functional/combine_logs.py -c &lt;test data directory&gt; | less -r
</code></pre>
<p>will pipe the colorized logs from the test into less.</p>
<p>Use <code>--tracerpc</code> to trace out all the RPC calls and responses to the console. For
some tests (eg any that use <code>submitblock</code> to submit a full block over RPC),
this can result in a lot of screen output.</p>
<p>By default, the test data directory will be deleted after a successful run.
Use <code>--nocleanup</code> to leave the test data directory intact. The test data
directory is never deleted after a failed test.</p>
<h5 id="attaching-a-debugger"><a class="header" href="#attaching-a-debugger">Attaching a debugger</a></h5>
<p>A python debugger can be attached to tests at any point. Just add the line:</p>
<pre><code class="language-py">import pdb; pdb.set_trace()
</code></pre>
<p>anywhere in the test. You will then be able to inspect variables, as well as
call methods that interact with the bitcoind nodes-under-test.</p>
<p>If further introspection of the bitcoind instances themselves becomes
necessary, this can be accomplished by first setting a pdb breakpoint
at an appropriate location, running the test to that point, then using
<code>gdb</code> (or <code>lldb</code> on macOS) to attach to the process and debug.</p>
<p>For instance, to attach to <code>self.node[1]</code> during a run you can get
the pid of the node within <code>pdb</code>.</p>
<pre><code>(pdb) self.node[1].process.pid
</code></pre>
<p>Alternatively, you can find the pid by inspecting the temp folder for the specific test
you are running. The path to that folder is printed at the beginning of every
test run:</p>
<pre><code class="language-bash">2017-06-27 14:13:56.686000 TestFramework (INFO): Initializing test directory /tmp/user/1000/testo9vsdjo3
</code></pre>
<p>Use the path to find the pid file in the temp folder:</p>
<pre><code class="language-bash">cat /tmp/user/1000/testo9vsdjo3/node1/regtest/bitcoind.pid
</code></pre>
<p>Then you can use the pid to start <code>gdb</code>:</p>
<pre><code class="language-bash">gdb /home/example/bitcoind &lt;pid&gt;
</code></pre>
<p>Note: gdb attach step may require ptrace_scope to be modified, or <code>sudo</code> preceding the <code>gdb</code>.
See this link for considerations: https://www.kernel.org/doc/Documentation/security/Yama.txt</p>
<p>Often while debugging RPC calls in functional tests, the test might time out before the
process can return a response. Use <code>--timeout-factor 0</code> to disable all RPC timeouts for that particular
functional test. Ex: <code>build/test/functional/wallet_hd.py --timeout-factor 0</code>.</p>
<h5 id="profiling"><a class="header" href="#profiling">Profiling</a></h5>
<p>An easy way to profile node performance during functional tests is provided
for Linux platforms using <code>perf</code>.</p>
<p>Perf will sample the running node and will generate profile data in the node's
datadir. The profile data can then be presented using <code>perf report</code> or a graphical
tool like <a href="https://github.com/KDAB/hotspot">hotspot</a>.</p>
<p>To generate a profile during test suite runs, use the <code>--perf</code> flag.</p>
<p>To see render the output to text, run</p>
<pre><code class="language-sh">perf report -i /path/to/datadir/send-big-msgs.perf.data.xxxx --stdio | c++filt | less
</code></pre>
<p>For ways to generate more granular profiles, see the README in
<a href="test//test/functional">test/functional</a>.</p>
<h3 id="util-tests"><a class="header" href="#util-tests">Util tests</a></h3>
<p>Util tests can be run locally by running <code>build/test/util/test_runner.py</code>.
Use the <code>-v</code> option for verbose output.</p>
<h3 id="lint-tests"><a class="header" href="#lint-tests">Lint tests</a></h3>
<p>See the README in <a href="test//test/lint">test/lint</a>.</p>
<h1 id="writing-functional-tests"><a class="header" href="#writing-functional-tests">Writing functional tests</a></h1>
<p>You are encouraged to write functional tests for new or existing features.
Further information about the functional test framework and individual
tests is found in <a href="test//test/functional">test/functional</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="functional-tests-1"><a class="header" href="#functional-tests-1">Functional tests</a></h1>
<h3 id="writing-functional-tests-1"><a class="header" href="#writing-functional-tests-1">Writing Functional Tests</a></h3>
<h4 id="example-test"><a class="header" href="#example-test">Example test</a></h4>
<p>The file <a href="test/functional/example_test.py">test/functional/example_test.py</a> is a heavily commented example
of a test case that uses both the RPC and P2P interfaces. If you are writing your first test, copy
that file and modify to fit your needs.</p>
<h4 id="coverage"><a class="header" href="#coverage">Coverage</a></h4>
<p>Assuming the build directory is <code>build</code>,
running <code>build/test/functional/test_runner.py</code> with the <code>--coverage</code> argument tracks which RPCs are
called by the tests and prints a report of uncovered RPCs in the summary. This
can be used (along with the <code>--extended</code> argument) to find out which RPCs we
don't have test cases for.</p>
<h4 id="style-guidelines"><a class="header" href="#style-guidelines">Style guidelines</a></h4>
<ul>
<li>Where possible, try to adhere to <a href="https://www.python.org/dev/peps/pep-0008/">PEP-8 guidelines</a></li>
<li>Use a python linter like flake8 before submitting PRs to catch common style
nits (eg trailing whitespace, unused imports, etc)</li>
<li>The oldest supported Python version is specified in <a href="test/functional//doc/dependencies.html">doc/dependencies.md</a>.
Consider using <a href="https://github.com/pyenv/pyenv">pyenv</a>, which checks <a href="test/functional//.python-version">.python-version</a>,
to prevent accidentally introducing modern syntax from an unsupported Python version.
The CI linter job also checks this, but <a href="https://github.com/bitcoin/bitcoin/pull/14884#discussion_r239585126">possibly not in all cases</a>.</li>
<li>See <a href="test/functional//test/lint/lint-python.py">the python lint script</a> that checks for violations that
could lead to bugs and issues in the test code.</li>
<li>Use <a href="https://docs.python.org/3/library/typing.html">type hints</a> in your code to improve code readability
and to detect possible bugs earlier.</li>
<li>Avoid wildcard imports.</li>
<li>If more than one name from a module is needed, use lexicographically sorted multi-line imports
in order to reduce the possibility of potential merge conflicts.</li>
<li>Use a module-level docstring to describe what the test is testing, and how it
is testing it.</li>
<li>When subclassing the BitcoinTestFramework, place overrides for the
<code>set_test_params()</code>, <code>add_options()</code> and <code>setup_xxxx()</code> methods at the top of
the subclass, then locally-defined helper methods, then the <code>run_test()</code> method.</li>
<li>Use <code>f'{x}'</code> for string formatting in preference to <code>'{}'.format(x)</code> or <code>'%s' % x</code>.</li>
<li>Use <code>platform.system()</code> for detecting the running operating system and <code>os.name</code> to
check whether it's a POSIX system (see also the <code>skip_if_platform_not_{linux,posix}</code>
methods in the <code>BitcoinTestFramework</code> class, which can be used to skip a whole test
depending on the platform).</li>
</ul>
<h4 id="naming-guidelines"><a class="header" href="#naming-guidelines">Naming guidelines</a></h4>
<ul>
<li>Name the test <code>&lt;area&gt;_test.py</code>, where area can be one of the following:
<ul>
<li><code>feature</code> for tests for full features that aren't wallet/mining/mempool, eg <code>feature_rbf.py</code></li>
<li><code>interface</code> for tests for other interfaces (REST, ZMQ, etc), eg <code>interface_rest.py</code></li>
<li><code>mempool</code> for tests for mempool behaviour, eg <code>mempool_reorg.py</code></li>
<li><code>mining</code> for tests for mining features, eg <code>mining_prioritisetransaction.py</code></li>
<li><code>p2p</code> for tests that explicitly test the p2p interface, eg <code>p2p_disconnect_ban.py</code></li>
<li><code>rpc</code> for tests for individual RPC methods or features, eg <code>rpc_listtransactions.py</code></li>
<li><code>tool</code> for tests for tools, eg <code>tool_wallet.py</code></li>
<li><code>wallet</code> for tests for wallet features, eg <code>wallet_keypool.py</code></li>
</ul>
</li>
<li>Use an underscore to separate words
<ul>
<li>exception: for tests for specific RPCs or command line options which don't include underscores, name the test after the exact RPC or argument name, eg <code>rpc_decodescript.py</code>, not <code>rpc_decode_script.py</code></li>
</ul>
</li>
<li>Don't use the redundant word <code>test</code> in the name, eg <code>interface_zmq.py</code>, not <code>interface_zmq_test.py</code></li>
</ul>
<h4 id="general-test-writing-advice"><a class="header" href="#general-test-writing-advice">General test-writing advice</a></h4>
<ul>
<li>Instead of inline comments or no test documentation at all, log the comments to the test log, e.g.
<code>self.log.info('Create enough transactions to fill a block')</code>. Logs make the test code easier to read and the test
logic easier <a href="test/functional//test/README.html#test-logging">to debug</a>.</li>
<li>Set <code>self.num_nodes</code> to the minimum number of nodes necessary for the test.
Having additional unrequired nodes adds to the execution time of the test as
well as memory/CPU/disk requirements (which is important when running tests in
parallel).</li>
<li>Avoid stop-starting the nodes multiple times during the test if possible. A
stop-start takes several seconds, so doing it several times blows up the
runtime of the test.</li>
<li>Set the <code>self.setup_clean_chain</code> variable in <code>set_test_params()</code> to <code>True</code> to
initialize an empty blockchain and start from the Genesis block, rather than
load a premined blockchain from cache with the default value of <code>False</code>. The
cached data directories contain a 200-block pre-mined blockchain with the
spendable mining rewards being split between four nodes. Each node has 25
mature block subsidies (25x50=1250 BTC) in its wallet. Using them is much more
efficient than mining blocks in your test.</li>
<li>When calling RPCs with lots of arguments, consider using named keyword
arguments instead of positional arguments to make the intent of the call
clear to readers.</li>
<li>Many of the core test framework classes such as <code>CBlock</code> and <code>CTransaction</code>
don't allow new attributes to be added to their objects at runtime like
typical Python objects allow. This helps prevent unpredictable side effects
from typographical errors or usage of the objects outside of their intended
purpose.</li>
</ul>
<h4 id="rpc-and-p2p-definitions"><a class="header" href="#rpc-and-p2p-definitions">RPC and P2P definitions</a></h4>
<p>Test writers may find it helpful to refer to the definitions for the RPC and
P2P messages. These can be found in the following source files:</p>
<ul>
<li><code>/src/rpc/*</code> for RPCs</li>
<li><code>/src/wallet/rpc*</code> for wallet RPCs</li>
<li><code>ProcessMessage()</code> in <code>/src/net_processing.cpp</code> for parsing P2P messages</li>
</ul>
<h4 id="using-the-p2p-interface"><a class="header" href="#using-the-p2p-interface">Using the P2P interface</a></h4>
<ul>
<li>
<p><code>P2P</code>s can be used to test specific P2P protocol behavior.
<a href="test/functional/test_framework/p2p.py">p2p.py</a> contains test framework p2p objects and
<a href="test/functional/test_framework/messages.py">messages.py</a> contains all the definitions for objects passed
over the network (<code>CBlock</code>, <code>CTransaction</code>, etc, along with the network-level
wrappers for them, <code>msg_block</code>, <code>msg_tx</code>, etc).</p>
</li>
<li>
<p>P2P tests have two threads. One thread handles all network communication
with the bitcoind(s) being tested in a callback-based event loop; the other
implements the test logic.</p>
</li>
<li>
<p><code>P2PConnection</code> is the class used to connect to a bitcoind.  <code>P2PInterface</code>
contains the higher level logic for processing P2P payloads and connecting to
the Bitcoin Core node application logic. For custom behaviour, subclass the
P2PInterface object and override the callback methods.</p>
</li>
</ul>
<p><code>P2PConnection</code>s can be used as such:</p>
<pre><code class="language-python">p2p_conn = node.add_p2p_connection(P2PInterface())
p2p_conn.send_and_ping(msg)
</code></pre>
<p>They can also be referenced by indexing into a <code>TestNode</code>'s <code>p2ps</code> list, which
contains the list of test framework <code>p2p</code> objects connected to itself
(it does not include any <code>TestNode</code>s):</p>
<pre><code class="language-python">node.p2ps[0].sync_with_ping()
</code></pre>
<p>More examples can be found in <a href="test/functional/p2p_unrequested_blocks.py">p2p_unrequested_blocks.py</a>,
<a href="test/functional/p2p_compactblocks.py">p2p_compactblocks.py</a>.</p>
<h4 id="prototyping-tests"><a class="header" href="#prototyping-tests">Prototyping tests</a></h4>
<p>The <a href="test/functional/test-shell.html"><code>TestShell</code></a> class exposes the BitcoinTestFramework
functionality to interactive Python3 environments and can be used to prototype
tests. This may be especially useful in a REPL environment with session logging
utilities, such as
<a href="https://ipython.readthedocs.io/en/stable/interactive/reference.html#session-logging-and-restoring">IPython</a>.
The logs of such interactive sessions can later be adapted into permanent test
cases.</p>
<h3 id="test-framework-modules"><a class="header" href="#test-framework-modules">Test framework modules</a></h3>
<p>The following are useful modules for test developers. They are located in
<a href="test/functional/test_framework">test/functional/test_framework/</a>.</p>
<h4 id="authproxypy"><a class="header" href="#authproxypy"><a href="test/functional/test_framework/authproxy.py">authproxy.py</a></a></h4>
<p>Taken from the <a href="https://github.com/jgarzik/python-bitcoinrpc">python-bitcoinrpc repository</a>.</p>
<h4 id="test_frameworkpy"><a class="header" href="#test_frameworkpy"><a href="test/functional/test_framework/test_framework.py">test_framework.py</a></a></h4>
<p>Base class for functional tests.</p>
<h4 id="utilpy"><a class="header" href="#utilpy"><a href="test/functional/test_framework/util.py">util.py</a></a></h4>
<p>Generally useful functions.</p>
<h4 id="p2ppy"><a class="header" href="#p2ppy"><a href="test/functional/test_framework/p2p.py">p2p.py</a></a></h4>
<p>Test objects for interacting with a bitcoind node over the p2p interface.</p>
<h4 id="scriptpy"><a class="header" href="#scriptpy"><a href="test/functional/test_framework/script.py">script.py</a></a></h4>
<p>Utilities for manipulating transaction scripts (originally from python-bitcoinlib)</p>
<h4 id="keypy"><a class="header" href="#keypy"><a href="test/functional/test_framework/key.py">key.py</a></a></h4>
<p>Test-only secp256k1 elliptic curve implementation</p>
<h4 id="blocktoolspy"><a class="header" href="#blocktoolspy"><a href="test/functional/test_framework/blocktools.py">blocktools.py</a></a></h4>
<p>Helper functions for creating blocks and transactions.</p>
<h3 id="benchmarking-with-perf"><a class="header" href="#benchmarking-with-perf">Benchmarking with perf</a></h3>
<p>An easy way to profile node performance during functional tests is provided
for Linux platforms using <code>perf</code>.</p>
<p>Perf will sample the running node and will generate profile data in the node's
datadir. The profile data can then be presented using <code>perf report</code> or a graphical
tool like <a href="https://github.com/KDAB/hotspot">hotspot</a>.</p>
<p>There are two ways of invoking perf: one is to use the <code>--perf</code> flag when
running tests, which will profile each node during the entire test run: perf
begins to profile when the node starts and ends when it shuts down. The other
way is the use the <code>profile_with_perf</code> context manager, e.g.</p>
<pre><code class="language-python">with node.profile_with_perf("send-big-msgs"):
    # Perform activity on the node you're interested in profiling, e.g.:
    for _ in range(10000):
        node.p2ps[0].send_message(some_large_message)
</code></pre>
<p>To see useful textual output, run</p>
<pre><code class="language-sh">perf report -i /path/to/datadir/send-big-msgs.perf.data.xxxx --stdio | c++filt | less
</code></pre>
<h4 id="see-also-1"><a class="header" href="#see-also-1">See also:</a></h4>
<ul>
<li><a href="https://askubuntu.com/q/50145">Installing perf</a></li>
<li><a href="https://www.brendangregg.com/perf.html">Perf examples</a></li>
<li><a href="https://github.com/KDAB/hotspot">Hotspot</a>: a GUI for perf output analysis</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="test-shell-for-interactive-environments"><a class="header" href="#test-shell-for-interactive-environments">Test Shell for Interactive Environments</a></h1>
<p>This document describes how to use the <code>TestShell</code> submodule in the functional
test suite.</p>
<p>The <code>TestShell</code> submodule extends the <code>BitcoinTestFramework</code> functionality to
external interactive environments for prototyping and educational purposes. Just
like <code>BitcoinTestFramework</code>, the <code>TestShell</code> allows the user to:</p>
<ul>
<li>Manage regtest bitcoind subprocesses.</li>
<li>Access RPC interfaces of the underlying bitcoind instances.</li>
<li>Log events to the functional test logging utility.</li>
</ul>
<p>The <code>TestShell</code> can be useful in interactive environments where it is necessary
to extend the object lifetime of the underlying <code>BitcoinTestFramework</code> between
user inputs. Such environments include the Python3 command line interpreter or
<a href="https://jupyter.org/">Jupyter</a> notebooks running a Python3 kernel.</p>
<h2 id="1-requirements"><a class="header" href="#1-requirements">1. Requirements</a></h2>
<ul>
<li>Python3</li>
<li><code>bitcoind</code> built in the same repository as the <code>TestShell</code>.</li>
</ul>
<h2 id="2-importing-testshell-from-the-bitcoin-core-repository"><a class="header" href="#2-importing-testshell-from-the-bitcoin-core-repository">2. Importing <code>TestShell</code> from the Bitcoin Core repository</a></h2>
<p>We can import the <code>TestShell</code> by adding the path of the Bitcoin Core
<code>test_framework</code> module to the beginning of the PATH variable, and then
importing the <code>TestShell</code> class from the <code>test_shell</code> sub-package.</p>
<pre><code>&gt;&gt;&gt; import sys
&gt;&gt;&gt; sys.path.insert(0, "/path/to/bitcoin/test/functional")
&gt;&gt;&gt; from test_framework.test_shell import TestShell
</code></pre>
<p>The following <code>TestShell</code> methods manage the lifetime of the underlying bitcoind
processes and logging utilities.</p>
<ul>
<li><code>TestShell().setup()</code></li>
<li><code>TestShell().shutdown()</code></li>
</ul>
<p>The <code>TestShell</code> inherits all <code>BitcoinTestFramework</code> members and methods, such
as:</p>
<ul>
<li><code>TestShell().nodes[index].rpc_method()</code></li>
<li><code>TestShell().log.info("Custom log message")</code></li>
</ul>
<p>The following sections demonstrate how to initialize, run, and shut down a
<code>TestShell</code> object.</p>
<h2 id="3-initializing-a-testshell-object"><a class="header" href="#3-initializing-a-testshell-object">3. Initializing a <code>TestShell</code> object</a></h2>
<pre><code>&gt;&gt;&gt; test = TestShell().setup(num_nodes=2, setup_clean_chain=True)
20XX-XX-XXTXX:XX:XX.XXXXXXX TestFramework (INFO): Initializing test directory /path/to/bitcoin_func_test_XXXXXXX
</code></pre>
<p>The <code>TestShell</code> forwards all functional test parameters of the parent
<code>BitcoinTestFramework</code> object. The full set of argument keywords which can be
used to initialize the <code>TestShell</code> can be found in <a href="test/functional/test-shell.html#custom-testshell-parameters">section
#6</a> of this document.</p>
<p><strong>Note: Running multiple instances of <code>TestShell</code> is not allowed.</strong> Running a
single process also ensures that logging remains consolidated in the same
temporary folder. If you need more bitcoind nodes than set by default (1),
simply increase the <code>num_nodes</code> parameter during setup.</p>
<pre><code>&gt;&gt;&gt; test2 = TestShell().setup()
TestShell is already running!
</code></pre>
<h2 id="4-interacting-with-the-testshell"><a class="header" href="#4-interacting-with-the-testshell">4. Interacting with the <code>TestShell</code></a></h2>
<p>Unlike the <code>BitcoinTestFramework</code> class, the <code>TestShell</code> keeps the underlying
Bitcoind subprocesses (nodes) and logging utilities running until the user
explicitly shuts down the <code>TestShell</code> object.</p>
<p>During the time between the <code>setup</code> and <code>shutdown</code> calls, all <code>bitcoind</code> node
processes and <code>BitcoinTestFramework</code> convenience methods can be accessed
interactively.</p>
<p><strong>Example: Mining a regtest chain</strong></p>
<p>By default, the <code>TestShell</code> nodes are initialized with a clean chain. This means
that each node of the <code>TestShell</code> is initialized with a block height of 0.</p>
<pre><code>&gt;&gt;&gt; test.nodes[0].getblockchaininfo()["blocks"]
0
</code></pre>
<p>We now let the first node generate 101 regtest blocks, and direct the coinbase
rewards to a wallet address owned by the mining node.</p>
<pre><code>&gt;&gt;&gt; test.nodes[0].createwallet('default')
{'name': 'default', 'warning': 'Empty string given as passphrase, wallet will not be encrypted.'}
&gt;&gt;&gt; address = test.nodes[0].getnewaddress()
&gt;&gt;&gt; test.generatetoaddress(test.nodes[0], 101, address)
['2b98dd0044aae6f1cca7f88a0acf366a4bfe053c7f7b00da3c0d115f03d67efb', ...
</code></pre>
<p>Since the two nodes are both initialized by default to establish an outbound
connection to each other during <code>setup</code>, the second node's chain will include
the mined blocks as soon as they propagate.</p>
<pre><code>&gt;&gt;&gt; test.nodes[1].getblockchaininfo()["blocks"]
101
</code></pre>
<p>The block rewards from the first block are now spendable by the wallet of the
first node.</p>
<pre><code>&gt;&gt;&gt; test.nodes[0].getbalance()
Decimal('50.00000000')
</code></pre>
<p>We can also log custom events to the logger.</p>
<pre><code>&gt;&gt;&gt; test.nodes[0].log.info("Successfully mined regtest chain!")
20XX-XX-XXTXX:XX:XX.XXXXXXX TestFramework.node0 (INFO): Successfully mined regtest chain!
</code></pre>
<p><strong>Note: Please also consider the functional test
<a href="test/functional//test/functional/README.html">readme</a>, which provides an overview of the
test-framework</strong>. Modules such as
<a href="test/functional//test/functional/test_framework/key.py">key.py</a>,
<a href="test/functional//test/functional/test_framework/script.py">script.py</a> and
<a href="test/functional//test/functional/test_framework/messages.py">messages.py</a> are particularly
useful in constructing objects which can be passed to the bitcoind nodes managed
by a running <code>TestShell</code> object.</p>
<h2 id="5-shutting-the-testshell-down"><a class="header" href="#5-shutting-the-testshell-down">5. Shutting the <code>TestShell</code> down</a></h2>
<p>Shutting down the <code>TestShell</code> will safely tear down all running bitcoind
instances and remove all temporary data and logging directories.</p>
<pre><code>&gt;&gt;&gt; test.shutdown()
20XX-XX-XXTXX:XX:XX.XXXXXXX TestFramework (INFO): Stopping nodes
20XX-XX-XXTXX:XX:XX.XXXXXXX TestFramework (INFO): Cleaning up /path/to/bitcoin_func_test_XXXXXXX on exit
20XX-XX-XXTXX:XX:XX.XXXXXXX TestFramework (INFO): Tests successful
</code></pre>
<p>To prevent the logs from being removed after a shutdown, simply set the
<code>TestShell().options.nocleanup</code> member to <code>True</code>.</p>
<pre><code>&gt;&gt;&gt; test.options.nocleanup = True
&gt;&gt;&gt; test.shutdown()
20XX-XX-XXTXX:XX:XX.XXXXXXX TestFramework (INFO): Stopping nodes
20XX-XX-XXTXX:XX:XX.XXXXXXX TestFramework (INFO): Not cleaning up dir /path/to/bitcoin_func_test_XXXXXXX on exit
20XX-XX-XXTXX:XX:XX.XXXXXXX TestFramework (INFO): Tests successful
</code></pre>
<p>The following utility consolidates logs from the bitcoind nodes and the
underlying <code>BitcoinTestFramework</code>:</p>
<ul>
<li><code>/path/to/bitcoin/test/functional/combine_logs.py '/path/to/bitcoin_func_test_XXXXXXX'</code></li>
</ul>
<h2 id="6-custom-testshell-parameters"><a class="header" href="#6-custom-testshell-parameters">6. Custom <code>TestShell</code> parameters</a></h2>
<p>The <code>TestShell</code> object initializes with the default settings inherited from the
<code>BitcoinTestFramework</code> class. The user can override these in
<code>TestShell().setup(key=value)</code>.</p>
<p><strong>Note:</strong> <code>TestShell().reset()</code> will reset test parameters to default values and
can be called after the TestShell is shut down.</p>
<div class="table-wrapper"><table><thead><tr><th>Test parameter key</th><th>Default Value</th><th>Description</th></tr></thead><tbody>
<tr><td><code>bind_to_localhost_only</code></td><td><code>True</code></td><td>Binds bitcoind P2P services to <code>127.0.0.1</code> if set to <code>True</code>.</td></tr>
<tr><td><code>cachedir</code></td><td><code>"/path/to/bitcoin/test/cache"</code></td><td>Sets the bitcoind datadir directory.</td></tr>
<tr><td><code>chain</code></td><td><code>"regtest"</code></td><td>Sets the chain-type for the underlying test bitcoind processes.</td></tr>
<tr><td><code>configfile</code></td><td><code>"/path/to/bitcoin/test/config.ini"</code></td><td>Sets the location of the test framework config file.</td></tr>
<tr><td><code>coveragedir</code></td><td><code>None</code></td><td>Records bitcoind RPC test coverage into this directory if set.</td></tr>
<tr><td><code>loglevel</code></td><td><code>INFO</code></td><td>Logs events at this level and higher. Can be set to <code>DEBUG</code>, <code>INFO</code>, <code>WARNING</code>, <code>ERROR</code> or <code>CRITICAL</code>.</td></tr>
<tr><td><code>nocleanup</code></td><td><code>False</code></td><td>Cleans up temporary test directory if set to <code>True</code> during <code>shutdown</code>.</td></tr>
<tr><td><code>noshutdown</code></td><td><code>False</code></td><td>Does not stop bitcoind instances after <code>shutdown</code> if set to <code>True</code>.</td></tr>
<tr><td><code>num_nodes</code></td><td><code>1</code></td><td>Sets the number of initialized bitcoind processes.</td></tr>
<tr><td><code>perf</code></td><td>False</td><td>Profiles running nodes with <code>perf</code> for the duration of the test if set to <code>True</code>.</td></tr>
<tr><td><code>rpc_timeout</code></td><td><code>60</code></td><td>Sets the RPC server timeout for the underlying bitcoind processes.</td></tr>
<tr><td><code>setup_clean_chain</code></td><td><code>False</code></td><td>A 200-block-long chain is initialized from cache by default. Instead, <code>setup_clean_chain</code> initializes an empty blockchain if set to <code>True</code>.</td></tr>
<tr><td><code>randomseed</code></td><td>Random Integer</td><td><code>TestShell().options.randomseed</code> is a member of <code>TestShell</code> which can be accessed during a test to seed a random generator. User can override default with a constant value for reproducible test runs.</td></tr>
<tr><td><code>supports_cli</code></td><td><code>False</code></td><td>Whether the bitcoin-cli utility is compiled and available for the test.</td></tr>
<tr><td><code>tmpdir</code></td><td><code>"/var/folders/.../"</code></td><td>Sets directory for test logs. Will be deleted upon a successful test run unless <code>nocleanup</code> is set to <code>True</code></td></tr>
<tr><td><code>trace_rpc</code></td><td><code>False</code></td><td>Logs all RPC calls if set to <code>True</code>.</td></tr>
<tr><td><code>usecli</code></td><td><code>False</code></td><td>Uses the bitcoin-cli interface for all bitcoind commands instead of directly calling the RPC server. Requires <code>supports_cli</code>.</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><p>This folder contains lint scripts.</p>
<h1 id="running-locally"><a class="header" href="#running-locally">Running locally</a></h1>
<p>To run linters locally with the same versions as the CI environment, use the included
Dockerfile:</p>
<pre><code class="language-sh">DOCKER_BUILDKIT=1 docker build -t bitcoin-linter --file "./ci/lint_imagefile" ./ &amp;&amp; docker run --rm -v $(pwd):/bitcoin -it bitcoin-linter
</code></pre>
<p>Building the container can be done every time, because it is fast when the
result is cached and it prevents issues when the image changes.</p>
<h1 id="test-runner"><a class="header" href="#test-runner">test runner</a></h1>
<p>To run all the lint checks in the test runner outside the docker you first need
to install the rust toolchain using your package manager of choice or
<a href="https://www.rust-lang.org/tools/install">rustup</a>.</p>
<p>Then you can use:</p>
<pre><code class="language-sh">( cd ./test/lint/test_runner/ &amp;&amp; cargo fmt &amp;&amp; cargo clippy &amp;&amp; RUST_BACKTRACE=1 cargo run )
</code></pre>
<p>If you wish to run individual lint checks, run the test_runner with
<code>--lint=TEST_TO_RUN</code> arguments. If running with <code>cargo run</code>, arguments after
<code>--</code> are passed to the binary you are running e.g.:</p>
<pre><code class="language-sh">( cd ./test/lint/test_runner/ &amp;&amp; RUST_BACKTRACE=1 cargo run -- --lint=doc --lint=trailing_whitespace )
</code></pre>
<p>To see a list of all individual lint checks available in test_runner, use <code>-h</code>
or <code>--help</code>:</p>
<pre><code class="language-sh">( cd ./test/lint/test_runner/ &amp;&amp; RUST_BACKTRACE=1 cargo run -- --help )
</code></pre>
<h4 id="dependencies-3"><a class="header" href="#dependencies-3">Dependencies</a></h4>
<div class="table-wrapper"><table><thead><tr><th>Lint test</th><th style="text-align: center">Dependency</th></tr></thead><tbody>
<tr><td><a href="test/lint//test/lint/lint-python.py"><code>lint-python.py</code></a></td><td style="text-align: center"><a href="https://github.com/lief-project/LIEF">lief</a></td></tr>
<tr><td><a href="test/lint//test/lint/lint-python.py"><code>lint-python.py</code></a></td><td style="text-align: center"><a href="https://github.com/python/mypy">mypy</a></td></tr>
<tr><td><a href="test/lint//test/lint/lint-python.py"><code>lint-python.py</code></a></td><td style="text-align: center"><a href="https://github.com/zeromq/pyzmq">pyzmq</a></td></tr>
<tr><td><a href="test/lint//test/lint/lint-python-dead-code.py"><code>lint-python-dead-code.py</code></a></td><td style="text-align: center"><a href="https://github.com/jendrikseipp/vulture">vulture</a></td></tr>
<tr><td><a href="test/lint//test/lint/lint-shell.py"><code>lint-shell.py</code></a></td><td style="text-align: center"><a href="https://github.com/koalaman/shellcheck">ShellCheck</a></td></tr>
<tr><td><a href="test/lint//test/lint/lint-spelling.py"><code>lint-spelling.py</code></a></td><td style="text-align: center"><a href="https://github.com/codespell-project/codespell">codespell</a></td></tr>
<tr><td><code>py_lint</code></td><td style="text-align: center"><a href="https://github.com/astral-sh/ruff">ruff</a></td></tr>
<tr><td>markdown link check</td><td style="text-align: center"><a href="https://github.com/becheran/mlc">mlc</a></td></tr>
</tbody></table>
</div>
<p>In use versions and install instructions are available in the <a href="test/lint/../../ci/lint/04_install.sh">CI setup</a>.</p>
<p>Please be aware that on Linux distributions all dependencies are usually available as packages, but could be outdated.</p>
<h4 id="running-the-tests-1"><a class="header" href="#running-the-tests-1">Running the tests</a></h4>
<p>Individual tests can be run by directly calling the test script, e.g.:</p>
<pre><code>test/lint/lint-files.py
</code></pre>
<h1 id="check-docpy"><a class="header" href="#check-docpy">check-doc.py</a></h1>
<p>Check for missing documentation of command line options.</p>
<h1 id="commit-script-checksh"><a class="header" href="#commit-script-checksh">commit-script-check.sh</a></h1>
<p>Verification of <a href="test/lint//doc/developer-notes.html#scripted-diffs">scripted diffs</a>.
Scripted diffs are only assumed to run on the latest LTS release of Ubuntu. Running them on other operating systems
might require installing GNU tools, such as GNU sed.</p>
<h1 id="git-subtree-checksh"><a class="header" href="#git-subtree-checksh">git-subtree-check.sh</a></h1>
<p>Run this script from the root of the repository to verify that a subtree matches the contents of
the commit it claims to have been updated to.</p>
<pre><code>Usage: test/lint/git-subtree-check.sh [-r] DIR [COMMIT]
       test/lint/git-subtree-check.sh -?
</code></pre>
<ul>
<li><code>DIR</code> is the prefix within the repository to check.</li>
<li><code>COMMIT</code> is the commit to check, if it is not provided, HEAD will be used.</li>
<li><code>-r</code> checks that subtree commit is present in repository.</li>
</ul>
<p>To do a full check with <code>-r</code>, make sure that you have fetched the upstream repository branch in which the subtree is
maintained:</p>
<ul>
<li>for <code>src/secp256k1</code>: https://github.com/bitcoin-core/secp256k1.git (branch master)</li>
<li>for <code>src/leveldb</code>: https://github.com/bitcoin-core/leveldb-subtree.git (branch bitcoin-fork)</li>
<li>for <code>src/crypto/ctaes</code>: https://github.com/bitcoin-core/ctaes.git (branch master)</li>
<li>for <code>src/crc32c</code>: https://github.com/bitcoin-core/crc32c-subtree.git (branch bitcoin-fork)</li>
<li>for <code>src/minisketch</code>: https://github.com/sipa/minisketch.git (branch master)</li>
</ul>
<p>To do so, add the upstream repository as remote:</p>
<pre><code>git remote add --fetch secp256k1 https://github.com/bitcoin-core/secp256k1.git
</code></pre>
<h1 id="lint_ignore_dirspy"><a class="header" href="#lint_ignore_dirspy">lint_ignore_dirs.py</a></h1>
<p>Add list of common directories to ignore when running tests</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
