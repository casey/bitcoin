<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>test - Bitcoin Core Developer Documentation</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Bitcoin Core Developer Documentation</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="unit-tests"><a class="header" href="#unit-tests">Unit tests</a></h1>
<p>The sources in this directory are unit test cases. Boost includes a
unit testing framework, and since Bitcoin Core already uses Boost, it makes
sense to simply use this framework rather than require developers to
configure some other framework (we want as few impediments to creating
unit tests as possible).</p>
<p>The build system is set up to compile an executable called <code>test_bitcoin</code>
that runs all of the unit tests. The main source file for the test library is found in
<code>util/setup_common.cpp</code>.</p>
<p>The examples in this document assume the build directory is named
<code>build</code>. You'll need to adapt them if you named it differently.</p>
<h3 id="compilingrunning-unit-tests"><a class="header" href="#compilingrunning-unit-tests">Compiling/running unit tests</a></h3>
<p>Unit tests will be automatically compiled if dependencies were met
during the generation of the Bitcoin Core build system
and tests weren't explicitly disabled.</p>
<p>The unit tests can be run with <code>ctest --test-dir build</code>, which includes unit
tests from subtrees.</p>
<p>Run <code>test_bitcoin --list_content</code> for the full list of tests.</p>
<p>To run the unit tests manually, launch <code>build/src/test/test_bitcoin</code>. To recompile
after a test file was modified, run <code>cmake --build build</code> and then run the test again. If you
modify a non-test file, use <code>cmake --build build --target test_bitcoin</code> to recompile only what's needed
to run the unit tests.</p>
<p>To add more unit tests, add <code>BOOST_AUTO_TEST_CASE</code> functions to the existing
.cpp files in the <code>test/</code> directory or add new .cpp files that
implement new <code>BOOST_AUTO_TEST_SUITE</code> sections.</p>
<p>To run the GUI unit tests manually, launch <code>build/src/qt/test/test_bitcoin-qt</code></p>
<p>To add more GUI unit tests, add them to the <code>src/qt/test/</code> directory and
the <code>src/qt/test/test_main.cpp</code> file.</p>
<h3 id="running-individual-tests"><a class="header" href="#running-individual-tests">Running individual tests</a></h3>
<p>The <code>test_bitcoin</code> runner accepts command line arguments from the Boost
framework. To see the list of arguments that may be passed, run:</p>
<pre><code>test_bitcoin --help
</code></pre>
<p>For example, to run only the tests in the <code>getarg_tests</code> file, with full logging:</p>
<pre><code class="language-bash">build/src/test/test_bitcoin --log_level=all --run_test=getarg_tests
</code></pre>
<p>or</p>
<pre><code class="language-bash">build/src/test/test_bitcoin -l all -t getarg_tests
</code></pre>
<p>or to run only the doubledash test in <code>getarg_tests</code></p>
<pre><code class="language-bash">build/src/test/test_bitcoin --run_test=getarg_tests/doubledash
</code></pre>
<p>The <code>--log_level=</code> (or <code>-l</code>) argument controls the verbosity of the test output.</p>
<p>The <code>test_bitcoin</code> runner also accepts some of the command line arguments accepted by
<code>bitcoind</code>. Use <code>--</code> to separate these sets of arguments:</p>
<pre><code class="language-bash">build/src/test/test_bitcoin --log_level=all --run_test=getarg_tests -- -printtoconsole=1
</code></pre>
<p>The <code>-printtoconsole=1</code> after the two dashes sends debug logging, which
normally goes only to <code>debug.log</code> within the data directory, to the
standard terminal output as well.</p>
<p>Running <code>test_bitcoin</code> creates a temporary working (data) directory with a randomly
generated pathname within <code>test_common bitcoin/</code>, which in turn is within
the system's temporary directory (see
<a href="https://en.cppreference.com/w/cpp/filesystem/temp_directory_path"><code>temp_directory_path</code></a>).
This data directory looks like a simplified form of the standard <code>bitcoind</code> data
directory. Its content will vary depending on the test, but it will always
have a <code>debug.log</code> file, for example.</p>
<p>The location of the temporary data directory can be specified with the
<code>-testdatadir</code> option. This can make debugging easier. The directory
path used is the argument path appended with
<code>/test_common bitcoin/&lt;test-name&gt;/datadir</code>.
The directory path is created if necessary.
Specifying this argument also causes the data directory
not to be removed after the last test. This is useful for looking at
what the test wrote to <code>debug.log</code> after it completes, for example.
(The directory is removed at the start of the next test run,
so no leftover state is used.)</p>
<pre><code class="language-bash">$ build/src/test/test_bitcoin --run_test=getarg_tests/doubledash -- -testdatadir=/somewhere/mydatadir
Test directory (will not be deleted): "/somewhere/mydatadir/test_common bitcoin/getarg_tests/doubledash/datadir"
Running 1 test case...

*** No errors detected
$ ls -l '/somewhere/mydatadir/test_common bitcoin/getarg_tests/doubledash/datadir'
total 8
drwxrwxr-x 2 admin admin 4096 Nov 27 22:45 blocks
-rw-rw-r-- 1 admin admin 1003 Nov 27 22:45 debug.log
</code></pre>
<p>If you run an entire test suite, such as <code>--run_test=getarg_tests</code>, or all the test suites
(by not specifying <code>--run_test</code>), a separate directory
will be created for each individual test.</p>
<h3 id="adding-test-cases"><a class="header" href="#adding-test-cases">Adding test cases</a></h3>
<p>To add a new unit test file to our test suite, you need
to add the file to either <code>src/test/CMakeLists.txt</code> or
<code>src/wallet/test/CMakeLists.txt</code> for wallet-related tests. The pattern is to create
one test file for each class or source file for which you want to create
unit tests. The file naming convention is <code>&lt;source_filename&gt;_tests.cpp</code>
and such files should wrap their tests in a test suite
called <code>&lt;source_filename&gt;_tests</code>. For an example of this pattern,
see <code>uint256_tests.cpp</code>.</p>
<h3 id="logging-and-debugging-in-unit-tests"><a class="header" href="#logging-and-debugging-in-unit-tests">Logging and debugging in unit tests</a></h3>
<p><code>ctest --test-dir build</code> will write to the log file <code>build/Testing/Temporary/LastTest.log</code>. You can
additionally use the <code>--output-on-failure</code> option to display logs of the failed tests automatically
on failure. For running individual tests verbosely, refer to the section
<a href="#running-individual-tests">above</a>.</p>
<p>To write to logs from unit tests you need to use specific message methods
provided by Boost. The simplest is <code>BOOST_TEST_MESSAGE</code>.</p>
<p>For debugging you can launch the <code>test_bitcoin</code> executable with <code>gdb</code> or <code>lldb</code> and
start debugging, just like you would with any other program:</p>
<pre><code class="language-bash">gdb build/src/test/test_bitcoin
</code></pre>
<h4 id="segmentation-faults"><a class="header" href="#segmentation-faults">Segmentation faults</a></h4>
<p>If you hit a segmentation fault during a test run, you can diagnose where the fault
is happening by running <code>gdb ./build/src/test/test_bitcoin</code> and then using the <code>bt</code> command
within gdb.</p>
<p>Another tool that can be used to resolve segmentation faults is
<a href="https://valgrind.org/">valgrind</a>.</p>
<p>If for whatever reason you want to produce a core dump file for this fault, you can do
that as well. By default, the boost test runner will intercept system errors and not
produce a core file. To bypass this, add <code>--catch_system_errors=no</code> to the
<code>test_bitcoin</code> arguments and ensure that your ulimits are set properly (e.g. <code>ulimit -c unlimited</code>).</p>
<p>Running the tests and hitting a segmentation fault should now produce a file called <code>core</code>
(on Linux platforms, the file name will likely depend on the contents of
<code>/proc/sys/kernel/core_pattern</code>).</p>
<p>You can then explore the core dump using</p>
<pre><code class="language-bash">gdb build/src/test/test_bitcoin core

(gdb) bt  # produce a backtrace for where a segfault occurred
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../src/qt/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../src/test/data/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../src/qt/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../src/test/data/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
